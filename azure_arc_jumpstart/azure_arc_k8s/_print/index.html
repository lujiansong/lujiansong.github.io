<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.80.0" /><link rel="canonical" type="text/html" href="/azure_arc_jumpstart/azure_arc_k8s/">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Azure Arc enabled Kubernetes | Goldydocs</title><meta property="og:title" content="Azure Arc enabled Kubernetes" />
<meta property="og:description" content="The deployment scenarios in this section will guide you through onboarding various Kubernetes distributions as an Azure Arc enabled Kubernetes clusters." />
<meta property="og:type" content="website" />
<meta property="og:url" content="/azure_arc_jumpstart/azure_arc_k8s/" />
<meta property="og:site_name" content="Goldydocs" />
<meta itemprop="name" content="Azure Arc enabled Kubernetes">
<meta itemprop="description" content="The deployment scenarios in this section will guide you through onboarding various Kubernetes distributions as an Azure Arc enabled Kubernetes clusters.">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Azure Arc enabled Kubernetes"/>
<meta name="twitter:description" content="The deployment scenarios in this section will guide you through onboarding various Kubernetes distributions as an Azure Arc enabled Kubernetes clusters."/>





<link rel="preload" href="/scss/main.min.4aec00cbc82dae02258a2ba135990358146339f666dc47346f0f1e49d7a6fa42.css" as="style">
<link href="/scss/main.min.4aec00cbc82dae02258a2ba135990358146339f666dc47346f0f1e49d7a6fa42.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>




  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zM197.0804 232.033c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zM197.0839 232.0372c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zM197.0839 232.0372c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zM197.0804 177.6188c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zM197.0839 177.623c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zM197.0839 177.623c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zM197.5309 286.4723c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zM197.5344 286.4765c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zM197.5344 286.4765c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zM197.0804 340.5784c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zM197.0839 340.5826c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zM197.0839 340.5826c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">Goldydocs</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			
			
			<li class="nav-item dropdown d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	English
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/no/">Norsk</a>
	
	<a class="dropdown-item" href="/fa/">فارسی</a>
	
</div>
			</li>
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete="off">

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/azure_arc_jumpstart/azure_arc_k8s/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Azure Arc enabled Kubernetes</h1>
<div class="lead">The deployment scenarios in this section will guide you through onboarding various Kubernetes distributions as an Azure Arc enabled Kubernetes clusters.</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-b5702fde6357d066dbe4fb888521f927">Onboarding</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-8e99abf7a2c151b8574581f07908c165">Existing cluster</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-4058c92f46090baba44b0e09d635676b">Azure Kubernetes Service</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-c2630ddab80d3d6d1693e2416207a76a">AKS cluster ARM template</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>2.2: <a href="#pg-468b4e879c0975ed6583c45f5657a0cc">AKS cluster Terraform plan</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-3e05fff6e5f9edc84a1c1f7e7cbd6a89">Amazon Elastic Kubernetes Service</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-5e17a5ecfaf4883b327e3a3a5a173c93">EKS cluster Terraform plan</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-28b2918a0d905681a5ba4bb5b347ea47">Google Kubernetes Engine</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-7b3417c1127106046a16ebb3ce567134">GKE cluster Terraform plan</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-a57a5382ffb7c67c0e8f32e5cd7bda2f">Kubernetes Cluster API</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-19ad9d47852711a9ec0dfb3405805685">Azure Provider</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-ce8c5dc601de838593a9b6be96998df3">Rancher K3s</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-6b79ac779a90e2d51c854647ee30fd19">k3s Azure ARM template</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>6.2: <a href="#pg-d56ecc40c26e1cc0f12f4d0304905c81">k3s Azure Terraform plan</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>6.3: <a href="#pg-cff71fdb229d543e558525c8c80283d9">k3s on VMware Terraform plan</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-aaac4d3169279a7ae1691c0c9b59ec53">Azure Red Hat OpenShift</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-b00ec34618f4a7c6c0cefb270ee9bd59">ARO Cluster</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-715d96aca7ade3fe976071e1cd0ba8e0">Kind</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.1: <a href="#pg-26e6fd581cdac268f933c80f67cb66ed">Kind cluster</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>9: <a href="#pg-d7bef51078e0d72deaa1a59c8907857a">MicroK8s</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>9.1: <a href="#pg-4e867e92b2a5802eefb8ffa06426f985">MicroK8s cluster</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>10: <a href="#pg-1d0f8542d6157eb9642fa1e8bba23a9d">Unified Operations Use Cases</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.1: <a href="#pg-4d3df2981d26d03a22ca357944650885">AKS</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.1.1: <a href="#pg-44610c6b5316b3f8cd2b84332697b1c4">Deploy GitOps configurations and perform basic GitOps flow on AKS as an Azure Arc Connected Cluster</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>10.1.2: <a href="#pg-c88c142dc87e09357d590b49fc212f80">Deploy GitOps configurations and perform Helm-based GitOps flow on AKS as an Azure Arc Connected Cluster</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>10.1.3: <a href="#pg-cdb23c16630e70509b44b66208dbc024">Integrate Azure Monitor for Containers with AKS as an Azure Arc Connected Cluster</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>10.1.4: <a href="#pg-0ab2c80854e6dbba2714dfe7f5623dd0">Apply GitOps configurations on AKS as an Azure Arc Connected Cluster using Azure Policy for Kubernetes</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>10.2: <a href="#pg-ecb095d0322798ee5c46b4a8223b12cf">GKE</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.2.1: <a href="#pg-d457b58c7bf722d2347deaef42e48f9f">Deploy GitOps configurations and perform basic GitOps flow on GKE as an Azure Arc Connected Cluster</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>10.2.2: <a href="#pg-185c98c7d0c0e36f4297a126b0d881f3">Deploy GitOps configurations and perform Helm-based GitOps flow on GKE as an Azure Arc Connected Cluster</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>10.2.3: <a href="#pg-de11c18b0e8549b41c0a88fa1af98a22">Integrate Azure Monitor for Containers with GKE as an Azure Arc Connected Cluster</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>10.2.4: <a href="#pg-aff3a2239473fef2a378434ef6640e2c">Apply GitOps configurations on GKE as an Azure Arc Connected Cluster using Azure Policy for Kubernetes</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>10.3: <a href="#pg-35f95ff005abe064acf384005986b669">Kind</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.3.1: <a href="#pg-37841f0de5e94de64c5a1f739f9f2f89">Deploy GitOps configurations and perform Helm-based GitOps flow on kind as an Azure Arc Connected Cluster</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>10.4: <a href="#pg-38c8e0744fcb743de272a63e7e6783d7">Microk8s</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.4.1: <a href="#pg-149a30bbf147076ee35e812c981993fb">Deploy GitOps configurations and perform Helm-based GitOps flow on MicroK8s as an Azure Arc Connected Cluster</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>
    
  

    </ul>
    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b5702fde6357d066dbe4fb888521f927">1 - Onboarding</h1>
    <div class="lead">This example demonstrates how to connect an existing Kubernetes cluster to Arc. It assumes you already have a cluster ready to work with.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-8e99abf7a2c151b8574581f07908c165">1.1 - Existing cluster</h1>
    
	<h2 id="connect-an-existing-kubernetes-cluster-to-azure-arc">Connect an existing Kubernetes cluster to Azure Arc</h2>
<p>The following README will guide you on how to connect an existing Kubernetes cluster to Azure Arc using a simple shell script.</p>
<blockquote>
<p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href="https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/">public preview</a></strong>.</p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Make sure your <em>kubeconfig</em> file is configured properly and you are working against your <a href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/">k8s cluster context</a>.</p>
</li>
<li>
<p>(Optional) To simplify work against multiple k8s contexts, consider using <a href="https://github.com/ahmetb/kubectx">kubectx</a>.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">Install and Set Up kubectl</a></p>
</li>
<li>
<p><a href="https://helm.sh/docs/intro/install/">Install Helm 3</a>. If you are on a Windows environment, a recommended and easy way is to use the <a href="https://chocolatey.org/packages/kubernetes-helm">Helm 3 Chocolatey package</a>.</p>
</li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
<li>
<p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li>
<li>
<p>Create a new Azure resource group where you want your cluster(s) to show up.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az group create -l &lt;Azure Region&gt; -n &lt;resource group name&gt;
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az group create -l eastus -n Arc-k8s-Clusters
</code></pre></div><blockquote>
<p><strong>Note: Currently, Azure Arc enabled Kubernetes resource creation is supported only in the following locations: eastus, westeurope. Use the &ndash;location (or -l) flag to specify one of these locations.</strong></p>
</blockquote>
<p><img src="./01.png" alt="Screenshot showing Azure Portal with empty resource group"></p>
</li>
<li>
<p>Change the following environment variables according to your Azure service principal name and Azure environment.</p>
<p>If using shell:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#204a87">export</span> <span style="color:#000">appId</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;Your Azure service principal name&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;Your Azure service principal password&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">tenantId</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;Your Azure tenant ID&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">resourceGroup</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;Azure resource group name&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">arcClusterName</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;The name of your k8s cluster as it will be shown in Azure Arc&gt;&#39;</span>
</code></pre></div><p>If using PowerShell:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#000">$env:appId</span><span style="color:#000;font-weight:bold">=&lt;</span><span style="color:#000">Your</span> <span style="color:#000">Azure</span> <span style="color:#000">service</span> <span style="color:#000">principal</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">&gt;</span>
<span style="color:#000">$env:password</span><span style="color:#000;font-weight:bold">=&lt;</span><span style="color:#000">Your</span> <span style="color:#000">Azure</span> <span style="color:#000">service</span> <span style="color:#000">principal</span> <span style="color:#000">password</span><span style="color:#000;font-weight:bold">&gt;</span>
<span style="color:#000">$env:tenantId</span><span style="color:#000;font-weight:bold">=&lt;</span><span style="color:#000">Your</span> <span style="color:#000">Azure</span> <span style="color:#000">tenant</span> <span style="color:#000">ID</span><span style="color:#000;font-weight:bold">&gt;</span>
<span style="color:#000">$env:resourceGroup</span><span style="color:#000;font-weight:bold">=&lt;</span><span style="color:#000">Azure</span> <span style="color:#000">resource</span> <span style="color:#204a87">group </span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">&gt;</span>
<span style="color:#000">$env:arcClusterName</span><span style="color:#000;font-weight:bold">=&lt;</span><span style="color:#000">The</span> <span style="color:#000">name</span> <span style="color:#000">of</span> <span style="color:#000">your</span> <span style="color:#000">k8s</span> <span style="color:#000">cluster</span> <span style="color:#000">as</span> <span style="color:#000">it</span> <span style="color:#000">will</span> <span style="color:#000">be</span> <span style="color:#000">shown</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">Azure</span> <span style="color:#000">Arc</span><span style="color:#000;font-weight:bold">&gt;</span>
</code></pre></div></li>
</ul>
<h2 id="deployment">Deployment</h2>
<ul>
<li>
<p>Install the Azure Arc for Kubernetes CLI extensions <em><strong>connectedk8s</strong></em> and <em><strong>k8sconfiguration</strong></em>:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az extension add --name connectedk8s
az extension add --name k8sconfiguration
</code></pre></div><blockquote>
<p><strong>Note: If you already used this guide before and/or have the extensions installed, use the bellow commands:</strong></p>
</blockquote>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az extension update --name connectedk8s
az extension update --name k8sconfiguration
</code></pre></div></li>
<li>
<p>Login to your Azure subscription using the SP you created.</p>
<p>If using shell:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login --service-principal --username <span style="color:#000">$appId</span> --password <span style="color:#000">$password</span> --tenant <span style="color:#000">$tenantId</span>
</code></pre></div><p>If using PowerShell:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#000">az</span> <span style="color:#000">login</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000">-service-principal</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000">-username</span> <span style="color:#000">$env:appId</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000">-password</span> <span style="color:#000">$env:password</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000">-tenant</span> <span style="color:#000">$env:tenantId</span>
</code></pre></div></li>
<li>
<p>If you are working in a Linux OS or MacOS environment, make sure you are the owner of the following:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo chown -R <span style="color:#000">$USER</span> /home/<span style="color:#4e9a06">${</span><span style="color:#000">USER</span><span style="color:#4e9a06">}</span>/.kube
sudo chown -R <span style="color:#000">$USER</span> /home/<span style="color:#4e9a06">${</span><span style="color:#000">USER</span><span style="color:#4e9a06">}</span>/.kube/config
sudo chown -R <span style="color:#000">$USER</span> /home/<span style="color:#4e9a06">${</span><span style="color:#000">USER</span><span style="color:#4e9a06">}</span>/.azure/config
sudo chown -R <span style="color:#000">$USER</span> /home/<span style="color:#4e9a06">${</span><span style="color:#000">USER</span><span style="color:#4e9a06">}</span>/.azure
sudo chmod -R <span style="color:#0000cf;font-weight:bold">777</span> /home/<span style="color:#4e9a06">${</span><span style="color:#000">USER</span><span style="color:#4e9a06">}</span>/.azure/config
sudo chmod -R <span style="color:#0000cf;font-weight:bold">777</span> /home/<span style="color:#4e9a06">${</span><span style="color:#000">USER</span><span style="color:#4e9a06">}</span>/.azure
</code></pre></div></li>
<li>
<p>To connect the Kubernetes cluster to Azure Arc use the below command.</p>
<p>If using shell:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az connectedk8s connect --name <span style="color:#000">$arcClusterName</span> --resource-group <span style="color:#000">$resourceGroup</span>
</code></pre></div><p>If using PowerShell:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#000">az</span> <span style="color:#000">connectedk8s</span> <span style="color:#000">connect</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000">-name</span> <span style="color:#000">$env:arcClusterName</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#000">-resource-group</span> <span style="color:#000">$env:resourceGroup</span>
</code></pre></div></li>
</ul>
<p>Upon completion, you will have your Kubernetes cluster, connected as a new Azure Arc enabled Kubernetes resource inside your resource group.</p>
<p><img src="./02.png" alt="Screenshot showing Azure ARM template deployment"></p>
<p><img src="./03.png" alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource"></p>
<p><img src="./04.png" alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource"></p>
<h2 id="delete-the-deployment">Delete the deployment</h2>
<p>The most straightforward way is to delete the Azure Arc enabled Kubernetes resource is via the Azure Portal, just select cluster and delete it.</p>
<p><img src="./05.png" alt="Screenshot showing how to delete resources in Azure Portal"></p>
<p>If you want to delete the entire environment, just delete the Azure resource group.</p>
<p><img src="./06.png" alt="Screenshot showing how to delete resource groups in Azure Portal"></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4058c92f46090baba44b0e09d635676b">2 - Azure Kubernetes Service</h1>
    <div class="lead">If you do not yet have a Kubernetes cluster, the scenarios in this section will guide on creating an AKS cluster in order to simulate an &ldquo;on-premises&rdquo; cluster in an automated fashion using either ARM template or Terraform.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-c2630ddab80d3d6d1693e2416207a76a">2.1 - AKS cluster ARM template</h1>
    
	<h2 id="deploy-aks-cluster-and-connect-it-to-azure-arc-using-an-azure-arm-template">Deploy AKS cluster and connect it to Azure Arc using an Azure ARM template</h2>
<p>The following README will guide you on how to use the provided <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview">Azure ARM Template</a> to deploy an <a href="https://docs.microsoft.com/en-us/azure/aks/intro-kubernetes">Azure Kubernetes Service (AKS)</a> cluster and connected it as an Azure Arc cluster resource.</p>
<blockquote>
<p><strong>Note: Since AKS is a 1st-party Azure solution and natively supports capabilities such as <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/insights/container-insights-overview">Azure Monitor</a> integration as well as GitOps configurations (currently in private preview), it is not expected for an AKS cluster to be projected as an Azure Arc enabled Kubernetes cluster. The following scenario should ONLY be used for demo and testing purposes.</strong></p>
</blockquote>
<blockquote>
<p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href="https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/">public preview</a>.</strong></p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-ssh-keys-detailed">Generate SSH Key</a> (or use existing ssh key).</p>
</li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
<li>
<p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li>
</ul>
<h2 id="deployment">Deployment</h2>
<ul>
<li>
<p>Before deploying the ARM template, determine which AKS Kubernetes versions are available in your region using the below Azure CLI command.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az aks get-versions -l <span style="color:#4e9a06">&#34;&lt;Your Azure Region&gt;&#34;</span>
</code></pre></div></li>
<li>
<p>The deployment is using the template parameters file. Before initiating the deployment, edit the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/arm_template/azuredeploy.parameters.json"><em>azuredeploy.parameters.json</em></a> file to match your environment and using one of the available Kubernetes Versions from the previous step.</p>
<p><img src="./01.png" alt="Screenshot of Azure ARM template"></p>
<p>To deploy the ARM template, navigate to the <a href="https://github.com/microsoft/azure_arc/tree/main/azure_arc_k8s_jumpstart/aks/arm_template">deployment folder</a> and run the below command:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az group create --name &lt;Name of the Azure resource group&gt; --location &lt;Azure Region&gt;
az deployment group create <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--resource-group &lt;Name of the Azure resource group&gt; <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--name &lt;The name of this deployment&gt; <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_k8s_jumpstart/aks/arm_template/azuredeploy.json <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--parameters &lt;The *azuredeploy.parameters.json* parameters file location&gt;
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az group create --name Arc-AKS-Demo --location <span style="color:#4e9a06">&#34;East US&#34;</span>
az deployment group create <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--resource-group Arc-AKS-Demo <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--name arcaksdemo01 <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_k8s_jumpstart/aks/arm_template/azuredeploy.json <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--parameters azuredeploy.parameters.json
</code></pre></div></li>
<li>
<p>Once the ARM template deployment is completed, a new AKS cluster in a new Azure resource group is created.</p>
<p><img src="./02.png" alt="Screenshot of Azure Portal showing AKS resource"></p>
<p><img src="./03.png" alt="Screenshot of Azure Portal showing AKS resource"></p>
</li>
</ul>
<h2 id="connecting-to-azure-arc">Connecting to Azure Arc</h2>
<ul>
<li>
<p>Now that you have a running AKS cluster, edit the environment variables section in the included <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/arm_template/scripts/az_connect_aks.sh">az_connect_aks</a> shell script.</p>
<p><img src="./04.png" alt="Screenshot of az_connect_aks shell script"></p>
</li>
<li>
<p>In order to keep your local environment clean and untouched, we will use <a href="https://docs.microsoft.com/en-us/azure/cloud-shell/overview">Azure Cloud Shell</a> (located in the top-right corner in the Azure portal) to run the <em>az_connect_aks</em> shell script against the AKS cluster. <strong>Make sure Cloud Shell is configured to use Bash.</strong></p>
<p><img src="./05.png" alt="Screenshot of Azure Cloud Shell button in Visual Studio Code"></p>
</li>
<li>
<p>After editing the environment variables in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/arm_template/scripts/az_connect_aks.sh"><em>az_connect_aks</em></a> shell script to match your parameters, save the file and then upload it to the Cloud Shell environment and run it using the <code>. ./az_connect_aks.sh</code> command.</p>
<blockquote>
<p><strong>Note: The extra dot is due to the script having an <em>export</em> function and needs to have the vars exported in the same shell session as the other commands.</strong></p>
</blockquote>
<p><img src="./06.png" alt="Screenshot showing upload of file to Cloud Shell"></p>
<p><img src="./07.png" alt="Screenshot showing upload of file to Cloud Shell"></p>
<p><img src="./08.png" alt="Screenshot showing Cloud Shell with uploaded file"></p>
</li>
<li>
<p>Once the script run has finished, the AKS cluster will be projected as a new Azure Arc cluster resource.</p>
<p><img src="./09.png" alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource"></p>
<p><img src="./10.png" alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource"></p>
<p><img src="./11.png" alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource"></p>
</li>
</ul>
<h2 id="delete-the-deployment">Delete the deployment</h2>
<p>The most straightforward way is to delete the Azure Arc cluster resource via the Azure Portal, just select the cluster and delete it.</p>
<p><img src="./12.png" alt="Screenshot showing how to delete Azure Arc enabled Kubernetes resource"></p>
<p>If you want to nuke the entire environment, run the below commands.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az deployment group delete --name &lt;Deployment name&gt; --resource-group &lt;Azure resource group name&gt;
</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az group delete --name &lt;Azure resource group name&gt; --yes
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az deployment group delete --name arcaksdemo01 --resource-group Arc-AKS-Demo
</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az group delete --name Arc-AKS-Demo --yes
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-468b4e879c0975ed6583c45f5657a0cc">2.2 - AKS cluster Terraform plan</h1>
    
	<h2 id="deploy-aks-cluster-and-connect-it-to-azure-arc-using-terraform">Deploy AKS cluster and connect it to Azure Arc using Terraform</h2>
<p>The following README will guide you on how to use the provided <a href="https://www.terraform.io/">Terraform</a> plan to deploy an <a href="https://docs.microsoft.com/en-us/azure/aks/intro-kubernetes">Azure Kubernetes Service (AKS)</a> cluster and connected it as an Azure Arc enabled Kubernetes resource.</p>
<blockquote>
<p><strong>Note: Since AKS is a 1st-party Azure solution and natively supports capabilities such as <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/insights/container-insights-overview">Azure Monitor</a> integration as well as GitOps configurations (currently in private preview), it is not expected for an AKS cluster to be projected as an Azure Arc enabled Kubernetes cluster. The following scenario should ONLY be used for demo and testing purposes.</strong></p>
</blockquote>
<blockquote>
<p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href="https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/">public preview</a>.</strong></p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p><a href="https://learn.hashicorp.com/terraform/getting-started/install.html">Install Terraform &gt;=0.12</a></p>
</li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
<li>
<p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li>
</ul>
<h2 id="deployment">Deployment</h2>
<p>The only thing you need to do before executing the Terraform plan is to export the environment variables which will be used by the plan. This is based on the Azure service principal you&rsquo;ve just created and your subscription.</p>
<p>In addition, validate that the AKS Kubernetes version is available in your region using the below Azure CLI command.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az aks get-versions -l <span style="color:#4e9a06">&#34;&lt;Your Azure Region&gt;&#34;</span>
</code></pre></div><p>In case the AKS service is not available in your region, you can change the AKS Kubernetes version in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/terraform/variables.tf"><em>variables.tf</em></a> file by searching for <em>kubernetes_version</em>.</p>
<ul>
<li>
<p>Export the environment variables needed for the Terraform plan.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_client_id</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;Your Azure service principal App ID&gt;
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_client_secret</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;Your Azure service principal App Password&gt;
</code></pre></div></li>
<li>
<p>Run the <code>terraform init</code> command which will download the Terraform AzureRM provider.</p>
<p><img src="./01.png" alt="Screenshot showing terraform init being run"></p>
</li>
<li>
<p>Run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish.</p>
<p>Once the Terraform deployment is completed, a new AKS cluster in a new Azure resource group is created.</p>
<p><img src="./02.png" alt="Screenshot showing terraform plan completing"></p>
<p><img src="./03.png" alt="Screenshot showing Azure Portal with AKS resource"></p>
<p><img src="./04.png" alt="Screenshot showing Azure Portal with AKS resource"></p>
</li>
<li>
<p>Now that you have a running AKS cluster, edit the environment variables section in the included <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/terraform/scripts/az_connect_aks.sh">az_connect_aks</a> shell script.</p>
<p><img src="./05.png" alt="Screenshot showing az_connect_aks shell script"></p>
</li>
<li>
<p>In order to keep your local environment clean and untouched, we will use <a href="https://docs.microsoft.com/en-us/azure/cloud-shell/overview">Azure Cloud Shell</a> (located in the top-right corner in the Azure portal) to run the <em>az_connect_aks</em> shell script against the AKS cluster. <strong>Make sure Cloud Shell is configured to use Bash.</strong></p>
<p><img src="./06.png" alt="Screenshot showing how to access Cloud Shell in Visual Studio Code"></p>
</li>
<li>
<p>Edit the environment variables in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/terraform/scripts/az_connect_aks.sh"><em>az_connect_aks</em></a> shell script to match your parameters, upload it to the Cloud Shell environment and run it using the <code>. ./az_connect_aks.sh</code> command.</p>
<blockquote>
<p><strong>Note: The extra dot is due to the script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p>
</blockquote>
<p><img src="./07.png" alt="Screenshot showing Cloud Shell upload functionality"></p>
<p><img src="./08.png" alt="Screenshot showing Cloud Shell upload functionality"></p>
<p><img src="./09.png" alt="Screenshot showing Cloud Shell upload functionality"></p>
<p><img src="./10.png" alt="Screenshot showing Cloud Shell upload functionality"></p>
</li>
<li>
<p>Once the script run has finished, the AKS cluster will be projected as a new Azure Arc enabled Kubernetes resource.</p>
<p><img src="./11.png" alt="Screenshot showing Azure Portal with Azure Arc enabled resource"></p>
<p><img src="./12.png" alt="Screenshot showing Azure Portal with Azure Arc enabled resource"></p>
</li>
</ul>
<h2 id="delete-the-deployment">Delete the deployment</h2>
<p>The most straightforward way is to delete the Azure Arc enabled Kubernetes resource via the Azure Portal, just select the cluster and delete it.</p>
<p><img src="./13.png" alt="Screenshot showing delete function in Azure Portal"></p>
<p>If you want to nuke the entire environment, delete both the AKS and the AKS resources resource groups or run the <code>terraform destroy -auto-approve</code> command.</p>
<p><img src="./14.png" alt="Screenshot showing terraform destroy being run"></p>
<p><img src="./15.png" alt="Screenshot showing terraform destroy being run"></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3e05fff6e5f9edc84a1c1f7e7cbd6a89">3 - Amazon Elastic Kubernetes Service</h1>
    <div class="lead">If you are working in a multi-cloud environment, the scenario in this section will guide on creating an Amazon Elastic Kubernetes Service (EKS) and onboard it as an Azure Arc enabled Kubernetes cluster in an automated fashion using Terraform.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-5e17a5ecfaf4883b327e3a3a5a173c93">3.1 - EKS cluster Terraform plan</h1>
    
	<h2 id="deploy-eks-cluster-and-connect-it-to-azure-arc-using-terraform">Deploy EKS cluster and connect it to Azure Arc using Terraform</h2>
<p>The following README will guide you on how to use the provided <a href="https://www.terraform.io/">Terraform</a> plan to deploy an Amazon Web Services (AWS) <a href="https://aws.amazon.com/eks/">Kubernetes Engine cluster</a> and connected it as an Azure Arc cluster resource.</p>
<blockquote>
<p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href="https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/">public preview</a></strong>.</p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p><a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html">Install</a> and <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html#cli-quick-configuration">Configure</a> AWS CLI</p>
</li>
<li>
<p>Install <strong>wget</strong> package (required for the eks module)</p>
<ul>
<li><a href="https://builtvisible.com/download-your-website-with-wget/">Windows</a></li>
<li><a href="https://www.cyberciti.biz/faq/howto-install-wget-om-mac-os-x-mountain-lion-mavericks-snow-leopard/">Mac</a></li>
<li><a href="https://www.tecmint.com/install-wget-in-linux/">Linux</a></li>
</ul>
</li>
<li>
<p><a href="https://docs.aws.amazon.com/eks/latest/userguide/install-aws-iam-authenticator.html">Install AWS IAM Authenticator</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p><a href="https://aws.amazon.com/free/">Create a free Amazon Web Service&rsquo;s account</a></p>
</li>
<li>
<p><a href="https://helm.sh/docs/intro/install/">Install Helm 3</a></p>
</li>
<li>
<p><a href="https://learn.hashicorp.com/terraform/getting-started/install.html">Install Terraform &gt;=0.12</a></p>
</li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
<li>
<p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li>
<li>
<p>Install the Azure Arc for Kubernetes CLI extensions <em><strong>connectedk8s</strong></em> and <em><strong>k8sconfiguration</strong></em>:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az extension add --name connectedk8s
az extension add --name k8sconfiguration
</code></pre></div><blockquote>
<p><strong>Note: If you already used this guide before and/or have the extensions installed, use the bellow commands:</strong></p>
</blockquote>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az extension update --name connectedk8s
az extension update --name k8sconfiguration
</code></pre></div></li>
<li>
<p>Create AWS User IAM Key</p>
<p>An access key grants programmatic access to your resources. To create an AWS Access Key for a user:</p>
<ul>
<li>
<p>Navigate to the <a href="https://console.aws.amazon.com/iam/home#/home">IAM Access page</a>.</p>
<p><img src="./image0.png" alt="Screenshot showing how to create AWS IAM key"></p>
</li>
<li>
<p>Select the <strong>Users</strong> from the side menu.</p>
<p><img src="./image1.png" alt="Screenshot showing how to create AWS IAM key"></p>
</li>
<li>
<p>Select the <strong>User</strong> you want to create the access key for.</p>
<p><img src="./image2.png" alt="Screenshot showing how to create AWS IAM key"></p>
</li>
<li>
<p>Select *<strong>Security credentials</strong> of the <strong>User</strong> selected.</p>
<p><img src="./image3.png" alt="Screenshot showing how to create AWS IAM key"></p>
</li>
<li>
<p>Under <strong>Access Keys</strong> select <strong>Create Access Keys</strong>.</p>
<p><img src="./image4.png" alt="Screenshot showing how to create AWS IAM key"></p>
</li>
<li>
<p>In the popup window it will show you the <em><strong>Access key ID</strong></em> and <em><strong>Secret access key</strong></em>. Save both of these values to configure <strong>AWS CLI</strong> later</p>
<p><img src="./image5.png" alt="Screenshot showing how to create AWS IAM key"></p>
</li>
<li>
<p>Set your credentials via the AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY, environment variables, representing your AWS Access Key and AWS Secret Key.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#204a87">export</span> <span style="color:#000">AWS_ACCESS_KEY_ID</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;an access key&#34;</span>
<span style="color:#204a87">export</span> <span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;a secret key&#34;</span>
<span style="color:#204a87">export</span> <span style="color:#000">AWS_DEFAULT_REGION</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;us-west-2&#34;</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h2 id="deployment">Deployment</h2>
<ul>
<li>
<p>Navigate to the folder that has <strong>EKS</strong> terraform binaries.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#204a87">cd</span> azure_arc_k8s_jumpstart/eks/terraform
</code></pre></div></li>
<li>
<p>Run the <code>terraform init</code> command which will initialize Terraform, creating the state file to track our work:</p>
<p><img src="./image6.png" alt="Screenshot showing terraform init being run"></p>
</li>
<li>
<p>Deploy EKS by running the <code>terraform apply --auto-approve</code> command.
Wait for the plan to finish:</p>
<p><img src="./image7.png" alt="Screenshot showing terraform apply being run"></p>
</li>
<li>
<p>You will need the configuration output from Terraform in order to use kubectl to interact with your new cluster. Create your kube configuration directory, and output the configuration from Terraform into the config file using the Terraform output command:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">mkdir ~/.kube/
terraform output kubeconfig&gt;~/.kube/config
</code></pre></div><p>Check to see if cluster is discoverable by <code>kubectl</code> by running:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl version
</code></pre></div><p>Output should look similar to this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Client Version: version.Info<span style="color:#ce5c00;font-weight:bold">{</span>Major:<span style="color:#4e9a06">&#34;1&#34;</span>, Minor:<span style="color:#4e9a06">&#34;15&#34;</span>, GitVersion:<span style="color:#4e9a06">&#34;v1.15.5&#34;</span>, GitCommit:<span style="color:#4e9a06">&#34;20c265fef0741dd71a66480e35bd69f18351daea&#34;</span>, GitTreeState:<span style="color:#4e9a06">&#34;clean&#34;</span>, BuildDate:<span style="color:#4e9a06">&#34;2019-10-15T19:16:51Z&#34;</span>, GoVersion:<span style="color:#4e9a06">&#34;go1.12.10&#34;</span>, Compiler:<span style="color:#4e9a06">&#34;gc&#34;</span>, Platform:<span style="color:#4e9a06">&#34;darwin/amd64&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
Server Version: version.Info<span style="color:#ce5c00;font-weight:bold">{</span>Major:<span style="color:#4e9a06">&#34;1&#34;</span>, Minor:<span style="color:#4e9a06">&#34;16+&#34;</span>, GitVersion:<span style="color:#4e9a06">&#34;v1.16.8-eks-e16311&#34;</span>, GitCommit:<span style="color:#4e9a06">&#34;e163110a04dcb2f39c3325af96d019b4925419eb&#34;</span>, GitTreeState:<span style="color:#4e9a06">&#34;clean&#34;</span>, BuildDate:<span style="color:#4e9a06">&#34;2020-03-27T22:37:12Z&#34;</span>, GoVersion:<span style="color:#4e9a06">&#34;go1.13.8&#34;</span>, Compiler:<span style="color:#4e9a06">&#34;gc&#34;</span>, Platform:<span style="color:#4e9a06">&#34;linux/amd64&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div></li>
<li>
<p>Configure EKS Nodes to communicate to EKS Control Plane</p>
<p>Now let’s add the ConfigMap to the cluster from Terraform as well. The ConfigMap is a Kubernetes configuration, in this case for granting access to our EKS cluster. This ConfigMap allows our ec2 instances in the cluster to communicate with the EKS master, as well as allowing our user account access to run commands against the cluster. You’ll run the Terraform output command to a file, and the kubectl apply command to apply that file:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">terraform output config_map_aws_auth &gt; configmap.yml
kubectl apply -f configmap.yml
</code></pre></div><p><img src="./image8.png" alt="Screenshot showing kubectl apply being run"></p>
<p>Once this is complete, you should see your nodes from your autoscaling group either starting to join or joined to the cluster. Once the second column reads Ready the node can have deployments pushed to it. Again, your output may vary here:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get nodes -o wide
</code></pre></div><p><img src="./image9.png" alt="Screenshot showing kubectl get nodes being run"></p>
</li>
<li>
<p>Verify EKS deployment</p>
<p>Once done, you will have a ready EKS cluster under the <em><strong>Elastic Kubernetes Service</strong></em> section in your AWS console.</p>
<p><img src="./image10.png" alt="Screenshot showing AWS cloud console"></p>
<p><img src="./image11.png" alt="Screenshot showing AWS cloud console with EKS cluster"></p>
</li>
</ul>
<h2 id="connecting-to-azure-arc">Connecting to Azure Arc</h2>
<p>Now that you have a running EKS cluster, lets connect the EKS cluster to Azure Arc by:</p>
<ul>
<li>
<p>Login to previously created <a href="#prerequisites"><em><strong>Service Principal</strong></em></a></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login --service-principal -u mySpnClientId -p mySpnClientSecret --tenant myTenantID
</code></pre></div></li>
<li>
<p>Create a resource group</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az group create --name arceksdemo -l EastUS -o table
</code></pre></div><blockquote>
<p><strong>Note: Azure Arc enabled Kubernetes is currently supported in <em>East US</em> and <em>West Europe</em></strong></p>
</blockquote>
</li>
<li>
<p>Deploy Arc binaries using Azure CLI:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az connectedk8s connect --name arceksdemo --resource-group arceksdemo --location <span style="color:#4e9a06">&#39;eastus&#39;</span> --tags <span style="color:#4e9a06">&#39;Project=jumpstart_azure_arc_k8s&#39;</span>
</code></pre></div></li>
<li>
<p>Upon completion, you will have your EKS cluster connect as a new Azure Arc enabled Kubernetes resource in a new resource group.</p>
<p><img src="./image13.png" alt="Screenshot showing ARM deployment"></p>
<p><img src="./image14.png" alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource"></p>
<p><img src="./image15.png" alt="Screenshot showing Azure POrtal with Azure Arc enabled Kubernetes resource detail"></p>
</li>
</ul>
<h2 id="delete-the-deployment">Delete the deployment</h2>
<p>In Azure, the most straightforward way is to delete the cluster or the resource group via the Azure Portal or through the CLI.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az group delete --name arceksdemo
</code></pre></div><p><img src="./image16.png" alt="Screenshot showing delete resource function in Azure Portal"></p>
<p><img src="./image17.png" alt="Screenshot showing delete resource group function in Azure Portal"></p>
<p>On your AWS portal, select the cluster and delete it or alternatively, you can use the <code>terraform destroy --auto-approve</code> command.</p>
<p><img src="./image18.png" alt="Screenshot showing terraform destroy being run"></p>
<p><img src="./image20.png" alt="Screenshot showing terraform destroy being run"></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-28b2918a0d905681a5ba4bb5b347ea47">4 - Google Kubernetes Engine</h1>
    <div class="lead">If you are working in a multi-cloud environment, the scenario in this section will guide on creating a Google Kubernetes Engine (GKE) and onboard it as an Azure Arc enabled Kubernetes cluster in an automated fashion using Terraform.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-7b3417c1127106046a16ebb3ce567134">4.1 - GKE cluster Terraform plan</h1>
    
	<h2 id="deploy-gke-cluster-and-connect-it-to-azure-arc-using-terraform">Deploy GKE cluster and connect it to Azure Arc using Terraform</h2>
<p>The following README will guide you on how to use the provided <a href="https://www.terraform.io/">Terraform</a> plan to deploy a Google Cloud Platform <a href="https://cloud.google.com/kubernetes-engine">Kubernetes Engine cluster</a> and connected it as an Azure Arc cluster resource.</p>
<blockquote>
<p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href="https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/">public preview</a></strong>.</p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p><a href="https://cloud.google.com/free">Create a free Google Cloud account</a></p>
</li>
<li>
<p><a href="https://learn.hashicorp.com/terraform/getting-started/install.html">Install Terraform &gt;=0.12</a></p>
</li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
<li>
<p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li>
<li>
<p>Install the Azure Arc for Kubernetes CLI extensions <em><strong>connectedk8s</strong></em> and <em><strong>k8sconfiguration</strong></em>:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az extension add --name connectedk8s
az extension add --name k8sconfiguration
</code></pre></div><blockquote>
<p><strong>Note: If you already used this guide before and/or have the extensions installed, use the bellow commands:</strong></p>
</blockquote>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az extension update --name connectedk8s
az extension update --name k8sconfiguration
</code></pre></div></li>
</ul>
<h3 id="create-a-new-gcp-project">Create a new GCP Project</h3>
<ul>
<li>
<p>Browse to <a href="https://console.cloud.google.com/">https://console.cloud.google.com/</a> and login with your Google Cloud account. Once logged in, <a href="https://cloud.google.com/resource-manager/docs/creating-managing-projects">create a new project</a> named &ldquo;Azure Arc Demo&rdquo;. After creating it, be sure to copy down the project id as it is usually different then the project name.</p>
<p><img src="./01.png" alt="GCP new project"></p>
<p><img src="./02.png" alt="GCP new project"></p>
<p><img src="./03.png" alt="GCP new project"></p>
</li>
<li>
<p>Enable the Compute Engine API for the project, create a project Owner service account credentials and download the private key JSON file and copy the file to the directory where Terraform files are located. Change the JSON file name (for example <em>account.json</em>). The Terraform plan will be using the credentials stored in this file to authenticate against your GCP project.</p>
<p><img src="./04.png" alt="Enable Compute Engine API"></p>
<p><img src="./05.png" alt="Enable Compute Engine API"></p>
<p><img src="./06.png" alt="Add credentials"></p>
<p><img src="./07.png" alt="Add credentials"></p>
<p><img src="./08.png" alt="Add credentials"></p>
<p><img src="./09.png" alt="Add credentials"></p>
<p><img src="./10.png" alt="Add credentials"></p>
<p><img src="./11.png" alt="Create private key"></p>
<p><img src="./12.png" alt="Create private key"></p>
<p><img src="./13.png" alt="Create private key"></p>
<p><img src="./14.png" alt="Create private key"></p>
<p><img src="./15.png" alt="account.json"></p>
</li>
<li>
<p>Enable the Compute Engine API for the project</p>
<p><img src="./16.png" alt="Enable the Kubernetes Engine API"></p>
<p><img src="./17.png" alt="Enable the Kubernetes Engine API"></p>
</li>
</ul>
<h2 id="deployment">Deployment</h2>
<p>The only thing you need to do before executing the Terraform plan is to export the environment variables which will be used by the plan. This is based on the Azure service principal you&rsquo;ve just created and your subscription.</p>
<ul>
<li>
<p>Export the environment variables needed for the Terraform plan.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_subscriptionId</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;Your Azure subscription ID&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_servicePrincipalAppId</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;Your Azure service principal App ID&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_servicePrincipalSecret</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;Your Azure service principal App Password&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_servicePrincipalTenantId</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;Your Azure tenant ID&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_gcp_project_id</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;Your GCP Project ID&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_location</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;Azure Region&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_resourceGroup</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;Azure resource group name&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_gcp_credentials_filename</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;Location on the Keys JSON file&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_gcp_region</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;GCP Region to deploy resources&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_gke_cluster_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;GKE cluster name&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_admin_username</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;GKE control plane administrator username&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_admin_password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;GKE control plane administrator password&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_gke_cluster_node_count</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;GKE cluster node count&gt;&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_gke_cluster_node_machine_type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&lt;GKE cluster node machine type&gt;&#39;</span>
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_subscriptionId</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_servicePrincipalAppId</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_servicePrincipalSecret</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_servicePrincipalTenantId</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_location</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;eastus&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_resourceGroup</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;Arc-GKE-Demo&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_gcp_project_id</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;azure-arc-demo-111111&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_gcp_credentials_filename</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;account.json&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_gcp_region</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;us-west1&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_gke_cluster_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;arc-gke-demo&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_admin_username</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;arcdemo&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_admin_password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;ArcDemo1234567!!&#39;</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_gke_cluster_node_count</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_gke_cluster_node_machine_type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;n1-standard-2&#39;</span>
</code></pre></div></li>
<li>
<p>Run the <code>terraform init</code> command which will download the required terraform providers.</p>
<p><img src="./18.png" alt="terraform init"></p>
</li>
<li>
<p>Run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish. Once done, you will have a new empty Azure resource group and and a GKE cluster under the <em>Kubernetes Engine</em> page in your GCP console.</p>
<p><img src="./19.png" alt="terraform apply"></p>
<p><img src="./20.png" alt="An empty Azure resource group"></p>
<p><img src="./21.png" alt="New GKE cluster in the Google Console"></p>
<p><img src="./22.png" alt="New GKE cluster in the Google Console"></p>
</li>
</ul>
<h2 id="connecting-to-azure-arc">Connecting to Azure Arc</h2>
<ul>
<li>
<p>Now that you have a running GKE cluster, retrieve your Azure subscription ID using the <code>az account list</code> command and edit the environment variables section in the included <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/terraform/scripts/az_connect_gke.sh">az_connect_gke</a> shell script.</p>
<p><img src="./23.png" alt="Export environment variables"></p>
</li>
<li>
<p>Open a new Cloud Shell session which will pre-authenticated against your GKE cluster.</p>
<p><img src="./24.png" alt="Open Google Cloud Shell session and authenticate against the GKE cluster"></p>
<p><img src="./25.png" alt="Open Google Cloud Shell session and authenticate against the GKE cluster"></p>
<p><img src="./26.png" alt="Open Google Cloud Shell session and authenticate against the GKE cluster"></p>
</li>
<li>
<p>Upload the <em>az_connect_gke</em> shell script and run it using the <code>. ./az_connect_gke.sh</code> command.</p>
<blockquote>
<p><strong>Note: The extra dot is due to the script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p>
</blockquote>
<p><img src="./27.png" alt="Upload a file to Cloud Shell"></p>
<p><img src="./28.png" alt="Upload a file to Cloud Shell"></p>
<p><img src="./29.png" alt="Upload a file to Cloud Shell"></p>
</li>
<li>
<p>Upon completion, you will have your GKE cluster connect as a new Azure Arc Kubernetes cluster resource in the new Azure resource group.</p>
<p><img src="./30.png" alt="New Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./31.png" alt="New Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./32.png" alt="New Azure Arc enabled Kubernetes cluster"></p>
</li>
</ul>
<h2 id="delete-the-deployment">Delete the deployment</h2>
<p>To delete the environment, use the <em><code>terraform destroy --auto-approve</code></em> command.</p>
<p><img src="./33.png" alt="terraform destroy"></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a57a5382ffb7c67c0e8f32e5cd7bda2f">5 - Kubernetes Cluster API</h1>
    <div class="lead">If you are working in a multi-cloud environment, the scenarios in this section will guide on creating clusters using Kubernetes Cluster API (CAPI) and onboard it as an Azure Arc enabled Kubernetes cluster in an automated fashion.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-19ad9d47852711a9ec0dfb3405805685">5.1 - Azure Provider</h1>
    
	<h2 id="deploy-kubernetes-cluster-and-connect-it-to-azure-arc-using-cluster-api-azure-provider">Deploy Kubernetes cluster and connect it to Azure Arc using Cluster API Azure provider</h2>
<p>The following README will guide you on to deploy an Kubernetes cluster in Azure virtual machines and connected it as an Azure Arc cluster resource by leveraging the <a href="https://cluster-api.sigs.k8s.io/introduction.html">Kubernetes Cluster API (CAPI) project</a> and it&rsquo;s <a href="https://cloudblogs.microsoft.com/opensource/2020/12/15/introducing-cluster-api-provider-azure-capz-kubernetes-cluster-management/">Cluster API Azure provider (CAPZ)</a>.</p>
<blockquote>
<p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href="https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/">public preview</a>.</strong></p>
</blockquote>
<h2 id="architecture-in-a-nutshell">Architecture (In a nutshell)</h2>
<p>From the Cluster API Book docs:</p>
<p>&ldquo;Cluster API requires an existing Kubernetes cluster accessible via kubectl; during the installation process the Kubernetes cluster will be transformed into a management cluster by installing the Cluster API provider components, so it is recommended to keep it separated from any application workload.&rdquo;</p>
<p>In this guide (as explained in the CAPI Book docs), you will deploy a local <a href="https://kind.sigs.k8s.io/">kind</a> cluster which will be used as the management cluster. This cluster will then be used to deploy the workload cluster using the Cluster API Azure provider (CAPZ).</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
<li>
<p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li>
<li>
<p>As mentioned, you will need to deploy a local, small footprint Kubernetes cluster using kind which will act the management/provisioner cluster. To install kind on your machine, use the below command.</p>
<blockquote>
<p><strong>Note: In order for you to complete this scenario, either a Linux (<a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">WSL incl.</a>) or MacOS is required. Currently, this scenario does not support Windows OS</strong></p>
</blockquote>
<p>On Linux:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.9.0/kind-linux-amd64
chmod +x ./kind
sudo mv ./kind /usr/local/bin/kind
</code></pre></div><p>On MacOS:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">brew install kind
</code></pre></div><p><img src="./01.png" alt="Screenshot of kind CLI"></p>
</li>
</ul>
<h2 id="deployment---management-cluster">Deployment - Management Cluster</h2>
<blockquote>
<p><strong>Disclaimer: The deployment process of a the management cluster and the <em>clusterctl</em> CLI tool described in below are taken straight from the <a href="https://cluster-api.sigs.k8s.io/user/quick-start.html">&ldquo;Cluster API Book&rdquo;</a> and deserves it&rsquo;s writers all the credit for it!</strong>
<strong>The reason being for this process to be included is to provide you with the end-to-end user experience which also include the proprietary automation developed for this Jumpstart scenario and will be used later on in this guide.</strong></p>
</blockquote>
<ul>
<li>
<p>Now that you have kind installed, deploy the local management cluster and test to ensure it&rsquo;s ready using the below commands:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kind create cluster
kubectl cluster-info
</code></pre></div><p><img src="./02.png" alt="Screenshot of kind management cluster deployment"></p>
</li>
<li>
<p>Install the <em>clusterctl</em> CLI tool which handles the lifecycle of a Cluster API management cluster using the below commands:</p>
<p>On Linux:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -L https://github.com/kubernetes-sigs/cluster-api/releases/download/v0.3.12/clusterctl-linux-amd64 -o clusterctl
chmod +x ./clusterctl
sudo mv ./clusterctl /usr/local/bin/clusterctl
clusterctl version
</code></pre></div><p>On MacOS:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -L https://github.com/kubernetes-sigs/cluster-api/releases/download/v0.3.12/clusterctl-darwin-amd64 -o clusterctl
chmod +x ./clusterctl
sudo mv ./clusterctl /usr/local/bin/clusterctl
clusterctl version
</code></pre></div><p><img src="./03.png" alt="Screenshot clusterctl installation"></p>
</li>
</ul>
<h2 id="deployment---workload-cluster">Deployment - Workload Cluster</h2>
<ul>
<li>
<p>In the your directory of the cloned Jumpstart repository, navigate to where the <a href="https://github.com/microsoft/azure_arc/tree/main/azure_arc_k8s_jumpstart/cluster_api/capi_azure"><em>arc_capi_azure</em></a> bash script is located.</p>
<p>The script will transform the kind Kubernetes cluster to management cluster with the Azure Cluster API provisioner components that are needed. It will then deploy the workload cluster and it&rsquo;s Azure resources based on the environment variables you will edit in the next bullet. Once the deployment is completed, the cluster will be onboard as an Azure Arc enabled Kubernetes cluster.</p>
</li>
<li>
<p>Edit the environment variables to match your Azure subscription and SPN details created in the prerequisites section in this guide as well as the required workload cluster details.</p>
<ul>
<li><em>KUBERNETES_VERSION</em>=&ldquo;Kubernetes version. For example: 1.18.10&rdquo;</li>
<li><em>CONTROL_PLANE_MACHINE_COUNT</em>=&ldquo;Control Plane node count. For example: 1&rdquo;</li>
<li><em>WORKER_MACHINE_COUNT</em>=&ldquo;Workers node count. For example: 2&rdquo;</li>
<li><em>AZURE_LOCATION</em>=&ldquo;Azure region. For example: eastus&rdquo;</li>
<li><em>CAPI_WORKLOAD_CLUSTER_NAME</em>=&ldquo;Workload cluster name. For example: arc-capi-azure&rdquo;. Must consist of lower case alphanumeric characters, &lsquo;-&rsquo; or &lsquo;.&rsquo;, and must start and end with an alphanumeric character (e.g. &lsquo;example.com&rsquo;, regex used for validation is &lsquo;<a href="%5B-a-z0-9%5D*%5Ba-z0-9%5D">a-z0-9</a>?(.<a href="%5B-a-z0-9%5D*%5Ba-z0-9%5D">a-z0-9</a>?)*')</li>
<li><em>AZURE_SUBSCRIPTION_ID</em>=&ldquo;Azure subscription id&rdquo;</li>
<li><em>AZURE_TENANT_ID</em>=&ldquo;Azure tenant id&rdquo;</li>
<li><em>AZURE_CLIENT_ID=</em>&ldquo;Azure SPN application client id&rdquo;</li>
<li><em>AZURE_CLIENT_SECRET</em>=&ldquo;Azure SPN application client secret&rdquo;</li>
<li><em>AZURE_CONTROL_PLANE_MACHINE_TYPE</em>=&ldquo;Control Plane node Azure VM type .For example: Standard_D2_v3&rdquo;</li>
<li><em>AZURE_NODE_MACHINE_TYPE</em>=&ldquo;Worker node Azure VM type .For example: Standard_D4s_v3&rdquo;</li>
</ul>
<p><img src="./04.png" alt="Screenshot of user environment variables"></p>
</li>
<li>
<p>Execute the script using the below command. The script runtime can take ~10-20min, depends on the number of control plane and worker nodes you chose to deploy. In case you don&rsquo;t have the required Azure CLI extensions already installed or if they are requires an update, the script will either install it or perform an update.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">. ./arc_capi_azure.sh
</code></pre></div><blockquote>
<p><strong>Note: The extra dot is due to the script having an <em>export</em> function and needs to have the vars exported in the same shell session as the other commands.</strong></p>
</blockquote>
<p><img src="./05.png" alt="Screenshot of workload cluster deployment script runtime"></p>
<p><img src="./06.png" alt="Screenshot of workload cluster deployment script runtime"></p>
<p><img src="./07.png" alt="Screenshot of workload cluster deployment script runtime"></p>
<p><img src="./08.png" alt="Screenshot of workload cluster deployment script runtime"></p>
<p><img src="./09.png" alt="Screenshot of workload cluster deployment script runtime"></p>
</li>
<li>
<p>Upon completion, you will have a new Kubernetes cluster deployed on top of Azure virtual machines  that is already onboard as an Azure Arc enabled Kubernetes cluster.</p>
<p>The script will generate the cluster definition <em>yaml</em> file which was used to deploy the workload cluster as will as the <em>kubeconfig</em> file. To test the cluster is up and running use the below command.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl --kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>./&lt;Name of your workload cluster&gt;.kubeconfig get nodes
</code></pre></div><p><img src="./10.png" alt="Screenshot of the workload cluster nodes"></p>
</li>
<li>
<p>In the Azure portal, you can see how all the resources were deployed in a new resource group as well as the Azure Arc enabled Kubernetes cluster resource.</p>
<p><img src="./11.png" alt="Screenshot of the deployment Azure virtual machines"></p>
<p><img src="./12.png" alt="Screenshot of the Azure Arc enabled Kubernetes cluster in a resource group"></p>
<p><img src="./13.png" alt="Screenshot of the Azure Arc enabled Kubernetes cluster resource"></p>
</li>
</ul>
<h2 id="cleanup">Cleanup</h2>
<ul>
<li>
<p>To delete only the workload cluster (and as a result, the Azure resources as well), run the below command. Deletion can take ~10min, depends on the number of control plane and worker nodes you have chosen to deploy.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl delete cluster <span style="color:#4e9a06">&#34;&lt;Name of your cluster&gt;&#34;</span>
</code></pre></div><p><img src="./14.png" alt="Screenshot of the workload cluster deletion"></p>
</li>
<li>
<p>In addition, you can also delete the management cluster using the below command.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kind delete cluster
</code></pre></div><p><img src="./15.png" alt="Screenshot of the management cluster deletion"></p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ce8c5dc601de838593a9b6be96998df3">6 - Rancher K3s</h1>
    <div class="lead">If you do not have a Kubernetes cluster, the scenarios in this section will guide on creating a Rancher K3s Kubernetes cluster on either your VMware vSphere infrastructure or on an Azure VM and onboard it as an Azure Arc enabled Kubernetes cluster in an automated fashion using either ARM template or Terraform.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-6b79ac779a90e2d51c854647ee30fd19">6.1 - k3s Azure ARM template</h1>
    
	<h2 id="deploy-rancher-k3s-on-an-azure-vm-and-connect-it-to-azure-arc-using-azure-arm-template">Deploy Rancher k3s on an Azure VM and connect it to Azure Arc using Azure ARM template</h2>
<p>The following README will guide you on how to use the provided <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview">Azure ARM Template</a> to deploy a &ldquo;Ready to Go&rdquo; Azure virtual machine installed with single-master Rancher K3s Kubernetes cluster and connected it as an Azure Arc cluster resource.</p>
<blockquote>
<p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href="https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/">public preview</a></strong>.</p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
<li>
<p>Enable subscription for two providers for Azure Arc enabled Kubernetes.</p>
</li>
<li>
<p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li>
</ul>
<h2 id="deployment">Deployment</h2>
<p>The deployment is using the template parameters file. Before initiating the deployment, edit the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/rancher_k3s/azure/arm_template/azuredeploy.parameters.json"><em>azuredeploy.parameters.json</em></a> file to include the OS username and password as well as the appId, password and tenant generated from the service principal creation.</p>
<ul>
<li>
<p>To deploy the ARM template, navigate to the <a href="https://github.com/microsoft/azure_arc/tree/main/azure_arc_k8s_jumpstart/rancher_k3s/azure/arm_template">deployment folder</a> and run the below command:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az group create --name &lt;Name of the Azure resource group&gt; --location &lt;Azure Region&gt;
az deployment group create <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--resource-group &lt;Name of the Azure resource group&gt; <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--name &lt;The name of this deployment&gt; <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_k8s_jumpstart/rancher_k3s/azure/arm_template/azuredeploy.json <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--parameters &lt;The *azuredeploy.parameters.json* parameters file location&gt;
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az group create --name Arc-K3s-Demo --location <span style="color:#4e9a06">&#34;East US&#34;</span>
az deployment group create <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--resource-group Arc-K3s-Demo <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--name arck3sdemo01 <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_k8s_jumpstart/rancher_k3s/azure/arm_template/azuredeploy.json <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>--parameters azuredeploy.parameters.json
</code></pre></div><p>Upon completion, you will have new VM installed as a single-host k3s cluster which is already projected as an Azure Arc enabled Kubernetes cluster in a new resource group.</p>
<p><img src="./01.png" alt="Azure resource group"></p>
</li>
</ul>
<h2 id="k3s-external-access">K3s External Access</h2>
<p>Traefik is the (default) ingress controller for k3s and uses port 80. To test external access to k3s cluster, an &ldquo;<em>hello-world</em>&rdquo; deployment was for you and it is included in the <em>home</em> directory <a href="https://github.com/paulbouwer/hello-kubernetes">(credit)</a>.</p>
<ul>
<li>
<p>Since port 80 is taken by Traefik <a href="https://github.com/rancher/k3s/issues/436">(read more about here)</a>, the deployment LoadBalancer was changed to use port 32323 along side with the matching Azure Network Security Group (NSG).</p>
<p><img src="./02.png" alt="Azure Network Security Group (NSG) rule"></p>
<p><img src="./03.png" alt="hello-kubernetes.yaml file"></p>
</li>
<li>
<p>To deploy it, use the <code>kubectl apply -f hello-kubernetes.yaml</code> command. Run <code>kubectl get pods</code> and <code>kubectl get svc</code> to check that the pods and the service has been created.</p>
<p><img src="./04.png" alt="kubectl apply -f hello-kubernetes.yaml command"></p>
<p><img src="./05.png" alt="kubectl get pods command"></p>
<p><img src="./06.png" alt="kubectl get svc command"></p>
</li>
<li>
<p>In your browser, enter the <em>cluster_public_ip:3232</em> which will bring up the <em>hello-world</em> application.</p>
<p><img src="./07.png" alt="hello-kubernetes application in a web browser"></p>
</li>
</ul>
<h2 id="delete-the-deployment">Delete the deployment</h2>
<p>To delete environment, simply just delete the Azure resource group.</p>
<p><img src="./08.png" alt="Delete Azure resource group"></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d56ecc40c26e1cc0f12f4d0304905c81">6.2 - k3s Azure Terraform plan</h1>
    
	<h2 id="deploy-rancher-k3s-on-an-azure-vm-and-connect-it-to-azure-arc-using-terraform">Deploy Rancher k3s on an Azure VM and connect it to Azure Arc using Terraform</h2>
<p>The following README will guide you on how to use the provided <a href="https://www.terraform.io/">Terraform</a> plan to deploy a &ldquo;Ready to Go&rdquo; Azure virtual machine installed with single-master Rancher K3s Kubernetes cluster and connected it as an Azure Arc cluster resource.</p>
<blockquote>
<p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href="https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/">public preview</a></strong>.</p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p><a href="https://learn.hashicorp.com/terraform/getting-started/install.html">Install Terraform &gt;=0.12</a></p>
</li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
<li>
<p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li>
<li>
<p>The Terraform plan execute a script on the VM OS to install all the needed artifacts as well to inject environment variables. Edit the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/rancher_k3s/azure/terraform/scripts/vars.sh"><em>scripts/vars.sh</em></a> to match the Azure service principal you&rsquo;ve just created.</p>
</li>
</ul>
<h2 id="deployment">Deployment</h2>
<p>The only thing you need to do before executing the Terraform plan is to export the environment variables which will be used by the plan. This is based on the Azure service principal you&rsquo;ve just created and your subscription.</p>
<ul>
<li>
<p>Retrieve your Azure subscription ID using the <code>az account list</code> command.</p>
</li>
<li>
<p>Export the environment variables needed for the Terraform plan.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_subscription_id</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;Your Azure subscription ID&gt;  
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_client_id</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;Your Azure service principal App ID&gt;
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_client_secret</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;Your Azure service principal App password&gt;  
<span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_tenant_id</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;Your Azure service principal Tenant ID&gt;
</code></pre></div></li>
<li>
<p>Run the <code>terraform init</code> command which will download the Terraform AzureRM provider.</p>
<p><img src="./01.png" alt="terraform init"></p>
</li>
<li>
<p>Run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish.</p>
<p><img src="./02.png" alt="terraform apply completed"></p>
</li>
</ul>
<h2 id="connecting-to-azure-arc">Connecting to Azure Arc</h2>
<blockquote>
<p><strong>Note: The VM bootstrap includes the log in process to Azure as well deploying the needed Azure Arc CLI extensions - no action items on you there!</strong></p>
</blockquote>
<ul>
<li>
<p>SSH to the VM using the created Azure Public IP and your username/password.</p>
<p><img src="./03.png" alt="Azure VM public IP"></p>
</li>
<li>
<p>Check the cluster is up and running using the <code>kubectl get nodes -o wide</code></p>
<p><img src="./04.png" alt="k3s cluster nodes"></p>
</li>
<li>
<p>Using the Azure service principal you&rsquo;ve created, run the below command to connect the cluster to Azure Arc.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az connectedk8s connect --name &lt;Name of your cluster as it will be shown in Azure&gt; --resource-group &lt;Azure resource group name&gt;
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az connectedk8s connect --name arck3sdemo --resource-group Arc-K3s-Demo
</code></pre></div><p><img src="./05.png" alt="Successful azconnctedk8s command"></p>
<p><img src="./06.png" alt="Azure Arc enabled Kubernetes cluster in an Azure resource group"></p>
<p><img src="./07.png" alt="Azure Arc enabled Kubernetes cluster in an Azure resource group"></p>
</li>
</ul>
<h2 id="k3s-external-access">K3s External Access</h2>
<p>Traefik is the (default) ingress controller for k3s and uses port 80. To test external access to k3s cluster, an &ldquo;<em>hello-world</em>&rdquo; deployment was <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/rancher_k3s/azure/terraform/deployment/hello-kubernetes.yaml">made available</a> for you and it is included in the <em>home</em> directory <a href="https://github.com/paulbouwer/hello-kubernetes">(credit)</a>.</p>
<ul>
<li>
<p>Since port 80 is taken by Traefik <a href="https://github.com/rancher/k3s/issues/436">(read more about here)</a>, the deployment LoadBalancer was changed to use port 32323 along side with the matching Azure Network Security Group (NSG).</p>
<p><img src="./08.png" alt="Azure Network Security Group (NSG) rule"></p>
<p><img src="./09.png" alt="hello-kubernetes.yaml file"></p>
</li>
<li>
<p>To deploy it, use the <code>kubectl apply -f hello-kubernetes.yaml</code> command. Run <code>kubectl get pods</code> and <code>kubectl get svc</code> to check that the pods and the service has been created.</p>
<p><img src="./10.png" alt="kubectl apply -f hello-kubernetes.yaml command"></p>
<p><img src="./11.png" alt="kubectl get pods command"></p>
<p><img src="./12.png" alt="kubectl get svc command"></p>
</li>
<li>
<p>In your browser, enter the <em>cluster_public_ip:3232</em> which will bring up the <em>hello-world</em> application.</p>
<p><img src="./13.png" alt="hello-kubernetes application in a web browser"></p>
</li>
</ul>
<h2 id="delete-the-deployment">Delete the deployment</h2>
<ul>
<li>
<p>The most straightforward way is to delete the cluster is via the Azure Portal, just select cluster and delete it.</p>
<p><img src="./14.png" alt="Delete Azure Arc enabled Kubernetes cluster"></p>
</li>
<li>
<p>If you want to nuke the entire environment, just delete the Azure resource group or alternatively, you can use the <code>terraform destroy --auto-approve</code> command.</p>
<p><img src="./15.png" alt="Delete Azure resource group"></p>
<p><img src="./16.png" alt="terraform destroy"></p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cff71fdb229d543e558525c8c80283d9">6.3 - k3s on VMware Terraform plan</h1>
    
	<h2 id="deploy-rancher-k3s-on-a-vmware-vsphere-vm-and-connect-it-to-azure-arc-using-terraform">Deploy Rancher k3s on a VMware vSphere VM and connect it to Azure Arc using Terraform</h2>
<p>The following README will guide you on how to use the provided <a href="https://www.terraform.io/">Terraform</a> plan to deploy a &ldquo;Ready to Go&rdquo; VMware vSphere Ubuntu Server virtual machine installed with a single-master Rancher K3s Kubernetes cluster and connected it as an Azure Arc cluster resource.</p>
<blockquote>
<p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href="https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/">public preview</a></strong>.</p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p><a href="https://learn.hashicorp.com/terraform/getting-started/install.html">Install Terraform &gt;=0.12</a></p>
</li>
<li>
<p>A VMware vCenter Server user with <a href="https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.vm_admin.doc/GUID-8254CD05-CC06-491D-BA56-A773A32A8130.html">permissions to deploy</a> a Virtual Machine from a Template in the vSphere Web Client.</p>
</li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
<li>
<p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li>
</ul>
<h3 id="preparing-an-ubuntu-server-vmware-vsphere-vm-template">Preparing an Ubuntu Server VMware vSphere VM Template</h3>
<p>Before using the below guide to deploy an Ubuntu Server VM and connect it to Azure Arc, a VMware vSphere Template is required. <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/vmware_ubuntu_template/">The following README</a> will instruct you how to easily create such a template using VMware vSphere 6.5 and above.</p>
<blockquote>
<p><strong>Note: If you already have an Ubuntu Server VM template it is still recommended to use the guide as a reference.</strong></p>
</blockquote>
<h2 id="deployment">Deployment</h2>
<p>Before executing the Terraform plan, you must set the environment variables which will be used by the plan. These variables are based on the Azure service principal you&rsquo;ve just created, your Azure subscription and tenant, and your VMware vSphere credentials.</p>
<ul>
<li>
<p>Retrieve your Azure subscription ID and tenant ID using the <code>az account list</code> command.</p>
</li>
<li>
<p>The Terraform plan creates resources in both Microsoft Azure and VMware vSphere. It then executes a script on the virtual machine to install the Azure Arc agent and all necessary artifacts. This script requires certain information about your VMware vSphere and Azure environments.</p>
</li>
<li>
<p>Edit <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/rancher_k3s/vmware/terraform/scripts/vars.sh"><em>scripts/vars.sh</em></a> and update each of the variables with the appropriate values.</p>
<ul>
<li>TF_VAR_subscription_id=Your Azure subscription ID</li>
<li>TF_VAR_client_id=Your Azure service principal name</li>
<li>TF_VAR_client_secret=Your Azure service principal password</li>
<li>TF_VAR_tenant_id=Your Azure tenant ID</li>
<li>TF_VAR_resourceGroup=Azure resource group name</li>
<li>TF_VAR_location=Azure Region</li>
<li>TF_VAR_arcClusterName=The name of your k8s cluster as it will be shown in Azure Arc</li>
<li>TF_VAR_vsphere_user=vCenter Admin Username</li>
<li>TF_VAR_vsphere_password=vCenter Admin Password</li>
<li>TF_VAR_vsphere_server=vCenter server FQDN/IP</li>
<li>TF_VAR_admin_user=OS Admin Username</li>
<li>TF_VAR_admin_password=OS Admin Password</li>
</ul>
</li>
<li>
<p>From CLI, navigate to the <a href="https://github.com/microsoft/azure_arc/tree/main/azure_arc_k8s_jumpstart/rancher_k3s/vmware/terraform"><em>azure_arc_k8s_jumpstart/rancher_k3s/vmware/terraform</em></a> directory of the cloned repo.</p>
</li>
<li>
<p>Export the environment variables you edited by running <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/rancher_k3s/vmware/terraform/scripts/vars.sh"><em>scripts/vars.sh</em></a> with the source command as shown below. Terraform requires these to be set for the plan to execute properly. Note that this script will also be automatically executed remotely on the virtual machine as part of the Terraform deployment.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#204a87">source</span> ./scripts/vars.sh
</code></pre></div></li>
<li>
<p>In addition to the <em>TF_VAR</em> environment variables you&rsquo;ve just exported, edit the Terraform variables in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/rancher_k3s/vmware/terraform/terraform.tfvars"><em>terraform.tfvars</em></a> to match your VMware vSphere environment.</p>
<p><img src="./01.png" alt="TF_VAR environment variables"></p>
</li>
<li>
<p>Run the <code>terraform init</code> command which will download the Terraform AzureRM, Local and vSphere providers.</p>
<p><img src="./02.png" alt="terraform init"></p>
</li>
<li>
<p>Run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish.</p>
<p><img src="./03.png" alt="terraform apply"></p>
</li>
<li>
<p>Once the Terraform deployment is completed, a new Ubuntu Server VM will be up &amp; running, installed with a single-master Rancher K3s Kubernetes cluster and will be projected as an Azure Arc Kubernetes cluster in a newly created Azure resource group.</p>
<p><img src="./04.png" alt="VMware vSphere Ubuntu Server VM"></p>
<p><img src="./05.png" alt="Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./06.png" alt="Azure Arc enabled Kubernetes cluster"></p>
</li>
</ul>
<h2 id="delete-the-deployment">Delete the deployment</h2>
<ul>
<li>
<p>The most straightforward way is to delete the cluster is via the Azure Portal, just select cluster and delete it.</p>
<p><img src="./07.png" alt="Delete Azure Arc enabled Kubernetes cluster"></p>
</li>
<li>
<p>If you want to nuke the entire environment, just delete the Azure resource group and the newly generated <em>az_connect_k3s</em> shell script in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/rancher_k3s/vmware/terraform/scripts"><em>scripts</em></a> folder.</p>
<p><img src="./08.png" alt="Delete Azure resource group"></p>
</li>
<li>
<p>Alternatively, you can use the <code>terraform destroy --auto-approve</code> command.</p>
<p><img src="./09.png" alt="terraform destroy"></p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aaac4d3169279a7ae1691c0c9b59ec53">7 - Azure Red Hat OpenShift</h1>
    <div class="lead">The scenario in this section will guide on creating an Azure Red Hat OpenShift (ARO) v4 Kubernetes cluster and onboard it as an Azure Arc enabled Kubernetes cluster in an automated fashion.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b00ec34618f4a7c6c0cefb270ee9bd59">7.1 - ARO Cluster</h1>
    
	<h2 id="deploy-azure-red-hat-openshift-cluster-and-connect-it-to-azure-arc-using-automation">Deploy Azure Red Hat OpenShift Cluster and connect it to Azure Arc using automation</h2>
<p>The following is a guide on how to use the Azure Cloud Shell to deploy an <a href="https://azure.microsoft.com/en-us/services/openshift/">Azure Red Hat OpenShift</a> 4 cluster and have it as a connected Azure Arc Kubernetes resource.</p>
<blockquote>
<p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href="https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/">public preview</a></strong>.</p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Ensure the user logging into Azure portal as admin or co-admin rights to be able to create service principals and/or assign policies to those service principals.</p>
</li>
<li>
<p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li>
</ul>
<h2 id="deployment">Deployment</h2>
<p>There are two sets of resources that will be deployed, first is the Azure Red Hat OpenShift Container cluster. Second is the Azure Arc Kubernetes resource that will connect the <code>aro</code> cluster to Azure Arc.</p>
<p>The deployment of all resources is going to be done via Azure Cloud Shell.</p>
<ul>
<li>
<p>Log into Azure Cloud Shell.</p>
<p><img src="./image1.png" alt="Screenshot showing Azure Cloud Shell"></p>
</li>
<li>
<p>Run the following script:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">wget -O - https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_k8s_jumpstart/aro/run.sh <span style="color:#000;font-weight:bold">|</span> bash
</code></pre></div><p>This script will perform the following tasks:</p>
<ul>
<li>
<p>Deploy the following Resources:</p>
<ul>
<li>Azure Container Instance</li>
<li>Azure VNet</li>
<li>Azure Red Hat  OpenShift (<code>aro</code>) cluster</li>
<li>Azure Arc K8s connected resource</li>
<li>Ensure required providers are registered</li>
</ul>
</li>
</ul>
</li>
<li>
<p>When the script is finished copy the <strong>device login code</strong></p>
<p><img src="./image2.png" alt="Screenshot showing device login code"></p>
</li>
<li>
<p>To start creating resources first log into <a href="https://microsoft.com/devicelogin">Azure device login page</a> and authenticate your credentials and that code copied earlier.</p>
<p><img src="./image3.png" alt="Screenshot showing how to use device code with Azure login"></p>
</li>
<li>
<p>Close the Cloud Shell and navigate to the resource group</p>
<p><img src="./image4.png" alt="Screenshot showing Azure Portal closing Cloud Shell"></p>
<p><img src="./image5.png" alt="Screenshot showing Azure Portal"></p>
</li>
<li>
<p>To track progress navigate to the logs of the container by selecting <strong>Containers</strong> under <strong>Settings</strong> and then selecting <strong>Logs</strong>. This deployment can take up to <em><strong>50 mins</strong></em>.</p>
<p><img src="./image6.png" alt="Screenshot showing Azure Portal container deployment"></p>
</li>
<li>
<p>Upon completion, the following resources will be deployed in the resource group:</p>
<ul>
<li>Azure Arc enabled Kubernetes</li>
<li>OpenShift cluster</li>
<li>Azure VNet</li>
</ul>
<p><img src="./image7.png" alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resources"></p>
</li>
</ul>
<h2 id="delete-the-deployment">Delete the deployment</h2>
<p>The way to delete all the resources deployed is by deleting the resource group. This will delete the managed resource group as well the resources created for the Azure Arc enabled Kubernetes cluster.</p>
<p><img src="./image8.png" alt="Screenshot showing how to delete resource group from Azure Portal"></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-715d96aca7ade3fe976071e1cd0ba8e0">8 - Kind</h1>
    <div class="lead">If you do not have a Kubernetes cluster, the scenario in this section will guide on creating a kind (kubernetes in docker) cluster on your local machine and onboard it as an Azure Arc enabled Kubernetes cluster in an automated fashion.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-26e6fd581cdac268f933c80f67cb66ed">8.1 - Kind cluster</h1>
    
	<h2 id="deploy-a-local-kubernetes-cluster-using-kind-and-connect-it-to-azure-arc">Deploy a local Kubernetes Cluster using kind and connect it to Azure Arc</h2>
<p>The following README will guide you on how to use <a href="https://kind.sigs.k8s.io/">kind</a> to run a Kubernetes cluster locally and connect it as an Azure Arc enabled Kubernetes cluster resource.</p>
<blockquote>
<p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href="https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/">public preview</a></strong>.</p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">Install and Set Up kubectl</a></p>
</li>
<li>
<p><a href="https://helm.sh/docs/intro/install/">Install Helm 3</a></p>
</li>
<li>
<p>Kind leverages Docker to run the Kubernetes nodes. You will need to install Docker locally:</p>
<ul>
<li>If you are a Windows user, install <a href="https://www.docker.com/products/docker-desktop">Docker Desktop</a>. You can also use the <a href="https://chocolatey.org/packages/docker-desktop">Chocolatey package</a> to automate the installation.</li>
<li>If you are a MacOS User, install <a href="https://docs.docker.com/docker-for-mac/">Docker Desktop for Mac</a>.</li>
<li>If you are a Linux user, use your package manager to install the <a href="https://docs.docker.com/engine/install/">Docker engine</a>.</li>
</ul>
</li>
<li>
<p>Install the <a href="https://golang.org/dl/">Go programming language</a>.</p>
</li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
<li>
<p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li>
<li>
<p>Install the Azure Arc for Kubernetes CLI extensions <em><strong>connectedk8s</strong></em> and <em><strong>k8sconfiguration</strong></em>:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az extension add --name connectedk8s
az extension add --name k8sconfiguration
</code></pre></div><blockquote>
<p><strong>Note: If you already used this guide before and/or have the extensions installed, use the bellow commands:</strong></p>
</blockquote>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az extension update --name connectedk8s
az extension update --name k8sconfiguration
</code></pre></div></li>
</ul>
<h2 id="deployment">Deployment</h2>
<ul>
<li>
<p>Install kind</p>
<p>On Linux:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.9.0/kind-linux-amd64
chmod +x ./kind
sudo mv ./kind /usr/local/bin/kind
</code></pre></div><p>On MacOS:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">brew install kind
</code></pre></div><p>On Windows:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#000">choco</span> <span style="color:#000">install</span> <span style="color:#000">kind</span>
</code></pre></div><ul>
<li>Navigate to the folder that has the kind cluster definition.</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#204a87">cd</span> azure_arc/azure_arc_k8s_jumpstart/kind
</code></pre></div><ul>
<li>Create the kind cluster. We are using a configuration file called <code>kind_cluster.yaml</code> to specify our cluster configuration. This will create a 3 node cluster, with 1 master node and 2 worker nodes.</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kind create cluster --config kind_cluster.yaml --name arc-cluster
</code></pre></div><p><img src="./01.png" alt="kind create cluster"></p>
<blockquote>
<p><strong>Note: By default, kind will store the kubeconfig file used to connect to your cluster in the ~/.kube directory. If you want to use a custom directory to store the kubeconfig file, use the <code>--kube-config</code> flag.</strong></p>
</blockquote>
<p>If you did chose a specific location for the cluster&rsquo;s <em>kubeconfig</em> file make sure you are exporting its location as an environment variable using the <code>export KUBECONFIG=kubeconfig location</code> or in Windows, add this location to your PATH.</p>
</li>
<li>
<p>Verify your cluster was created successfully and you can access the cluster using <code>kubectl</code>.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get nodes
</code></pre></div><p><img src="./02.png" alt="kubectl get nodes"></p>
</li>
</ul>
<h2 id="connecting-to-azure-arc">Connecting to Azure Arc</h2>
<ul>
<li>
<p>Now that you have a running kind cluster, lets connect the kind cluster to Azure Arc.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login --service-principal -u mySpnClientId -p mySpnClientSecret --tenant myTenantID
</code></pre></div></li>
<li>
<p>Create a resource group</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az group create --name Arc-kind-Demo -l EastUS -o table
</code></pre></div><blockquote>
<p><strong>Note: Azure Arc enabled Kubernetes is currently supported in <em>East US</em> and <em>West Europe</em></strong></p>
</blockquote>
<p><img src="./03.png" alt="Create Azure resource group"></p>
</li>
<li>
<p>Deploy the Arc binaries using Azure CLI:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az connectedk8s connect -n Arc-kind-Demo -g Arc-kind-Demo --tags <span style="color:#4e9a06">&#39;Project=jumpstart_azure_arc_k8s&#39;</span>
</code></pre></div></li>
<li>
<p>Upon completion, you will have your kind cluster connected as a new Azure Arc Kubernetes cluster resource in a new resource group.</p>
<p><img src="./04.png" alt="New Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./05.png" alt="New Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./06.png" alt="New Azure Arc enabled Kubernetes cluster"></p>
</li>
</ul>
<h2 id="delete-the-deployment">Delete the deployment</h2>
<ul>
<li>
<p>In Azure, the most straightforward way is to delete the cluster or the resource group via the Azure Portal or through the CLI.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az group delete --name Arc-kind-Demo
</code></pre></div><p><img src="./07.png" alt="Delete the Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./08.png" alt="Delete Azure resource group"></p>
</li>
<li>
<p>To delete the kind cluster locally, use the following command:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kind delete cluster --name arc-cluster
</code></pre></div><p><img src="./09.png" alt="kind delete cluster"></p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d7bef51078e0d72deaa1a59c8907857a">9 - MicroK8s</h1>
    <div class="lead">If you do not have a Kubernetes cluster, the scenario in this section will guide on creating a MicroK8s Kubernetes cluster on your local machine and onboard it as an Azure Arc enabled Kubernetes cluster in an automated fashion.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-4e867e92b2a5802eefb8ffa06426f985">9.1 - MicroK8s cluster</h1>
    
	<h2 id="deploy-a-local-kubernetes-cluster-using-microk8s-and-connect-it-to-azure-arc">Deploy a local Kubernetes Cluster using MicroK8s and connect it to Azure Arc</h2>
<p>The following README will guide you on how to use <a href="https://microk8s.io/">MicroK8s</a> to run a Kubernetes cluster locally and connect it as an Azure Arc enabled Kubernetes cluster resource.</p>
<blockquote>
<p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href="https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/">public preview</a></strong>.</p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">Install and Set Up kubectl</a></p>
</li>
<li>
<p><a href="https://helm.sh/docs/intro/install/">Install Helm 3</a></p>
</li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
<li>
<p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li>
<li>
<p>Install the Azure Arc for Kubernetes CLI extensions <em><strong>connectedk8s</strong></em> and <em><strong>k8sconfiguration</strong></em>:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az extension add --name connectedk8s
az extension add --name k8sconfiguration
</code></pre></div><blockquote>
<p><strong>Note: If you already used this guide before and/or have the extensions installed, use the bellow commands:</strong></p>
</blockquote>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az extension update --name connectedk8s
az extension update --name k8sconfiguration
</code></pre></div></li>
</ul>
<h2 id="deployment">Deployment</h2>
<ul>
<li>
<p>Install MicroK8s following the <a href="https://microk8s.io/">specific install guide</a> for your operating system. For convenience, we&rsquo;ve added some commands below:</p>
<p>Windows:</p>
<p>Download the <a href="https://microk8s.io/docs/install-alternatives#heading--windows">MicroK8s installer for Windows</a> and follow the instructions.</p>
<p><img src="https://aws1.discourse-cdn.com/business6/uploads/kubernetes/original/2X/c/cc39a370d6a9f62bbcfa0b84ba8356da84a4c8c1.png" alt=" MicroK8s installer for Windows"></p>
<p>Once installed, enable MicroK8s with:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">microk8s status --wait-ready
microk8s <span style="color:#204a87">enable</span> dns
</code></pre></div><p>Linux:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo snap install microk8s --classic
microk8s status --wait-ready
microk8s <span style="color:#204a87">enable</span> dns
</code></pre></div><p>MacOS:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">brew install ubuntu/microk8s/microk8s
microk8s install
microk8s status --wait-ready
microk8s <span style="color:#204a87">enable</span> dns
</code></pre></div><p><img src="https://assets.ubuntu.com/v1/670398bd-mac1.png" alt="brew install microk8s"></p>
<p>WSL2:</p>
<p><a href="https://ubuntu.com/blog/kubernetes-on-windows-with-microk8s-and-wsl-2">This blog post</a> walks through an installation of MicroK8s in WSL 2.</p>
</li>
<li>
<p>Export MicroK8s cluster kubeconfig file path</p>
<p>MicroK8s will not update your .kube/config file, and accessing the cluster is done using the microk8s cli, eg: <code>microk8s kubectl get nodes</code>. To be able to use this config with the Azure Arc CLI, we need to export it into a file.</p>
<p>Windows:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">microk8s config view &gt; %HOMEPATH%<span style="color:#4e9a06">\.</span>kube<span style="color:#4e9a06">\m</span>icrok8s
</code></pre></div><p>Linux and MacOS:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">microk8s config view &gt; ~/.kube/microk8s
</code></pre></div></li>
</ul>
<h2 id="connect-the-cluster-to-azure-arc">Connect the cluster to Azure Arc</h2>
<ul>
<li>
<p>Authenticate Azure CLI</p>
<p>We&rsquo;ll start by authenticating our CLI with Azure, <strong>replacing the values below</strong> with the output from the command we issued to create service principal earlier (<code>az ad sp create-for-rbac</code>) in the prerequisite section of this guide.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login --service-principal -u appId -p password --tenant tenant
</code></pre></div><p><img src="./01.png" alt="Authenticate Azure CLI"></p>
</li>
<li>
<p>Create a resource group</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az group create -n Arc-MicroK8s-Demo -l EastUS
</code></pre></div><p><img src="./02.png" alt="Create new Azure resource group"></p>
<p><img src="./03.png" alt="Create new Azure resource group"></p>
</li>
<li>
<p>Connect the cluster to Azure Arc</p>
<p>Windows:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az connectedk8s connect --name Arc-MicroK8s-Demo --resource-group Arc-MicroK8s-Demo --kube-config %HOMEPATH%<span style="color:#4e9a06">\.</span>kube<span style="color:#4e9a06">\m</span>icrok8s --kube-context microk8s --tags <span style="color:#4e9a06">&#39;Project=jumpstart_azure_arc_k8s&#39;</span>
</code></pre></div><p>Linux and MacOS:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az connectedk8s connect --name Arc-MicroK8s-Demo --resource-group Arc-MicroK8s-Demo  --kube-config ~/.kube/microk8s --kube-context microk8s --tags <span style="color:#4e9a06">&#39;Project=jumpstart_azure_arc_k8s&#39;</span>
</code></pre></div><p><img src="./04.png" alt="New Azure Arc enabled Kubernetes cluster"></p>
</li>
<li>
<p>Upon completion, you will have your MicroK8s cluster connected as a new Azure Arc Kubernetes cluster resource in a new resource group.</p>
<p><img src="./05.png" alt="New Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./06.png" alt="New Azure Arc enabled Kubernetes cluster"></p>
</li>
</ul>
<h2 id="optional---day-2-operations">Optional - Day 2 Operations</h2>
<p>Now that your Kubernetes cluster is connected to Azure Arc, you might want to explore the following Day 2 scenarios:</p>
<ul>
<li><a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/day2/microk8s/local_microk8s_gitops_helm/">Deploy GitOps configurations and perform Helm-based GitOps flow on MicroK8s as an Azure Arc Connected Cluster</a></li>
</ul>
<h2 id="delete-the-deployment">Delete the deployment</h2>
<ul>
<li>
<p>In Azure, the most straightforward way is to delete the cluster or the resource group via the Azure Portal or through the CLI.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az group delete --name Arc-MicroK8s-Demo
</code></pre></div><p><img src="./07.png" alt="Delete Azure resource group"></p>
</li>
<li>
<p>To stop the MicroK8s cluster locally, use the following command:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">microk8s stop
</code></pre></div></li>
<li>
<p>The uninstall process of MicroK8s depends on your operating system.</p>
<p>Windows</p>
<p>Stop the MicroK8s VM in Multipass:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">multipass stop microk8s-vm
</code></pre></div><p>Launch <code>Add or Remove Programs</code> and uninstall MicroK8s.</p>
<p><img src="./08.png" alt="Uninstall MicroK8s from Windows"></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">multipass delete microk8s-vm
multipass purge
</code></pre></div><p>If you want to completely uninstall Multipass, launch <code>Add or Remove Programs</code> and uninstall Multipass.</p>
<p><img src="./09.png" alt="Uninstall Multipass from Windows"></p>
<p>Linux:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo snap remove microk8s
</code></pre></div><p>MacOS:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">brew uninstall ubuntu/microk8s/microk8s
</code></pre></div></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1d0f8542d6157eb9642fa1e8bba23a9d">10 - Unified Operations Use Cases</h1>
    <div class="lead">Once you have Kubernetes clusters projected into Azure with Azure Arc, you can start to use native Azure tooling to manage the clusters as native Azure resources. The following scenarios show examples of using Azure management tools such as Azure Monitor, GitOps configurations, and Azure Policy.</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-4d3df2981d26d03a22ca357944650885">10.1 - AKS</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-44610c6b5316b3f8cd2b84332697b1c4">10.1.1 - Deploy GitOps configurations and perform basic GitOps flow on AKS as an Azure Arc Connected Cluster</h1>
    
	<h2 id="deploy-gitops-configurations-and-perform-basic-gitops-flow-on-aks-as-an-azure-arc-connected-cluster">Deploy GitOps configurations and perform basic GitOps flow on AKS as an Azure Arc Connected Cluster</h2>
<p>The following README will guide you on how to create GitOps configuration on an Azure Kubernetes Service (AKS) cluster which is projected as an Azure Arc connected cluster resource.</p>
<p>In this guide, you will deploy &amp; attach GitOps configuration to your cluster which will also include deploying an &ldquo;Hello World&rdquo; Azure Arc web application on your Kubernetes cluster. By doing so, you will be able to make real-time changes to the application and show how the GitOps flow takes effect.</p>
<blockquote>
<p><strong>Note: This guide assumes you already deployed an AKS cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using either <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_arm_template/">ARM Template</a> or <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_terraform/">Terraform</a>.</strong></p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p>Fork the <a href="https://github.com/likamrat/hello_arc">&ldquo;Hello Arc&rdquo;</a> demo application repository.</p>
</li>
<li>
<p>(Optional) Install the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. This will help you to show the real-time changes on the application in an automated way.</p>
<ul>
<li>
<p><a href="https://microsoftedge.microsoft.com/addons/detail/odiofbnciojkpogljollobmhplkhmofe">Microsoft Edge</a></p>
</li>
<li>
<p><a href="https://chrome.google.com/webstore/detail/tab-auto-refresh/jaioibhbkffompljnnipmpkeafhpicpd?hl=en">Google Chrome</a></p>
</li>
<li>
<p><a href="https://addons.mozilla.org/en-US/firefox/addon/tab-auto-refresh/">Mozilla Firefox</a></p>
</li>
</ul>
</li>
<li>
<p>As mentioned, this guide starts at the point where you already have a connected AKS cluster to Azure Arc.</p>
<p><img src="./01.png" alt="Existing Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./02.png" alt="Existing Azure Arc enabled Kubernetes cluster"></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
</ul>
<h2 id="azure-arc-kubernetes-gitops-configuration">Azure Arc Kubernetes GitOps Configuration</h2>
<ul>
<li>
<p>In order to keep your local environment clean and untouched, we will use <a href="https://docs.microsoft.com/en-us/azure/cloud-shell/overview">Azure Cloud Shell</a> (located in the top-right corner in the Azure portal) to run the <em>az_k8sconfig_aks</em> shell script against the AKS connected cluster. <strong>Make sure Cloud Shell is configured to use Bash.</strong></p>
</li>
<li>
<p>Edit the environment variables in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/gitops/basic/az_k8sconfig_aks.sh"><em>az_k8sconfig_aks</em></a> shell script to match your parameters, upload it to the Cloud Shell environment and run it using the <code>. ./az_k8sconfig_aks.sh</code> command.</p>
<blockquote>
<p><strong>Note: The extra dot is due to the script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p>
</blockquote>
<p><img src="./03.png" alt="Open Azure Cloud Shell"></p>
<p><img src="./04.png" alt="Upload a file to Azure Cloud Shell"></p>
<p><img src="./05.png" alt="Upload a file to Azure Cloud Shell"></p>
<p><img src="./06.png" alt="Upload a file to Azure Cloud Shell"></p>
<p>The script will:</p>
<ul>
<li>
<p>Login to your Azure subscription using the SPN credentials</p>
</li>
<li>
<p>Retrieve the cluster credentials (KUBECONFIG)</p>
</li>
<li>
<p>Will use Helm to deploy NGINX ingress controller</p>
</li>
<li>
<p>Create the GitOps configurations and deploy the Flux operator and Memcached on the Azure Arc connected cluster</p>
</li>
<li>
<p>Deploy the <a href="https://github.com/likamrat/hello_arc">&ldquo;Hello Arc&rdquo;</a> application along side an Ingress rule to make it available from outside the cluster</p>
<blockquote>
<p><strong>Disclaimer: For the purpose of this guide, notice how the &ldquo;<em>git-poll-interval 3s</em>&rdquo; is set. The 3 seconds interval is useful for demo purposes since it will make the git-poll interval to rapidly track changes on the repository but it is recommended to have longer interval in your production environment (default value is 5min)</strong></p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>Once the script will complete it&rsquo;s run, you will have the GitOps configuration created and all the resources deployed in your Kubernetes cluster.</p>
<blockquote>
<p><strong>Note: that it takes few min for the configuration change it&rsquo;s Operator state status from &ldquo;Pending&rdquo; to Install.</strong></p>
</blockquote>
<p><img src="./07.png" alt="New GitOps configurations"></p>
<p><img src="./08.png" alt="New GitOps configurations"></p>
<p><img src="./09.png" alt="New GitOps configurations"></p>
</li>
</ul>
<h2 id="the-hello-arc-application--components">The &ldquo;Hello Arc&rdquo; Application &amp; Components</h2>
<ul>
<li>
<p>Before kicking the GitOps flow, let&rsquo;s verify and zoom-in to the Kubernetes resources deployed by running few <em>kubectl</em> commands.</p>
<ul>
<li>
<p><code>kubectl get pods -n cluster-config</code> - Will show the Flux operator and the Memcached pods.</p>
<ul>
<li><code>kubectl get pods -n hello-arc</code> - Will show 3 replicas of the &ldquo;Hello Arc&rdquo; application and the NGINX controller.</li>
<li><code>kubectl get svc -n hello-arc</code> - Will show NGINX controller Kubernetes Service (Type LoadBalancer).</li>
<li><code>kubectl get ing -n hello-arc</code> - Will show NGINX rule which will route the traffic to the &ldquo;Hello Arc&rdquo; application from outside the cluster.</li>
</ul>
<p><img src="./10.png" alt="kubectl get pods -n cluster-config"></p>
<p><img src="./11.png" alt="kubectl get pods -n hello-arc"></p>
<p><img src="./12.png" alt="kubectl get svc -n hello-arc"></p>
<p><img src="./13.png" alt="kubectl get ing -n hello-arc"></p>
</li>
</ul>
</li>
<li>
<p>The GitOps flow works as follow:</p>
<ol>
<li>
<p>The Flux operator holds the &ldquo;desired state&rdquo; of the &ldquo;Hello Arc&rdquo; application, this are the configuration we deployed against the Azure Arc connected cluster. The operator &ldquo;polls&rdquo; the state of the of the <a href="https://github.com/likamrat/hello_arc">&ldquo;Hello Arc&rdquo;</a> application repository.</p>
</li>
<li>
<p>Changing the application which is consider to be a new version of it, will trigger the Flux operator to kick-in the GitOps flow.</p>
</li>
<li>
<p>A new Kubernetes pod with the new version of the application will be deployed on the cluster. Once the new pods is successfully deployed, the old one will be terminated (rolling upgrade).</p>
</li>
</ol>
</li>
<li>
<p>To show the above flow, open 2 (ideally 3) side-by-side browser windows:</p>
<ul>
<li>
<p>Azure Cloud Shell open running the <code>kubectl get pods -n hello-arc -w</code> command</p>
<p><img src="./14.png" alt="kubectl get pods -n hello-arc -w"></p>
</li>
<li>
<p>Your fork of the &ldquo;Hello Arc&rdquo; application repository. Open the <a href="https://github.com/likamrat/hello_arc/blob/master/yaml/hello_arc.yaml"><em>hello_arc.yaml</em></a> file.</p>
</li>
<li>
<p>The external IP address of the Kubernetes Service seen using the <code>kubectl get svc -n hello-arc</code> command.</p>
<p><img src="./15.png" alt="kubectl get svc -n hello-arc"></p>
</li>
<li>
<p>End result should look like that:</p>
<p><img src="./16.png" alt="Side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p>
</li>
</ul>
</li>
<li>
<p>As mentioned in the prerequisites section, it is optional but very recommended to configure the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. If you did, in the &ldquo;Hello Arc&rdquo; application window, configure it to refresh every 2 seconds.</p>
<p><img src="./17.png" alt="Tab Auto Refresh"></p>
</li>
<li>
<p>In the repository window showing the <em>hello_arc.yaml</em> file, change the text under &ldquo;MESSAGE&rdquo; section commit the change. Alternatively, you can open the fork repository in your IDE, make the change, commit and push it.</p>
<p><img src="./18.png" alt="Making a change to the &ldquo;MESSAGE&rdquo; section"></p>
<p><img src="./19.png" alt="Making a change to the &ldquo;MESSAGE&rdquo; section and committing"></p>
</li>
<li>
<p>Upon committing the changes, notice how the Kubernetes Pod rolling upgrade starts. Once the Pod is up &amp; running, the new &ldquo;Hello Arc&rdquo; application version window will show the new message, showing the rolling upgrade is completed and the GitOps flow is successful.</p>
<p><img src="./20.png" alt="New Side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c88c142dc87e09357d590b49fc212f80">10.1.2 - Deploy GitOps configurations and perform Helm-based GitOps flow on AKS as an Azure Arc Connected Cluster</h1>
    
	<h2 id="deploy-gitops-configurations-and-perform-helm-based-gitops-flow-on-aks-as-an-azure-arc-connected-cluster">Deploy GitOps configurations and perform Helm-based GitOps flow on AKS as an Azure Arc Connected Cluster</h2>
<p>The following README will guide you on how to create <a href="https://helm.sh/">Helm</a>-based GitOps configuration on an Azure Kubernetes Service (AKS) cluster which is projected as an Azure Arc connected cluster resource.</p>
<p>In this guide, you will deploy &amp; attach 2 GitOps configuration to your cluster, a cluster-level config to deploy nginx-ingress controller and a namespace-level config to deploy the &ldquo;Hello Arc&rdquo; web application on your Kubernetes cluster.</p>
<p>By doing so, you will be able to make real-time changes to the application and show how the GitOps flow takes effect.</p>
<blockquote>
<p><strong>Note: This guide assumes you already deployed an AKS cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using either <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_arm_template/">ARM Template</a> or <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_terraform/">Terraform</a>.</strong></p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p>Fork/Clone the <a href="https://github.com/likamrat/hello_arc">&ldquo;Hello Arc&rdquo;</a> demo application repository.</p>
</li>
<li>
<p>(Optional) Install the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. This will help you to show the real-time changes on the application in an automated way.</p>
<ul>
<li>
<p><a href="https://microsoftedge.microsoft.com/addons/detail/odiofbnciojkpogljollobmhplkhmofe">Microsoft Edge</a></p>
</li>
<li>
<p><a href="https://chrome.google.com/webstore/detail/tab-auto-refresh/jaioibhbkffompljnnipmpkeafhpicpd?hl=en">Google Chrome</a></p>
</li>
<li>
<p><a href="https://addons.mozilla.org/en-US/firefox/addon/tab-auto-refresh/">Mozilla Firefox</a></p>
</li>
</ul>
</li>
<li>
<p>As mentioned, this guide starts at the point where you already have a connected AKS cluster to Azure Arc.</p>
<p><img src="./01.png" alt="Existing Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./02.png" alt="Existing Azure Arc enabled Kubernetes cluster"></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
</ul>
<h2 id="cluster-level-config-vs-namespace-level-config">Cluster-level Config vs. Namespace-level Config</h2>
<h3 id="cluster-level-config">Cluster-level Config</h3>
<p>With Cluster-level GitOps config, the goal is to have an &ldquo;horizontal components&rdquo; or &ldquo;management components&rdquo; deployed on your Kubernetes cluster which will then be used by your applications. Good examples are Service Meshes, Security products, Monitoring solutions, etc. A very popular example will also be Ingress Controller which is exactly the nginx-ingress controller we will deploy in the next section.</p>
<h3 id="namespace-level-config">Namespace-level Config</h3>
<p>With Namespace-level GitOps config, the goal is to have Kubernetes resources deployed only in the namespace selected. The most obvious use-case here is simply your application and it&rsquo;s respective pods, services, ingress routes, etc. In the next section will have the &ldquo;Hello Arc&rdquo; application deployed on a dedicated namespace.</p>
<h2 id="azure-arc-kubernetes-gitops-configuration-with-helm">Azure Arc Kubernetes GitOps Configuration with Helm</h2>
<h3 id="the-mechanism-in-a-nutshell">The Mechanism (In a nutshell)</h3>
<p>In the process of creating Azure Arc GitOps configuration, <a href="https://github.com/fluxcd/flux">Weaveworks Flux Kubernetes Operator</a> is deployed on the cluster.</p>
<p>The Operator is aware of the &ldquo;HelmRelease&rdquo; Custom Resource Definition (CRD). This HelmRelease points to a helm chart in a git repo and can optionally contain specific values to input into the helm chart. Due to this configuration, a user can choose to leave the chart values intact or to have different values for different releases.</p>
<p>For example, an application (captured in an Helm chart) dev release can have no pod replication (single pod) while a production release, using the same chart can have 3 pod replicas.</p>
<p>In the next section will use the &ldquo;Hello Arc&rdquo; Helm chart to deploy a production release which we will then change and see the results in real-time.</p>
<h3 id="deployment-flow">Deployment Flow</h3>
<p>For our scenario, notice we have in two Helm charts in the &ldquo;Hello Arc&rdquo; repository; one for nginx and one for the actual application as well as an Helm Release for each.</p>
<p><img src="./03.png" alt="&ldquo;Hello Arc&rdquo; GitHub repository"></p>
<p><img src="./04.png" alt="&ldquo;Hello Arc&rdquo; GitHub repository"></p>
<ul>
<li>
<p>The nginx-ingress controller (a Cluster-level component) will be deployed with 3 replicas to the <em>cluster-mgmt</em> namespace.</p>
</li>
<li>
<p>The &ldquo;Hello Arc&rdquo; application (a Namespace-level component) will be deployed with 1 replica to the <em>prod</em> namespace.</p>
</li>
</ul>
<h2 id="deployment">Deployment</h2>
<ul>
<li>
<p>In order to keep your local environment clean and untouched, we will use <a href="https://docs.microsoft.com/en-us/azure/cloud-shell/overview">Azure Cloud Shell</a> (located in the top-right corner in the Azure portal) to run the <em>az_k8sconfig_helm_aks</em> shell script against the AKS connected cluster. <strong>Make sure Cloud Shell is configured to use Bash.</strong></p>
</li>
<li>
<p>Edit the environment variables in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/gitops/helm/az_k8sconfig_helm_aks.sh"><em>az_k8sconfig_helm_aks</em></a> shell script to match your parameters, upload it to the Cloud Shell environment and run it using the <code>. ./az_k8sconfig_helm_aks</code> command.</p>
<blockquote>
<p><strong>Note: The extra dot is due to the script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p>
</blockquote>
<p><img src="./03.png" alt="Open Azure Cloud Shell"></p>
<p><img src="./04.png" alt="Upload a file to Azure Cloud Shell"></p>
<p><img src="./05.png" alt="Upload a file to Azure Cloud Shell"></p>
<p><img src="./06.png" alt="Upload a file to Azure Cloud Shell"></p>
<p>The script will:</p>
<ul>
<li>
<p>Login to your Azure subscription using the SPN credentials</p>
</li>
<li>
<p>Retrieve the cluster credentials (KUBECONFIG)</p>
</li>
<li>
<p>Create two GitOps configurations for the Azure Arc Connected Cluster. Both configurations will be using the Helm charts located in the &ldquo;Hello Arc&rdquo; repository.</p>
</li>
<li>
<p>Cluster-level config to deploy nginx-ingress controller Helm chart</p>
</li>
<li>
<p>Namespace-level config to deploy the &ldquo;Hello Arc&rdquo; application Helm chart</p>
<blockquote>
<p><strong>Disclaimer: For the purpose of this guide, notice how the &ldquo;<em>git-poll-interval 3s</em>&rdquo; is set. The 3 seconds interval is useful for demo purposes since it will make the git-poll interval to rapidly track changes on the repository but it is recommended to have longer interval in your production environment (default value is 5min)</strong></p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>Once the script will complete it&rsquo;s run, you will have 2 GitOps configuration created and all the resources deployed in your Kubernetes cluster. <strong>Note:</strong> that it takes few min for the configuration change it&rsquo;s Operator state status from &ldquo;Pending&rdquo; to Install.</p>
<p><img src="./09.png" alt="New GitOps configurations"></p>
<p><img src="./10.png" alt="New GitOps configurations"></p>
<p><img src="./11.png" alt="New GitOps configurations"></p>
<p><img src="./12.png" alt="New GitOps configurations"></p>
</li>
<li>
<p>The Cluster-level config initiated the nginx-ingress Pods and Service resource deployment (along with the Flux operator and Memcached). To see it&rsquo;s resource, use the below <em>kubectl</em> commands.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -n cluster-mgmt
kubectl get svc -n cluster-mgmt
</code></pre></div><p><img src="./13.png" alt="nginx-ingress Pods and Service resource"></p>
</li>
<li>
<p>The Namespace-level config initiated the &ldquo;Hello Arc&rdquo; Pod (1 replica), Service and Ingress Route resource deployment.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -n prod
kubectl get svc -n prod
kubectl get ing -n prod
</code></pre></div><p><img src="./14.png" alt="Hello Arc" Pod, Service and Ingress Route resource"></p>
</li>
</ul>
<h2 id="initiating-hello-arc-application-gitops">Initiating &ldquo;Hello Arc&rdquo; Application GitOps</h2>
<ul>
<li>
<p>The GitOps flow works as follow:</p>
<ol>
<li>
<p>The Flux operator holds the &ldquo;desired state&rdquo; for both the nginx-ingress and the &ldquo;Hello Arc&rdquo; Helm releases, this are the configuration we deployed against the Azure Arc connected cluster. The operator will pull every 3 seconds the state of the releases in the repository.</p>
</li>
<li>
<p>Changing the application release will trigger the Flux operator to kick-in the GitOps flow.</p>
</li>
<li>
<p>A new version of the application will be deployed on the cluster with more replicas as configured. Once the new pods is successfully deployed, the old ones will be terminated (rolling upgrade).</p>
</li>
</ol>
</li>
<li>
<p>To show the above flow, open 2 (ideally 3) side-by-side browser windows:</p>
<ul>
<li>
<p>Azure Cloud Shell open running the <code>kubectl get pods -n prod -w</code></p>
<p><img src="./15.png" alt="kubectl get pods -n prod -w"></p>
</li>
<li>
<p>In your own repository fork, open the &ldquo;Hello Arc&rdquo; <a href="https://github.com/likamrat/hello_arc/blob/master/releases/prod/hello-arc.yaml"><em>hello-arc.yaml</em></a> Helm release file.</p>
</li>
<li>
<p>The external IP address of the Kubernetes Service seen using the <code>kubectl get svc -n hello-arc</code> command.</p>
<p><img src="./16.png" alt="kubectl get svc -n hello-arc"></p>
</li>
<li>
<p>End result should look like that:</p>
<p><img src="./17.png" alt="Side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p>
</li>
</ul>
</li>
<li>
<p>As mentioned in the prerequisites section, it is optional but very recommended to configure the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. If you did, in the &ldquo;Hello Arc&rdquo; application window, configure it to refresh every 2 seconds.</p>
<p><img src="./18.png" alt="Tab Auto Refresh"></p>
</li>
<li>
<p>In the repository window showing the <em>hello-arc.yaml</em> file, change the number of <em>replicaCount</em> to 3 as well as the the message text and commit your changes. Alternatively, you can open the forked repository in your IDE, make the change, commit and push it.</p>
<p><img src="./19.png" alt="Making a change to the replica count and the &ldquo;MESSAGE&rdquo; section"></p>
</li>
<li>
<p>Upon committing the changes, notice how the rolling upgrade starts. Once the Pods are up &amp; running, the new &ldquo;Hello Arc&rdquo; application version window will show the new messages as well as the additional pods replicas, showing the rolling upgrade is completed and the GitOps flow is successful.</p>
<p><img src="./20.png" alt="&ldquo;Hello Arc&rdquo; rolling upgrade"></p>
<p><img src="./21.png" alt="&ldquo;Hello Arc&rdquo; rolling upgrade"></p>
<p><img src="./22.png" alt="New side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p>
</li>
</ul>
<h2 id="cleanup">Cleanup</h2>
<p>To delete the GitOps configuration and it&rsquo;s respective Kubernetes resources, edit the environment variables to match the Azure Arc Kubernetes cluster and Resources in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/gitops/helm/az_k8sconfig_helm_cleanup.sh">az_k8sconfig_helm_cleanup</a> script, upload it to Cloud Shell and run it using the <code>. ./az_k8sconfig_helm_cleanup.sh</code> command.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cdb23c16630e70509b44b66208dbc024">10.1.3 - Integrate Azure Monitor for Containers with AKS as an Azure Arc Connected Cluster</h1>
    
	<h2 id="integrate-azure-monitor-for-containers-with-aks-as-an-azure-arc-connected-cluster">Integrate Azure Monitor for Containers with AKS as an Azure Arc Connected Cluster</h2>
<p>The following README will guide you on how to onboard an Azure Kubernetes Service (AKS) cluster which is projected an Azure Arc connected cluster resource on to <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/insights/container-insights-overview">Azure Monitor for Containers</a>.</p>
<p>In this guide, you will hook the AKS cluster to Azure Monitor by deploying the <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/platform/log-analytics-agent">OMS agent</a> on your Kubernetes cluster to start collecting telemetry.</p>
<blockquote>
<p><strong>Note: This guide assumes you already deployed an AKS cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using either <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_arm_template/">ARM Template</a> or <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_terraform/">Terraform</a>.</strong></p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
</ul>
<h2 id="azure-monitor-for-containers-integration">Azure Monitor for Containers Integration</h2>
<ul>
<li>
<p>In order to keep your local environment clean and untouched, we will use <a href="https://docs.microsoft.com/en-us/azure/cloud-shell/overview">Azure Cloud Shell</a> (located in the top-right corner in the Azure portal) to run the <em>aks_monitor_onboarding</em> script against the AKS connected cluster. For your convenient, both shell and PowerShell scripts are <a href="https://github.com/microsoft/azure_arc/tree/main/azure_arc_k8s_jumpstart/aks/azure_monitor">provided</a>.</p>
</li>
<li>
<p>Before integrating the cluster with Azure Monitor for Containers, click on the &ldquo;Insights (preview)&rdquo; blade for the connected Arc cluster to show how the cluster is not currently being monitored.</p>
<p><img src="./01.png" alt="An existing Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./02.png" alt="An existing Azure Arc enabled Kubernetes cluster with no Azure Monitor integration"></p>
</li>
<li>
<p>Edit the environment variables in either of the scripts to match your environment parameters, upload it to the Cloud Shell environment and run it using the <code>. ./aks_monitor_onboarding.sh</code> (Bash) or <code>./aks_monitor_onboarding.ps1</code> (PowerShell) command.</p>
<blockquote>
<p><strong>Note: The extra dot is due to the shell script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p>
</blockquote>
<p><img src="./03.png" alt="Open Azure Cloud Shell"></p>
<p><img src="./04.png" alt="Upload a file to Azure Cloud Shell"></p>
<p><img src="./05.png" alt="Upload a file to Azure Cloud Shell"></p>
<p><img src="./06.png" alt="Upload a file to Azure Cloud Shell"></p>
<p><img src="./07.png" alt="Upload a file to Azure Cloud Shell"></p>
<p>The script will:</p>
<ul>
<li>Login to your Azure subscription using the SPN credentials</li>
<li>Download the OMS script</li>
<li>Retrieve the Azure Arc Connected Cluster Azure Resource ID as well as the cluster credentials (KUBECONFIG)</li>
<li>Execute the script which will create Azure Log Analytics workspace, deploy the OMS agent on the Kubernetes cluster and tag the cluster</li>
<li>Delete the downloaded script</li>
</ul>
</li>
<li>
<p>Once the script will complete it&rsquo;s run, you will have an Azure Arc connected cluster integrated with Azure Monitor for Containers. At the end of it&rsquo;s run, the script generates URL for you to click on. This URL will open a new browser tab leading to the Azure Monitor for Containers Insights page.</p>
<blockquote>
<p><strong>Note: As the OMS start collecting telemetry from the cluster nodes and pods, it will take 5-10min for data to start show up in the Azure Portal.</strong></p>
</blockquote>
<p><img src="./08.png" alt="Installing the OMS agent on the cluster"></p>
<p><img src="./09.png" alt="Installing the OMS agent on the cluster"></p>
</li>
<li>
<p>Click the &ldquo;Connected Clusters&rdquo; tab and see the Azure Arc connected cluster was added. Now that your cluster is being monitored, navigate trough the different tabs and sections and watch the monitoring telemetry for the cluster nodes and pods.</p>
<p><img src="./10.png" alt="Agent install on the cluster"></p>
<p><img src="./11.png" alt="New Azure Monitor telemetry"></p>
<p><img src="./12.png" alt="New Azure Monitor telemetry"></p>
<p><img src="./13.png" alt="New Azure Monitor telemetry"></p>
<p><img src="./14.png" alt="New Azure Monitor telemetry"></p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0ab2c80854e6dbba2714dfe7f5623dd0">10.1.4 - Apply GitOps configurations on AKS as an Azure Arc Connected Cluster using Azure Policy for Kubernetes</h1>
    
	<h2 id="apply-gitops-configurations-on-aks-as-an-azure-arc-connected-cluster-using-azure-policy-for-kubernetes">Apply GitOps configurations on AKS as an Azure Arc Connected Cluster using Azure Policy for Kubernetes</h2>
<p>The following README will guide you on how to enable <a href="https://docs.microsoft.com/en-us/azure/governance/policy/concepts/policy-for-kubernetes#:~:text=Azure%20Policy%20extends%20Gatekeeper%20v3,Kubernetes%20clusters%20from%20one%20place.">Azure Policy for Kubernetes</a> on an Azure Kubernetes Service (AKS) cluster that is projected as an Azure Arc connected cluster as well as how to create GitOps policy to apply on the cluster.</p>
<blockquote>
<p><strong>Note: This guide assumes you already deployed an AKS cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using either <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_arm_template/">ARM Template</a> or <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_terraform/">Terraform</a>.</strong></p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p>Fork the <a href="https://github.com/likamrat/hello_arc">&ldquo;Hello Arc&rdquo;</a> demo application repository.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p>As mentioned, this guide starts at the point where you already have a connected AKS cluster to Azure Arc.</p>
<p><img src="./01.png" alt="Existing AKS Azure Arc connected cluster"></p>
<p><img src="./02.png" alt="Existing AKS Azure Arc connected cluster"></p>
</li>
<li>
<p>Before installing the Azure Policy Add-on or enabling any of the service features, your subscription must enable the Microsoft.PolicyInsights resource provider and create a role assignment for the cluster service principal. To do that, open <a href="https://shell.azure.com/">Azure Cloud Shell</a> and run either the Azure CLI or Azure PowerShell command.</p>
<p><img src="./03.png" alt="Open Azure Cloud Shell"></p>
<p>Azure CLI:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider register --namespace <span style="color:#4e9a06">&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div><p>Azure PowerShell:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#204a87">Register-AzResourceProvider</span> <span style="color:#000">-ProviderNamespace</span> <span style="color:#4e9a06">&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div><p>To verify successful registration, run either the below Azure CLI or Azure PowerShell command.</p>
<p>Azure CLI:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider show --namespace <span style="color:#4e9a06">&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div><p>Azure PowerShell:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#204a87">Get-AzResourceProvider</span> <span style="color:#000">-ProviderNamespace</span> <span style="color:#4e9a06">&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div><p><img src="./04.png" alt="AzResourceProvider Bash"></p>
<p><img src="./05.png" alt="AzResourceProvider PowerShell"></p>
</li>
<li>
<p>Create Azure service principal (SP)</p>
<blockquote>
<p><strong>Note: This guide assumes you will be working with a service principal assigned with the &lsquo;Contributor&rsquo; role as described below. If you want to further limit the RBAC scope of your service Principal, you can assign it with the &lsquo;Policy Insights Data Writer (Preview)&rsquo; role the Azure Arc enabled Kubernetes cluster as described <a href="https://github.com/MicrosoftDocs/azure-docs/edit/master/articles/governance/policy/concepts/policy-for-kubernetes#L247-L275">here</a>.</strong></p>
</blockquote>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in Azure Cloud Shell).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
</ul>
<h2 id="azure-policy-for-azure-arc-connected-cluster-integration">Azure Policy for Azure Arc Connected Cluster Integration</h2>
<ul>
<li>
<p>In order to keep your local environment clean and untouched, we will use <a href="https://docs.microsoft.com/en-us/azure/cloud-shell/overview">Azure Cloud Shell</a> (located in the top-right corner in the Azure portal) to run the <em>aks_policy_onboarding</em> script against the AKS connected cluster. For your convenient, shell script is <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/azure_policy/aks_policy_onboarding.sh">provided to you</a>.</p>
</li>
<li>
<p>Edit the environment variables in the script to match your environment parameters, upload it to the Cloud Shell environment and run it using the <code>. ./aks_policy_onboarding.sh</code> command. <strong>If you decided to use the &lsquo;Policy Insights Data Writer (Preview)&rsquo; role assignment as described in the perquisites section, make sure to use it&rsquo;s respective <em>appId</em>, <em>password</em> and <em>tenantId</em></strong></p>
<blockquote>
<p><strong>Note: The extra dot is due to the shell script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p>
</blockquote>
<p><img src="./06.png" alt="Upload onboarding script"></p>
<p><img src="./07.png" alt="Upload onboarding script"></p>
<p><img src="./08.png" alt="Upload onboarding script"></p>
</li>
</ul>
<p>The script will:</p>
<ul>
<li>Login to your Azure subscription using the SPN credentials</li>
<li>Install NGINX Ingress Controller</li>
<li>Retrieve the Azure Arc Connected Cluster Azure Resource ID</li>
<li>Install the &lsquo;azure-policy-addon&rsquo; helm chart &amp; Gatekeeper</li>
</ul>
<p>After few seconds, by running the the <code>kubectl get pods -A</code> command, you will notice all pods have been deployed.</p>
<p><img src="./09.png" alt="Showing pods deployment"></p>
<h2 id="deploy-gitops-to-azure-arc-kubernetes-cluster-using-azure-policy">Deploy GitOps to Azure Arc Kubernetes cluster using Azure Policy</h2>
<p>Although you can <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/day2/aks/aks_gitops_helm/">deploy GitOps configuration individually</a> on each of your Azure Arc connected clusters, Azure Policy for Kubernetes allows to do the same on a broader scope (i.e subscription or resource group). That way, you can guarantee existing and newly added Azure Arc connected clusters to all have the same GitOps configuration and as a result, the same cluster baseline and/or application version deployed.</p>
<ul>
<li>
<p>Before assigning the policy, in the Azure portal, click the <em>Configuration</em> setting in your AKS connected cluster. Notice how no GitOps configurations are deployed.</p>
<p><img src="./10.png" alt="Empty GitOps configurations"></p>
</li>
<li>
<p>In the Search bar, look for <em>Policy</em> and click on <em>Definitions</em> which will show you all of the available Azure policies.</p>
<p><img src="./11.png" alt="Searching for Azure Policy definitions"></p>
<p><img src="./12.png" alt="Searching for Azure Policy definitions"></p>
</li>
<li>
<p>The &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; policy is part of the Kubernetes policies. Once you filter to find these, click on the policy and the &lsquo;Assign&rsquo; button.</p>
<p><img src="./13.png" alt="GitOps to Kubernetes cluster Azure policy"></p>
<p><img src="./14.png" alt="GitOps to Kubernetes cluster Azure policy"></p>
</li>
<li>
<p>In the below example, the scope of the policy represent the resource group where the AKS connected cluster Azure Arc resource is located. Alternatively, the scope could have been the entire Azure subscription or a resource group with many Azure Arc connected clusters. Also, make sure <em>Policy enforcement</em> is set to <em>Enabled</em>.</p>
<p>For this GitOps configuration policy, we will be using the <a href="https://github.com/likamrat/hello_arc">&ldquo;Hello Arc&rdquo;</a> application repository which includes the Kubernetes Service for external access, Deployment as well as the ingress rule to be used by the NGINX ingress controller.</p>
<p><img src="./15.png" alt="Assigning Azure policy"></p>
<p><img src="./16.png" alt="Assigning Azure policy"></p>
<p><img src="./17.png" alt="Assigning Azure policy"></p>
<p><img src="./18.png" alt="Assigning Azure policy"></p>
<p><img src="./19.png" alt="Assigning Azure policy"></p>
</li>
<li>
<p>Once the policy configuration deployed, after ~15-25min, the policy remediation task will start the evaluation against the Kubernetes cluster, recognize it as &ldquo;Non-compliant&rdquo; (since it&rsquo;s still does note have the GitOps configuration deployed) and lastly, after the configuration has been deployed the policy will move to a &ldquo;Compliant&rdquo; state. To check this, go back to the main Policy page in the Azure portal.</p>
<blockquote>
<p><strong>Note: The process of evaluation all the way to the point that the GitOps configuration is deployed against the cluster can take ~15-30min.</strong></p>
</blockquote>
<p><img src="./20.png" alt="Azure policy evaluation"></p>
<p><img src="./21.png" alt="Azure policy evaluation"></p>
<p><img src="./22.png" alt="Azure policy evaluation"></p>
<p><img src="./23.png" alt="Azure policy evaluation"></p>
<p><img src="./24.png" alt="Azure policy evaluation"></p>
</li>
</ul>
<h2 id="verify-gitops-configuration--app-deployment">Verify GitOps Configuration &amp; App Deployment</h2>
<ul>
<li>
<p>Now that the policy is in compliant state, let&rsquo;s first verify the GitOps configurations. In the Azure portal click the AKS connected Azure Arc cluster and open the Configurations settings.</p>
<p><img src="./25.png" alt="Successful GitOps config deployment"></p>
<p><img src="./26.png" alt="Successful GitOps config deployment"></p>
<p><img src="./27.png" alt="Successful GitOps config deployment"></p>
</li>
<li>
<p>In order to verify the &ldquo;Hello Arc&rdquo; application and it&rsquo;s component has been deployed, In the Azure Cloud Shell, run the below commands.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -n hello-arc
kubectl get ing -n hello-arc
kubectl get svc -n hello-arc
</code></pre></div><p>You can see how the Flux GitOps operator, Memcached, the &ldquo;Hello Arc&rdquo; application and the ingress rule now deployed on the cluster as well the Service with an external IP.</p>
<p><img src="./28.png" alt="&ldquo;Hello Arc&rdquo; Kubernetes pods"></p>
</li>
<li>
<p>Copy the Service external IP and paste in your browser.</p>
<p><img src="./29.png" alt="&ldquo;Hello Arc&rdquo; application deployed"></p>
</li>
</ul>
<h2 id="clean-up-environment">Clean up environment</h2>
<p>Complete the following steps to clean up your environment.</p>
<ul>
<li>
<p>Delete the AKS cluster as described in the <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_arm_template/">ARM Template teardown instructions</a> or the <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_terraform/">Terraform teardown instructions</a>.</p>
</li>
<li>
<p>From the Policy page in the Azure portal, remove the &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; policy assignment from the cluster.</p>
<p><img src="./30.png" alt="Delete Azure Policy assignment"></p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ecb095d0322798ee5c46b4a8223b12cf">10.2 - GKE</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-d457b58c7bf722d2347deaef42e48f9f">10.2.1 - Deploy GitOps configurations and perform basic GitOps flow on GKE as an Azure Arc Connected Cluster</h1>
    
	<h2 id="deploy-gitops-configurations-and-perform-basic-gitops-flow-on-gke-as-an-azure-arc-connected-cluster">Deploy GitOps configurations and perform basic GitOps flow on GKE as an Azure Arc Connected Cluster</h2>
<p>The following README will guide you on how to create GitOps configuration on a Google Kubernetes Engine (GKE) cluster which is projected as an Azure Arc connected cluster resource.</p>
<p>In this guide, you will deploy &amp; attach GitOps configuration to your cluster which will also include deploying an &ldquo;Hello World&rdquo; Azure Arc web application on your Kubernetes cluster. By doing so, you will be able to make real-time changes to the application and show how the GitOps flow takes effect.</p>
<p><strong>Note: This guide assumes you already deployed a GKE cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/gke/gke_terraform/">Terraform</a>.</strong></p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p>Clone the <a href="https://github.com/likamrat/hello_arc">&ldquo;Hello Arc&rdquo;</a> demo application repository.</p>
</li>
<li>
<p>(Optional) Install the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. This will help you to show the real-time changes on the application in an automated way.</p>
<ul>
<li>
<p><a href="https://microsoftedge.microsoft.com/addons/detail/odiofbnciojkpogljollobmhplkhmofe">Microsoft Edge</a></p>
</li>
<li>
<p><a href="https://chrome.google.com/webstore/detail/tab-auto-refresh/jaioibhbkffompljnnipmpkeafhpicpd?hl=en">Google Chrome</a></p>
</li>
<li>
<p><a href="https://addons.mozilla.org/en-US/firefox/addon/tab-auto-refresh/">Mozilla Firefox</a></p>
</li>
</ul>
</li>
<li>
<p>As mentioned, this guide starts at the point where you already have a connected GKE cluster to Azure Arc.</p>
<p><img src="./01.png" alt="Existing Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./02.png" alt="Existing Azure Arc enabled Kubernetes cluster"></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
</ul>
<h2 id="azure-arc-kubernetes-gitops-configuration">Azure Arc Kubernetes GitOps Configuration</h2>
<ul>
<li>
<p>In order to keep your local environment clean and untouched, we will use <a href="https://cloud.google.com/shell">Google Cloud Shell</a> to run the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/gitops/basic/az_k8sconfig_gke.sh"><em>az_k8sconfig_gke</em></a> shell script against the GKE connected cluster.</p>
</li>
<li>
<p>Edit the environment variables in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/gitops/basic/az_k8sconfig_gke.sh"><em>az_k8sconfig_gke</em></a> shell script to match your parameters, upload it to the Cloud Shell environment and run it using the <code>. ./az_k8sconfig_gke.sh</code> command.</p>
<blockquote>
<p><strong>Note: The extra dot is due to the script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p>
</blockquote>
<p><img src="./03.png" alt="Open Google Cloud Shell session and authenticate against the GKE cluster"></p>
<p><img src="./04.png" alt="Open Google Cloud Shell session and authenticate against the GKE cluster"></p>
<p><img src="./05.png" alt="Upload a file to Cloud Shell"></p>
<p><img src="./06.png" alt="Upload a file to Cloud Shell"></p>
<p><img src="./07.png" alt="Upload a file to Cloud Shell"></p>
<p>The script will:</p>
<ul>
<li>
<p>Login to your Azure subscription using the SPN credentials</p>
</li>
<li>
<p>Retrieve the cluster credentials (KUBECONFIG)</p>
</li>
<li>
<p>Will use Helm to deploy NGINX ingress controller</p>
</li>
<li>
<p>Create the GitOps configurations and deploy the Flux operator and Memcached on the Azure Arc connected cluster</p>
</li>
<li>
<p>Deploy the <a href="https://github.com/likamrat/hello_arc">&ldquo;Hello Arc&rdquo;</a> application along side an Ingress rule to make it available from outside the cluster</p>
<blockquote>
<p><strong>Disclaimer: For the purpose of this guide, notice how the &ldquo;<em>git-poll-interval 3s</em>&rdquo; is set. The 3 seconds interval is useful for demo purposes since it will make the git-poll interval to rapidly track changes on the repository but it is recommended to have longer interval in your production environment (default value is 5min)</strong></p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>Once the script will complete it&rsquo;s run, you will have the GitOps configuration created all the resources deployed in your Kubernetes cluster. Note that it takes few min for the configuration change it&rsquo;s Operator state status from &ldquo;Pending&rdquo; to Install.</p>
<p><img src="./08.png" alt="New GitOps configuration"></p>
<p><img src="./09.png" alt="New GitOps configuration"></p>
</li>
</ul>
<h2 id="the-hello-arc-application--components">The &ldquo;Hello Arc&rdquo; Application &amp; Components</h2>
<ul>
<li>
<p>Before kicking the GitOps flow, let&rsquo;s verify and zoom-in to the Kubernetes resources deployed by running few <em>kubectl</em> commands.</p>
<p><code>kubectl get pods -n cluster-config</code> - Will show the Flux operator and the Memcached pods.</p>
<p><code>kubectl get pods -n hello-arc</code> - Will show 3 replicas of the &ldquo;Hello Arc&rdquo; application and the NGINX controller.</p>
<p><code>kubectl get svc -n hello-arc</code> - Will show NGINX controller Kubernetes Service (Type LoadBalancer).</p>
<p><code>kubectl get ing -n hello-arc</code> - Will show NGINX rule which will route the traffic to the &ldquo;Hello Arc&rdquo; application from outside the cluster.</p>
<p><img src="./10.png" alt="kubectl get pods -n cluster-config"></p>
<p><img src="./11.png" alt="kubectl get pods -n hello-arc"></p>
<p><img src="./12.png" alt="kubectl get svc -n hello-arc"></p>
<p><img src="./13.png" alt="kubectl get ing -n hello-arc"></p>
</li>
<li>
<p>The GitOps flow works as follow:</p>
<ol>
<li>
<p>The Flux operator holds the &ldquo;desired state&rdquo; of the &ldquo;Hello Arc&rdquo; application, this are the configuration we deployed against the Azure Arc connected cluster. The operator &ldquo;polls&rdquo; the state of the of the <a href="https://github.com/likamrat/hello_arc">&ldquo;Hello Arc&rdquo;</a> application repository.</p>
</li>
<li>
<p>Changing the application which is consider to be a new version of it, will trigger the Flux operator to kick-in the GitOps flow.</p>
</li>
<li>
<p>A new Kubernetes pod with the new version of the application will be deployed on the cluster. Once the new pods is successfully deployed, the old one will be terminated (rolling upgrade).</p>
</li>
</ol>
</li>
<li>
<p>To show the above flow, open 2 (ideally 3) side-by-side browser windows:</p>
<ul>
<li>
<p>Google Cloud Shell open running the <code>kubectl get pods -n hello-arc -w</code></p>
<p><img src="./14.png" alt="kubectl get pods -n hello-arc -w"></p>
</li>
<li>
<p>Your clone of the &ldquo;Hello Arc&rdquo; application repository. Open the <a href="https://github.com/likamrat/hello_arc/blob/master/yaml/hello_arc.yaml"><em>hello_arc.yaml</em></a> file.</p>
</li>
<li>
<p>The external IP address of the Kubernetes Service seen using the <code>kubectl get svc -n hello-arc</code> command.</p>
<p><img src="./15.png" alt="kubectl get svc -n hello-arc"></p>
</li>
<li>
<p>End result should look like that:</p>
<p><img src="./16.png" alt="Side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p>
</li>
</ul>
</li>
<li>
<p>As mentioned in the prerequisites section, it is optional but very recommended to configure the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. If you did, in the &ldquo;Hello Arc&rdquo; application window, configure it to refresh every 2 seconds.</p>
<p><img src="./17.png" alt="Tab Auto Refresh"></p>
</li>
<li>
<p>In the repository window showing the <em>hello_arc.yaml</em> file, change the text under &ldquo;MESSAGE&rdquo; section commit the change. Alternatively, you can open the clone repository in your IDE, make the change, commit and push it.</p>
<p><img src="./18.png" alt="Making a change to the replica count and the &ldquo;MESSAGE&rdquo; section"></p>
<p><img src="./19.png" alt="Making a change to the replica count and the &ldquo;MESSAGE&rdquo; section"></p>
</li>
<li>
<p>Upon committing the changes, notice how the Kubernetes Pod rolling upgrade starts. Once the Pod is up &amp; running, the new &ldquo;Hello Arc&rdquo; application version window will show the new message, showing the rolling upgrade is completed and the GitOps flow is successful.</p>
<p><img src="./20.png" alt="New side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-185c98c7d0c0e36f4297a126b0d881f3">10.2.2 - Deploy GitOps configurations and perform Helm-based GitOps flow on GKE as an Azure Arc Connected Cluster</h1>
    
	<h2 id="deploy-gitops-configurations-and-perform-helm-based-gitops-flow-on-gke-as-an-azure-arc-connected-cluster">Deploy GitOps configurations and perform Helm-based GitOps flow on GKE as an Azure Arc Connected Cluster</h2>
<p>The following README will guide you on how to create <a href="https://helm.sh/">Helm</a>-based GitOps configuration on a Google Kubernetes Engine (GKE) cluster which is projected as an Azure Arc connected cluster resource.</p>
<p>In this guide, you will deploy &amp; attach 2 GitOps configuration to your cluster, a cluster-level config to deploy nginx-ingress controller and a namespace-level config to deploy the &ldquo;Hello Arc&rdquo; web application on your Kubernetes cluster.</p>
<p>By doing so, you will be able to make real-time changes to the application and show how the GitOps flow takes effect.</p>
<p><strong>Note: This guide assumes you already deployed a GKE cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/gke/gke_terraform/">Terraform</a>.</strong></p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p>Fork/Clone the <a href="https://github.com/likamrat/hello_arc">&ldquo;Hello Arc&rdquo;</a> demo application repository.</p>
</li>
<li>
<p>(Optional) Install the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. This will help you to show the real-time changes on the application in an automated way.</p>
<ul>
<li>
<p><a href="https://microsoftedge.microsoft.com/addons/detail/odiofbnciojkpogljollobmhplkhmofe">Microsoft Edge</a></p>
</li>
<li>
<p><a href="https://chrome.google.com/webstore/detail/tab-auto-refresh/jaioibhbkffompljnnipmpkeafhpicpd?hl=en">Google Chrome</a></p>
</li>
<li>
<p><a href="https://addons.mozilla.org/en-US/firefox/addon/tab-auto-refresh/">Mozilla Firefox</a></p>
</li>
</ul>
</li>
<li>
<p>As mentioned, this guide starts at the point where you already have a connected GKE cluster to Azure Arc.</p>
<p><img src="./01.png" alt="Existing Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./02.png" alt="Existing Azure Arc enabled Kubernetes cluster"></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
</ul>
<h2 id="cluster-level-config-vs-namespace-level-config">Cluster-level Config vs. Namespace-level Config</h2>
<h3 id="cluster-level-config">Cluster-level Config</h3>
<p>With Cluster-level GitOps config, the goal is to have an &ldquo;horizontal components&rdquo; or &ldquo;management components&rdquo; deployed on your Kubernetes cluster which will then be used by your applications. Good examples are Service Meshes, Security products, Monitoring solutions, etc. A very popular example will also be Ingress Controller which is exactly the nginx-ingress controller we will deploy in the next section.</p>
<h3 id="namespace-level-config">Namespace-level Config</h3>
<p>With Namespace-level GitOps config, the goal is to have Kubernetes resources deployed only in the namespace selected. The most obvious use-case here is simply your application and it&rsquo;s respective pods, services, ingress routes, etc. In the next section will have the &ldquo;Hello Arc&rdquo; application deployed on a dedicated namespace.</p>
<h2 id="azure-arc-kubernetes-gitops-configuration-with-helm">Azure Arc Kubernetes GitOps Configuration with Helm</h2>
<h2 id="the-mechanism-in-a-nutshell">The Mechanism (In a nutshell)</h2>
<p>In the process of creating Azure Arc GitOps configuration, <a href="https://github.com/fluxcd/flux">Weaveworks Flux Kubernetes Operator</a> is deployed on the cluster.</p>
<p>The Operator is aware of the &ldquo;HelmRelease&rdquo; Custom Resource Definition (CRD). This HelmRelease points to a helm chart in a git repo and can optionally contain specific values to input into the helm chart. Due to this configuration, a user can choose to leave the chart values intact or to have different values for different releases.</p>
<p>For example, an application (captured in an Helm chart) dev release can have no pod replication (single pod) while a production release, using the same chart can have 3 pod replicas.</p>
<p>In the next section will use the &ldquo;Hello Arc&rdquo; Helm chart to deploy a production release which we will then change and see the results in real-time.</p>
<h3 id="deployment-flow">Deployment Flow</h3>
<p>For our scenario, notice we have in two Helm charts in the &ldquo;Hello Arc&rdquo; repository; one for nginx and one for the actual application as well as an Helm Release for each.</p>
<p><img src="./03.png" alt="&ldquo;Hello Arc&rdquo; GitHub repository"></p>
<p><img src="./04.png" alt="&ldquo;Hello Arc&rdquo; GitHub repository"></p>
<ul>
<li>
<p>The nginx-ingress controller (a Cluster-level component) will be deployed with 3 replicas to the <em>cluster-mgmt</em> namespace.</p>
</li>
<li>
<p>The &ldquo;Hello Arc&rdquo; application (a Namespace-level component) will be deployed with 1 replica to the <em>prod</em> namespace.</p>
</li>
</ul>
<h3 id="deployment">Deployment</h3>
<ul>
<li>
<p>In order to keep your local environment clean and untouched, we will use <a href="https://cloud.google.com/shell">Google Cloud Shell</a> to run the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/gitops/helm/az_k8sconfig_helm_gke.sh"><em>az_k8sconfig_helm_gke</em></a> shell script against the GKE connected cluster.</p>
</li>
<li>
<p>Edit the environment variables in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/gitops/helm/az_k8sconfig_helm_gke.sh"><em>az_k8sconfig_helm_gke</em></a> shell script to match your parameters, upload it to the Cloud Shell environment and run it using the <code>. ./az_k8sconfig_helm_gke</code> command.</p>
<blockquote>
<p><strong>Note: The extra dot is due to the script has an <em>export</em> function and needs to have the variables exported in the same shell session as the rest of the commands.</strong></p>
</blockquote>
<p><img src="./05.png" alt="Export environment variables"></p>
<p><img src="./06.png" alt="Open Google Cloud Shell session and authenticate against the GKE cluster"></p>
<p><img src="./07.png" alt="Open Google Cloud Shell session and authenticate against the GKE cluster"></p>
<p><img src="./08.png" alt="Upload a file to Cloud Shell"></p>
<p><img src="./09.png" alt="Upload a file to Cloud Shell"></p>
<p><img src="./10.png" alt="Upload a file to Cloud Shell"></p>
<p>The script will:</p>
<ul>
<li>
<p>Install Helm 3 in Google Cloud Shell</p>
</li>
<li>
<p>Install Azure CLI &amp; Azure Arc extensions</p>
</li>
<li>
<p>Login to your Azure subscription using the SPN credentials</p>
</li>
<li>
<p>Create two GitOps configurations for the Azure Arc Connected Cluster. Both configurations will be using the Helm charts located in the &ldquo;Hello Arc&rdquo; repository.</p>
</li>
<li>
<p>Cluster-level config to deploy nginx-ingress controller Helm chart</p>
</li>
<li>
<p>Namespace-level config to deploy the &ldquo;Hello Arc&rdquo; application Helm chart</p>
<blockquote>
<p><strong>Disclaimer: For the purpose of this guide, notice how the &ldquo;<em>git-poll-interval 3s</em>&rdquo; is set. The 3 seconds interval is useful for demo purposes since it will make the git-poll interval to rapidly track changes on the repository but it is recommended to have longer interval in your production environment (default value is 5min)</strong></p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>Once the script will complete it&rsquo;s run, you will have 2 GitOps configuration created and all the resources deployed in your Kubernetes cluster.</p>
<blockquote>
<p><strong>Note: that it takes few min for the configuration change it&rsquo;s Operator state status from &ldquo;Pending&rdquo; to Install.</strong></p>
</blockquote>
<p><img src="./11.png" alt="Cluster-level GitOps configurations"></p>
<p><img src="./12.png" alt="Namespace-level GitOps configurations"></p>
<p><img src="./13.png" alt="Azure Arc enabled Kubernetes GitOps configurations"></p>
<p><img src="./14.png" alt="New GitOps configurations in Azure portal"></p>
<p>The Cluster-level config initiated the nginx-ingress Pods and Service resource deployment (along with the Flux operator and Memcached). To see it&rsquo;s resource, use the below <em>kubectl</em> commands.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -n cluster-mgmt
kubectl get svc -n cluster-mgmt
</code></pre></div><p><img src="./15.png" alt="cluster-mgmt namespace resources"></p>
<p>The Namespace-level config initiated the &ldquo;Hello Arc&rdquo; Pod (1 replica), Service and Ingress Route resource deployment.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -n prod
kubectl get svc -n prod
kubectl get ing -n prod
</code></pre></div><p><img src="./16.png" alt="prod namespace resources"></p>
</li>
</ul>
<h2 id="initiating-hello-arc-application-gitops">Initiating &ldquo;Hello Arc&rdquo; Application GitOps</h2>
<ul>
<li>
<p>The GitOps flow works as follow:</p>
<ol>
<li>
<p>The Flux operator holds the &ldquo;desired state&rdquo; for both the nginx-ingress and the &ldquo;Hello Arc&rdquo; Helm releases, this are the configuration we deployed against the Azure Arc connected cluster. The operator will pull every 3 seconds the state of the releases in the repository.</p>
</li>
<li>
<p>Changing the application release will trigger the Flux operator to kick-in the GitOps flow.</p>
</li>
<li>
<p>A new version of the application will be deployed on the cluster with more replicas as configured. Once the new pods is successfully deployed, the old ones will be terminated (rolling upgrade).</p>
</li>
</ol>
</li>
<li>
<p>To show the above flow, open 2 (ideally 3) side-by-side browser windows:</p>
<ul>
<li>
<p>Google Cloud Shell open running the <code>kubectl get pods -n prod -w</code></p>
<p><img src="./17.png" alt="kubectl get pods -n prod -w"></p>
</li>
<li>
<p>In your own repository fork, open the &ldquo;Hello Arc&rdquo; <a href="https://github.com/likamrat/hello_arc/blob/master/releases/prod/hello-arc.yaml"><em>hello-arc.yaml</em></a> Helm release file.</p>
</li>
<li>
<p>The external IP address of the Kubernetes Service seen using the <code>kubectl get svc -n prod</code> command.</p>
<p><img src="./18.png" alt="kubectl get svc -n prod"></p>
</li>
<li>
<p>End result should look like that:</p>
<p><img src="./19.png" alt="Side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p>
</li>
</ul>
</li>
<li>
<p>As mentioned in the prerequisites section, it is optional but very recommended to configure the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. If you did, in the &ldquo;Hello Arc&rdquo; application window, configure it to refresh every 2 seconds.</p>
<p><img src="./20.png" alt="Tab Auto Refresh"></p>
</li>
<li>
<p>In the repository window showing the <em>hello-arc.yaml</em> file, change the number of <em>replicaCount</em> to 3 as well as the the message text and commit your changes. Alternatively, you can open the forked repository in your IDE, make the change, commit and push it.</p>
<p><img src="./21.png" alt="Making a change to the replica count and the &ldquo;MESSAGE&rdquo; section"></p>
</li>
<li>
<p>Upon committing the changes, notice how the rolling upgrade starts. Once the Pods are up &amp; running, the new &ldquo;Hello Arc&rdquo; application version window will show the new messages as well as the additional pods replicas, showing the rolling upgrade is completed and the GitOps flow is successful.</p>
<p><img src="./22.png" alt="&ldquo;Hello Arc&rdquo; rolling upgrade"></p>
<p><img src="./23.png" alt="New side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p>
<p><img src="./24.png" alt="New pods deployed"></p>
</li>
</ul>
<h2 id="cleanup">Cleanup</h2>
<p>To delete the GitOps configuration and it&rsquo;s respective Kubernetes resources, edit the environment variables to match the Azure Arc Kubernetes cluster and Resources in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/gitops/helm/az_k8sconfig_helm_cleanup.sh">az_k8sconfig_helm_cleanup</a> shell script, upload it to Cloud Shell and run it using the <code>. ./az_k8sconfig_helm_cleanup.sh</code> command.</p>
<p><img src="./25.png" alt="Edit environment variables"></p>
<p><img src="./26.png" alt="GitOps configuration deleted"></p>
<p><img src="./27.png" alt="Empty GitOps configuration"></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-de11c18b0e8549b41c0a88fa1af98a22">10.2.3 - Integrate Azure Monitor for Containers with GKE as an Azure Arc Connected Cluster</h1>
    
	<h2 id="integrate-azure-monitor-for-containers-with-gke-as-an-azure-arc-connected-cluster">Integrate Azure Monitor for Containers with GKE as an Azure Arc Connected Cluster</h2>
<p>The following README will guide you on how to enable <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/insights/container-insights-overview">Azure Monitor for Containers</a> for a Google Kubernetes Engine (GKE) cluster that is projected as an Azure Arc connected cluster.</p>
<p>In this guide, you will hook the GKE cluster to Azure Monitor by deploying the <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/platform/log-analytics-agent">OMS agent</a> on your Kubernetes cluster in order to start collecting telemetry.</p>
<blockquote>
<p><strong>Note: This guide assumes you already deployed a GKE cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/docs/gke_terraform.md">Terraform</a>.</strong></p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
</ul>
<h2 id="azure-monitor-for-containers-integration">Azure Monitor for Containers Integration</h2>
<ul>
<li>
<p>In order to keep your local environment clean and untouched, we will use <a href="https://cloud.google.com/shell">Google Cloud Shell</a> to run the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/gke_monitor/gke_monitor_onboarding.sh"><em>gke_monitor_onboarding</em></a> shell script against the GKE connected cluster.</p>
</li>
<li>
<p>Before integrating the cluster with Azure Monitor for Containers, click on the &ldquo;Insights (preview)&rdquo; blade for the connected Arc cluster to show how the cluster is not currently being monitored.</p>
<p><img src="./01.png" alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource"></p>
<p><img src="./02.png" alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource Insights"></p>
</li>
<li>
<p>Edit the environment variables in the script to match your environment parameters, upload it to the Cloud Shell environment and run it using the <code>. ./gke_monitor_onboarding.sh</code> command.</p>
<blockquote>
<p><strong>Note: The extra dot is due to the shell script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p>
</blockquote>
<p><img src="./03.png" alt="Screenshot showing GKE cluster in GCP console"></p>
<p><img src="./04.png" alt="Screenshot showing connection to GKE cluster in GCP console"></p>
<p><img src="./05.png" alt="Screenshot showing GKE cluster in GCP console"></p>
<p><img src="./06.png" alt="Screenshot showing GKE cluster in GCP console"></p>
<p><img src="./07.png" alt="Screenshot showing GKE cluster in GCP console"></p>
<p>The script will:</p>
<ul>
<li>Login to your Azure subscription using the SPN credentials</li>
<li>Download the OMS script</li>
<li>Retrieve cluster Azure resource ID as well as the cluster credentials (KUBECONFIG)</li>
<li>Execute the script which will create Azure Log Analytics workspace, deploy the OMS agent on the Kubernetes cluster and tag the cluster</li>
<li>Delete the downloaded script</li>
</ul>
</li>
<li>
<p>Once the script will complete it&rsquo;s run, you will have an Azure Arc connected cluster integrated with Azure Monitor for Containers. At the end of it&rsquo;s run, the script generates URL for you to click on. This URL will open a new browser tab leading to the Azure Monitor for Containers Insights page.a</p>
<blockquote>
<p><strong>Note: As the OMS start collecting telemetry from the cluster nodes and pods, it will take 5-10min for data to start show up in the Azure Portal.</strong></p>
</blockquote>
<p><img src="./08.png" alt="Screenshot showing script being run"></p>
<p><img src="./09.png" alt="Screenshot showing deployment"></p>
</li>
<li>
<p>Click the &ldquo;Connected Clusters&rdquo; tab and see the Azure Arc connected cluster was added. Now that your cluster is being monitored, navigate trough the different tabs and sections and watch the monitoring telemetry for the cluster nodes and pods.</p>
<p><img src="./10.png" alt="Screenshot showing Azure Portal with connected cluster detail"></p>
<p><img src="./11.png" alt="Screenshot showing Azure Portal with connected cluster detail"></p>
<p><img src="./12.png" alt="Screenshot showing Azure Portal with connected cluster detail"></p>
<p><img src="./13.png" alt="Screenshot showing Azure Portal with connected cluster detail"></p>
<p><img src="./14.png" alt="Screenshot showing Azure Portal with connected cluster detail"></p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aff3a2239473fef2a378434ef6640e2c">10.2.4 - Apply GitOps configurations on GKE as an Azure Arc Connected Cluster using Azure Policy for Kubernetes</h1>
    
	<h2 id="apply-gitops-configurations-on-gke-as-an-azure-arc-connected-cluster-using-azure-policy-for-kubernetes">Apply GitOps configurations on GKE as an Azure Arc Connected Cluster using Azure Policy for Kubernetes</h2>
<p>The following README will guide you on how to enable <a href="https://docs.microsoft.com/en-us/azure/governance/policy/concepts/policy-for-kubernetes#:~:text=Azure%20Policy%20extends%20Gatekeeper%20v3,Kubernetes%20clusters%20from%20one%20place.">Azure Policy for Kubernetes</a> on a Google Kubernetes Engine (GKE) cluster that is projected as an Azure Arc connected cluster as well as how to create GitOps policy to apply on the cluster.</p>
<blockquote>
<p><strong>Note: This guide assumes you already deployed a GKE cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/gke/gke_terraform/">Terraform</a>.</strong></p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p>As mentioned, this guide starts at the point where you already have a connected GKE cluster to Azure Arc.</p>
<p><img src="./01.png" alt="Existing GKE Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./02.png" alt="Existing GKE Azure Arc enabled Kubernetes cluster"></p>
</li>
<li>
<p>Before installing the Azure Policy addon or enabling any of the service features, your subscription must enable the Microsoft.PolicyInsights resource provider and create a role assignment for the cluster service principal. To do that, open <a href="https://shell.azure.com/">Azure Cloud Shell</a> and run either the Azure CLI or Azure PowerShell command.</p>
<p><img src="./03.png" alt="Azure Cloud Shell"></p>
<p>Azure CLI:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider register --namespace <span style="color:#4e9a06">&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div><p>PowerShell:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#204a87">Register-AzResourceProvider</span> <span style="color:#000">-ProviderNamespace</span> <span style="color:#4e9a06">&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div></li>
<li>
<p>To verify successful registration, run either the below Azure CLI or Azure PowerShell command.</p>
<p>Azure CLI:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az provider show --namespace <span style="color:#4e9a06">&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div><p>PowerShell:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#204a87">Get-AzResourceProvider</span> <span style="color:#000">-ProviderNamespace</span> <span style="color:#4e9a06">&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div><p><img src="./04.png" alt="Installing the Azure Policy addon resource provider"></p>
<p><img src="./05.png" alt="Installing the Azure Policy addon resource provider"></p>
</li>
<li>
<p>Create Azure service principal (SP)</p>
<blockquote>
<p><strong>Note: This guide assumes you will be working with a service principal assigned with the &lsquo;Contributor&rsquo; role as described below. If you want to further limit the RBAC scope of your service Principal, you can assign it with the &lsquo;Policy Insights Data Writer (Preview)&rsquo; role the Azure Arc enabled Kubernetes cluster as described <a href="https://github.com/MicrosoftDocs/azure-docs/blob/master/articles/governance/policy/concepts/policy-for-kubernetes.md#install-azure-policy-add-on-for-azure-arc-enabled-kubernetes-preview">here</a>.</strong></p>
</blockquote>
</li>
<li>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in Azure Cloud Shell).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p><strong>Note</strong>: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></p>
</li>
</ul>
<h2 id="azure-policy-for-azure-arc-connected-cluster-integration">Azure Policy for Azure Arc Connected Cluster Integration</h2>
<ul>
<li>
<p>In order to keep your local environment clean and untouched, we will use <a href="https://cloud.google.com/shell">Google Cloud Shell</a> to run the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/azure_policy/gke_policy_onboarding.sh"><em>gke_policy_onboarding</em></a> shell script against the GKE connected cluster.</p>
</li>
<li>
<p>Edit the environment variables in the script to match your environment parameters, upload it to the Cloud Shell environment and run it using the <code>. ./gke_policy_onboarding.sh</code> command. <strong>If you decided to use the &lsquo;Policy Insights Data Writer (Preview)&rsquo; role assignment as described in the perquisites section, make sure to use it&rsquo;s respective <em>appId</em>, <em>password</em> and <em>tenantId</em></strong>.</p>
<p><strong>Note</strong>: The extra dot is due to the shell script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</p>
<p><img src="./06.png" alt="Run GCP Cloud Shell"></p>
<p><img src="./07.png" alt="Run GCP Cloud Shell"></p>
<p><img src="./08.png" alt="Upload a file to GCP Cloud Shell"></p>
<p><img src="./09.png" alt="Upload a file to GCP Cloud Shell"></p>
<p><img src="./10.png" alt="Upload a file to GCP Cloud Shell"></p>
<p>The script will:</p>
<ul>
<li>
<p>Install Helm 3 &amp; Azure CLI</p>
</li>
<li>
<p>Install NGINX Ingress Controller</p>
</li>
<li>
<p>Login to your Azure subscription using the SPN credentials</p>
</li>
<li>
<p>Retrieve cluster Azure Resource ID</p>
</li>
<li>
<p>Install the &lsquo;azure-policy-addon&rsquo; helm chart &amp; Gatekeeper</p>
<p>After few seconds, by running the the <code>kubectl get pods -A</code> command, you will notice all pods have been deployed.</p>
<p><img src="./11.png" alt="kubectl get pods"></p>
</li>
</ul>
</li>
</ul>
<h2 id="deploy-gitops-to-azure-arc-kubernetes-cluster-using-azure-policy">Deploy GitOps to Azure Arc Kubernetes cluster using Azure Policy</h2>
<p>Although you can <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/day2/gke/gke_gitops_basic/">deploy GitOps configuration individually</a> on each of your Azure Arc connected clusters, Azure Policy for Kubernetes allows to do the same on a broader scope (i.e Subscription or resource group). That way, you can guarantee existing and newly added Azure Arc connected clusters to all have the same GitOps configuration and as a result, the same cluster baseline and/or application version deployed.</p>
<ul>
<li>
<p>Before assigning the policy, in the Azure portal, click the <em>Configuration</em> setting in your GKE connected cluster. Notice how no GitOps configurations are deployed.</p>
<p><img src="./12.png" alt="No GitOps configurations"></p>
</li>
<li>
<p>In the Search bar, look for <em>Policy</em> and click on <em>Definitions</em> which will show you all of the available Azure policies.</p>
<p><img src="./13.png" alt="Search for Azure Policy Definitions in the Azure portal"></p>
<p><img src="./14.png" alt="Search for Azure Policy Definitions in the Azure portal"></p>
</li>
<li>
<p>The &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; policy is part of the Kubernetes policies. Once you filter to find these, click on the policy and the &lsquo;Assign&rsquo; button.</p>
<p><img src="./15.png" alt="Azure Policy in the Azure portal"></p>
<p><img src="./16.png" alt="Azure Policy definitions in the Azure portal"></p>
</li>
<li>
<p>In the below example, the scope of the policy represent the resource group where the GKE connected cluster Azure Arc resource is located. Alternatively, the scope could have been the entire Azure subscription or a resource group with many Azure Arc connected clusters. Also, make sure <em>Policy enforcement</em> is set to <em>Enabled</em>.</p>
<p>For this GitOps configuration policy, we will be using the <a href="https://github.com/likamrat/hello_arc">&ldquo;Hello Arc&rdquo;</a> application repository which includes the Kubernetes Service for external access, Deployment as well as the ingress rule to be used by the NGINX ingress controller.</p>
<p><img src="./17.png" alt="Assign the &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; Azure Policy"></p>
<p><img src="./18.png" alt="Assign the &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; Azure Policy"></p>
<p><img src="./19.png" alt="Assign the &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; Azure Policy"></p>
<p><img src="./20.png" alt="Assign the &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; Azure Policy"></p>
</li>
<li>
<p>Once the policy configuration deployed, after ~10-20min, the policy remediation task will start the evaluation against the Kubernetes cluster, recognize it as &ldquo;Non-compliant&rdquo; (since it&rsquo;s still does note have the GitOps configuration deployed) and lastly, after the configuration has been deployed the policy will move to a &ldquo;Compliant&rdquo; state. To check this, go back to the main Policy page in the Azure portal.</p>
<blockquote>
<p><strong>Note: The process of evaluation all the way to the point that the GitOps configuration is deployed against the cluster can take ~15-30min.</strong></p>
</blockquote>
<p><img src="./21.png" alt="Verifying Azure Policy status and compliance state"></p>
<p><img src="./22.png" alt="Verifying Azure Policy status and compliance state"></p>
<p><img src="./23.png" alt="Verifying Azure Policy status and compliance state"></p>
<p><img src="./24.png" alt="Verifying Azure Policy status and compliance state"></p>
<p><img src="./25.png" alt="Verifying Azure Policy status and compliance state"></p>
</li>
</ul>
<h2 id="verify-gitops-configuration--app-deployment">Verify GitOps Configuration &amp; App Deployment</h2>
<ul>
<li>
<p>Now that the policy is in compliant state, let&rsquo;s first verify the GitOps configurations. In the Azure portal click the GKE connected Azure Arc cluster and open the Configurations settings.</p>
<p><img src="./26.png" alt="Newly created GitOps configurations"></p>
<p><img src="./27.png" alt="Newly created GitOps configurations"></p>
<p><img src="./28.png" alt="Newly created GitOps configurations"></p>
</li>
<li>
<p>In order to verify the &ldquo;Hello Arc&rdquo; application and it&rsquo;s component has been deployed, In the Google Cloud Shell, run the below commands.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -n hello-arc
kubectl get ing -n hello-arc
kubectl get svc -n hello-arc
</code></pre></div><p>You can see how the Flux GitOps operator, Memcached, the &ldquo;Hello Arc&rdquo; application and the ingress rule now deployed on the cluster as well the Kubernetes service with an external IP.</p>
<p><img src="./29.png" alt="Running kubectl commands to verifying successful deployment"></p>
</li>
<li>
<p>Copy the Service external IP and paste in your browser to see the deployed &ldquo;Hello Arc&rdquo; application.</p>
<p><img src="./30.png" alt="Deployed &ldquo;Hello Arc&rdquo; application"></p>
</li>
</ul>
<h2 id="clean-up-environment">Clean up environment</h2>
<p>Complete the following steps to clean up your environment.</p>
<ul>
<li>
<p>Delete the GKE cluster as described in the <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/gke/gke_terraform/">teardown instructions</a>.</p>
</li>
<li>
<p>From the Policy page in the Azure portal, remove the &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; policy assignment from the cluster.</p>
<p><img src="./31.png" alt="Delete Azure Policy assignment"></p>
<p><img src="./32.png" alt="Delete Azure Policy assignment"></p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-35f95ff005abe064acf384005986b669">10.3 - Kind</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-37841f0de5e94de64c5a1f739f9f2f89">10.3.1 - Deploy GitOps configurations and perform Helm-based GitOps flow on kind as an Azure Arc Connected Cluster</h1>
    
	<h2 id="deploy-gitops-configurations-and-perform-helm-based-gitops-flow-on-kind-as-an-azure-arc-connected-cluster">Deploy GitOps configurations and perform Helm-based GitOps flow on kind as an Azure Arc Connected Cluster</h2>
<p>The following README will guide you on how to create <a href="https://helm.sh/">Helm</a>-based GitOps configuration on a <a href="https://kind.sigs.k8s.io/">kind (Kubernetes in Docker)</a> cluster which is projected as an Azure Arc connected cluster resource.</p>
<p>In this guide, you will first deploy a nginx ingress controller to your cluster. Then you will deploy &amp; attach a GitOps configuration to your cluster. This will be a namespace-level config to deploy the &ldquo;Hello Arc&rdquo; web application on your Kubernetes cluster.</p>
<p>By doing so, you will be able to make real-time changes to the application and show how the GitOps flow takes effect.</p>
<blockquote>
<p><strong>Note: This guide assumes you already deployed a kind and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in the <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/kind/local_kind/">kind onboarding guide</a>.</strong></p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p>Fork/Clone the <a href="https://github.com/likamrat/hello_arc">&ldquo;Hello Arc&rdquo;</a> demo application repository.</p>
</li>
<li>
<p>(Optional) Install the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. This will help you to show the real-time changes on the application in an automated way.</p>
<ul>
<li>
<p><a href="https://microsoftedge.microsoft.com/addons/detail/odiofbnciojkpogljollobmhplkhmofe">Microsoft Edge</a></p>
</li>
<li>
<p><a href="https://chrome.google.com/webstore/detail/tab-auto-refresh/jaioibhbkffompljnnipmpkeafhpicpd?hl=en">Google Chrome</a></p>
</li>
<li>
<p><a href="https://addons.mozilla.org/en-US/firefox/addon/tab-auto-refresh/">Mozilla Firefox</a></p>
</li>
</ul>
</li>
<li>
<p>As mentioned, this guide starts at the point where you already have a connected kind cluster to Azure Arc.</p>
<p><img src="./01.png" alt="Existing Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./02.png" alt="Existing Azure Arc enabled Kubernetes cluster"></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
</ul>
<h2 id="manually-setting-up-an-ingress-controller-on-kind">Manually setting up an ingress controller on kind</h2>
<p>The demo application that will be deployed later in this guide relies on an ingress controller. For ingress controllers to work on kind, a specific configuration of the ingress needs to be deployed. For more information related to this, please refer to the <a href="https://kind.sigs.k8s.io/docs/user/ingress/">kind documentation</a>.</p>
<h2 id="nginx-controller-deployment">NGINX Controller Deployment</h2>
<ul>
<li>
<p>Run the following command to install the nginx ingress controller on kind:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/kind/deploy.yaml
</code></pre></div></li>
<li>
<p>This command will create a new namespace and deploy the required components in this namespace. To verify the deployment of the ingress controller was successful, make sure the pod with name <code>ingress-nginx-controller-&lt;random id&gt;-&lt;random id&gt;</code> is in a running state with 1/1 containers ready:</p>
<p><img src="./03.png" alt="Running ingress nginx controller"></p>
</li>
<li>
<p>Finally, test that the ingress is responding to traffic. To test this, either browse to <a href="http://localhost">http://localhost</a> or use the command line to connect to <code>localhost</code>. You should get a HTTP 404 response with a nginx footer. This shows that the ingress is working. The 404 response is to be expected since you haven&rsquo;t setup an ingress route yet. You will do that in the next section.</p>
<p><img src="./04.png" alt="HTTP 404 response in a web browser"></p>
<p><img src="./05.png" alt="HTTP 404 response in a terminal"></p>
</li>
</ul>
<h2 id="cluster-level-config-vs-namespace-level-config">Cluster-level Config vs. Namespace-level Config</h2>
<h3 id="cluster-level-config">Cluster-level Config</h3>
<p>With Cluster-level GitOps config, the goal is to have &ldquo;horizontal components&rdquo; or &ldquo;management components&rdquo; deployed on your Kubernetes cluster which will then be used by your applications. Good examples are Service Meshes, Security products, Monitoring solutions, etc.</p>
<blockquote>
<p><strong>Note: You will not be creating a cluster-level config in this guide. For an example of a cluster-level configuration please refer to either the <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/day2/aks/aks_gitops_helm/">Helm-based GitOps on AKS scenario</a> or the <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/day2/gke/gke_gitops_helm/">GKE one</a>.</strong></p>
</blockquote>
<h3 id="namespace-level-config">Namespace-level Config</h3>
<p>With Namespace-level GitOps config, the goal is to have Kubernetes resources deployed only in the namespace selected. The most obvious use-case here is simply your application and its respective pods, services, ingress routes, etc. In the next section will have the &ldquo;Hello Arc&rdquo; application deployed on a dedicated namespace.</p>
<h2 id="azure-arc-kubernetes-gitops-configuration-with-helm">Azure Arc Kubernetes GitOps Configuration with Helm</h2>
<h3 id="the-mechanism-in-a-nutshell">The Mechanism (In a nutshell)</h3>
<p>In the process of creating Azure Arc enabled Kubernetes GitOps configuration, <a href="https://github.com/fluxcd/flux">Weaveworks Flux Kubernetes Operator</a> is deployed on the cluster.</p>
<p>The Operator is aware of the &ldquo;HelmRelease&rdquo; Custom Resource Definition (CRD). This HelmRelease points to a helm chart in a git repo and can optionally contain specific values to input into the helm chart. Due to this configuration, a user can choose to leave the chart values intact or to have different values for different releases.</p>
<p>For example, an application (captured in an Helm chart) dev release can have no pod replication (single pod) while a production release, using the same chart can have 3 pod replicas.</p>
<p>In the next section will use the &ldquo;Hello Arc&rdquo; Helm chart to deploy a production release which we will then change and see the results in real-time.</p>
<h3 id="deployment-flow">Deployment Flow</h3>
<p>For our scenario, we will deploy the &ldquo;Hello Arc&rdquo; application from the <a href="https://github.com/likamrat/hello_arc">&ldquo;demo repository&rdquo;</a> through GitOps. We will deploy the &ldquo;Hello Arc&rdquo; application (a Namespace-level component) with 1 replica to the <em>prod</em> namespace.</p>
<p><img src="./06.png" alt="&ldquo;Hello Arc&rdquo; application GitHub repository"></p>
<p><img src="./07.png" alt="&ldquo;Hello Arc&rdquo; application GitHub repository"></p>
<h3 id="deployment">Deployment</h3>
<ul>
<li>
<p>Edit the environment variables in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/kind/gitops/helm/az_k8sconfig_helm_kind.sh"><em>az_k8sconfig_helm_kind</em></a> shell script to match your parameters, and run it using the <code>. az_k8sconfig_helm_kind.sh</code> command.</p>
<blockquote>
<p><strong>Note: The extra dot is due to the script having an <em>export</em> function and that needs to have the vars exported in the same shell session as the rest of the commands.</strong></p>
</blockquote>
<p>The <code>az_k8sconfig_helm_kind.sh</code> script will:</p>
<ul>
<li>
<p>Login to your Azure subscription using the SPN credentials.</p>
</li>
<li>
<p>Create the GitOps configurations for the Azure Arc Connected Cluster. The configuration will be using the Helm chart located in the &ldquo;Hello Arc&rdquo; repository. This will create a namespace-level config to deploy the &ldquo;Hello Arc&rdquo; application Helm chart.</p>
<blockquote>
<p><strong>Disclaimer: For the purpose of this guide, notice how the &ldquo;<em>git-poll-interval 3s</em>&rdquo; is set. The 3 seconds interval is useful for demo purposes since it will make the git-poll interval to rapidly track changes on the repository but it is recommended to have longer interval in your production environment (default value is 5min)</strong></p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>Once the script will complete its run, you will have the GitOps configuration created and all the resources deployed in your local kind Kubernetes cluster.</p>
<blockquote>
<p><strong>Note: it can take a few minutes for the configuration to change its Operator state status from &ldquo;Pending&rdquo; to &ldquo;Installed&rdquo;.</strong></p>
</blockquote>
<p><img src="./08.png" alt="New GitOps configuration created"></p>
<p><img src="./09.png" alt="New GitOps configuration created"></p>
</li>
<li>
<p>The Namespace-level config initiated the &ldquo;Hello Arc&rdquo; Pod (1 replica), Service and Ingress Route resource deployment.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -n prod
kubectl get svc -n prod
kubectl get ing -n prod
</code></pre></div><p><img src="./10.png" alt="&ldquo;Hello Arc&rdquo; application deployed"></p>
</li>
</ul>
<h2 id="initiating-hello-arc-application-gitops">Initiating &ldquo;Hello Arc&rdquo; Application GitOps</h2>
<ul>
<li>
<p>The GitOps flow works as follow:</p>
<ol>
<li>
<p>The Flux operator holds the &ldquo;desired state&rdquo; of the &ldquo;Hello Arc&rdquo; Helm release. This is the configuration we deployed against the Azure Arc connected cluster. The operator will pull the state of the releases in the repository every 3 seconds.</p>
</li>
<li>
<p>Changing the application release will trigger the Flux operator to kick-in the GitOps flow. In our case, we will be changing the welcome message and the amount of replicas.</p>
</li>
<li>
<p>A new version of the application will be deployed on the cluster with more replicas as configured. Once the new pods are successfully deployed, the old ones will be terminated (rolling upgrade).</p>
</li>
</ol>
</li>
<li>
<p>To show the above flow, open 2 (ideally 3) side-by-side windows:</p>
<ul>
<li>
<p>Local shell running <code>kubectl get pods -n prod -w</code></p>
<p><img src="./11.png" alt="&lsquo;kubectl get pods&rsquo; command"></p>
</li>
<li>
<p>In your own repository fork, open the &ldquo;Hello Arc&rdquo; <a href="https://github.com/likamrat/hello_arc/blob/master/releases/prod/hello-arc.yaml"><em>hello-arc.yaml</em></a> Helm release file.</p>
</li>
<li>
<p>Another browser window that has the webpage <a href="http://localhost">http://localhost</a> open</p>
</li>
<li>
<p>End result should look like this:</p>
<p><img src="./12.png" alt="Side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p>
</li>
</ul>
</li>
<li>
<p>As mentioned in the prerequisites section, it is optional but very recommended to configure the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. If you did, in the &ldquo;Hello Arc&rdquo; application window, configure it to refresh every 2 seconds.</p>
<p><img src="./13.png" alt="&ldquo;Tab Auto Refresh&rdquo; extension"></p>
</li>
<li>
<p>In the repository window showing the <em>hello-arc.yaml</em> file, change the number of <em>replicaCount</em> to 3 as well as the the message text and commit your changes. Alternatively, you can open the forked repository in your IDE, make the change, commit and push it.</p>
<p><img src="./14.png" alt="hello-arc.yaml file"></p>
</li>
<li>
<p>Upon committing the changes, notice how the rolling upgrade starts. Once the Pods are up &amp; running, the new &ldquo;Hello Arc&rdquo; application version window will show the new messages as well as the additional pods replicas, showing the rolling upgrade is completed and the GitOps flow is successful.</p>
<p><img src="./15.png" alt="&ldquo;Hello Arc&rdquo; application rolling upgrade in terminal"></p>
<p><img src="./16.png" alt="&ldquo;Hello Arc&rdquo; application rolling upgrade in terminal"></p>
<p><img src="./17.png" alt="New side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the new application version open in a web browser"></p>
</li>
</ul>
<h2 id="cleanup">Cleanup</h2>
<ul>
<li>
<p>To delete the GitOps configuration and it&rsquo;s respective Kubernetes resources, edit the environment variables to match the Azure Arc Kubernetes cluster and Resources in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/kind/gitops/helm/az_k8sconfig_helm_cleanup_kind.sh">az_k8sconfig_helm_cleanup_kind</a> shell script.It is recommended to run this script locally, since it also removes elements from the local cluster.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">. ./az_k8sconfig_helm_cleanup_kind.sh
</code></pre></div><p><img src="./18.png" alt="Cleanup script in terminal"></p>
</li>
<li>
<p>If you also wish to remove the local kind cluster and the Arc connected cluster from Azure, you can run the following commands:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kind delete cluster --name &lt;cluster-name&gt;
az group delete -n &lt;resource group name&gt;
</code></pre></div></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-38c8e0744fcb743de272a63e7e6783d7">10.4 - Microk8s</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-149a30bbf147076ee35e812c981993fb">10.4.1 - Deploy GitOps configurations and perform Helm-based GitOps flow on MicroK8s as an Azure Arc Connected Cluster</h1>
    
	<h2 id="deploy-gitops-configurations-and-perform-helm-based-gitops-flow-on-microk8s-as-an-azure-arc-connected-cluster">Deploy GitOps configurations and perform Helm-based GitOps flow on MicroK8s as an Azure Arc Connected Cluster</h2>
<p>The following README will guide you on how to create <a href="https://helm.sh/">Helm</a>-based GitOps configuration on a <a href="https://microk8s.io/">MicroK8s</a> cluster which is projected as an Azure Arc connected cluster resource.</p>
<p>In this guide, you will first deploy a nginx ingress controller to your cluster. Then you will deploy &amp; attach a GitOps configuration to your cluster. This will be a namespace-level config to deploy the &ldquo;Hello Arc&rdquo; web application on your Kubernetes cluster.</p>
<p>By doing so, you will be able to make real-time changes to the application and show how the GitOps flow takes effect.</p>
<blockquote>
<p><strong>Note: This guide assumes you already deployed MicroK8s and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in the <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/microk8s/local_microk8s/">MicroK8s onboarding guide</a>.</strong></p>
</blockquote>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>
<p>Clone the Azure Arc Jumpstart repository</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li>
<li>
<p>Fork/Clone the <a href="https://github.com/likamrat/hello_arc">&ldquo;Hello Arc&rdquo;</a> demo application repository.</p>
</li>
<li>
<p>(Optional) Install the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. This will help you to show the real-time changes on the application in an automated way.</p>
<ul>
<li>
<p><a href="https://microsoftedge.microsoft.com/addons/detail/odiofbnciojkpogljollobmhplkhmofe">Microsoft Edge</a></p>
</li>
<li>
<p><a href="https://chrome.google.com/webstore/detail/tab-auto-refresh/jaioibhbkffompljnnipmpkeafhpicpd?hl=en">Google Chrome</a></p>
</li>
<li>
<p><a href="https://addons.mozilla.org/en-US/firefox/addon/tab-auto-refresh/">Mozilla Firefox</a></p>
</li>
</ul>
</li>
<li>
<p>As mentioned, this guide starts at the point where you already have a connected MicroK8s cluster to Azure Arc.</p>
<p><img src="./01.png" alt="Existing Azure Arc enabled Kubernetes cluster"></p>
<p><img src="./02.png" alt="Existing Azure Arc enabled Kubernetes cluster"></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az --version
</code></pre></div></li>
<li>
<p>Create Azure service principal (SP)</p>
<p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href="https://shell.azure.com/">Azure Cloud Shell</a>).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az login
az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">az ad sp create-for-rbac -n <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">&#34;appId&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;displayName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http://AzureArcK8s&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#204a87;font-weight:bold">&#34;tenant&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p>
</blockquote>
</li>
<li>
<p>Export MicroK8s config</p>
<p>You can export MicroK8s cluster config to a file and use <code>kubectl</code> directly instead of <code>microk8s kubectl</code> command.</p>
<ul>
<li>
<p>Windows</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">microk8s config view &gt; %HOMEPATH%<span style="color:#4e9a06">\.</span>kube<span style="color:#4e9a06">\m</span>icrok8s
</code></pre></div></li>
<li>
<p>Linux</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">microk8s config view &gt; ~<span style="color:#4e9a06">\.</span>kube<span style="color:#4e9a06">\m</span>icrok8s
</code></pre></div></li>
</ul>
</li>
<li>
<p>From this point forward, this guide assumes you have exported MicroK8s config file and have set it in kubectl using <code>--kubeconfig</code> flag or <code>$KUBECONFIG</code> environment variable. More information can be found in <a href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/">Organizing Cluster Access Using kubeconfig Files</a>.</p>
</li>
</ul>
<h2 id="manually-setting-up-an-ingress-controller-on-microk8s">Manually setting up an ingress controller on MicroK8s</h2>
<p>The demo application that will be deployed later in this guide relies on an ingress controller. Given that MicroK8s needs <a href="https://multipass.run/">Multipass</a> on Windows and MacOS, we&rsquo;ll be covering that scenario and assuming Multipass is running.</p>
<h2 id="nginx-controller-deployment">NGINX Controller Deployment</h2>
<ul>
<li>
<p>Run the following command to install the nginx ingress controller on MicroK8s:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.35.0/deploy/static/provider/baremetal/deploy.yaml
</code></pre></div></li>
<li>
<p>This command will create a new namespace and deploy the required components in this namespace. To verify the deployment of the ingress controller was successful, make sure the pod with name <code>ingress-nginx-controller-&lt;random id&gt;-&lt;random id&gt;</code> is in a running state with 1/1 containers ready and that a service has been exposed as NodePort.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -n ingress-nginx
</code></pre></div><p><img src="./03.png" alt="Running ingress nginx controller"></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get svc -n ingress-nginx
</code></pre></div><p><img src="./04.png" alt="Running ingress nginx controller service"></p>
</li>
<li>
<p>Take note of the port where the ingress has been exposed (in the image above it was assigned port <strong>32106</strong>). We now need to get the IP address assigned to our microk8s-vm instance in multipass:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">multipass list
</code></pre></div><p><img src="./05.png" alt="multipass list"></p>
</li>
<li>
<p>Combining the IP address from multipass and the NodePort assigned to the ingress controller, we can now test that the NGINX ingress controller has been deployed successfully. In our case, the full address becomes <em><code>http://172.22.206.155:32106</code></em>.</p>
</li>
<li>
<p>Using the below in your browser or command line, should get you with a HTTP 404 response with a nginx footer. This shows that the ingress is working. The 404 response is to be expected since you haven&rsquo;t setup an ingress route yet. You will do that in the next section.</p>
<p><img src="./06.png" alt="HTTP 404 response in a web browser"></p>
<p><img src="./07.png" alt="HTTP 404 response in a terminal"></p>
</li>
</ul>
<h2 id="cluster-level-config-vs-namespace-level-config">Cluster-level Config vs. Namespace-level Config</h2>
<h3 id="cluster-level-config">Cluster-level Config</h3>
<p>With Cluster-level GitOps config, the goal is to have &ldquo;horizontal components&rdquo; or &ldquo;management components&rdquo; deployed on your Kubernetes cluster which will then be used by your applications. Good examples are Service Meshes, Security products, Monitoring solutions, etc.</p>
<blockquote>
<p><strong>Note: You will not be creating a cluster-level config in this guide. For an example of a cluster-level configuration please refer to either the <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/day2/aks/aks_gitops_helm/">Helm-based GitOps on AKS scenario</a> or the <a href="https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/day2/gke/gke_gitops_helm/">GKE one</a>.</strong></p>
</blockquote>
<h3 id="namespace-level-config">Namespace-level Config</h3>
<p>With Namespace-level GitOps config, the goal is to have Kubernetes resources deployed only in the namespace selected. The most obvious use-case here is simply your application and its respective pods, services, ingress routes, etc. In the next section will have the &ldquo;Hello Arc&rdquo; application deployed on a dedicated namespace.</p>
<h2 id="azure-arc-kubernetes-gitops-configuration-with-helm">Azure Arc Kubernetes GitOps Configuration with Helm</h2>
<h3 id="the-mechanism-in-a-nutshell">The Mechanism (In a nutshell)</h3>
<p>In the process of creating Azure Arc enabled Kubernetes GitOps configuration, <a href="https://github.com/fluxcd/flux">Weaveworks Flux Kubernetes Operator</a> is deployed on the cluster.</p>
<p>The Operator is aware of the &ldquo;HelmRelease&rdquo; Custom Resource Definition (CRD). This HelmRelease points to a helm chart in a git repo and can optionally contain specific values to input into the helm chart. Due to this configuration, a user can choose to leave the chart values intact or to have different values for different releases.</p>
<p>For example, an application (captured in an Helm chart) dev release can have no pod replication (single pod) while a production release, using the same chart can have 3 pod replicas.</p>
<p>In the next section will use the &ldquo;Hello Arc&rdquo; Helm chart to deploy a production release which we will then change and see the results in real-time.</p>
<h3 id="deployment-flow">Deployment Flow</h3>
<p>For our scenario, we will deploy the &ldquo;Hello Arc&rdquo; application from the <a href="https://github.com/likamrat/hello_arc">&ldquo;demo repository&rdquo;</a> through GitOps. We will deploy the &ldquo;Hello Arc&rdquo; application (a Namespace-level component) with 1 replica to the <em>prod</em> namespace.</p>
<p><img src="./08.png" alt="&ldquo;Hello Arc&rdquo; application GitHub repository"></p>
<p><img src="./09.png" alt="&ldquo;Hello Arc&rdquo; application GitHub repository"></p>
<h3 id="deployment">Deployment</h3>
<p>To create the GitOps configuration and it&rsquo;s respective Kubernetes resources, we&rsquo;ve provided a script in a shell file (Linux, MacOS) and batch file (Windows).</p>
<ul>
<li>
<p>Linux and MacOS</p>
<p>Edit the environment variables in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/microk8s/gitops/helm/az_k8sconfig_helm_microk8s.sh"><em>az_k8sconfig_helm_microk8s</em></a> shell script to match your parameters, and run the below command.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">. ./az_k8sconfig_helm_microk8s.sh
</code></pre></div><blockquote>
<p><strong>Note: The extra dot is due to the script having an <em>export</em> function and that needs to have the vars exported in the same shell session as the rest of the commands.</strong></p>
</blockquote>
</li>
<li>
<p>Windows</p>
<p>Edit the environment variables in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/microk8s/gitops/helm/az_k8sconfig_helm_microk8s_windows.ps1"><em>az_k8sconfig_helm_microk8s_windows</em></a> PowerShell file to match your parameters, and run it using the <code>.\az_k8sconfig_helm_microk8s.ps1</code> command.</p>
</li>
</ul>
<p>The <code>az_k8sconfig_helm_microk8s</code> and <code>az_k8sconfig_helm_microk8s_windows</code> scripts will:</p>
<ul>
<li>
<p>Login to your Azure subscription using the SPN credentials.</p>
</li>
<li>
<p>Create the GitOps configurations for the Azure Arc Connected Cluster. The configuration will be using the Helm chart located in the &ldquo;Hello Arc&rdquo; repository. This will create a namespace-level config to deploy the &ldquo;Hello Arc&rdquo; application Helm chart.</p>
<blockquote>
<p><strong>Disclaimer: For the purpose of this guide, notice how the &ldquo;<em>git-poll-interval 3s</em>&rdquo; is set. The 3 seconds interval is useful for demo purposes since it will make the git-poll interval to rapidly track changes on the repository but it is recommended to have longer interval in your production environment (default value is 5min)</strong></p>
</blockquote>
</li>
<li>
<p>Once the script will complete its run, you will have the GitOps configuration created and all the resources deployed in your local MicroK8s Kubernetes cluster.</p>
<blockquote>
<p><strong>Note: it can take a few minutes for the configuration to change its Operator state status from &ldquo;Pending&rdquo; to &ldquo;Installed&rdquo;.</strong></p>
</blockquote>
<p><img src="./10.png" alt="New GitOps configuration created"></p>
<p><img src="./11.png" alt="New GitOps configuration created"></p>
</li>
<li>
<p>The Namespace-level config initiated the &ldquo;Hello Arc&rdquo; Pod (1 replica), Service and Ingress Route resource deployment.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -n prod
kubectl get svc -n prod
kubectl get ing -n prod
</code></pre></div><p><img src="./12.png" alt="&ldquo;Hello Arc&rdquo; application deployed"></p>
</li>
</ul>
<h2 id="initiating-hello-arc-application-gitops">Initiating &ldquo;Hello Arc&rdquo; Application GitOps</h2>
<ul>
<li>
<p>The GitOps flow works as follow:</p>
<ol>
<li>
<p>The Flux operator holds the &ldquo;desired state&rdquo; of the &ldquo;Hello Arc&rdquo; Helm release. This is the configuration we deployed against the Azure Arc connected cluster. The operator will pull the state of the releases in the repository every 3 seconds.</p>
</li>
<li>
<p>Changing the application release will trigger the Flux operator to kick-in the GitOps flow. In our case, we will be changing the welcome message and the amount of replicas.</p>
</li>
<li>
<p>A new version of the application will be deployed on the cluster with more replicas as configured. Once the new pods are successfully deployed, the old ones will be terminated (rolling upgrade).</p>
</li>
</ol>
</li>
<li>
<p>To show the above flow, open 2 (ideally 3) side-by-side windows:</p>
<ul>
<li>
<p>Local shell running <code>kubectl get pods -n prod -w</code></p>
</li>
<li>
<p>In your own repository fork, open the &ldquo;Hello Arc&rdquo; <a href="https://github.com/likamrat/hello_arc/blob/master/releases/prod/hello-arc.yaml"><em>hello-arc.yaml</em></a> Helm release file.</p>
</li>
<li>
<p>Another browser window that has the webpage <a href="http://172.22.206.155:32106">http://172.22.206.155:32106</a> open <strong>(replace with your own values)</strong></p>
</li>
<li>
<p>End result should look like this:</p>
<p><img src="./13.png" alt="Side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p>
</li>
</ul>
</li>
<li>
<p>As mentioned in the prerequisites section, it is optional but very recommended to configure the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. If you did, in the &ldquo;Hello Arc&rdquo; application window, configure it to refresh every 2 seconds.</p>
<p><img src="./14.png" alt="&ldquo;Tab Auto Refresh&rdquo; extension"></p>
</li>
<li>
<p>In the repository window showing the <em>hello-arc.yaml</em> file, change the number of <em>replicaCount</em> to 3 as well as the the message text and commit your changes. Alternatively, you can open the forked repository in your IDE, make the change, commit and push it.</p>
<p><img src="./15.png" alt="hello-arc.yaml file"></p>
</li>
<li>
<p>Upon committing the changes, notice how the rolling upgrade starts. Once the Pods are up &amp; running, the new &ldquo;Hello Arc&rdquo; application version window will show the new messages as well as the additional pods replicas, showing the rolling upgrade is completed and the GitOps flow is successful.</p>
<p><img src="./16.png" alt="&ldquo;Hello Arc&rdquo; application rolling upgrade in terminal"></p>
<p><img src="./17.png" alt="&ldquo;Hello Arc&rdquo; application rolling upgrade in terminal"></p>
<p><img src="./18.png" alt="New side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the new application version open in a web browser"></p>
</li>
</ul>
<h2 id="cleanup">Cleanup</h2>
<p>To delete the GitOps configuration and it&rsquo;s respective Kubernetes resources, we&rsquo;ve provided a script in a shell file (Linux, MacOS) and a PowerShell file (Windows). It is recommended to run this script locally, since it also removes elements from the local cluster.</p>
<ul>
<li>
<p>Linux and MacOS</p>
<p>Edit the environment variables to match the Azure Arc Kubernetes cluster and Resources in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/microk8s/gitops/helm/az_k8sconfig_helm_cleanup_microk8s.sh">az_k8sconfig_helm_cleanup_microk8s</a> shell script, then run the file:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">./az_k8sconfig_helm_cleanup_microk8s.sh
</code></pre></div></li>
<li>
<p>Windows</p>
<p>Edit the environment variables to match the Azure Arc Kubernetes cluster and Resources in the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/microk8s/gitops/helm/az_k8sconfig_helm_cleanup_microk8s_windows.ps1">az_k8sconfig_helm_cleanup_microk8s_windows</a> script, then run the file:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">.<span style="color:#4e9a06">\a</span>z_k8sconfig_helm_cleanup_microk8s_windows.ps1
</code></pre></div></li>
<li>
<p>You should see the resources being deleted:</p>
<p><img src="./19.png" alt="Cleanup script in terminal"></p>
</li>
<li>
<p>If you also wish to remove the local MicroK8s cluster and the Arc connected cluster from Azure, please refer to the <a href="https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/microk8s/gitops/helm/az_k8sconfig_helm_cleanup_microk8s_windows.ps1">Delete the Deployment section</a> in the onboarding guide.</p>
</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://example.org/mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://example.org/twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://example.org/stack">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://github.com/google/docsy">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://example.org/slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://example.org/mail">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 The Docsy Authors All Rights Reserved</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank">Privacy Policy</a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>











<script src="/js/main.min.b5fc1b29d2465835844254bd4d804738eaf24c0cec53009b4c6899989be55a47.js" integrity="sha256-tfwbKdJGWDWEQlS9TYBHOOryTAzsUwCbTGiZmJvlWkc=" crossorigin="anonymous"></script>




  </body>
</html>

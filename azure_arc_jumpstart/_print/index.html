<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.80.0"><link rel=canonical type=text/html href=/azure_arc_jumpstart/><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Azure Arc Jumpstart Scenarios | Goldydocs</title><meta property="og:title" content="Azure Arc Jumpstart Scenarios"><meta property="og:description" content="A Docsy example site"><meta property="og:type" content="website"><meta property="og:url" content="/azure_arc_jumpstart/"><meta property="og:site_name" content="Goldydocs"><meta itemprop=name content="Azure Arc Jumpstart Scenarios"><meta itemprop=description content="A Docsy example site"><meta name=twitter:card content="summary"><meta name=twitter:title content="Azure Arc Jumpstart Scenarios"><meta name=twitter:description content="A Docsy example site"><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-00000000-0','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=preload href=/scss/main.min.4aec00cbc82dae02258a2ba135990358146339f666dc47346f0f1e49d7a6fa42.css as=style><link href=/scss/main.min.4aec00cbc82dae02258a2ba135990358146339f666dc47346f0f1e49d7a6fa42.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zM197.0804 232.033c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zM197.0839 232.0372c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zM197.0839 232.0372c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zM197.0804 177.6188c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zM197.0839 177.623c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zM197.0839 177.623c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zM197.5309 286.4723c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zM197.5344 286.4765c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zM197.5344 286.4765c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zM197.0804 340.5784c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zM197.0839 340.5826c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zM197.0839 340.5826c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">Goldydocs</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/no/>Norsk</a>
<a class=dropdown-item href=/fa/>فارسی</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="print();return false;">Click here to print</a>.</p><p><a href=/azure_arc_jumpstart/>Return to the regular view of this page</a>.</p></div><h1 class=title>Azure Arc Jumpstart Scenarios</h1><ul><li>1: <a href=#pg-2ed30b2aab931bda1708f55e40fff7d3>Azure Arc enabled servers</a></li><ul><li>1.1: <a href=#pg-f50dbb11f22a2dab04f22fe2fb8d6e85>Onboarding</a></li><ul><li>1.1.1: <a href=#pg-b0d3d4fad0fd4018d3b43ec4bde91047>Existing Linux server</a></li><ul></ul><li>1.1.2: <a href=#pg-41648d31abfbcdd577d255c0d8740968>Existing Windows server</a></li><ul></ul></ul><li>1.2: <a href=#pg-824fa04b9d283e1e5725dc43e7215bc2>Microsoft Azure</a></li><ul><li>1.2.1: <a href=#pg-4786344b95bcdfe23de1ab08ae70a0a6>Linux Virtual Machine</a></li><ul></ul><li>1.2.2: <a href=#pg-38881774a1c7c94d3b31a8907926b998>Windows Server Virtual Machine</a></li><ul></ul></ul><li>1.3: <a href=#pg-42ec827fb753e202548a5a81de66076c>HashiCorp Vagrant</a></li><ul><li>1.3.1: <a href=#pg-6977b8e9fbf0de3c5e928d5025026e8c>Ubuntu Vagrant box</a></li><ul></ul><li>1.3.2: <a href=#pg-bc5683d9bbb43663a4b1455cd48f61ea>Windows Vagrant box</a></li><ul></ul></ul><li>1.4: <a href=#pg-9a3473e6423ee4c24673e9cd153d9658>Amazon Web Services</a></li><ul><li>1.4.1: <a href=#pg-fc1f094c01d528ff3519c6ccebdccfff>Ubuntu EC2 instance</a></li><ul></ul><li>1.4.2: <a href=#pg-95541056e5a6754e9f9e64a085445d0f>Amazon Linux 2 EC2 instance</a></li><ul></ul></ul><li>1.5: <a href=#pg-7064577bc1b93c68f79cd424bda7f426>Google Cloud Platform</a></li><ul><li>1.5.1: <a href=#pg-d042d13faf89faf82810b281cfa42258>Ubuntu GCP instance</a></li><ul></ul><li>1.5.2: <a href=#pg-a692f8c5cd59332abe3227bb76485698>Windows GCP instance</a></li><ul></ul></ul><li>1.6: <a href=#pg-5b91b658f8abbc63f40d299548f9cb0e>VMware vSphere</a></li><ul><li>1.6.1: <a href=#pg-e56462edb69ef5a1281ec6e2129b4745>Ubuntu VM</a></li><ul><li>1.6.1.1: <a href=#pg-35f5273e1310f62b1fd14f656ada12a2>Create Ubuntu vSphere template</a></li><ul></ul></ul><li>1.6.2: <a href=#pg-7ede8ac96598e3cbc19ecd306e0933fe>Windows VM</a></li><ul><li>1.6.2.1: <a href=#pg-445074e741930bddb3d57e908f6dcc90>Create Windows vSphere template</a></li><ul></ul></ul></ul><li>1.7: <a href=#pg-0234ac16eaff72421179b07a80c54256>Unified Operations Use Cases</a></li><ul><li>1.7.1: <a href=#pg-f662c3c6424f0e3f7be88762438f027f>Inventory Tagging</a></li><ul></ul><li>1.7.2: <a href=#pg-caccbcbc963315fae066659de1818715>Monitoring Agent Extension</a></li><ul></ul><li>1.7.3: <a href=#pg-8a7b8f2b3e4ec67d3a0eede84e3eae93>Custom Script Extension</a></li><ul></ul><li>1.7.4: <a href=#pg-4bcf5ee34563db9860f2594f7c5d636a>Azure Policy</a></li><ul></ul><li>1.7.5: <a href=#pg-1960d9874e7502df863af9a46f8cae84>Key Vault Integration</a></li><ul></ul><li>1.7.6: <a href=#pg-eda68bcba3c1263207b730fff996799e>Security Center</a></li><ul></ul><li>1.7.7: <a href=#pg-50dbeacfd1099752a6b9ae86ffca6b70>Azure Sentinel</a></li><ul></ul><li>1.7.8: <a href=#pg-16e609be239099590da0beb9af17b4c5>Update Management</a></li><ul></ul></ul><li>1.8: <a href=#pg-8683b32c638509b66c8a8d83ce8e8dd1>Scaled Deployment</a></li><ul><li>1.8.1: <a href=#pg-3232c0522cad0a1e82efd628559a3a01>VMware vSphere Windows Server VMs</a></li><ul></ul><li>1.8.2: <a href=#pg-6505de5782967c0e0060cc85e4dbaf9a>VMware vSphere Linux VMs</a></li><ul></ul><li>1.8.3: <a href=#pg-c74d41f4582660136f72b61a4784fa21>AWS EC2 dynamic inventory with Ansible</a></li><ul></ul></ul></ul><li>2: <a href=#pg-bf179d00a56c61c4fb23242e6434c738>Azure Arc enabled SQL Server</a></li><ul><li>2.1: <a href=#pg-c12c951b6c375f80f7847834cdcc8abd>Microsoft Azure</a></li><ul><li>2.1.1: <a href=#pg-7e6a22f521dd06e37a0862afc3cc5a51>SQL Server Virtual Machine</a></li><ul></ul></ul><li>2.2: <a href=#pg-cfa90491acfc4183e3edd8811ffcda55>Amazon Web Services</a></li><ul><li>2.2.1: <a href=#pg-1c7623fa022f4e3eda2af8b035cbb220>SQL Server EC2 instance</a></li><ul></ul></ul><li>2.3: <a href=#pg-48665cd3821fc3cb6a56e5bf4a7b1700>Google Cloud Platform</a></li><ul><li>2.3.1: <a href=#pg-902ce380d3ffe6b2389dbb5f0587b0ec>SQL Server GCP instance</a></li><ul></ul></ul><li>2.4: <a href=#pg-c2f7cf1f325670d4b3c331a6b7955873>VMware vSphere</a></li><ul><li>2.4.1: <a href=#pg-d522c677fb3694c8b330c3549f9e9cb2>SQL Server VM</a></li><ul></ul></ul></ul><li>3: <a href=#pg-2002d72914137e61c4c0f458cae83603>Azure Arc enabled Kubernetes</a></li><ul><li>3.1: <a href=#pg-b5702fde6357d066dbe4fb888521f927>Onboarding</a></li><ul><li>3.1.1: <a href=#pg-8e99abf7a2c151b8574581f07908c165>Existing cluster</a></li><ul></ul></ul><li>3.2: <a href=#pg-4058c92f46090baba44b0e09d635676b>Azure Kubernetes Service</a></li><ul><li>3.2.1: <a href=#pg-c2630ddab80d3d6d1693e2416207a76a>AKS cluster ARM template</a></li><ul></ul><li>3.2.2: <a href=#pg-468b4e879c0975ed6583c45f5657a0cc>AKS cluster Terraform plan</a></li><ul></ul></ul><li>3.3: <a href=#pg-3e05fff6e5f9edc84a1c1f7e7cbd6a89>Amazon Elastic Kubernetes Service</a></li><ul><li>3.3.1: <a href=#pg-5e17a5ecfaf4883b327e3a3a5a173c93>EKS cluster Terraform plan</a></li><ul></ul></ul><li>3.4: <a href=#pg-28b2918a0d905681a5ba4bb5b347ea47>Google Kubernetes Engine</a></li><ul><li>3.4.1: <a href=#pg-7b3417c1127106046a16ebb3ce567134>GKE cluster Terraform plan</a></li><ul></ul></ul><li>3.5: <a href=#pg-a57a5382ffb7c67c0e8f32e5cd7bda2f>Kubernetes Cluster API</a></li><ul><li>3.5.1: <a href=#pg-19ad9d47852711a9ec0dfb3405805685>Azure Provider</a></li><ul></ul></ul><li>3.6: <a href=#pg-ce8c5dc601de838593a9b6be96998df3>Rancher K3s</a></li><ul><li>3.6.1: <a href=#pg-6b79ac779a90e2d51c854647ee30fd19>k3s Azure ARM template</a></li><ul></ul><li>3.6.2: <a href=#pg-d56ecc40c26e1cc0f12f4d0304905c81>k3s Azure Terraform plan</a></li><ul></ul><li>3.6.3: <a href=#pg-cff71fdb229d543e558525c8c80283d9>k3s on VMware Terraform plan</a></li><ul></ul></ul><li>3.7: <a href=#pg-aaac4d3169279a7ae1691c0c9b59ec53>Azure Red Hat OpenShift</a></li><ul><li>3.7.1: <a href=#pg-b00ec34618f4a7c6c0cefb270ee9bd59>ARO Cluster</a></li><ul></ul></ul><li>3.8: <a href=#pg-715d96aca7ade3fe976071e1cd0ba8e0>Kind</a></li><ul><li>3.8.1: <a href=#pg-26e6fd581cdac268f933c80f67cb66ed>Kind cluster</a></li><ul></ul></ul><li>3.9: <a href=#pg-d7bef51078e0d72deaa1a59c8907857a>MicroK8s</a></li><ul><li>3.9.1: <a href=#pg-4e867e92b2a5802eefb8ffa06426f985>MicroK8s cluster</a></li><ul></ul></ul><li>3.10: <a href=#pg-1d0f8542d6157eb9642fa1e8bba23a9d>Unified Operations Use Cases</a></li><ul><li>3.10.1: <a href=#pg-4d3df2981d26d03a22ca357944650885>AKS</a></li><ul><li>3.10.1.1: <a href=#pg-44610c6b5316b3f8cd2b84332697b1c4>Deploy GitOps configurations and perform basic GitOps flow on AKS as an Azure Arc Connected Cluster</a></li><ul></ul><li>3.10.1.2: <a href=#pg-c88c142dc87e09357d590b49fc212f80>Deploy GitOps configurations and perform Helm-based GitOps flow on AKS as an Azure Arc Connected Cluster</a></li><ul></ul><li>3.10.1.3: <a href=#pg-cdb23c16630e70509b44b66208dbc024>Integrate Azure Monitor for Containers with AKS as an Azure Arc Connected Cluster</a></li><ul></ul><li>3.10.1.4: <a href=#pg-0ab2c80854e6dbba2714dfe7f5623dd0>Apply GitOps configurations on AKS as an Azure Arc Connected Cluster using Azure Policy for Kubernetes</a></li><ul></ul></ul><li>3.10.2: <a href=#pg-ecb095d0322798ee5c46b4a8223b12cf>GKE</a></li><ul><li>3.10.2.1: <a href=#pg-d457b58c7bf722d2347deaef42e48f9f>Deploy GitOps configurations and perform basic GitOps flow on GKE as an Azure Arc Connected Cluster</a></li><ul></ul><li>3.10.2.2: <a href=#pg-185c98c7d0c0e36f4297a126b0d881f3>Deploy GitOps configurations and perform Helm-based GitOps flow on GKE as an Azure Arc Connected Cluster</a></li><ul></ul><li>3.10.2.3: <a href=#pg-de11c18b0e8549b41c0a88fa1af98a22>Integrate Azure Monitor for Containers with GKE as an Azure Arc Connected Cluster</a></li><ul></ul><li>3.10.2.4: <a href=#pg-aff3a2239473fef2a378434ef6640e2c>Apply GitOps configurations on GKE as an Azure Arc Connected Cluster using Azure Policy for Kubernetes</a></li><ul></ul></ul><li>3.10.3: <a href=#pg-35f95ff005abe064acf384005986b669>Kind</a></li><ul><li>3.10.3.1: <a href=#pg-37841f0de5e94de64c5a1f739f9f2f89>Deploy GitOps configurations and perform Helm-based GitOps flow on kind as an Azure Arc Connected Cluster</a></li><ul></ul></ul><li>3.10.4: <a href=#pg-38c8e0744fcb743de272a63e7e6783d7>Microk8s</a></li><ul><li>3.10.4.1: <a href=#pg-149a30bbf147076ee35e812c981993fb>Deploy GitOps configurations and perform Helm-based GitOps flow on MicroK8s as an Azure Arc Connected Cluster</a></li><ul></ul></ul></ul></ul><li>4: <a href=#pg-5ab6b24072ecc818fea52358b4b7ec35>Azure Arc enabled data services</a></li><ul><li>4.1: <a href=#pg-a8de654c4e1024d6d7b2cfcfce45536b>Azure Kubernetes Service</a></li><ul><li>4.1.1: <a href=#pg-cf0bb7467ca6126c55bbde86783f5e54>Data Controller ARM Template</a></li><ul></ul><li>4.1.2: <a href=#pg-38c79c16af3e1716130983a099acb141>SQL Managed Instance ARM Template</a></li><ul></ul><li>4.1.3: <a href=#pg-c090c91194a8bca318c0a3d2f5811a40>PostgreSQL Hyperscale ARM Template</a></li><ul></ul></ul><li>4.2: <a href=#pg-d70863f525996f26010a52ca274a8bce>Amazon Elastic Kubernetes Service</a></li><ul><li>4.2.1: <a href=#pg-8837fdad1692ac50843da72c4bec59a5>Data Controller Terraform plan</a></li><ul></ul></ul><li>4.3: <a href=#pg-b0a3ec2e3953376bf0aa17e63f36c93c>Google Kubernetes Engine</a></li><ul><li>4.3.1: <a href=#pg-b8cb9eadc7cc3146b19781c3ed7d36cc>Data Controller Terraform plan</a></li><ul></ul></ul><li>4.4: <a href=#pg-afa54bcc6f5679cb5d63462c1eff04a6>Upstream Kubernetes (Kubeadm)</a></li><ul><li>4.4.1: <a href=#pg-2112d779f6fa22c76cef146c2063f97c>Data Controller Azure VM ARM Template</a></li><ul></ul></ul></ul></ul><div class=content></div></div><div class=td-content><h1 id=pg-2ed30b2aab931bda1708f55e40fff7d3>1 - Azure Arc enabled servers</h1><div class=lead>The deployment scenarios in this section will guide you through onboarding various Windows and Linux server distributions as Azure Arc enabled servers.</div></div><div class=td-content><h1 id=pg-f50dbb11f22a2dab04f22fe2fb8d6e85>1.1 - Onboarding</h1><div class=lead>The scenarios in this section can be used to onboard your existing Windows or Linux servers as Azure Arc enabled servers.</div></div><div class=td-content><h1 id=pg-b0d3d4fad0fd4018d3b43ec4bde91047>1.1.1 - Existing Linux server</h1><h2 id=connect-an-existing-linux-server-to-azure-arc>Connect an existing Linux server to Azure Arc</h2><p>The following README will guide you on how to connect an Linux server to Azure Arc using a simple shell script.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Create Azure service principal (SP)</p><p>To connect a server to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Create a new Azure resource group where you want your server(s) to show up.</p><p><img src=./01.png alt="Screenshot showing Azure Portal with empty resource group"></p></li><li><p>Download the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/scripts/az_connect_linux.sh>az_connect_linux</a> shell script.</p></li><li><p>Change the environment variables according to your environment.</p><p><img src=./02.png alt="Screenshot showing az_connect_linux shell script"></p></li><li><p>Copy the script to the designated server using your preferred tool of choice (or copy/paste the script to a new file inside the server). Below example shows copy the script from MacOS to the server using SCP.</p><p><img src=./03.png alt="Screenshot showing scp being run"></p></li></ul><h2 id=deployment>Deployment</h2><p>Run the script using the <code>. ./az_connect_linux.sh</code> command.</p><blockquote><p><strong>Note: The extra dot is due to the script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p></blockquote><p>Upon completion, you will have your Linux server, connected as a new Azure Arc resource inside your resource group.</p><p><img src=./04.png alt="Screenshot showing az_connect_linux script being run"></p><p><img src=./05.png alt="Screenshot showing Azure Portal with Azure Arc enabled resource"></p><p><img src=./06.png alt="Screenshot showing Azure Portal with Azure Arc enabled resource detail"></p><h2 id=delete-the-deployment>Delete the deployment</h2><p>The most straightforward way is to delete the server via the Azure Portal, just select server and delete it.</p><p><img src=./07.png alt="Screenshot showing delete resource function in Azure Portal"></p><p>If you want to nuke the entire environment, just delete the Azure resource group.</p><p><img src=./08.png alt="Screenshot showing delete resource group function in Azure Portal"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-41648d31abfbcdd577d255c0d8740968>1.1.2 - Existing Windows server</h1><h2 id=connect-an-existing-windows-server-to-azure-arc>Connect an existing Windows server to Azure Arc</h2><p>The following README will guide you on how to connect an Windows machine to Azure Arc using a simple PowerShell script.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Create Azure service principal (SP)</p><p>To connect a server to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Create a new Azure resource group where you want your machine(s) to show up.</p><p><img src=./01.png alt="Screenshot showing Azure Portal with empty resource group"></p></li><li><p>Download the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/scripts/az_connect_win.ps1>az_connect_win</a> PowerShell script.</p></li><li><p>Change the environment variables according to your environment and copy the script to the designated machine.</p><p><img src=./02.png alt="Screenshot showing PowerShell script"></p></li></ul><h2 id=deployment>Deployment</h2><p>On the designated machine, Open PowerShell ISE <strong>as Administrator</strong> and run the script. Note the script is using <em>$env:ProgramFiles</em> as the agent installation path so make sure <strong>you are not using PowerShell ISE (x86)</strong>.</p><p><img src=./03.png alt="Screenshot showing PowerShell script"></p><p><img src=./04.png alt="Screenshot showing PowerShell script"></p><p>Upon completion, you will have your Windows server, connected as a new Azure Arc resource inside your resource group.</p><p><img src=./05.png alt="Screenshot showing PowerShell script being run"></p><p><img src=./06.png alt="Screenshot showing Azure Portal with Azure Arc enabled server resource"></p><p><img src=./07.png alt="Screenshot showing Azure Portal with Azure Arc enabled server resource detail"></p><h2 id=delete-the-deployment>Delete the deployment</h2><p>The most straightforward way is to delete the server via the Azure Portal, just select server and delete it.</p><p><img src=./08.png alt="Screenshot showing delete resource function in Azure Portal"></p><p>If you want to delete the entire environment, just delete the Azure resource group.</p><p><img src=./09.png alt="Screenshot showing delete resource group function in Azure Portal"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-824fa04b9d283e1e5725dc43e7215bc2>1.2 - Microsoft Azure</h1><div class=lead>The scenarios in this section will walk you through how to project an Azure VM as an Azure Arc enabled server in an automated fashion using either ARM templates or Terraform. These scenarios, using Azure VM as the targeted Azure Arc server are designed <strong>for demo and testing purposes ONLY and are not supported.</strong>
In each scenario, you will find a detailed, technical explanation of the mechanism and why <strong>it is not expected to project an Azure VM as an Azure Arc enabled server.</strong></div></div><div class=td-content><h1 id=pg-4786344b95bcdfe23de1ab08ae70a0a6>1.2.1 - Linux Virtual Machine</h1><h2 id=deploy-an-ubuntu-azure-virtual-machine-and-connect-it-to-azure-arc-using-arm-template>Deploy an Ubuntu Azure Virtual Machine and connect it to Azure Arc using ARM Template</h2><p>The following README will guide you on how to automatically onboard a Azure Ubuntu VM on to Azure Arc using <a href=https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview>Azure ARM Template</a>. The provided ARM template is responsible of creating the Azure resources as well as executing the Azure Arc onboard script on the VM.</p><p>Azure VMs are leveraging the <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service>Azure Instance Metadata Service (IMDS)</a> by default. By projecting an Azure VM as an Azure Arc enabled server, a &ldquo;conflict&rdquo; is created which will not allow for the Azure Arc server resources to be represented as one when the IMDS is being used and instead, the Azure Arc server will still &ldquo;act&rdquo; as a native Azure VM.</p><p>However, <strong>for demo purposes only</strong>, the below guide will allow you to use and onboard Azure VMs to Azure Arc and by doing so, you will be able to simulate a server which is deployed outside of Azure (i.e &ldquo;on-premises&rdquo; or in other cloud platforms)</p><blockquote><p><strong>Note: It is not expected for an Azure VM to be projected as an Azure Arc enabled server. The below scenario is unsupported and should ONLY be used for demo and testing purposes.</strong></p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>In case you don&rsquo;t already have one, you can <a href=https://azure.microsoft.com/en-us/free/>Create a free Azure account</a>.</p></li><li><p>Create Azure service principal (SP).</p><p>In order for you to deploy the Azure resources using the ARM template, Azure service principal assigned with the &ldquo;contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: it is optional, but highly recommended, to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a>.</strong></p></blockquote></li></ul><h2 id=automation-flow>Automation Flow</h2><p>For you to get familiar with the automation and deployment flow, below is an explanation.</p><ol><li><p>User is editing the ARM template parameters file (1-time edit). These parameters values are being used throughout the deployment.</p></li><li><p>The ARM template includes an Azure VM custom script extension which will deploy the the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/azure/linux/arm_template/scripts/install_arc_agent.sh><em>install_arc_agent.sh</em></a> Shell script.</p></li><li><p>In order to allow the Azure VM to successfully be projected as an Azure Arc enabled server, the script will:</p><ol><li><p>Set local OS environment variables.</p></li><li><p>Generate a ~/.bash_profile file that will be initialized at user&rsquo;s first login to configure the environment. This script will:</p><ul><li><p>Stop and disable the &ldquo;Linux Azure Guest Agent&rdquo; service.</p></li><li><p>Create a new OS Firewall rule to block Azure IMDS outbound traffic to the <em>169.254.169.254</em> remote address.</p></li><li><p>Install the Azure Arc connected machine agent.</p></li><li><p>Remove the ~/.bash_profile file so it will not run after first login.</p></li></ul></li></ol></li><li><p>User SSH to Linux VM which will start the <em>~/.bash_profile</em> script execution and will onboard the VM to Azure Arc</p><blockquote><p><strong>Note: The <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/azure/linux/arm_template/scripts/install_arc_agent.sh><em>install_arc_agent.sh</em></a> shell script will enable the OS firewall and set up new rules for incoming and outgoing connections. By default all incoming and outgoing traffic will be allowed, except blocking Azure IMDS outbound traffic to the <em>169.254.169.254</em> remote address.</strong></p></blockquote></li></ol><h2 id=deployment>Deployment</h2><p>As mentioned, this deployment will leverage ARM templates. You will deploy a single template, responsible for creating all the Azure resources in a single resource group as well onboarding the created VM to Azure Arc.</p><ul><li><p>Before deploying the ARM template, login to Azure using AZ CLI with the <code>az login</code> command.</p></li><li><p>The deployment is using the ARM template parameters file. Before initiating the deployment, edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/azure/linux/arm_template/azuredeploy.parameters.json><em>azuredeploy.parameters.json</em></a> file located in your local cloned repository folder. An example parameters file is located <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/azure/linux/arm_template/azuredeploy.parameters.example.json>here</a>.</p></li><li><p>To deploy the ARM template, navigate to the local cloned <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_servers_jumpstart/azure/linux/arm_template>deployment folder</a> and run the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name &lt;Name of the Azure resource group&gt; --location &lt;Azure region&gt; --tags <span style=color:#4e9a06>&#34;Project=jumpstart_azure_arc_servers&#34;</span>
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name &lt;The name of this deployment&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_servers_jumpstart/azure/linux/arm_template/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters &lt;The *azuredeploy.parameters.json* parameters file location&gt;
</code></pre></div><blockquote><p><strong>Note: make sure that you are using the same Azure resource group name as the one you&rsquo;ve just used in the <em>azuredeploy.parameters.json</em> file</strong></p></blockquote><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name Arc-Servers-Linux-Demo --location <span style=color:#4e9a06>&#34;westeurope&#34;</span> --tags <span style=color:#4e9a06>&#34;Project=jumpstart_azure_arc_servers&#34;</span>
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group Arc-Servers-Linux-Demo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name arclinuxdemo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_servers_jumpstart/azure/linux/arm_template/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters azuredeploy.parameters.json
</code></pre></div></li><li><p>Once Azure resources has been provisioned, you will be able to see it in Azure portal.</p><p><img src=./01.png alt="Screenshot output of ARM template"></p><p><img src=./02.png alt="Screenshot resources in resource group"></p></li></ul><h2 id=linux-login--post-deployment>Linux Login & Post Deployment</h2><ul><li><p>Now that the Linux VM is created, it is time to login to it. Using its public IP, SSH to the VM.</p><p><img src=./03.png alt="Screenshot Azure VM public IP address"></p></li><li><p>At first login, as mentioned in the &ldquo;Automation Flow&rdquo; section, a logon script will get executed. This script was created as part of the automated deployment process.</p></li><li><p>Let the script to run its course and <strong>do not close</strong> the SSH session, this will be done for you once completed.</p><p><img src=./04.png alt="Screenshot script output"></p><p><img src=./05.png alt="Screenshot script output"></p><p><img src=./06.png alt="Screenshot script output"></p></li><li><p>Upon successful run, a new Azure Arc enabled server will be added to the resource group.</p><p><img src=./07.png alt="Screenshot Azure Arc resource on the Azure portal"></p><p><img src=./08.png alt="Screenshot details of Azure Arc enabled server on Azure portal"></p></li></ul><h2 id=cleanup>Cleanup</h2><p>To delete the entire deployment, simply delete the resource group from the Azure portal.</p><p><img src=./09.png alt="Screenshot how to delete resource group"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-38881774a1c7c94d3b31a8907926b998>1.2.2 - Windows Server Virtual Machine</h1><h2 id=deploy-a-windows-azure-virtual-machine-and-connect-it-to-azure-arc-using-an-arm-template>Deploy a Windows Azure Virtual Machine and connect it to Azure Arc using an ARM Template</h2><p>The following README will guide you on how to automatically onboard a Azure Windows VM on to Azure Arc using <a href=https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview>Azure ARM Template</a>. The provided ARM template is responsible of creating the Azure resources as well as executing the Azure Arc onboard script on the VM.</p><p>Azure VMs are leveraging the <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service>Azure Instance Metadata Service (IMDS)</a> by default. By projecting an Azure VM as an Azure Arc enabled server, a &ldquo;conflict&rdquo; is created which will not allow for the Azure Arc server resources to be represented as one when the IMDS is being used and instead, the Azure Arc server will still &ldquo;act&rdquo; as a native Azure VM.</p><p>However, <strong>for demo purposes only</strong>, the below guide will allow you to use and onboard Azure VMs to Azure Arc and by doing so, you will be able to simulate a server which is deployed outside of Azure (i.e &ldquo;on-premises&rdquo; or in other cloud platforms)</p><blockquote><p><strong>Note: It is not expected for an Azure VM to be projected as an Azure Arc enabled server. The below scenario is unsupported and should ONLY be used for demo and testing purposes.</strong></p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>In case you don&rsquo;t already have one, you can <a href=https://azure.microsoft.com/en-us/free/>Create a free Azure account</a>.</p></li><li><p>Create Azure service principal (SP)</p><p>In order for you to deploy the Azure resources using the ARM template, Azure service principal assigned with the &ldquo;contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional, but highly recommended, to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a>.</strong></p></blockquote></li></ul><h2 id=automation-flow>Automation Flow</h2><p>For you to get familiar with the automation and deployment flow, below is an explanation.</p><ol><li><p>User is editing the ARM template parameters file (one time edit). These parameters values are being used throughout the deployment.</p></li><li><p>The ARM template incl. an Azure VM custom script extension which will deploy the the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/azure/windows/arm_template/scripts/install_arc_agent.ps1><em>install_arc_agent.ps1</em></a> PowerShell script.</p></li><li><p>In order to allow the Azure VM to successfully be projected as an Azure Arc enabled server, the script will:</p><ol><li><p>Set local OS environment variables.</p></li><li><p>Generate a local OS logon script named <em>LogonScript.ps1</em>. This script will:</p><ul><li><p>Create the <em>LogonScript.log</em> file.</p></li><li><p>Stop and disable the &ldquo;Windows Azure Guest Agent&rdquo; service.</p></li><li><p>Create a new Windows Firewall rule to block Azure IMDS outbound traffic to the <em>169.254.169.254</em> remote address.</p></li><li><p>Unregister the logon script Windows schedule task so it will not run after first login.</p></li></ul></li><li><p>Disable and prevent Windows Server Manager from running on startup.</p></li></ol></li><li><p>User RDP to Windows VM which will start the <em>LogonScript</em> script execution and will onboard the VM to Azure Arc.</p></li></ol><h2 id=deployment>Deployment</h2><p>As mentioned, this deployment will leverage ARM templates. You will deploy a single template, responsible for creating all the Azure resources in a single resource group as well onboarding the created VM to Azure Arc.</p><ul><li><p>Before deploying the ARM template, login to Azure using Azure CLI with the <code>az login</code> command.</p></li><li><p>The deployment is using the ARM template parameters file. Before initiating the deployment, edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/azure/windows/arm_template/azuredeploy.parameters.json><em>azuredeploy.parameters.json</em></a> file located in your local cloned repository folder. An example parameters file is located <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/azure/windows/arm_template/azuredeploy.parameters.example.json>here</a>.</p></li><li><p>To deploy the ARM template, navigate to the local cloned <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_servers_jumpstart/azure/windows/arm_template>deployment folder</a> and run the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name &lt;Name of the Azure resource group&gt; --location &lt;Azure Region&gt; --tags <span style=color:#4e9a06>&#34;Project=jumpstart_azure_arc_servers&#34;</span>
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name &lt;The name of this deployment&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_servers_jumpstart/azure/windows/arm_template/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters &lt;The *azuredeploy.parameters.json* parameters file location&gt;
</code></pre></div><blockquote><p><strong>Note: Make sure that you are using the same Azure resource group name as the one you&rsquo;ve just used in the <em>azuredeploy.parameters.json</em> file</strong></p></blockquote><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name Arc-Servers-Win-Demo --location <span style=color:#4e9a06>&#34;East US&#34;</span> --tags <span style=color:#4e9a06>&#34;Project=jumpstart_azure_arc_servers&#34;</span>
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group Arc-Servers-Win-Demo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name arcwinsrvdemo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_servers_jumpstart/azure/windows/arm_template/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters azuredeploy.parameters.json
</code></pre></div></li><li><p>Once Azure resources has been provisioned, you will be able to see it in Azure portal.</p><p><img src=./01.jpg alt="Screenshot ARM template output"></p><p><img src=./02.jpg alt="Screenshot resources in resource group"></p></li></ul><h2 id=windows-login--post-deployment>Windows Login & Post Deployment</h2><ul><li><p>Now that the Windows Server VM is created, it is time to login to it. Using its public IP, RDP to the VM.</p><p><img src=./03.jpg alt="Screenshot Azure VM public IP address"></p></li><li><p>At first login, as mentioned in the &ldquo;Automation Flow&rdquo; section, a logon script will get executed. This script was created as part of the automated deployment process.</p></li><li><p>Let the script to run its course and <strong>do not close</strong> the Powershell session, this will be done for you once completed.</p><blockquote><p><strong>Note: The script run time is ~1-2min long.</strong></p></blockquote><p><img src=./04.jpg alt="Screenshot script output"></p><p><img src=./05.jpg alt="Screenshot script output"></p><p><img src=./06.jpg alt="Screenshot script output"></p><p><img src=./07.jpg alt="Screenshot script output"></p></li><li><p>Upon successful run, a new Azure Arc enabled server will be added to the resource group.</p></li></ul><p><img src=./08.jpg alt="Screenshot Azure Arc enabled server on resource group"></p><p><img src=./09.jpg alt="Screenshot Azure Arc enabled server details"></p><h2 id=cleanup>Cleanup</h2><p>To delete the entire deployment, simply delete the resource group from the Azure portal.</p><p><img src=./10.jpg alt="Screenshot delete resource group"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-42ec827fb753e202548a5a81de66076c>1.3 - HashiCorp Vagrant</h1><div class=lead>If you don&rsquo;t have any existing servers available, the scenarios in this section will guide you on using HashiCorp Vagrant to host a new server locally in order to simulate an &ldquo;on-premises&rdquo; server and onboard it as an Azure Arc enabled server.</div></div><div class=td-content><h1 id=pg-6977b8e9fbf0de3c5e928d5025026e8c>1.3.1 - Ubuntu Vagrant box</h1><h2 id=deploy-a-local-ubuntu-server-hosted-with-vagrant-and-connect-it-azure-arc>Deploy a local Ubuntu server hosted with Vagrant and connect it Azure Arc</h2><p>The following README will guide you on how to deploy a local <strong>Ubuntu</strong> virtual machine using <a href=https://www.vagrantup.com/>Vagrant</a> and connect it as an Azure Arc enabled server resource.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Vagrant relies on an underlying hypervisor. For the purpose of this guide, we will be using &ldquo;Oracle VM VirtualBox&rdquo;.</p><ul><li><p>Install <a href=https://www.virtualbox.org/wiki/Downloads>VirtualBox</a>.</p><ul><li>If you are an OSX user, simply run <code>brew cask install virtualbox</code></li><li>If you are a Windows user, you can use the <a href=https://chocolatey.org/packages/virtualbox>Chocolatey package</a></li><li>If you are a Linux user, all package installation methods can be found <a href=https://www.virtualbox.org/wiki/Linux_Downloads>here</a></li></ul></li><li><p>Install <a href=https://www.vagrantup.com/docs/installation/>Vagrant</a></p><ul><li>If you are an OSX user, simply run <code>brew cask install vagrant</code></li><li>If you are a Windows user, you can use the <a href=https://chocolatey.org/packages/vagrant>Chocolatey package</a></li><li>If you are a Linux user, look <a href=https://www.vagrantup.com/downloads.html>here</a></li></ul></li></ul></li><li><p>Create Azure service principal (SP)</p><p>To connect the Vagrant virtual machine to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>The Vagrantfile executes a script on the VM OS to install all the needed artifacts as well to inject environment variables. Edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/local/vagrant/ubuntu/scripts/vars.sh><em>scripts/vars.sh</em></a> shell script to match the Azure service principal you&rsquo;ve just created.</p><ul><li>subscriptionId=Your Azure subscription ID</li><li>appId=Your Azure service principal name</li><li>password=Your Azure service principal password</li><li>tenantId=Your Azure tenant ID</li><li>resourceGroup=Azure resource group name</li><li>location=Azure region</li></ul></li></ul><h2 id=deployment>Deployment</h2><p>Like any Vagrant deployment, a <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/local/vagrant/ubuntu/Vagrantfile><em>Vagrantfile</em></a> and a <a href=https://www.vagrantup.com/docs/boxes.html>Vagrant Box</a> is needed. At a high-level, the deployment will:</p><ol><li>Download the Ubuntu 16.04 image file <a href=https://app.vagrantup.com/ubuntu/boxes/xenial64>Vagrant Box</a></li><li>Execute the installation script</li></ol><p>After editing the <em><strong>scripts/vars.sh</strong></em> script to match your environment, from the <em>Vagrantfile</em> folder, run <code>vagrant up</code>. As this is the first time you are creating the VM, the first run will be <strong>much slower</strong> than the ones to follow. This is because the deployment is downloading the Ubuntu box for the first time.</p><p><img src=./01.png alt="Screenshot of vagrant up being run"></p><p>Once the download is complete, the actual provisioning will start. As you can see in the screenshot below, the process takes no longer than 3 minutes.</p><p><img src=./02.png alt="Screenshot of completed vagrant up"></p><p>Upon completion, you will have a local Ubuntu VM deployed, connected as a new Azure Arc enabled server inside a new resource group.</p><p><img src=./03.png alt="Screenshot of Azure portal showing Azure Arc enabled server"></p><p><img src=./04.png alt="Screenshot of Azure portal showing Azure Arc enabled server detail"></p><h2 id=semi-automated-deployment-optional>Semi-Automated Deployment (Optional)</h2><p>As you may noticed, the last step of the run is to register the VM as a new Azure Arc enabled server resource.</p><p><img src=./05.png alt="Screenshot of vagrant up being run"></p><p>In a case you want to demo/control the actual registration process, to the following:</p><ul><li><p>In the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/local/vagrant/ubuntu/scripts/install_arc_agent.sh><em>install_arc_agent</em></a> shell script, comment out the &ldquo;Run connect command&rdquo; section and save the file. You can also comment out or change the creation of the resource group.</p><p><img src=./06.png alt="Screenshot of the azcmagent connect command"></p><p><img src=./07.png alt="Screenshot of the az group create command"></p></li><li><p>SSH the VM using the <code>vagrant ssh</code> command.</p><p><img src=./08.png alt="Screenshot of of SSH to the Vagrant machine"></p></li><li><p>Run the same <em>azcmagent connect</em> command you&rsquo;ve just commented out using your environment variables.</p><p><img src=./09.png alt="Screenshot of the azcmagent connect"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><p>To delete the entire deployment, run the <code>vagrant destroy -f</code> command. The Vagrantfile includes a <em>before: destroy</em> Vagrant trigger which will run a script to delete the Azure resource group before destroying the actual VM. That way, you will be starting fresh next time.</p><p><img src=./10.png alt="Screenshot of vagrant destroy being run"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-bc5683d9bbb43663a4b1455cd48f61ea>1.3.2 - Windows Vagrant box</h1><h2 id=deploy-a-local-windows-server-hosted-with-vagrant-and-connect-it-to-azure-arc>Deploy a local Windows server hosted with Vagrant and connect it to Azure Arc</h2><p>The following README will guide you on how to deploy a local <strong>Windows 10</strong> virtual machine using <a href=https://www.vagrantup.com/>Vagrant</a> and connect it as an Azure Arc enabled server resource.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Vagrant relies on an underlying hypervisor. For the purpose of this guide, we will be using &ldquo;Oracle VM VirtualBox&rdquo;.</p><ul><li><p>Install <a href=https://www.virtualbox.org/wiki/Downloads>VirtualBox</a>.</p><ul><li>If you are an OSX user, simply run <code>brew cask install virtualbox</code></li><li>If you are a Windows user, you can use the <a href=https://chocolatey.org/packages/virtualbox>Chocolatey package</a></li><li>If you are a Linux user, all package installation methods can be found <a href=https://www.virtualbox.org/wiki/Linux_Downloads>here</a></li></ul></li><li><p>Install <a href=https://www.vagrantup.com/docs/installation/>Vagrant</a></p><ul><li>If you are an OSX user, simply run <code>brew cask install vagrant</code></li><li>If you are a Windows user, you can use the <a href=https://chocolatey.org/packages/vagrant>Chocolatey package</a></li><li>If you are a Linux user, look <a href=https://www.vagrantup.com/downloads.html>here</a></li></ul></li></ul></li><li><p>Create Azure service principal (SP)</p><p>To connect the Vagrant virtual machine to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>The Vagrantfile executes a script on the VM OS to install all the needed artifacts as well to inject environment variables. Edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/local/vagrant/windows/scripts/vars.ps1><em>scripts/vars.ps1</em></a> PowerShell script to match the Azure service principal you&rsquo;ve just created.</p><ul><li>subscriptionId=Your Azure subscription ID</li><li>appId=Your Azure service principal name</li><li>password=Your Azure service principal password</li><li>tenantId=Your Azure tenant ID</li><li>resourceGroup=Azure resource group name</li><li>location=Azure region</li></ul></li></ul><h2 id=deployment>Deployment</h2><p>Like any Vagrant deployment, a <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/local/vagrant/windows/Vagrantfile><em>Vagrantfile</em></a> and a <a href=https://www.vagrantup.com/docs/boxes.html>Vagrant Box</a> is needed. At a high-level, the deployment will:</p><ol><li>Download the Windows 10 image file <a href=https://app.vagrantup.com/StefanScherer/boxes/windows_10>Vagrant Box</a></li><li>Execute the Arc installation script</li></ol><p>After editing the <em><strong>scripts/vars.ps1</strong></em> script to match your environment, from the <em>Vagrantfile</em> folder, run <code>vagrant up</code>. As this is the first time you are creating the VM, the first run will be <strong>much slower</strong> than the ones to follow. This is because the deployment is downloading the Windows 10 box for the first time.</p><p><img src=./01.png alt="Screenshot of running vagrant up"></p><p>Once the download is complete, the actual provisioning will start. As you can see in the screenshot below, the process takes can take somewhere between 7 to 10 minutes.</p><p><img src=./02.png alt="Screenshot of completed vagrant up"></p><p>Upon completion, you will have a local Windows 10 VM deployed, connected as a new Azure Arc enabled server inside a new resource group.</p><p><img src=./03.png alt="Screenshot of the Azure portal showing Azure Arc enabled server"></p><p><img src=./04.png alt="Screenshot of the Azure portal showing Azure Arc enabled server detail"></p><h2 id=semi-automated-deployment-optional>Semi-Automated Deployment (Optional)</h2><p>As you may noticed, the last step of the run is to register the VM as a new Azure Arc enabled server resource.</p><p><img src=./05.png alt="Screenshot of vagrant up being completed"></p><p>In a case you want to demo/control the actual registration process, to the following:</p><ul><li><p>In the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/local/vagrant/windows/scripts/install_arc_agent.ps1><em>install_arc_agent</em></a> PowerShell script, comment out the &ldquo;Run connect command&rdquo; section and save the file. You can also comment out or change the creation of the resource group.</p><p><img src=./06.png alt="Screenshot of the install_arc_agent PowerShell script"></p><p><img src=./07.png alt="Screenshot of az group create being run"></p></li><li><p>RDP the VM using the <code>vagrant rdp</code> command. Use <em>vagrant/vagrant</em> as the username/password.</p><p><img src=./08.png alt="Screenshot of RDP into a Vagrant server"></p></li><li><p>Open PowerShell ISE <strong>as Administrator</strong> and edit the <em>C:\runtime\vars.ps1</em> with your environment variables.</p><p><img src=./09.png alt="Screenshot of PowerShell ISE"></p></li><li><p>Paste the <code>Invoke-Expression "C:\runtime\vars.ps1"</code> commmand, the <code>az group create --location $env:location --name $env:resourceGroup --subscription $env:subscriptionId</code> command and the same <em>azcmagent connect</em> command you&rsquo;ve just commented and execute the script.</p><p><img src=./10.png alt="Screenshot of PowerShell ISE running a script"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><p>To delete the entire deployment, run the <code>vagrant destroy -f</code> command. The Vagrantfile includes a <em>before: destroy</em> Vagrant trigger which will run the command to delete the Azure resource group before destroying the actual VM. That way, you will be starting fresh next time.</p><p><img src=./11.png alt="Screenshot of vagrant destroy being run"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-9a3473e6423ee4c24673e9cd153d9658>1.4 - Amazon Web Services</h1><div class=lead>If you are working in a multi-cloud environment, you can deploy new AWS EC2 instances in an automated fashion using Terraform and onboard it as Azure Arc enabled servers.</div></div><div class=td-content><h1 id=pg-fc1f094c01d528ff3519c6ccebdccfff>1.4.1 - Ubuntu EC2 instance</h1><h2 id=deploy-an-aws-ubuntu-ec2-instance-and-connect-it-to-azure-arc-using-a-terraform-plan>Deploy an AWS Ubuntu EC2 instance and connect it to Azure Arc using a Terraform plan</h2><p>The following README will guide you on how to use the provided <a href=https://www.terraform.io/>Terraform</a> plan to deploy an AWS EC2 virtual machine and connect it as an Azure Arc enabled server resource.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/>Generate SSH Key</a> (or use existing ssh key)</p></li><li><p><a href=https://aws.amazon.com/premiumsupport/knowledge-center/create-and-activate-aws-account/>Create free AWS account</a></p></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>Create Azure service principal (SP)</p><p>To connect the AWS virtual machine to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcAWS&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcAWS&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcAWS&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=create-an-aws-identity>Create an AWS identity</h2><p>In order for Terraform to create resources in AWS, we will need to create a new AWS IAM role with appropriate permissions and configure Terraform to use it.</p><ul><li><p>Login to the <a href=https://console.aws.amazon.com>AWS management console</a></p></li><li><p>After logging in, click the &ldquo;Services&rdquo; dropdown in the top left. Under &ldquo;Security, Identity, and Compliance&rdquo; select &ldquo;IAM&rdquo; to access the <a href=https://console.aws.amazon.com/iam/home>Identity and Access Management page</a></p><p><img src=./01.png alt="Screenshot of AWS cloud console"></p><p><img src=./02.png alt="Screenshot of IAM AWS cloud console"></p></li><li><p>Click on &ldquo;Users&rdquo; from the left menu and then click on &ldquo;Add user&rdquo; to create a new IAM user.</p><p><img src=./03.png alt="Screenshot of new user creation in AWS cloud console"></p></li><li><p>On the &ldquo;Add User&rdquo; screen, name the user &ldquo;terraform&rdquo; and select the &ldquo;Programmatic Access&rdquo; checkbox then click &ldquo;Next&rdquo;</p><p><img src=./04.png alt="Screenshot of new user creation in AWS cloud console"></p></li><li><p>On the next &ldquo;Set Permissions&rdquo; screen, select &ldquo;Attach existing policies directly&rdquo; and then check the box next to AmazonEC2FullAccess as seen in the screenshot then click &ldquo;Next&rdquo;</p><p><img src=./05.png alt="Screenshot showing new user in AWS cloud console"></p></li><li><p>On the tags screen, assign a tag with a key of &ldquo;azure-arc-demo&rdquo; and click &ldquo;Next&rdquo; to proceed to the Review screen.</p><p><img src=./06.png alt="Screenshot showing tags in AWS cloud console"></p></li><li><p>Double check that everything looks correct and click &ldquo;Create user&rdquo; when ready.</p><p><img src=./07.png alt="Screenshot showing creating a user in AWS cloud console"></p></li><li><p>After the user is created, you will see the user&rsquo;s Access key ID and Secret access key. Copy these values down before clicking the Close button. In the screen below, you can see an example of what this should look like. Once you have these keys, you will be able to use them with Terraform to create AWS resources.</p><p><img src=./08.png alt="Screenshot showing created user in AWS cloud console"></p></li></ul><h2 id=configure-terraform>Configure Terraform</h2><p>Before executing the Terraform plan, you must export the environment variables which will be used by the plan. These variables are based on your Azure subscription and tenant, the Azure service principal, and the AWS IAM user and keys you just created.</p><ul><li><p>Retrieve your Azure subscription ID and tenant ID using the <code>az account list</code> command.</p></li><li><p>The Terraform plan creates resources in both Microsoft Azure and AWS. It then executes a script on an AWS EC2 virtual machine to install the Azure Arc agent and all necessary artifacts. This script requires certain information about your AWS and Azure environments. Edit <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/ubuntu/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> and update each of the variables with the appropriate values.</p><ul><li>TF_VAR_subscription_id=Your Azure subscription ID</li><li>TF_VAR_client_id=Your Azure service principal app id</li><li>TF_VAR_client_secret=Your Azure service principal password</li><li>TF_VAR_tenant_id=Your Azure tenant ID</li><li>AWS_ACCESS_KEY_ID=AWS access key</li><li>AWS_SECRET_ACCESS_KEY=AWS secret key</li></ul></li><li><p>From CLI, navigate to the &ldquo;azure_arc_servers_jumpstart/aws/ubuntu/terraform&rdquo; directory of the cloned repo.</p></li><li><p>Export the environment variables you edited by running <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/ubuntu/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> with the source command as shown below. Terraform requires these to be set for the plan to execute properly. Note that this script will also be automatically executed remotely on the AWS virtual machine as part of the Terraform deployment.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>source</span> ./scripts/vars.sh
</code></pre></div></li><li><p>Make sure your SSH keys are available in <em>~/.ssh</em> and named <em>id_rsa.pub</em> and <em>id_rsa</em>. If you followed the ssh-keygen guide above to create your key then this should already be setup correctly. If not, you may need to modify <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/ubuntu/terraform/main.tf><em>main.tf</em></a> to use a key with a different path.</p></li><li><p>Run the <code>terraform init</code> command which will download the Terraform AzureRM provider.</p><p><img src=./09.png alt="Screenshot of terraform init being run"></p></li></ul><h2 id=deployment>Deployment</h2><ul><li><p>Run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish. Upon completion, you will have an AWS Amazon Linux 2 EC2 instance deployed and connected as a new Azure Arc enabled server inside a new resource group.</p></li><li><p>Open the Azure portal and navigate to the resource group &ldquo;Arc-AWS-Demo&rdquo;. The virtual machine created in AWS will be visible as a resource.</p><p><img src=./10.png alt="Screenshot of Azure portal showing Azure Arc enabled server"></p><p><img src=./19.png alt="Screenshot of AWS cloud console showing EC2 instance"></p></li></ul><h2 id=semi-automated-deployment-optional>Semi-Automated Deployment (Optional)</h2><p>As you may have noticed, the last step of the run is to register the VM as a new Azure Arc enabled server resource.
<img src=./11.png alt="Screenshot showing azcmagent connect script"></p><p>If you want to demo/control the actual registration process, do the following:</p><ul><li><p>In the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/ubuntu/terraform/scripts/install_arc_agent.sh.tmpl><em>install_arc_agent.sh.tmpl</em></a> script template, comment out the &ldquo;Run connect command&rdquo; section and save the file.</p><p><img src=./12.png alt="Screenshot showing azcmagent connect script commented out"></p></li><li><p>Get the public IP of the AWS VM by running <code>terraform output</code></p><p><img src=./13.png alt="Screenshot of terraform output being run"></p></li><li><p>SSH the VM using the <code>ssh ubuntu@x.x.x.x</code> where x.x.x.x is the host ip.</p><p><img src=./14.png alt="Screenshot of SSH into EC2 server"></p></li><li><p>Export all the environment variables in <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/ubuntu/terraform/scripts/vars.sh><em>vars.sh</em></a></p><p><img src=./15.png alt="Screenshot showing export of environment variables in var.sh"></p></li><li><p>Run the following command</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>azcmagent connect --service-principal-id <span style=color:#000>$TF_VAR_client_id</span> --service-principal-secret <span style=color:#000>$TF_VAR_client_secret</span> --resource-group <span style=color:#4e9a06>&#34;Arc-AWS-Demo&#34;</span> --tenant-id <span style=color:#000>$TF_VAR_tenant_id</span> --location <span style=color:#4e9a06>&#34;westus2&#34;</span> --subscription-id <span style=color:#000>$TF_VAR_subscription_id</span>
</code></pre></div><p><img src=./16.png alt="Screenshot of azcmagent connect being run"></p></li><li><p>When complete, your VM will be registered with Azure Arc and visible in the resource group inside Azure Portal.</p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><p>To delete all the resources you created as part of this demo use the <code>terraform destroy --auto-approve</code> command as shown below.
<img src=./17.png alt="Screenshot showing terraform destroy being run"></p><p>Alternatively, you can delete the AWS EC2 instance directly by terminating it from the <a href=https://console.aws.amazon.com/ec2/v2/home>AWS Console</a>. Note that it will take a few minutes for the instance to actually be removed.
<img src=./18.png alt="Screenshot of AWS cloud console showing terminating instance"></p><p>If you delete the instance manually, then you should also delete <em>./scripts/install_arc_agent.sh</em> which is created by the Terraform plan.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-95541056e5a6754e9f9e64a085445d0f>1.4.2 - Amazon Linux 2 EC2 instance</h1><h2 id=deploy-an-aws-amazon-linux-2-ec2-instance-and-connect-it-to-azure-arc-using-a-terraform-plan>Deploy an AWS Amazon Linux 2 EC2 instance and connect it to Azure Arc using a Terraform plan</h2><p>The following README will guide you on how to use the provided <a href=https://www.terraform.io/>Terraform</a> plan to deploy an AWS Amazon Linux 2 EC2 instance and connect it as an Azure Arc enabled server resource.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/>Generate SSH Key</a> (or use existing ssh key)</p></li><li><p><a href=https://aws.amazon.com/premiumsupport/knowledge-center/create-and-activate-aws-account/>Create free AWS account</a></p></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>Create Azure service principal (SP)</p><p>To connect the AWS virtual machine to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcAWS&#34;</span> --role contributor
</code></pre></div><p>Output should look similar to this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcAWS&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcAWS&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=create-an-aws-identity>Create an AWS identity</h2><p>In order for Terraform to create resources in AWS, we will need to create a new AWS IAM role with appropriate permissions and configure Terraform to use it.</p><ul><li><p>Login to the <a href=https://console.aws.amazon.com>AWS management console</a></p></li><li><p>After logging in, click the &ldquo;Services&rdquo; dropdown in the top left. Under &ldquo;Security, Identity, and Compliance&rdquo; select &ldquo;IAM&rdquo; to access the <a href=https://console.aws.amazon.com/iam/home>Identity and Access Management page</a></p><p><img src=./01.png alt="Screenshot of AWS cloud console"></p><p><img src=./02.png alt="Screenshot of IAM AWS cloud console"></p></li><li><p>Click on &ldquo;Users&rdquo; from the left menu and then click on &ldquo;Add user&rdquo; to create a new IAM user.</p><p><img src=./03.png alt="Screenshot of new user creation in AWS cloud console"></p></li><li><p>On the &ldquo;Add User&rdquo; screen, name the user &ldquo;terraform&rdquo; and select the &ldquo;Programmatic Access&rdquo; checkbox then click &ldquo;Next&rdquo;</p><p><img src=./04.png alt="Screenshot of new user creation in AWS cloud console"></p></li><li><p>On the next &ldquo;Set Permissions&rdquo; screen, select &ldquo;Attach existing policies directly&rdquo; and then check the box next to AmazonEC2FullAccess as seen in the screenshot then click &ldquo;Next&rdquo;</p><p><img src=./05.png alt="Screenshot showing new user in AWS cloud console"></p></li><li><p>On the tags screen, assign a tag with a key of &ldquo;azure-arc-demo&rdquo; and click &ldquo;Next&rdquo; to proceed to the Review screen.</p><p><img src=./06.png alt="Screenshot showing tags in AWS cloud console"></p></li><li><p>Double check that everything looks correct and click &ldquo;Create user&rdquo; when ready.</p><p><img src=./07.png alt="Screenshot showing creating a user in AWS cloud console"></p></li><li><p>After the user is created, you will see the user&rsquo;s Access key ID and Secret access key. Copy these values down before clicking the Close button. In the screen below, you can see an example of what this should look like. Once you have these keys, you will be able to use them with Terraform to create AWS resources.</p><p><img src=./08.png alt="Screenshot showing created user in AWS cloud console"></p></li></ul><h2 id=configure-terraform>Configure Terraform</h2><p>Before executing the Terraform plan, you must export the environment variables which will be used by the plan. These variables are based on your Azure subscription and tenant, the Azure service principal, and the AWS IAM user and keys you just created.</p><ul><li><p>Retrieve your Azure subscription ID and tenant ID using the <code>az account list</code> command.</p></li><li><p>The Terraform plan creates resources in both Microsoft Azure and AWS. It then executes a script on an AWS EC2 virtual machine to install the Azure Arc agent and all necessary artifacts. This script requires certain information about your AWS and Azure environments. Edit <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/AL2/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> and update each of the variables with the appropriate values.</p><ul><li>TF_VAR_subscription_id=Your Azure subscription ID</li><li>TF_VAR_client_id=Your Azure service principal app id</li><li>TF_VAR_client_secret=Your Azure service principal password</li><li>TF_VAR_tenant_id=Your Azure tenant ID</li><li>AWS_ACCESS_KEY_ID=AWS access key</li><li>AWS_SECRET_ACCESS_KEY=AWS secret key</li></ul></li><li><p>From CLI, navigate to the <em>azure_arc_servers_jumpstart/aws/al2/terraform</em> directory of the cloned repo.</p></li><li><p>Export the environment variables you edited by running <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/AL2/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> with the source command as shown below. Terraform requires these to be set for the plan to execute properly. Note that this script will also be automatically executed remotely on the AWS virtual machine as part of the Terraform deployment.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>source</span> ./scripts/vars.sh
</code></pre></div></li><li><p>Make sure your SSH keys are available in <em>~/.ssh</em> and named <em>id_rsa.pub</em> and <em>id_rsa</em>. If you followed the ssh-keygen guide above to create your key then this should already be setup correctly. If not, you may need to modify <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/AL2/terraform/main.tf><em>main.tf</em></a> to use a key with a different path.</p></li><li><p>Run the <code>terraform init</code> command which will download the Terraform AzureRM provider.</p><p><img src=./09.png alt="Screenshot showing terraform init being run"></p></li></ul><h2 id=deployment>Deployment</h2><ul><li><p>Run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish. Upon completion, you will have an AWS Amazon Linux 2 EC2 instance deployed and connected as a new Azure Arc enabled server inside a new resource group.</p></li><li><p>Open the Azure portal and navigate to the resource group &ldquo;Arc-Servers-Demo&rdquo;. The virtual machine created in AWS will be visible as a resource.</p><p><img src=./10.png alt="Screenshot showing Azure Portal and Azure Arc enabled server"></p></li></ul><h2 id=semi-automated-deployment-optional>Semi-Automated Deployment (Optional)</h2><p>As you may have noticed, the last step of the run is to register the VM as a new Azure Arc enabled server resource.
<img src=./11.png alt="Screenshot showing azcmagent connect script"></p><p>If you want to demo/control the actual registration process, do the following:</p><ul><li><p>In the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/AL2/terraform/scripts/install_arc_agent.sh.tmpl><em>install_arc_agent.sh.tmpl</em></a> script template, comment out the &ldquo;Run connect command&rdquo; section and save the file.</p><p><img src=./12.png alt="Screenshot showing azcmagent connect script commented out"></p></li><li><p>Get the public IP of the AWS VM by running <code>terraform output</code></p><p><img src=./13.png alt="Screenshot showing terraform output"></p></li><li><p>SSH the VM using the <code>ssh ec2-user@x.x.x.x</code> where x.x.x.x is the host ip.</p><p><img src=./14.png alt="Screenshot showing SSH into EC2 server"></p></li><li><p>Export all the environment variables in <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/AL2/terraform/scripts/vars.sh><em>vars.sh</em></a></p><p><img src=./15.png alt="Screenshot showing export of environment variables in vars.sh"></p></li><li><p>Run the following command</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>azcmagent connect --service-principal-id <span style=color:#000>$TF_VAR_client_id</span> --service-principal-secret <span style=color:#000>$TF_VAR_client_secret</span> --resource-group <span style=color:#4e9a06>&#34;Arc-Servers-Demo&#34;</span> --tenant-id <span style=color:#000>$TF_VAR_tenant_id</span> --location <span style=color:#4e9a06>&#34;westus2&#34;</span> --subscription-id <span style=color:#000>$TF_VAR_subscription_id</span>
</code></pre></div><p><img src=./16.png alt="Screenshot showing azcmagent connect being run"></p></li><li><p>When complete, your VM will be registered with Azure Arc and visible in the resource group inside Azure Portal.</p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><p>To delete all the resources you created as part of this demo use the <code>terraform destroy --auto-approve</code> command as shown below.
<img src=./17.png alt="Screenshot showing terraform destroy being run"></p><p>Alternatively, you can delete the AWS EC2 instance directly by terminating it from the <a href=https://console.aws.amazon.com/ec2/v2/home>AWS Console</a>.
<img src=./18.png alt="Screenshot showing AWS Console with terminating instance"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-7064577bc1b93c68f79cd424bda7f426>1.5 - Google Cloud Platform</h1><div class=lead>If you are working in a multi-cloud environment, you can deploy new GCP instances in an automated fashion using Terraform and onboard it as Azure Arc enabled servers.</div></div><div class=td-content><h1 id=pg-d042d13faf89faf82810b281cfa42258>1.5.1 - Ubuntu GCP instance</h1><h2 id=deploy-a-gcp-ubuntu-instance-and-connect-it-to-azure-arc-using-a-terraform-plan>Deploy a GCP Ubuntu instance and connect it to Azure Arc using a Terraform plan</h2><p>The following README will guide you on how to use the provided <a href=https://www.terraform.io/>Terraform</a> plan to deploy an Ubuntu Server GCP virtual machine and connect it as an Azure Arc enabled server resource.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/>Generate SSH Key</a> (or use existing ssh key)</p></li><li><p><a href=(https://cloud.google.com/free)>Create free Google Cloud account</a></p></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>Create Azure service principal (SP)</p><p>To connect the GCP virtual machine to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcGCP&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcGCP&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcGCP&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=create-a-new-gcp-project>Create a new GCP Project</h2><ul><li><p>Browse to <a href=https://console.developers.google.com>https://console.developers.google.com</a> and login with your Google Cloud account. Once logged in, <a href=https://cloud.google.com/resource-manager/docs/creating-managing-projects>create a new project</a> named &ldquo;Azure Arc Demo&rdquo;. After creating it, be sure to copy down the project id as it is usually different then the project name.</p><p><img src=./01.png alt="Screenshot of GCP Cloud console create project screen"></p><p><img src=./02.png alt="Screenshot of GCP cloud new project screen"></p></li><li><p>Once the new project is created and selected in the dropdown at the top of the page, you must enable Compute Engine API access for the project. Click on &ldquo;+Enable APIs and Services&rdquo; and search for &ldquo;Compute Engine&rdquo;. Then click Enable to enable API access.</p><p><img src=./03.png alt="Screenshot of GCP console showing enabling Compute Engine API"></p><p><img src=./04.png alt="Screenshot of GCP console showing enabling Compute Engine API"></p></li><li><p>Next, set up a service account key, which Terraform will use to create and manage resources in your GCP project. Go to the <a href=https://console.cloud.google.com/apis/credentials/serviceaccountkey>create service account key page</a>. Select &ldquo;New Service Account&rdquo; from the dropdown, give it a name, select Project then Owner as the role, JSON as the key type, and click Create. This downloads a JSON file with all the credentials that will be needed for Terraform to manage the resources. Copy the downloaded JSON file to the <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_servers_jumpstart/gcp/ubuntu/terraform><em>azure_arc_servers_jumpstart/gcp/ubuntu/terraform</em></a> directory.</p><p><img src=./05.png alt="Screenshot of GCP cloud console showing creation of service account"></p></li><li><p>Finally, make sure your SSH keys are available in <em>~/.ssh</em> and named <em>id_rsa.pub</em> and <em>id_rsa</em>. If you followed the ssh-keygen guide above to create your key then this should already be setup correctly. If not, you may need to modify <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/gcp/ubuntu/terraform/main.tf><em>main.tf</em></a> to use a key with a different path.</p></li></ul><h2 id=deployment>Deployment</h2><p>Before executing the Terraform plan, you must export the environment variables which will be used by the plan. These variables are based on the Azure service principal you&rsquo;ve just created, your Azure subscription and tenant, and the GCP project name.</p><ul><li><p>Retrieve your Azure subscription ID and tenant ID using the <code>az account list</code> command.</p></li><li><p>The Terraform plan creates resources in both Microsoft Azure and Google Cloud. It then executes a script on a Google Cloud virtual machine to install the Azure Arc agent and all necessary artifacts. This script requires certain information about your Google Cloud and Azure environments. Edit <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/gcp/ubuntu/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> and update each of the variables with the appropriate values.</p><ul><li>TF_VAR_subscription_id=Your Azure subscription ID</li><li>TF_VAR_client_id=Your Azure service principal app id</li><li>TF_VAR_client_secret=Your Azure service principal password</li><li>TF_VAR_tenant_id=Your Azure tenant ID</li><li>TF_VAR_gcp_project_id=GCP project id</li><li>TF_VAR_gcp_credentials_filename=GCP credentials json filename</li></ul></li><li><p>From CLI, navigate to the <em>azure_arc_servers_jumpstart/gcp/ubuntu/terraform</em> directory of the cloned repo.</p></li><li><p>Export the environment variables you edited by running <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/gcp/ubuntu/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> with the source command as shown below. Terraform requires these to be set for the plan to execute properly. Note that this script will also be automatically executed remotely on the GCP virtual machine as part of the Terraform deployment.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>source</span> ./scripts/vars.sh
</code></pre></div></li><li><p>Run the <code>terraform init</code> command which will download the Terraform AzureRM provider.</p><p><img src=./08.png alt="Screenshot showing terraform init being run"></p></li><li><p>Next, run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish. Upon completion, you will have a GCP Ubuntu VM deployed and connected as a new Azure Arc enabled server inside a new resource group.</p></li><li><p>Open the Azure portal and navigate to the resource group &ldquo;Arc-GCP-Demo&rdquo;. The virtual machine created in GCP will be visible as a resource.</p><p><img src=./18.png alt="Screenshot of Azure Portal showing Azure Arc enabled server"></p></li></ul><h2 id=semi-automated-deployment-optional>Semi-Automated Deployment (Optional)</h2><p>As you may have noticed, the last step of the run is to register the VM as a new Azure Arc enabled server resource.
<img src=./10.png alt="Screenshot showing azcmagent connect script"></p><p>If you want to demo/control the actual registration process, do the following:</p><ul><li><p>In the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/gcp/ubuntu/terraform/scripts/install_arc_agent.sh.tmpl><em>install_arc_agent.sh.tmpl</em></a> script template, comment out the &ldquo;Run connect command&rdquo; section and save the file.</p><p><img src=./11.png alt="Screenshot showing azcmagent connect commented out"></p></li><li><p>Get the public IP of the GCP VM by running <code>terraform output</code></p><p><img src=./12.png alt="Screenshot showing terraform output"></p></li><li><p>SSH the VM using the <code>ssh arcadmin@x.x.x.x</code> where x.x.x.x is the host ip.</p><p><img src=./13.png alt="Screenshot showing SSH into GCP server"></p></li><li><p>Export all the environment variables in <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/gcp/ubuntu/terraform/scripts/vars.sh><em>vars.sh</em></a></p><p><img src=./14.png alt="Screenshot showing export of environment variables from vars.sh"></p></li><li><p>Run the following command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>azcmagent connect --service-principal-id <span style=color:#000>$TF_VAR_client_id</span> --service-principal-secret <span style=color:#000>$TF_VAR_client_secret</span> --resource-group <span style=color:#4e9a06>&#34;Arc-GCP-Demo&#34;</span> --tenant-id <span style=color:#000>$TF_VAR_tenant_id</span> --location <span style=color:#4e9a06>&#34;westus2&#34;</span> --subscription-id <span style=color:#000>$TF_VAR_subscription_id</span>
</code></pre></div><p><img src=./15.png alt="Screenshot of azcmagent connect being run"></p></li><li><p>When complete, your VM will be registered with Azure Arc and visible in the resource group inside Azure Portal.</p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><p>To delete all the resources you created as part of this demo use the <code>terraform destroy --auto-approve</code> command as shown below.</p><p><img src=./17.png alt="Screenshot of terraform destroy being run"></p><p>Alternatively, you can delete the GCP VM directly from <a href=https://console.cloud.google.com/compute/instances>GCP Console</a>.</p><p><img src=./16.png alt="Screenshot of deleting VM from GCP cloud console"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-a692f8c5cd59332abe3227bb76485698>1.5.2 - Windows GCP instance</h1><h2 id=deploy-a-gcp-windows-instance-and-connect-it-to-azure-arc-using-a-terraform-plan>Deploy a GCP Windows instance and connect it to Azure Arc using a Terraform plan</h2><p>The following README will guide you on how to use the provided <a href=https://www.terraform.io/>Terraform</a> plan to deploy a Windows Server GCP virtual machine and connect it as an Azure Arc enabled server resource.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>Google Cloud account with billing enabled - <a href=https://cloud.google.com/free>Create a free trial account</a>. To create Windows Server virtual machines, you must upgraded your account to enable billing. Click Billing from the menu and then select Upgrade in the lower right.</p><p><img src=./29.png alt="Screenshot showing how to enable billing on GCP account"></p><p><img src=./30.png alt="Screenshot showing how to enable billing on GCP account"></p><p><img src=./32.png alt="Screenshot showing how to enable billing on GCP account"></p><p><em><strong>Disclaimer</strong></em> - <strong>To prevent unexpected charges, please follow the &ldquo;Delete the deployment&rdquo; section at the end of this README</strong></p></li><li><p>Create Azure service principal (SP)</p><p>To connect the GCP virtual machine to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcGCP&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcGCP&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcGCP&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=create-a-new-gcp-project>Create a new GCP Project</h2><ul><li><p>Browse to <a href=https://console.cloud.google.com>https://console.cloud.google.com</a> and login with your Google Cloud account. Once logged in, <a href=https://cloud.google.com/resource-manager/docs/creating-managing-projects>create a new project</a> named &ldquo;Azure Arc Demo&rdquo;. After creating it, be sure to copy down the project id as it is usually different then the project name.</p><p><img src=./01.png alt="Screenshot of GCP Cloud console create project screen"></p><p><img src=./02.png alt="Screenshot of GCP cloud new project screen"></p></li><li><p>Once the new project is created and selected in the dropdown at the top of the page, you must enable Compute Engine API access for the project. Click on &ldquo;+Enable APIs and Services&rdquo; and search for &ldquo;Compute Engine&rdquo;. Then click Enable to enable API access.</p><p><img src=./03.png alt="Screenshot of GCP console showing enabling Compute Engine API"></p><p><img src=./04.png alt="Screenshot of GCP console showing enabling Compute Engine API"></p></li><li><p>Next, set up a service account key, which Terraform will use to create and manage resources in your GCP project. Go to the <a href=https://console.cloud.google.com/apis/credentials/serviceaccountkey>create service account key page</a>. Select &ldquo;New Service Account&rdquo; from the dropdown, give it a name, select Project then Owner as the role, JSON as the key type, and click Create. This downloads a JSON file with all the credentials that will be needed for Terraform to manage the resources. Copy the downloaded JSON file to the <em>azure_arc_servers_jumpstart/gcp/windows/terraform</em> directory.</p><p><img src=./05.png alt="Screenshot of GCP cloud console showing creation of service account"></p></li></ul><h2 id=deployment>Deployment</h2><p>Before executing the Terraform plan, you must set and then export the environment variables which will be used by the plan. These variables are based on the Azure service principal you&rsquo;ve just created, your Azure subscription and tenant, and the GCP project name.</p><ul><li><p>Retrieve your Azure subscription ID and tenant ID using the <code>az account list</code> command.</p></li><li><p>The Terraform plan creates resources in both Microsoft Azure and Google Cloud. It then executes a script on a Google Cloud virtual machine to install the Azure Arc agent and all necessary artifacts. This script requires certain information about your Google Cloud and Azure environments. Edit <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/gcp/windows/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> and update each of the variables with the appropriate values.</p><ul><li>TF_VAR_subscription_id=Your Azure subscription ID</li><li>TF_VAR_client_id=Your Azure service principal app id</li><li>TF_VAR_client_secret=Your Azure service principal password</li><li>TF_VAR_tenant_id=Your Azure tenant ID</li><li>TF_VAR_gcp_project_id=GCP project id</li><li>TF_VAR_gcp_credentials_filename=GCP credentials json filename</li></ul></li><li><p>From CLI, navigate to the <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_servers_jumpstart/gcp/windows/terraform><em>azure_arc_servers_jumpstart/gcp/windows/terraform</em></a> directory of the cloned repo.</p></li><li><p>Export the environment variables you edited by running <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/gcp/windows/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> with the source command as shown below. Terraform requires these to be set for the plan to execute properly.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>source</span> ./scripts/vars.sh
</code></pre></div></li><li><p>Run the <code>terraform init</code> command which will download the Terraform AzureRM provider.</p><p><img src=./08.png alt="Screenshot showing terraform init being run"></p></li><li><p>Next, run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish. Upon completion of the Terraform script, you will have deployed a GCP Windows Server 2019 VM and initiated a script to download the Azure Arc agent to the VM and connect the VM as a new Azure Arc enabled server inside a new Azure resource group. It will take a few minutes for the agent to finish provisioning so grab a coffee.</p><p><img src=./09.png alt="Screenshot of terraform apply being run"></p></li><li><p>After a few minutes, you should be able to open the Azure portal and navigate to the resource group &ldquo;Arc-GCP-Demo&rdquo;. The Windows Server virtual machine created in GCP will be visible as a resource.</p><p><img src=./33.png alt="Screenshot of Azure Portal showing Azure Arc enabled server"></p></li></ul><h2 id=semi-automated-deployment-optional>Semi-Automated Deployment (Optional)</h2><p>The Terraform plan automatically installs the Azure Arc agent and connects the VM to Azure as a managed resource by executing a PowerShell script when the VM is first booted.
<img src=./12.png alt="Screenshot showing azcmagent connect script"></p><p>If you want to demo/control the actual registration process, do the following:</p><ul><li><p>Before running the <code>terraform apply</code> command, open <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/gcp/windows/terraform/main.tf><em>main.tf</em></a> and comment out the <code>windows-startup-script-ps1 = local_file.install_arc_agent_ps1.content</code> line and save the file.</p><p><img src=./13.png alt="Screenshot showing main.tf being commented to disable automatic onboarding of Azure Arc agent"></p></li><li><p>Run <code>terraform apply --auto-approve</code> as instructed above.</p></li><li><p>Open the Google Cloud console and navigate to the <a href=https://console.cloud.google.com/compute/instances>Compute Instance page</a>, then click on the VM that was created.</p><p><img src=./14.png alt="Screenshot showing GCP cloud console with GCP server"></p><p><img src=./15.png alt="Screenshot showing how to reset password of GCP Windows server"></p></li><li><p>Create a user and password for the VM by clicking &ldquo;Set Password&rdquo; and specifying a username.</p><p><img src=./17.png alt="Screenshot showing setting username and password of GCP server"></p></li><li><p>RDP into the VM by clicking the RDP button from the VM page in Google Cloud console, and login with the username and password you just created.</p><p><img src=./18.png alt="Screenshot showing how to RDP into GCP instance"></p></li><li><p>Once logged in, open PowerShell ISE <strong>as Administrator</strong>. Make sure you are running the x64 version of PowerShell ISE and not x86. Once open, select File->New to create an empty .ps1 file. Then paste in the entire contents of <em>./scripts/install_arc_agent.ps1]</em>. Click the play button to execute the script. When complete, you should see the output showing successful onboarding of the machine.</p><p><img src=./19.png alt="Screenshot showing Powershell ISE with Azure Arc agent connection script"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><p>To delete all the resources you created as part of this demo use the <code>terraform destroy --auto-approve</code> command as shown below.
<img src=./11.png alt="Screenshot showing terraform destroy being run"></p><p>Alternatively, you can delete the GCP VM directly from <a href=https://console.cloud.google.com/compute/instances>GCP Console</a>.
<img src=./16.png alt="Screenshot showing how to delete GCP VM from cloud console"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5b91b658f8abbc63f40d299548f9cb0e>1.6 - VMware vSphere</h1><div class=lead>If you are working with an on-premises VMware vSphere infrastructure, you can deploy new Windows or Linux virtual machines in an automated fashion using Terraform and onboard it as Azure Arc enabled servers.</div></div><div class=td-content><h1 id=pg-e56462edb69ef5a1281ec6e2129b4745>1.6.1 - Ubuntu VM</h1><h2 id=deploy-a-vmware-ubuntu-vm-and-connect-it-to-azure-arc-using-terraform>Deploy a VMware Ubuntu VM and connect it to Azure Arc using Terraform</h2><p>The following README will guide you on how to use the provided <a href=https://www.terraform.io/>Terraform</a> plan to deploy an Ubuntu Server, VMware vSphere virtual machine and connect it as an Azure Arc enabled server resource.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>A VMware vCenter Server user with <a href=https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.vm_admin.doc/GUID-8254CD05-CC06-491D-BA56-A773A32A8130.html>permissions to deploy</a> a Virtual Machine from a Template in the vSphere Web Client.</p></li><li><p>Create Azure service principal (SP)</p><p>To connect the VMware vSphere virtual machine to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h3 id=preparing-an-ubuntu-server-vmware-vsphere-vm-template>Preparing an Ubuntu Server VMware vSphere VM Template</h3><p>Before using the below guide to deploy an Ubuntu Server VM and connect it to Azure Arc, a VMware vSphere Template is required. <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/vmware_ubuntu_template/>The following README</a> will instruct you how to easily create such a template using VMware vSphere 6.5 and above.</p><blockquote><p><strong>Note: If you already have an Ubuntu Server VM template it is still recommended to use the guide as a reference.</strong></p></blockquote><h2 id=deployment>Deployment</h2><p>Before executing the Terraform plan, you must set the environment variables which will be used by the plan. These variables are based on the Azure service principal you&rsquo;ve just created, your Azure subscription and tenant, and your VMware vSphere credentials.</p><ul><li><p>Retrieve your Azure subscription ID and tenant ID using the <code>az account list</code> command.</p></li><li><p>The Terraform plan creates resources in both Microsoft Azure and VMware vSphere. It then executes a script on the virtual machine to install the Azure Arc agent and all necessary artifacts. This script requires certain information about your VMware vSphere and Azure environments. Edit <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/vmware/ubuntu/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> and update each of the variables with the appropriate values.</p><ul><li>TF_VAR_subscription_id=Your Azure subscription ID</li><li>TF_VAR_client_id=Your Azure service principal name</li><li>TF_VAR_client_secret=Your Azure service principal password</li><li>TF_VAR_tenant_id=Your Azure tenant ID</li><li>TF_VAR_resourceGroup=Azure resource group name</li><li>TF_VAR_location=Azure Region</li><li>TF_VAR_vsphere_user=vCenter Admin Username</li><li>TF_VAR_vsphere_password=vCenter Admin Password</li><li>TF_VAR_vsphere_server=vCenter server FQDN/IP</li><li>TF_VAR_admin_user=OS Admin Username</li><li>TF_VAR_admin_password=OS Admin Password</li></ul></li><li><p>From CLI, navigate to the <em>azure_arc_servers_jumpstart/vmware/ubuntu/terraform</em> directory of the cloned repo.</p></li><li><p>Export the environment variables you edited by running <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/vmware/ubuntu/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> with the source command as shown below. Terraform requires these to be set for the plan to execute properly. Note that this script will also be automatically executed remotely on the virtual machine as part of the Terraform deployment.</p><p><code>source ./scripts/vars.sh</code></p></li><li><p>In addition to the <em>TF_VAR</em> environment variables you&rsquo;ve just exported, edit the Terraform variables in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/vmware/ubuntu/terraform/terraform.tfvars><em>terraform.tfvars</em></a> to match your VMware vSphere environment.</p><p><img src=./01.png alt="TF_VAR environment variables"></p></li><li><p>Run the <code>terraform init</code> command which will download the Terraform AzureRM, Local and vSphere providers.</p><p><img src=./02.png alt="terraform init"></p></li><li><p>Run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish.</p></li><li><p>Once the Terraform deployment is completed, a new Ubuntu Server VM will be up & running and will be projected as an Azure Arc enabled server resource in a newly created Azure resource group.</p><p><img src=./03.png alt="terraform apply"></p><p><img src=./04.png alt="New VMware vSphere Ubuntu Server VM"></p><p><img src=./05.png alt="Azure Arc enabled server in an Azure resource group"></p><p><img src=./06.png alt="Azure Arc enabled server in an Azure resource group"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><ul><li><p>The most straightforward way is to delete the Azure Arc resource via the Azure Portal, just select the resource and delete it. In addition, delete the VMware vSphere VM.</p><p><img src=./07.png alt="Delete Azure Arc enabled server"></p><p>If you delete the instance manually, then you should also delete <em>install_arc_agent.sh</em> which is created by the Terraform plan.</p></li><li><p>If you want to nuke the entire environment use the <code>terraform destroy --auto-approve</code> command as shown below.</p><p><img src=./08.png alt="terraform destroy"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-35f5273e1310f62b1fd14f656ada12a2>1.6.1.1 - Create Ubuntu vSphere template</h1><h2 id=create-a-vmware-vsphere-template-for-ubuntu-server-1804>Create a VMware vSphere template for Ubuntu Server 18.04</h2><p>The following README will guide you on how to create an Ubuntu Server 18.04 VMware vSphere virtual machine template.</p><h2 id=prerequisites>Prerequisites</h2><blockquote><p><strong>Note: This guide assumes that you have some VMware vSphere familiarity. It is also does not designed to go over either VMware and/or Ubuntu best-practices.</strong></p></blockquote><ul><li><p><a href=https://releases.ubuntu.com/18.04/>Download the latest Ubuntu Server 18.04 ISO file</a></p></li><li><p>VMware vSphere 6.5 and above</p></li><li><p>Although it can be used locally, for faster deployment, it is recommended to upload the file to a vSphere datastore or to vCenter Content Library.</p></li></ul><h2 id=creating-ubuntu-1804-vm-template>Creating Ubuntu 18.04 VM Template</h2><h3 id=deploying--installing-ubuntu>Deploying & Installing Ubuntu</h3><ul><li><p>Deploy new virtual machine</p><p><img src=./01.png alt="Create new VMware vSphere VM"></p><p><img src=./02.png alt="Create new VMware vSphere VM"></p><p><img src=./03.png alt="Create new VMware vSphere VM"></p><p><img src=./04.png alt="Create new VMware vSphere VM"></p><p><img src=./05.png alt="Create new VMware vSphere VM"></p><p><img src=./06.png alt="Create new VMware vSphere VM"></p></li><li><p>Make sure to select <em>Ubuntu Linux (64-bit)</em> as the Guest OS.</p><p><img src=./07.png alt="Ubuntu Linux (64-bit) Guest OS"></p></li><li><p>Point to the Ubuntu Server ISO file location.</p><p><img src=./08.png alt="Create new VMware vSphere VM"></p><p><img src=./09.png alt="Create new VMware vSphere VM"></p></li><li><p>Power-on the VM and start the Ubuntu installation. No specific instructions here but:</p><ul><li><p>(Optional) Consider using static IP</p></li><li><p>Install OpenSSH server</p><p><img src=./10.png alt="Power-on the VM"></p><p><img src=./11.png alt="Ubuntu installation"></p><p><img src=./12.png alt="Ubuntu installation"></p><p><img src=./13.png alt="Ubuntu installation"></p><p><img src=./14.png alt="Ubuntu installation"></p><p><img src=./15.png alt="Ubuntu installation"></p><p><img src=./16.png alt="Ubuntu installation"></p><p><img src=./17.png alt="Ubuntu installation"></p><p><img src=./18.png alt="Ubuntu installation"></p><p><img src=./19.png alt="Ubuntu installation"></p><p><img src=./20.png alt="Ubuntu installation"></p><p><img src=./21.png alt="Ubuntu installation"></p><p><img src=./22.png alt="Ubuntu installation"></p><p><img src=./23.png alt="Ubuntu installation"></p><p><img src=./24.png alt="Ubuntu installation"></p><p><img src=./25.png alt="Ubuntu installation"></p><p><img src=./26.png alt="Ubuntu installation"></p><p><img src=./27.png alt="Ubuntu installation"></p><p><img src=./28.png alt="Ubuntu installation"></p><p><img src=./29.png alt="Ubuntu installation"></p><p><img src=./30.png alt="Ubuntu installation"></p></li></ul></li></ul><h3 id=post-installation>Post-installation</h3><p>Before converting the VM to a template, few actions are needed.</p><ul><li><p>It&rsquo;s better to have your OS packages up-to-date</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo apt-get update
sudo apt-get upgrade -y
</code></pre></div></li><li><p>Prevent cloudconfig from preserving the original hostname and reset the hostname</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo sed -i <span style=color:#4e9a06>&#39;s/preserve_hostname: false/preserve_hostname: true/g&#39;</span> /etc/cloud/cloud.cfg
sudo truncate -s0 /etc/hostname
sudo hostnamectl set-hostname localhost
</code></pre></div></li><li><p>Remove the current network configuration</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo rm /etc/netplan/50-cloud-init.yaml
</code></pre></div></li><li><p>Clean shell history and shutdown the VM</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cat /dev/null &gt; ~/.bash_history <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>history</span> -c
sudo shutdown now
</code></pre></div></li></ul><h3 id=convert-to-template>Convert to Template</h3><p>Reduce the VM CPU count & memory resources to the minimum and convert the VM to template, switch the CD/DVD drive to client device as well disconnect it and convert the VM to template.</p><p><img src=./31.png alt="Reduce the VM CPU count & Memory"></p><p><img src=./32.png alt="Convert the VM to template"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-7ede8ac96598e3cbc19ecd306e0933fe>1.6.2 - Windows VM</h1><h2 id=deploy-a-vmware-windows-vm-and-connect-it-to-azure-arc-using-terraform>Deploy a VMware Windows VM and connect it to Azure Arc using Terraform</h2><p>The following README will guide you on how to use the provided <a href=https://www.terraform.io/>Terraform</a> plan to deploy a Windows Server, VMware vSphere virtual machine and connect it as an Azure Arc enabled server resource.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>A VMware vCenter Server user with <a href=https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.vm_admin.doc/GUID-8254CD05-CC06-491D-BA56-A773A32A8130.html>permissions to deploy</a> a Virtual Machine from a Template in the vSphere Web Client.</p></li><li><p>Create Azure service principal (SP)</p><p>To connect the VMware vSphere virtual machine to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h3 id=preparing-a-window-server-vmware-vsphere-vm-template>Preparing a Window Server VMware vSphere VM Template</h3><p>Before using the below guide to deploy a Windows Server VM and connect it to Azure Arc, a VMware vSphere Template is required. <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/vmware_winsrv2k19_template/>The following README</a> will instruct you how to easily create such a template using VMware vSphere 6.5 and above.</p><p><strong>The Terraform plan leveraged the <em>remote-exec</em> provisioner which uses the WinRM protocol to copy and execute the required Azure Arc script. To allow WinRM connectivity to the VM, run the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/vmware/winsrv/terraform/scripts/allow_winrm.ps1><em>allow_winrm</em></a> PowerShell script on your VM before converting it to template.</strong></p><blockquote><p><strong>Note: If you already have a Windows Server VM template it is still recommended to use the guide as a reference.</strong></p></blockquote><h2 id=deployment>Deployment</h2><p>Before executing the Terraform plan, you must set the environment variables which will be used by the plan. These variables are based on the Azure service principal you&rsquo;ve just created, your Azure subscription and tenant, and your VMware vSphere credentials.</p><ul><li><p>Retrieve your Azure subscription ID and tenant ID using the <code>az account list</code> command.</p></li><li><p>The Terraform plan creates resources in both Microsoft Azure and VMware vSphere. It then executes a script on the virtual machine to install the Azure Arc agent and all necessary artifacts. This script requires certain information about your VMware vSphere and Azure environments. Edit <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/vmware/winsrv/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> and update each of the variables with the appropriate values.</p><ul><li>TF_VAR_subscription_id=Your Azure subscription ID</li><li>TF_VAR_client_id=Your Azure service principal name</li><li>TF_VAR_client_secret=Your Azure service principal password</li><li>TF_VAR_tenant_id=Your Azure tenant ID</li><li>TF_VAR_resourceGroup=Azure resource group name</li><li>TF_VAR_location=Azure Region</li><li>TF_VAR_vsphere_user=vCenter Admin Username</li><li>TF_VAR_vsphere_password=vCenter Admin Password</li><li>TF_VAR_vsphere_server=vCenter server FQDN/IP</li><li>TF_VAR_admin_user=OS Admin Username</li><li>TF_VAR_admin_password=OS Admin Password</li></ul></li><li><p>From CLI, navigate to the <em>azure_arc_servers_jumpstart/vmware/winsrv/terraform</em> directory of the cloned repo.</p></li><li><p>Export the environment variables you edited by running <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/vmware/winsrv/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> with the source command as shown below. Terraform requires these to be set for the plan to execute properly. Note that this script will also be automatically executed remotely on the virtual machine as part of the Terraform deployment.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>source</span> ./scripts/vars.sh
</code></pre></div></li><li><p>In addition to the <em>TF_VAR</em> environment variables you&rsquo;ve just exported, edit the Terraform variables in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/vmware/winsrv/terraform/terraform.tfvars><em>terraform.tfvars</em></a> to match your VMware vSphere environment.</p><p><img src=./01.png alt="TF_VAR environment variables"></p></li><li><p>Run the <code>terraform init</code> command which will download the Terraform AzureRM, Local and vSphere providers.</p><p><img src=./02.png alt="terraform init"></p></li><li><p>Run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish.Once the Terraform deployment is completed, a new Windows Server VM will be up & running and will be projected as an Azure Arc server resource in a newly created Azure resource group.</p><p><img src=./03.png alt="terraform apply completed"></p><p><img src=./04.png alt="New VMware vSphere Windows Server VM"></p><p><img src=./05.png alt="Azure Arc enabled server in an Azure resource group"></p><p><img src=./06.png alt="Azure Arc enabled server in an Azure resource group"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><ul><li><p>The most straightforward way is to delete the Azure Arc resource via the Azure Portal, just select the resource and delete it. In addition, delete the VMware vSphere VM.</p><p><img src=./07.png alt="Delete Azure Arc enabled server"></p></li><li><p>If you delete the instance manually, then you should also delete <em>install_arc_agent.ps1</em> which is created by the Terraform plan.</p></li><li><p>If you want to nuke the entire environment use the <code>terraform destroy --auto-approve</code> command as shown below.</p><p><img src=./08.png alt="terraform destroy"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-445074e741930bddb3d57e908f6dcc90>1.6.2.1 - Create Windows vSphere template</h1><h2 id=create-a-vmware-vsphere-template-for-windows-server-2019>Create a VMware vSphere template for Windows Server 2019</h2><p>The following README will guide you on how to create a Windows Server 2019 VMware vSphere virtual machine template.</p><h2 id=prerequisites>Prerequisites</h2><blockquote><p><strong>Note: This guide assumes that you have some VMware vSphere familiarity and you have knowledge on how to install Windows Server. It is also does not designed to go over either VMware and/or Windows best-practices.</strong></p></blockquote><ul><li><p><a href=https://www.microsoft.com/en-us/windows-server/trial>Download the latest Windows Server ISO file</a></p></li><li><p>VMware vSphere 6.5 and above</p></li><li><p>Although it can be used locally, for faster deployment, it is recommended to upload the file to a vSphere datastore or to vCenter Content Library.</p></li></ul><h2 id=creating-windows-server-2019-vm-template>Creating Windows Server 2019 VM Template</h2><h3 id=deploying--installing-windows-server>Deploying & Installing Windows Server</h3><ul><li><p>Deploy new virtual machine</p><p><img src=./01.png alt="Create new VMware vSphere VM"></p><p><img src=./02.png alt="Create new VMware vSphere VM"></p><p><img src=./03.png alt="Create new VMware vSphere VM"></p><p><img src=./04.png alt="Create new VMware vSphere VM"></p><p><img src=./05.png alt="Create new VMware vSphere VM"></p><p><img src=./06.png alt="Create new VMware vSphere VM"></p></li><li><p>Make sure to select <em>Microsoft Windows Server 2016 or later (64-bit)</em> as the Guest OS.</p><p><img src=./07.png alt="Windows Server Guest OS"></p></li><li><p>Point to the Windows Server ISO file location.</p><p><img src=./08.png alt="Create new VMware vSphere VM"></p><p><img src=./09.png alt="Create new VMware vSphere VM"></p></li><li><p>Power-on the VM and start the Windows Server installation.</p><p><img src=./10.png alt="Power-on the VM"></p><p><img src=./11.png alt="Windows Server installation"></p><p><img src=./12.png alt="Windows Server installation"></p><p><img src=./13.png alt="Windows Server installation"></p><p><img src=./14.png alt="Windows Server installation"></p><p><img src=./15.png alt="Windows Server installation"></p><p><img src=./16.png alt="Windows Server installation"></p></li></ul><h3 id=post-installation>Post-installation</h3><p>Before converting the VM to a template, few actions needs to be taken.</p><ul><li><p>Install VMware Tools & Restart</p><p><img src=./17.png alt="Install VMware Tools"></p><p><img src=./18.png alt="Install VMware Tools"></p><p><img src=./19.png alt="Install VMware Tools"></p><p><img src=./20.png alt="Install VMware Tools"></p><p><img src=./21.png alt="Install VMware Tools"></p><p><img src=./22.png alt="Install VMware Tools"></p><p><img src=./23.png alt="Install VMware Tools"></p><p><img src=./24.png alt="Install VMware Tools"></p><p><img src=./25.png alt="Install VMware Tools"></p></li><li><p>Perform Windows Updates</p></li><li><p>Change PowerShell Execution Policy to &ldquo;bypass&rdquo; by running the <code>Set-ExecutionPolicy -ExecutionPolicy Bypass</code> command in PowerShell (can be later tuned on via Group Policy or a PowerShell script).</p></li><li><p>Allow WinRM communication to the OS buy running the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/vmware/winsrv/terraform/scripts/allow_winrm.ps1><em>allow_winrm</em></a> PowerShell script.</p></li><li><p>None of the below are mandatory but should be considered for a Windows Template:</p><ul><li><p>Disabling User Account Control (can be later tuned on via Group Policy or a PowerShell script)</p></li><li><p>Turn off Windows Defender FW (can be later tuned on via Group Policy or a PowerShell script)</p></li><li><p>Disabling Internet Explorer Enhanced Security Configuration (ESC) (can be later tuned on via Group Policy or a PowerShell script)</p></li><li><p>Enable Remote Desktop</p></li><li><p>In PowerShell, install <a href=https://chocolatey.org/install>Chocolaty</a></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#204a87>Set-ExecutionPolicy</span> <span style=color:#000>Bypass</span> <span style=color:#000>-Scope</span> <span style=color:#204a87;font-weight:700>Process</span> <span style=color:#000>-Force</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>[System.Net.ServicePointManager]</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>SecurityProtocol</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>[System.Net.ServicePointManager]</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>SecurityProtocol</span> <span style=color:#ce5c00;font-weight:700>-bor</span> <span style=color:#000>3072</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>iex </span><span style=color:#000;font-weight:700>((</span><span style=color:#204a87>New-Object</span> <span style=color:#000>System</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Net</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WebClient</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>DownloadString</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;https://chocolatey.org/install.ps1&#39;</span><span style=color:#000;font-weight:700>))</span>
</code></pre></div></li><li><p>Install all baseline apps you may want to include in your template.</p></li></ul></li></ul><h3 id=convert-to-template>Convert to Template</h3><p>Reduce the VM CPU count & memory resources to the minimum and convert the VM to template, switch the CD/DVD drive to client device as well disconnect it and convert the VM to template.</p><p><img src=./26.png alt="Reduce the VM CPU count & Memory"></p><p><img src=./27.png alt="Convert the VM to template"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-0234ac16eaff72421179b07a80c54256>1.7 - Unified Operations Use Cases</h1><div class=lead>Once you have server resources projected into Azure with Azure Arc, you can start to use native Azure tooling to manage the servers as native Azure resources. The following scenarios show examples of using Azure management tools such as resource tags, Azure Policy, Log Analytics, and more with Azure Arc enabled servers.</div></div><div class=td-content><h1 id=pg-f662c3c6424f0e3f7be88762438f027f>1.7.1 - Inventory Tagging</h1><h2 id=apply-inventory-tagging-to-azure-arc-enabled-servers>Apply inventory tagging to Azure Arc enabled servers</h2><p>The following README will guide you on how to use Azure Arc enabled servers to provide server inventory management capabilities across hybrid multi-cloud and on-premises environments.</p><p>Azure Arc enabled servers allows you to manage your Windows and Linux machines hosted outside of Azure on your corporate network or other cloud provider, similarly to how you manage native Azure virtual machines. When a hybrid machine is connected to Azure, it becomes a connected machine and is treated as a resource in Azure. Each connected machine has a Resource ID, is managed as part of a resource group inside a subscription, and benefits from standard Azure constructs such as Azure Policy and applying tags. The ability to easily organize and manage server inventory using Azure as a management engine greatly reduces administrative complexity and provides a consistent strategy for hybrid and multi-cloud environments.</p><p>In this guide, we will use <a href=https://docs.microsoft.com/en-us/azure/governance/resource-graph/first-query-portal>Resource Graph Explorer</a> and <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">AZ CLI</a> to demonstrate tagging and querying server inventory across multiple clouds from a single pane of glass in Azure.</p><blockquote><p><strong>Note: This guide assumes you already deployed VMs or servers that are running on-premises or other clouds and you have connected them to Azure Arc but If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion:</strong></p></blockquote><ul><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_windows/>GCP Windows instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_al2/>AWS Amazon Linux 2 EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_win/>Azure Windows VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>VMware vSphere Windows Server VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_windows/>Vagrant Windows box</a></strong></li></ul><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li></ul><h2 id=verify-that-your-arc-connected-servers-are-ready-for-tagging>Verify that your Arc connected servers are ready for tagging</h2><p>We will be using Resource Graph Explorer during this exercise to query and view resources in Azure.</p><ul><li><p>Enter &ldquo;Resource Graph Explorer&rdquo; in the top search bar in the Azure portal and select it.</p><p><img src=./01.png alt="Screenshot showing Resource Graph Explorer in Azure Portal"></p></li><li><p>In the query window, enter the following query and then click &ldquo;Run Query&rdquo;:</p><pre><code class=language-kusto data-lang=kusto>Resources
| where type =~ 'Microsoft.HybridCompute/machines'
</code></pre></li><li><p>If you have correctly created Azure Arc enabled servers, they should be listed in the Results pane of Resource Graph Explorer. You can also view the Azure Arc enabled serves from the Azure portal.</p><p><img src=./02.png alt="Screenshot showing Resource Graph Explorer query"></p><p><img src=./10.png alt="Screenshot showing Azure Portal with Azure Arc enabled server"></p><p><img src=./11.png alt="Screenshot showing Azure Arc enabled server details"></p></li></ul><h2 id=create-a-basic-azure-tag-taxonomy>Create a basic Azure tag taxonomy</h2><ul><li><p>Open AZ CLI and run the following commands to create a basic taxonomy structure that will allow us to easily query and report on where our server resources are hosted (i.e., Azure vs AWS vs GCP vs On-premises). For more guidance on building out a tag taxonomy please review the <a href=https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/decision-guides/resource-tagging/>Resource naming and tagging decision guide</a>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az tag create --name <span style=color:#4e9a06>&#34;Hosting Platform&#34;</span>
az tag add-value --name <span style=color:#4e9a06>&#34;Hosting Platform&#34;</span> --value <span style=color:#4e9a06>&#34;Azure&#34;</span>
az tag add-value --name <span style=color:#4e9a06>&#34;Hosting Platform&#34;</span> --value <span style=color:#4e9a06>&#34;AWS&#34;</span>
az tag add-value --name <span style=color:#4e9a06>&#34;Hosting Platform&#34;</span> --value <span style=color:#4e9a06>&#34;GCP&#34;</span>
az tag add-value --name <span style=color:#4e9a06>&#34;Hosting Platform&#34;</span> --value <span style=color:#4e9a06>&#34;On-premises&#34;</span>
</code></pre></div><p><img src=./05.png alt="Screenshot showing output of az tag create"></p></li></ul><h2 id=tag-arc-resources>Tag Arc resources</h2><p>Now that we have created a basic taxonomy structure, we will apply tags to our Azure Arc enabled server resources. In this guide, we will demonstrate tagging resources in both AWS and GCP. If you only have resources in one of these providers, you can skip to the appropriate section for AWS or GCP.</p><h3 id=tag-arc-connected-aws-ubuntu-ec2-instance>Tag Arc-connected AWS Ubuntu EC2 instance</h3><ul><li><p>In AZ CLI, run the following commands to apply the &ldquo;Hosting Platform : AWS&rdquo; tag to your AWS Azure Arc enabled servers.</p><blockquote><p><strong>Note: If you connected your AWS EC2 instances using a method other than the one described in <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>this tutorial</a>, then you will need to adjust the values for <code>awsResourceGroup</code> and <code>awsMachineName</code> to match values specific to your environment.</strong></p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>export</span> <span style=color:#000>awsResourceGroup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;arc-aws-demo&#34;</span>
<span style=color:#204a87>export</span> <span style=color:#000>awsMachineName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;arc-aws-demo&#34;</span>
<span style=color:#204a87>export</span> <span style=color:#000>awsMachineResourceId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span>az resource show --resource-group <span style=color:#000>$awsResourceGroup</span> --name <span style=color:#000>$awsMachineName</span> --resource-type <span style=color:#4e9a06>&#34;Microsoft.HybridCompute/machines&#34;</span> --query id<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
<span style=color:#204a87>export</span> <span style=color:#000>awsMachineResourceId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#000>$awsMachineResourceId</span> <span style=color:#000;font-weight:700>|</span> tr -d <span style=color:#4e9a06>&#34;\&#34;&#34;</span> <span style=color:#000;font-weight:700>|</span> tr -d <span style=color:#4e9a06>&#39;\r&#39;</span><span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
az resource tag --ids <span style=color:#000>$awsMachineResourceId</span> --tags <span style=color:#4e9a06>&#34;Hosting Platform&#34;</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;AWS&#34;</span>
</code></pre></div><p><img src=./07.png alt="Screenshot showing output of az resource tag"></p></li></ul><h3 id=tag-arc-connected-gcp-ubuntu-server>Tag Arc-connected GCP Ubuntu server</h3><ul><li><p>In AZ CLI, run the following commands to apply the &ldquo;Hosting Platform : GCP&rdquo; tag to your GCP Azure Arc enabled servers.</p><blockquote><p><strong>Note: If you connected your GCP instances using a method other than the one described in <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>this tutorial</a>, then you will need to adjust the values for <code>gcpResourceGroup</code> and <code>gcpMachineName</code> to match values specific to your environment.</strong></p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>export</span> <span style=color:#000>gcpResourceGroup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;arc-gcp-demo&#34;</span>
<span style=color:#204a87>export</span> <span style=color:#000>gcpMachineName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;arc-gcp-demo&#34;</span>
<span style=color:#204a87>export</span> <span style=color:#000>gcpMachineResourceId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span>az resource show --resource-group <span style=color:#000>$gcpResourceGroup</span> --name <span style=color:#000>$gcpMachineName</span> --resource-type <span style=color:#4e9a06>&#34;Microsoft.HybridCompute/machines&#34;</span> --query id<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
<span style=color:#204a87>export</span> <span style=color:#000>gcpMachineResourceId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#000>$gcpMachineResourceId</span> <span style=color:#000;font-weight:700>|</span> tr -d <span style=color:#4e9a06>&#34;\&#34;&#34;</span> <span style=color:#000;font-weight:700>|</span> tr -d <span style=color:#4e9a06>&#39;\r&#39;</span><span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
az resource tag --resource-group <span style=color:#000>$gcpResourceGroup</span> --ids <span style=color:#000>$gcpMachineResourceId</span> --tags <span style=color:#4e9a06>&#34;Hosting Platform&#34;</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;GCP&#34;</span>
</code></pre></div><p><img src=./08.png alt="Screenshot showing output of az resource tag"></p></li></ul><h2 id=query-resources-by-tag-using-resource-graph-explorer>Query resources by tag using Resource Graph Explorer</h2><p>Now that we have applied tags to our resources that are hosted in multiple clouds, we can use Resource Graph Explorer to query them and get insight into our multi-cloud landscape.</p><ul><li><p>In the query window, enter the following query:</p><pre><code class=language-kusto data-lang=kusto>Resources
| where type =~ 'Microsoft.HybridCompute/machines'
| where isnotempty(tags['Hosting Platform'])
| project name, location, resourceGroup, tags
</code></pre><p><img src=./04.png alt="Screenshot showing Resource Graph Explorer query"></p></li><li><p>Click &ldquo;Run Query&rdquo; and then select the Formatted Results toggle. If done correctly, you should see all Azure Arc enabled servers and their assigned &ldquo;Hosting Platform&rdquo; tag values.</p><p><img src=./06.png alt="Screenshot showing results of Resource Graph Explorer query"></p></li><li><p>We can also view the tags on the projected servers from Azure Portal.</p><p><img src=./12.png alt="Screenshot showing tags on Azure Arc enabled server"></p><p><img src=./13.png alt="Screenshot showing tags on Azure Arc enabled server"></p></li></ul><h2 id=clean-up-environment>Clean up environment</h2><p>Complete the following steps to clean up your environment.</p><ul><li><p>Remove the virtual machines from each environment by following the teardown instructions from each guide.</p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_windows/>GCP Windows instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_al2/>AWS Amazon Linux 2 EC2 instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_win/>Azure Windows VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>VMware vSphere Windows Server VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_windows/>Vagrant Windows box</a></strong></p></li><li><p>Remove tags created as part of this guide by executing the following script in AZ CLI.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az tag remove-value --name <span style=color:#4e9a06>&#34;Hosting Platform&#34;</span> --value <span style=color:#4e9a06>&#34;Azure&#34;</span>
az tag remove-value --name <span style=color:#4e9a06>&#34;Hosting Platform&#34;</span> --value <span style=color:#4e9a06>&#34;AWS&#34;</span>
az tag remove-value --name <span style=color:#4e9a06>&#34;Hosting Platform&#34;</span> --value <span style=color:#4e9a06>&#34;GCP&#34;</span>
az tag remove-value --name <span style=color:#4e9a06>&#34;Hosting Platform&#34;</span> --value <span style=color:#4e9a06>&#34;On-premises&#34;</span>
az tag create --name <span style=color:#4e9a06>&#34;Hosting Platform&#34;</span>
</code></pre></div></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-caccbcbc963315fae066659de1818715>1.7.2 - Monitoring Agent Extension</h1><h2 id=deploy-monitoring-agent-extension-on-azure-arc-linux-and-windows-servers-using-extension-management>Deploy Monitoring Agent Extension on Azure Arc Linux and Windows servers using Extension Management</h2><p>The following README will guide you on how to manage extensions on Azure Arc enabled servers. Virtual machine extensions are small applications that provide post-deployment configuration and automation tasks such as software installation, anti-virus protection, or a mechanism to run a custom script.</p><p>Azure Arc enabled servers, enables you to deploy Azure VM extensions to non-Azure Windows and Linux VMs, giving you a hybrid or multi-cloud management experience that levels to Azure VMs.</p><p>You can use the Azure portal, Azure CLI, an ARM template, PowerShell script or Azure policies to manage the extension deployment to Azure Arc enabled servers, both Linux and Windows. In this guide, you will use an ARM template deploy the Microsoft Monitoring Agent (MMA) to your servers so they are onboard on Azure services that leverage this agent: Azure Monitor, Azure Security Center, Azure Sentinel, etc.</p><blockquote><p><strong>Note: This guide assumes you already deployed VMs or servers that are running on-premises or other clouds and you have connected them to Azure Arc but If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion:</strong></p></blockquote><ul><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_windows/>GCP Windows instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_al2/>AWS Amazon Linux 2 EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_win/>Azure Windows VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>VMware vSphere Windows Server VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_windows/>Vagrant Windows box</a></strong></li></ul><p>Please review the <a href=https://docs.microsoft.com/en-us/azure/azure-monitor/insights/vminsights-enable-overview#supported-operating-systems>Azure Monitor supported OS documentation</a> and ensure that the VMs you will use for this exercise are supported. For Linux VMs, check both the Linux distribution and kernel to ensure you are using a supported configuration.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p>As mentioned, this guide starts at the point where you already deployed and connected VMs or servers to Azure Arc. In the screenshots below you can see a GCP server has been connected with Azure Arc and is visible as a resource in Azure.</p><p><img src=./01.png alt="Screenshot Azure Arc enabled server on resource group"></p><p><img src=./02.png alt="Screenshot Azure Arc enabled server connected status"></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI</a>. Azure CLI should be running version 2.7** or later. Use <code>az --version</code> to check your current installed version.</p></li><li><p>Create Azure Service Principal (SP)</p><p>To connect a VM or bare-metal server to Azure Arc, Azure service principal assigned with the &ldquo;contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a>.</strong></p></blockquote></li><li><p>You will also need to have a Log Analytics workspace deployed. You can automate the deployment by editing the ARM template <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/extensions/arm/log_analytics-template.parameters.json>parameters file</a> and provide a name and location for your workspace.</p><p><img src=./03.png alt="Screenshot ARM template parameters file"></p><p>To deploy the ARM template, navigate to the &ldquo;deployment folder&rdquo; <em><strong>../extensions/arm</strong></em> and run the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az deployment group create --resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-file &lt;The *log_analytics-template.json* template file location&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters &lt;The *log_analytics-template.parameters.json* template file location&gt;
</code></pre></div></li></ul><h2 id=azure-arc-enabled-servers-microsoft-monitoring-agent-extension-deployment>Azure Arc enabled servers Microsoft Monitoring Agent Extension Deployment</h2><ul><li><p>Edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/extensions/arm/mma-template.parameters.json><em>extensions parameters file</em></a></p><p><img src=./04.png alt="Screenshot ARM template parameters file"></p></li><li><p>To match your configuration you will need to provide:</p><ul><li><p>The VM name as it is registered in Azure Arc.</p><p><img src=./05.png alt="Screenshot Azure Arc enabled server computer name"></p></li><li><p>The location of the resource group where you registered the Azure Arc enabled server.</p><p><img src=./06.png alt="Screenshot Azure Arc enabled server location"></p></li><li><p>Information of the Log Analytics workspace you previously created: workspace ID and key. These parameters will be used to configure the MMA agent. You can get this information by going to your Log Analytics workspace and under &ldquo;Settings&rdquo; select &ldquo;Agent management&rdquo;.</p><p><img src=./07.png alt="Screenshot Azure Arc enabled server Agent management"></p><p><img src=./08.png alt="Screenshot workspace configuration"></p></li></ul></li><li><p>Choose the ARM template that matches your operating system, for <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/extensions/arm/mma-template-windows.json><em>Windows</em></a> and <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/extensions/arm/mma-template-linux.json><em>Linux</em></a>, deploy the template by running the following command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az deployment group create --resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-file &lt;The *mma-template.json* template file location&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters &lt;The *mma-template.parameters.json* template file location&gt;
</code></pre></div></li><li><p>Once the template has completed its run, you should see an output as follows:</p><p><img src=./09.png alt="Screenshot ARM template execution output"></p></li><li><p>You will have the Microsoft Monitoring agent deployed on your Windows or Linux system and reporting to the Log Analytics workspace that you have selected. You can verify by going back to the &ldquo;Agents management&rdquo; section of your workspace and choosing either Windows or Linux, you should see now an additional connected VM.</p><p><img src=./10.png alt="Screenshot Windows connected agents"></p><p><img src=./11.png alt="Screenshot Linux connected agents"></p></li></ul><h2 id=clean-up-environment>Clean up environment</h2><p>Complete the following steps to clean up your environment.</p><p>Remove the virtual machines from each environment by following the teardown instructions from each guide.</p><ul><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_windows/>GCP Windows instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_al2/>AWS Amazon Linux 2 EC2 instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_win/>Azure Windows VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>VMware vSphere Windows Server VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_windows/>Vagrant Windows box</a></strong></p></li><li><p>Remove the Log Analytics workspace by executing the following command in AZ CLI. Provide the workspace name you used when creating the Log Analytics Workspace.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az monitor log-analytics workspace delete --resource-group &lt;Name of the Azure resource group&gt; --workspace-name &lt;Log Analytics Workspace Name&gt; --yes
</code></pre></div></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8a7b8f2b3e4ec67d3a0eede84e3eae93>1.7.3 - Custom Script Extension</h1><h2 id=deploy-custom-script-extension-on-azure-arc-linux-and-windows-servers-using-extension-management>Deploy Custom Script Extension on Azure Arc Linux and Windows servers using Extension Management</h2><p>The following README will guide you on how to execute custom scripts on Azure Arc enabled servers by using Virtual Machine extensions. Virtual machine extensions are small applications that provide post-deployment configuration and automation tasks such as software installation, anti-virus protection, or a mechanism to run a custom script.</p><p>You can use the Azure portal, Azure CLI, an ARM template, PowerShell or Linux Shell script, or Azure policies to manage the extension deployment to Azure Arc enabled servers. In this guide, we will use an ARM template to deploy the custom script extension. This extension downloads and executes scripts on virtual machines and it is useful for post deployment configuration, software installation, or any other configuration or management tasks.</p><blockquote><p><strong>Note: This guide assumes you already deployed VMs or servers that are running on-premises or other clouds and you have connected them to Azure Arc but If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion:</strong></p></blockquote><ul><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_windows/>GCP Windows instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_al2/>AWS Amazon Linux 2 EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_win/>Azure Windows VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>VMware vSphere Windows Server VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_windows/>Vagrant Windows box</a></strong></li></ul><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p>As mentioned, this guide starts at the point where you already deployed and connected VMs or servers to Azure Arc. In the screenshots below you can see a GCP server has been connected with Azure Arc and is visible as a resource in Azure.</p><p><img src=./01.png alt="Screenshot Azure Arc enabled server on resource group"></p><p><img src=./02.png alt="Screenshot Azure Arc enabled server on connected status"></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI</a>. Azure CLI should be running version 2.7** or later. Use <code>az --version</code> to check your current installed version.</p></li><li><p>Create Azure Service Principal (SP)</p><p>To connect a VM or bare-metal server to Azure Arc, Azure service principal assigned with the &ldquo;contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a>.</strong></p></blockquote></li><li><p>In order to demonstrate the custom script extension, we will use the below Linux and Windows scripts.</p><ul><li><a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/scripts/custom_script_linux.sh><em>Linux</em></a>: The script will modify the message of the day (MOTD) on the operating system.</li><li><a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/scripts/custom_script_windows.ps1><em>Windows</em></a>: The script will install Windows Terminal, Microsoft Edge, 7zip and Visual Studio Code <a href=https://chocolatey.org/>Chocolaty</a> packages on the VM.</li></ul></li></ul><h2 id=azure-arc-enabled-servers-custom-script-extension-deployment>Azure Arc enabled servers Custom Script Extension Deployment</h2><ul><li><p>Edit the extensions parameters file for <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/extensions/arm/customscript-templatewindows.parameters.json><em>Windows</em></a> or for <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/extensions/arm/customscript-templatelinux.parameters.json><em>Linux</em></a></p><p><img src=./03.png alt="Screenshot parameters file"></p></li><li><p>To match your environment configuration, you will need to provide the following information:</p><ul><li><p>The VM name as it is registered in Azure Arc.</p><p><img src=./04.png alt="Screenshot Azure Arc enabled server machine name"></p></li><li><p>The location of the resource group where you registered the Azure Arc enabled server.</p><p><img src=./05.png alt="Screenshot Azure region"></p></li><li><p>A public Uri for the script that you would like to run on the servers, in this case use the URL for the script in raw format.</p><ul><li>For Windows: <a href=https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_servers_jumpstart/scripts/custom_script_windows.ps1>Public Uri</a></li><li>For Linux: <a href=https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_servers_jumpstart/scripts/custom_script_linux.sh>Public Uri</a></li></ul></li><li><p>To run either script, use the below commands:</p><ul><li><p>Windows:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000>powershell</span> <span style=color:#000>-ExecutionPolicy</span> <span style=color:#000>Unrestricted</span> <span style=color:#ce5c00;font-weight:700>-File</span> <span style=color:#000>custom_script_windows</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ps1</span>
</code></pre></div></li><li><p>Linux:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>./custom_script_linux.sh
</code></pre></div></li></ul></li></ul></li><li><p>To deploy the ARM template for Linux or Windows, navigate to the <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_servers_jumpstart/extensions/arm>deployment folder</a> and run the below command with the templates that match your operating system:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az deployment group create --resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-file &lt;The *customscript-template.json* template file location <span style=color:#204a87;font-weight:700>for</span> Linux or Windows&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters &lt;The *customscript-template.parameters.json* template file location&gt;
</code></pre></div></li><li><p>Once the template deployment has completed it&rsquo;s run, you should see an output as follows:</p><p><img src=./06.png alt="Screenshot ARM template output"></p></li><li><p>To verify a successful deployment on the Azure Arc enabled server, in the Azure Portal, by clicking on &ldquo;Extensions&rdquo; settings. You should see the Custom Script extension installed.</p><p><img src=./07.png alt="Screenshot custom script extension"></p></li><li><p>Another way to verify successful custom script execution is by connecting to the VMs and verifying that the operating system has been configured.</p><ul><li><p>For the Linux VM, use SSH to connect the VM and check out the message of the day which was customized by the script:</p><p><img src=./08.png alt="Screenshot message of the day changed"></p></li><li><p>For the Windows VM, use RDP to connect the VM and verify that the additional software has been installed: Microsoft Edge, 7zip and Visual Studio Code.</p><p><img src=./09.png alt="Screenshot additional software installed"></p></li></ul></li></ul><h2 id=clean-up-environment>Clean up environment</h2><p>Complete the following steps to clean up your environment.</p><p>Remove the virtual machines from each environment by following the teardown instructions from each guide.</p><ul><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_windows/>GCP Windows instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_al2/>AWS Amazon Linux 2 EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_win/>Azure Windows VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>VMware vSphere Windows Server VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_windows/>Vagrant Windows box</a></strong></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4bcf5ee34563db9860f2594f7c5d636a>1.7.4 - Azure Policy</h1><h2 id=deploy-monitoring-agent-extension-to-azure-arc-linux-and-windows-servers-using-azure-policy>Deploy Monitoring Agent Extension to Azure Arc Linux and Windows servers using Azure Policy</h2><p>The following README will guide you on how to use Azure Arc enabled servers to assign Azure Policies to VMs outside of Azure, whether they are on-premises or other clouds. With this feature you can now use Azure Policy to audit settings in the operating system of an Azure Arc enabled server, if a setting is not compliant you can also trigger a remediation task.</p><p>In this case, you will assign a policy to audit if the Azure Arc connected machine has the (Microsoft Monitoring Agent) MMA agent installed, if not, you will use the extensions feature to automatically deploy it to the VM, an enrollment experience that levels to Azure VMs. This approach can be used to make sure all your servers are onboard to services such as Azure Monitor, Azure Security Center, Azure Sentinel, etc.</p><p>You can use the Azure Portal, an ARM template or PowerShell script to assign policies to Azure subscriptions or resource groups. In this guide, you will use an ARM template to assign built-in policies.</p><blockquote><p><strong>Note: This guide assumes you already deployed VMs or servers that are running on-premises or other clouds and you have connected them to Azure Arc but If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion:</strong></p></blockquote><ul><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_windows/>GCP Windows instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_al2/>AWS Amazon Linux 2 EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_win/>Azure Windows VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>VMware vSphere Windows Server VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_windows/>Vagrant Windows box</a></strong></li></ul><p>Please review the <a href=https://docs.microsoft.com/en-us/azure/azure-monitor/insights/vminsights-enable-overview#supported-operating-systems>Azure Monitor supported OS documentation</a> and ensure that the VMs you will use for this guide are supported. For Linux VMs, check both the Linux distribution and kernel to ensure you are using a supported configuration.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p>As mentioned, this guide starts at the point where you already deployed and connected VMs or servers to Azure Arc. In the screenshots below we can see a GCP server has been connected with Azure Arc and is visible as a resource in Azure.</p><p><img src=./01.png alt="Screenshot Azure Arc enabled server on resource group"></p><p><img src=./02.png alt="Screenshot Azure Arc enabled server connected status"></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI</a>. Azure CLI should be running version 2.7** or later. Use <code>az --version</code> to check your current installed version.</p></li><li><p>Create Azure service principal (SP)</p><p>To connect a VM or bare-metal server to Azure Arc, Azure service principal assigned with the &ldquo;contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a>.</strong></p></blockquote></li><li><p>You will also need to have a Log Analytics workspace deployed. You can automate the deployment by editing the ARM template <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/policies/arm/log_analytics-template.parameters.json>parameters file</a>, provide a name and location for your workspace.</p><p><img src=./03.png alt="Screenshot ARM template parameters file"></p><p>To deploy the ARM template, navigate to the <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_servers_jumpstart/policies/arm>deployment folder</a> and run the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>  az deployment group create --resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>  --template-file &lt;The *log_analytics-template.json* template file location&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>  --parameters &lt;The *log_analytics-template.parameters.json* template file location&gt;
</code></pre></div></li></ul><h2 id=azure-policies-on-azure-arc-connected-machines>Azure Policies on Azure Arc connected machines</h2><ul><li><p>Now that you have all the prerequisites set, you can assign policies to our Arc connected machines. Edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/policies/arm/policy.json>parameters file</a> to provide your subscription ID as well as the Log Analytics workspace.</p><p><img src=./04.png alt="Screenshot ARM template parameter file"></p><p>To start the deployment, use the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az policy assignment create --name <span style=color:#4e9a06>&#39;Enable Azure Monitor for VMs&#39;</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--scope <span style=color:#4e9a06>&#39;/subscriptions/&lt;Your subscription ID&gt;/resourceGroups/&lt;Name of the Azure resource group&gt;&#39;</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--policy-set-definition <span style=color:#4e9a06>&#39;55f3eceb-5573-4f18-9695-226972c6d74a&#39;</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>-p &lt;The *policy.json* template file location&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--assign-identity --location &lt;Azure Region&gt;
</code></pre></div><p>The flag <em>policy-set-definition</em> points to the initiative &ldquo;Enable Azure Monitor&rdquo; definition ID.</p></li><li><p>Once the initiative is assigned, it takes around 30 minutes for the assignment to be applied to the defined scope. After those 30 minutes, Azure Policy will start the evaluation cycle against the Azure Arc connected machine and recognize it as &ldquo;Non-compliant&rdquo; (since it still does not have the Log Analytics Agent configuration deployed). To check this, go to the Azure Arc connected Machine under the Policies section.</p><p><img src=./05.png alt="Screenshot Azure Policy non-compliant"></p></li><li><p>Now, you will assign a remediation task to the non-compliant resource to put into a compliant state.</p><p><img src=./06.png alt="Screenshot Azure Policy remediation task"></p></li><li><p>Under &lsquo;Policy to remediate&rsquo; choose &lsquo;[Preview] Deploy Log Analytics Agent to Linux Azure Arc machines&rsquo; and select &lsquo;Remediate&rsquo;. This remediation task is instructing Azure Policy to run the deployIfNotExists effect and use the Azure Arc extension management capabilities to deploy the Log Analytics agent on the VM</p><p><img src=./07.png alt="Screenshot Azure Policy remediation task"></p></li><li><p>Once you have assigned remediation task, the policy will be evaluated again and show that the server on GCP is compliant and that the Microsoft Monitoring Agent extension is installed on the Azure Arc machine.</p><p><img src=./08.png alt="Screenshot remediation task configuration"></p><p><img src=./09.png alt="Screenshot Azure Policy compliant status"></p></li></ul><h2 id=clean-up-environment>Clean up environment</h2><p>Complete the following steps to clean up your environment.</p><p>Remove the virtual machines from each environment by following the teardown instructions from each guide.</p><ul><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_windows/>GCP Windows instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_al2/>AWS Amazon Linux 2 EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_win/>Azure Windows VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>VMware vSphere Windows Server VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_windows/>Vagrant Windows box</a></strong></li></ul><p>Remove the Azure Policy assignment by executing the following script in Azure CLI.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az policy assignment delete --name <span style=color:#4e9a06>&#39;Enable Azure Monitor for VMs&#39;</span> --resource-group &lt;resource_group&gt;
</code></pre></div><p>Remove the Log Analytics workspace by executing the following script in Azure CLI. Provide the workspace name you used when creating the Log Analytics workspace.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az monitor log-analytics workspace delete --resource-group &lt;Name of the Azure resource group&gt; --workspace-name &lt;Log Analytics workspace Name&gt; --yes
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-1960d9874e7502df863af9a46f8cae84>1.7.5 - Key Vault Integration</h1><h2 id=deploy-azure-key-vault-extension-to-azure-arc-enabled-ubuntu-server-and-use-a-key-vault-managed-certificate-with-nginx>Deploy Azure Key Vault Extension to Azure Arc enabled Ubuntu server and use a Key Vault managed certificate with Nginx</h2><p>The scenario will show you how to onboard the <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/key-vault-linux>Azure Key Vault</a> extension on an Azure Arc enabled server, and then use a certificate managed by Azure Key Vault to secure web traffic with TLS on a web server.</p><p>In this guide, we will focus on securing an Ubuntu web server. The only prerequisite you need to complete for this scenario is an existing Azure Arc enabled server running Ubuntu 18.04 (other Ubuntu releases may also work but have not been tested).</p><blockquote><p><strong>Note: This guide assumes you already deployed an Ubuntu server that is running on-premises or in other clouds and you have connected them to Azure Arc but If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion:</strong></p></blockquote><ul><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></li></ul><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p>As mentioned, this guide starts at the point where you already deployed and connected VMs or bare-metal servers to Azure Arc. For this scenario, as can be seen in the screenshots below, we will be using an Amazon Web Services (AWS) EC2 instance that has been already connected to Azure Arc and is visible as a resource in Azure.</p><p><img src=./01.png alt="Screenshot showing EC2 instance in AWS console"></p><p><img src=./02.png alt="Screenshot showing Azure Arc enabled server"></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li></ul><h2 id=create-an-azure-key-vault-and-a-new-self-signed-certificate>Create an Azure Key Vault and a new self-signed certificate</h2><p>First, we will create a new Azure resource group, Azure Key Vault and a self-signed certificate from an Az CLI.</p><ul><li><p>Create a new resource group to hold the key vault resource.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name &lt;name <span style=color:#204a87;font-weight:700>for</span> your resource group&gt; --location &lt;location <span style=color:#204a87;font-weight:700>for</span> your resource group&gt;
</code></pre></div><p><img src=./03.png alt="Screenshot of creating a resource group from Az CLI"></p></li><li><p>Create a new key vault resource. Note that key vault names must be globally unique.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az keyvault create --name &lt;name <span style=color:#204a87;font-weight:700>for</span> your keyvault&gt; --location &lt;location&gt; --resource-group &lt;name of your resource group&gt;
</code></pre></div><p><img src=./04.png alt="Screenshot of creating a keyvault from Az CLI"></p></li><li><p>Create a new self-signed certificate with keyvault.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az keyvault certificate create --vault-name arckeyvault1 -n cert1 -p <span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span>az keyvault certificate get-default-policy<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</code></pre></div><p><img src=./05.png alt="Screenshot of creating a self-signed certificate from Az CLI"></p></li></ul><h2 id=install-and-configure-nginx-on-your-azure-arc-enabled-ubuntu-server>Install and configure Nginx on your Azure Arc enabled Ubuntu server</h2><p>We will use the Azure Custom Script extension on your Azure Arc enabled server to install and configure an Nginx web server. Before installing Nginx, we must open the right inbound ports on our AWS EC2 instance&rsquo;s security group. Then we will deploy an ARM template that will use the custom script extension to install Nginx.</p><ul><li><p>Navigate to your EC2 instance on the AWS cloud console and open the &ldquo;allow-all-sg&rdquo; security group.</p><p><img src=./06.png alt="Screenshot of an EC2 instance in AWS cloud console"></p></li><li><p>Click on the &ldquo;Inbound&rdquo; tab of the security group and then click &ldquo;Edit&rdquo;.</p><p><img src=./07.png alt="Screenshot of a security group in AWS cloud console"></p><p><img src=./08.png alt="Screenshot of a security group in AWS cloud console"></p></li><li><p>Click &ldquo;Add Rule&rdquo; and add HTTP and HTTPS rules, keeping all the default seeings as seen in the screenshot. Click Save.</p><p><img src=./09.png alt="Screenshot of adding a security group rule in AWS cloud console"></p><p><img src=./10.png alt="Screenshot of added a security group rule in AWS cloud console"></p></li><li><p>Configure Key Vault to allow Azure Arc enabled server to access secrets</p><ul><li><p>Navigate to your Key Vault and open the &ldquo;Access Policies&rdquo; blade</p><p><img src=./11.png alt="Screenshot of the Access Policies blade in a Key Vault"></p></li><li><p>Click &ldquo;Add access policy&rdquo; and in the dropdown for &ldquo;Secret Permissions&rdquo; check Get and List.</p><p><img src=./12.png alt="Screenshot showing &ldquo;Add access policy&rdquo; for Key Vault"></p></li><li><p>Next to &ldquo;Select principal&rdquo; Click &ldquo;None selected&rdquo; and search for your Azure Arc enabled server machine name and select it.</p><p><img src=./13.png alt="Screenshot showing &ldquo;Add access policy&rdquo; for Key Vault"></p></li><li><p>Click &ldquo;Save&rdquo; to commit the changes.</p><p><img src=./14.png alt="Screenshot showing &ldquo;Add access policy&rdquo; for Key Vault"></p></li></ul></li><li><p>Use Custom Script extension to install Nginx and configure Key Vault extension</p><ul><li><p>Modify the values of nginx-keyvault.parameters.json for the following parameters with values for your environment:</p><p><img src=./15.png alt="Screenshot showing example parameters for nginx-keyvault.parameters.json"></p></li><li><p>Run the deployment with the following Az CLI command.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az deployment group create --resource-group &lt;name of your resource group&gt; --template-file nginx-keyvault.json --parameters nginx-keyvault.parameters.json
</code></pre></div><p><img src=./16.png alt="Screenshot showing ARM deployment completing"></p></li></ul></li><li><p>SSH into your Azure Arc enabled server to update the Nginx configuration to use the certificate.</p><p><img src=./17.png alt="Screenshot showing SSH into Azure Arc enabled server"></p><ul><li><p>Open <em>/etc/nginx/conf.d/ssl.conf</em> using nano or your preferred text editor.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>nano /etc/nginx/conf.d/ssl.conf
</code></pre></div><p><img src=./18.png alt="Screenshot showing nano editing /etc/nginx/conf.d/ssl.conf"></p></li><li><p>Edit the file updating the following lines with the correct path to your certificate.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ssl_certificate /etc/ssl/certs/&lt;your cert filename&gt;<span style=color:#000;font-weight:700>;</span>
ssl_certificate_key /etc/ssl/certs/&lt;your cert filename&gt;<span style=color:#000;font-weight:700>;</span>
</code></pre></div><p>Your filename will be of the format &lsquo;keyvault_name&rsquo;.&lsquo;certificate_name&rsquo; (all lowercase). For example, if your Key Vault is named &ldquo;myKeyVault&rdquo; and your certificate is named &ldquo;cert1&rdquo; then your filename will be &ldquo;mykeyvault.cert1&rdquo;. See the screens below for a before and after example.</p><p><img src=./19.png alt="Screenshot showing unedited /etc/nginx/conf.d/ssl.conf"></p><p><img src=./20.png alt="Screenshot showing edited /etc/nginx/conf.d/ssl.conf"></p></li><li><p>Restart the nginx service by running the following command.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo service nginx restart
</code></pre></div><p><img src=./21.png alt="Screenshot showing restart of nginx service"></p></li></ul></li><li><p>Test everything by accessing your Nginx webserver over HTTPS. Open a browser and enter &ldquo;https://XX.XX.XX.XX&rdquo; into the address bar, replacing the placeholder with the public IP address of your server.</p><ul><li><p>You should see a warning describing that your connection is not private or secure. The message will vary depending on which web browser you use.</p><p><img src=./22.png alt="Screenshot showing accessing web server in browser"></p></li><li><p>If you are using Microsoft Edge, you can validate that your certificate is being used by comparing the certificate thumbprint reported in the browser with your certificate thumbprint in Key Vault, as seen in the screenshots below. Click the &ldquo;Not secure&rdquo; box to the left of the address bar, then click &ldquo;Certificate (not valid)&rdquo; and open the &ldquo;Details&rdquo; tab to view the thumbprint.</p><p><img src=./23.png alt="Screenshot showing browser certificate thumbprint"></p><p><img src=./24.png alt="Screenshot showing browser certificate thumbprint"></p><p><img src=./25.png alt="Screenshot showing Key Vault certificate thumbprint"></p></li></ul></li></ul><h2 id=clean-up-environment>Clean up environment</h2><p>Complete the following steps to clean up your environment.</p><ul><li><p>Delete the key vault resource by running the following command in Az CLI.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az keyvault delete --name &lt;name of your keyvault&gt;
</code></pre></div><p><img src=./26.png alt="Screenshot showing Key Vault being deleted from Az CLI"></p></li><li><p>Remove the virtual machines from each environment by following the teardown instructions from each guide.</p><ul><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></li></ul></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-eda68bcba3c1263207b730fff996799e>1.7.6 - Security Center</h1><h2 id=connect-azure-arc-enabled-servers-to-azure-security-center>Connect Azure Arc enabled servers to Azure Security Center</h2><p>The following README will guide you on how to onboard an Azure Arc enabled server on to <a href=https://docs.microsoft.com/en-us/azure/security-center/>Azure Security Center (ASC)</a>, so you can start collecting security-related configurations as well as event logs to recommend actions and improve your overall Azure security posture.</p><p>In this guide, you will enable and configure Azure Security Center Standard tier on your Azure subscription, which will provide you with advanced threat protection (ATP) and detection capabilities. To complete this process you will:</p><ul><li><p>Setup a Log Analytics Workspace where logs and events will be aggregated for analysis.</p></li><li><p>Assign Security Center’s default security policies.</p></li><li><p>Review Azure Security Center&rsquo;s recommendations.</p></li><li><p>Apply recommended configurations on Azure Arc enabled servers using the <em><strong>Quick Fix</strong></em> remediations.</p></li></ul><blockquote><p><strong>Note: This guide assumes you already deployed VMs or servers that are running on-premises or other clouds and you have connected them to Azure Arc but If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion:</strong></p></blockquote><ul><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_windows/>GCP Windows instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_al2/>AWS Amazon Linux 2 EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_win/>Azure Windows VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>VMware vSphere Windows Server VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_windows/>Vagrant Windows box</a></strong></li></ul><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p>As mentioned, this guide starts at the point where you already deployed and connected VMs or bare-metal servers to Azure Arc. For this scenario, as can be seen in the screenshots below, we will be using a Google Cloud Platform (GCP) instance that has been already connected to Azure Arc and is visible as a resource in Azure.</p><p><img src=./01.png alt="Screenshot of Azure Portal showing Azure Arc enabled server"></p><p><img src=./02.png alt="Screenshot of Azure Portal showing Azure Arc enabled server detail"></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI</a>. Azure CLI should be running version 2.7** or later. Use <code>az --version</code> to check your current installed version.</p></li><li><p>Create Azure service principal (SP)</p><p>To connect a VM or bare-metal server to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a>.</strong></p></blockquote></li></ul><h2 id=onboarding-azure-security-center>Onboarding Azure Security Center</h2><ul><li><p>Data collected by Azure Security Center is stored in a Log Analytics workspace. You can either use the default one created by ASC or a custom one created by you. If you want to create a dedicated workspace, you can automate the deployment by editing the ARM template <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/securitycenter/arm/log_analytics-template.parameters.json>parameters file</a>, provide a name and location for your workspace:</p><p><img src=./03.png alt="Screenshot showing Azure ARM template"></p></li><li><p>To deploy the ARM template, navigate to the <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_servers_jumpstart/securitycenter/arm>deployment folder</a> and run the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>  az deployment group create --resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>  --template-file &lt;The *log_analytics-template.json* template file location&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>  --parameters &lt;The *log_analytics-template.parameters.json* template file location&gt;
</code></pre></div></li><li><p>If you are going for an user-defined workspace, you should instruct Security Center to use it instead of the default one, use the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>  az security workspace-setting create --name default <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>  --target-workspace <span style=color:#4e9a06>&#39;/subscriptions/&lt;Your subscription ID&gt;/resourceGroups/&lt;Name of the Azure resource group&gt;/providers/Microsoft.OperationalInsights/workspaces/&lt;Name of the Log Analytics Workspace&gt;&#39;</span>
</code></pre></div></li><li><p>Select the Azure Security Center tier. The Free tier is enabled on all your Azure subscriptions by default and will provide continuous security assessment and actionable security recommendations. In this guide, you will use the Standard tier for Virtual Machines that extends these capabilities providing unified security management and threat protection across your hybrid cloud workloads. To enable the Standard tier of Azure Security Center for VMs run the command below:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az security pricing create -n VirtualMachines --tier <span style=color:#4e9a06>&#39;standard&#39;</span>
</code></pre></div></li><li><p>Now you need to assign the default Security Center policy initiative. ASC makes its security recommendations based on policies. There is an specific initiative that groups Security Center policies with the definition ID &lsquo;1f3afdf9-d0c9-4c3d-847f-89da613e70a8&rsquo;. The command below will assign the ASC initiative to your subscription:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az policy assignment create --name <span style=color:#4e9a06>&#39;ASC Default &lt;Your subscription ID&gt;&#39;</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--scope <span style=color:#4e9a06>&#39;/subscriptions/&lt;Your subscription ID&gt;&#39;</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--policy-set-definition <span style=color:#4e9a06>&#39;1f3afdf9-d0c9-4c3d-847f-89da613e70a8&#39;</span>
</code></pre></div></li></ul><h2 id=azure-arc-and-azure-security-center-integration>Azure Arc and Azure Security Center Integration</h2><p>Now that you have successfully onboard ASC, you will get recommendations to help you protect your resources, including your Azure Arc enabled servers. ASC will then periodically analyze the security state of your Azure resources to identify potential security vulnerabilities.</p><ul><li><p>In the &ldquo;Compute & apps&rdquo; section under &ldquo;VM and Servers&rdquo;, ASC will provide you with an overview of all the discovered security recommendations for your VMs and computers, including Azure VMs, Azure Classic VMs, servers and <strong>Azure Arc Machines</strong>.</p><p><img src=./04.png alt="Screenshot showing Azure Security Center compute and apps"></p></li><li><p>On the Azure Arc enabled servers, ASC will provide a recommendation to install the Log Analytics agent. In addition, each recommendation will include:</p><ul><li><p>A short description of what is being recommended.</p></li><li><p>A Secure Score impact, in this case, with a status of <em>High</em>.</p></li><li><p>The remediation steps to carry out in order to implement the recommendation. For specific recommendations, like this one, you will also get a <em><strong>Quick Fix</strong></em> that enables you to quickly remediate a recommendation on multiple resources.</p><p><img src=./05.png alt="Screenshot showing ASC recommendation on Azure Arc enabled server"></p><p><img src=./06.png alt="Screenshot showing ASC recommendation to install Log Analytics"></p></li></ul></li><li><p>This remediation <em><strong>Quick Fix</strong></em> is using an ARM template to deploy the Microsoft Monitoring Agent extension on the Azure Arc machine.</p><p><img src=./07.png alt="Screenshot showing ASC Quick Fix ARM template"></p></li><li><p>You can trigger the remediation with the ARM template from the Azure Security Center dashboard, by selecting the Log Analytics Workspace used for ASC and clicking on &ldquo;Remediate 1 resource&rdquo;.</p><p><img src=./08.png alt="Screenshot showing triggering of remediation step of ASC"></p></li><li><p>After you apply the recommendation on the Azure Arc enabled server the resource will be now marked as healthy.</p><p><img src=./09.png alt="Screenshot showing healthy Azure Arc enabled server"></p></li></ul><h2 id=clean-up-environment>Clean up environment</h2><p>Complete the following steps to clean up your environment.</p><ul><li><p>Remove the virtual machines from each environment by following the teardown instructions from each guide.</p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_windows/>GCP Windows instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_al2/>AWS Amazon Linux 2 EC2 instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_win/>Azure Windows VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>VMware vSphere Windows Server VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_windows/>Vagrant Windows box</a></strong></p></li><li><p>Remove the Log Analytics workspace by executing the following script in AZ CLI. Provide the workspace name you used when creating the Log Analytics Workspace.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az monitor log-analytics workspace delete --resource-group &lt;Name of the Azure resource group&gt; --workspace-name &lt;Log Analytics Workspace Name&gt; --yes
</code></pre></div></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-50dbeacfd1099752a6b9ae86ffca6b70>1.7.7 - Azure Sentinel</h1><h2 id=connect-azure-arc-enabled-servers-to-azure-sentinel>Connect Azure Arc enabled servers to Azure Sentinel</h2><p>The following README will guide you on how to onboard Azure Arc enabled servers on to <a href=https://docs.microsoft.com/es-es/azure/sentinel/>Azure Sentinel</a>, so you can start collecting security-related events and start correlating them with other data sources.</p><p>In this guide, you will enable and configure Azure Sentinel on your Azure subscription. To complete this process you will:</p><ul><li><p>Setup a Log Analytics Workspace where logs and events will be aggregated for analysis and correlation.</p></li><li><p>Enable Azure Sentinel on the workspace.</p></li><li><p>Onboard Azure Arc enabled servers on Sentinel by using the extension management feature and Azure Policies.</p></li></ul><blockquote><p><strong>Note: This guide assumes you already deployed VMs or servers that are running on-premises or other clouds and you have connected them to Azure Arc but If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion:</strong></p></blockquote><ul><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_windows/>GCP Windows instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_al2/>AWS Amazon Linux 2 EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_win/>Azure Windows VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>VMware vSphere Windows Server VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_windows/>Vagrant Windows box</a></strong></li></ul><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p>As mentioned, this guide starts at the point where you already deployed and connected VMs or bare-metal servers to Azure Arc. For this scenario, as can be seen in the screenshots below, we will be using a Google Cloud Platform (GCP) instance that has been already connected to Azure Arc and is visible as a resource in Azure.</p><p><img src=./01.png alt="Screenshot showing Azure Portal with Azure Arc enabled server"></p><p><img src=./02.png alt="Screenshot showing Azure Portal with Azure Arc enabled server detail"></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI</a>. Azure CLI should be running version 2.7** or later. Use <code>az --version</code> to check your current installed version.</p></li><li><p>Create Azure service principal (SP).</p><p>To connect a VM or bare-metal server to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a>.</strong></p></blockquote></li></ul><h2 id=onboarding-azure-sentinel>Onboarding Azure Sentinel</h2><p>Azure Sentinel uses the Log Analytics agent to collect Windows and Linux server&rsquo;s log files and forwards them to Azure Sentinel, the data collected is stored in a Log Analytics workspace. Since you cannot use the default workspace created by Azure Security Center (ASC), a custom one is required and you could have raw events and alerts for ASC within the same custom workspace as Sentinel.</p><ul><li><p>You will need to create a dedicated Log Analytics workspace and enable the Azure Sentinel solution on the top of it. For that you can use this <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/azuresentinel/arm/sentinel-template.json>ARM template</a> that will create a new Log Analytics Workspace and define the Azure Sentinel solution and enable it for the workspace. To automate the deployment edit the ARM template <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/azuresentinel/arm/sentinel-template.parameters.json>parameters file</a>, provide a name and location for your workspace:</p><p><img src=./03.png alt="Screenshot showing Azure ARM template"></p></li><li><p>To deploy the ARM template, navigate to the <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_servers_jumpstart/azuresentinel/arm>deployment folder</a> and run the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az deployment group create --resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-file &lt;The *sentinel-template.json* template file location&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters &lt;The *sentinel-template.parameters.json* template file location&gt;
</code></pre></div></li></ul><p>For example:</p><p><img src=./04.png alt="Screenshot showing az deployment group create command"></p><h2 id=azure-arc-enabled-vms-onboarding-on-azure-sentinel>Azure Arc enabled VMs onboarding on Azure Sentinel</h2><p>Once you have deployed Azure Sentinel on your Log Analytics workspace, you will need to connect data sources to it.</p><p>There are connectors for Microsoft services, third party solutions from the Security products ecosystem. You can also use Common Event Format (CEF), Syslog, or REST-API to connect your data sources with Azure Sentinel.</p><p>For servers and VMs, you can install the Microsoft Monitoring Agent (MMA) agent or the Sentinel agent which collects the logs and forwards them to Azure Sentinel. You can deploy the agent in multiple ways by leveraging Azure Arc:</p><ul><li>Using <strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/day2/arc_vm_extension_mma_arm/>Extension Management</a></strong></li></ul><p>This feature in Azure Arc enabled servers allows you to deploy the MMA agent VM extensions to a non-Azure Windows and/or Linux VMs. You can use the Azure Portal, Azure CLI, an ARM template as well as PowerShell script to manage extension deployment to Azure Arc enabled servers.</p><ul><li>Setting up <strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/day2/arc_policies_mma/>Azure Policies</a></strong></li></ul><p>Using this approach, you will assign an Azure Policy to audit if the Azure Arc enabled Server has the MMA agent installed. If the agent is not installed, you will use the Extensions feature to automatically deploy it to the VM using a Remediation task, an enrollment experience that compares to Azure VMs.</p><h2 id=clean-up-environment>Clean up environment</h2><p>Complete the following steps to clean up your environment.</p><ul><li><p>Remove the virtual machines from each environment by following the teardown instructions from each guide.</p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_windows/>GCP Windows instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_al2/>AWS Amazon Linux 2 EC2 instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_win/>Azure Windows VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>VMware vSphere Windows Server VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_windows/>Vagrant Windows box</a></strong></p></li><li><p>Remove the Log Analytics workspace by executing the following script in AZ CLI. Provide the workspace name you used when creating the Log Analytics Workspace.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az monitor log-analytics workspace delete --resource-group &lt;Name of the Azure resource group&gt; --workspace-name &lt;Log Analytics Workspace Name&gt; --yes
</code></pre></div></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-16e609be239099590da0beb9af17b4c5>1.7.8 - Update Management</h1><h2 id=enable-update-management-on-azure-arc-enabled-servers>Enable Update Management on Azure Arc enabled servers</h2><p>The scenario will show you how to onboard Azure Arc enabled servers to <a href=https://docs.microsoft.com/en-us/azure/automation/update-management/overview>Update Management</a>, so that you can manage operating system updates for your Azure Arc enabled servers running Windows or Linux.</p><p>In this guide, you will create and configure an Azure Automation account and Log Analytics workspace to support Update Management for Azure Arc enabled servers by doing the following:</p><ul><li><p>Setup a new Log Analytics Workspace and Azure Automation account.</p></li><li><p>Enable Update Management on Azure Arc enabled servers.</p></li></ul><blockquote><p><strong>Note: This guide assumes you already deployed VMs or servers that are running on-premises or other clouds and you have connected them to Azure Arc but If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion:</strong></p></blockquote><ul><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_windows/>GCP Windows instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_al2/>AWS Amazon Linux 2 EC2 instance</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_win/>Azure Windows VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>VMware vSphere Windows Server VM</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></li><li><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_windows/>Vagrant Windows box</a></strong></li></ul><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p>As mentioned, this guide starts at the point where you already deployed and connected VMs or bare-metal servers to Azure Arc. For this scenario, as can be seen in the screenshots below, we will be using an Amazon Web Services (AWS) EC2 instance that has been already connected to Azure Arc and is visible as a resource in Azure.</p><p><img src=./01.png alt="Screenshot showing AWS cloud console with EC2 instance"></p><p><img src=./02.png alt="Screenshot showing Azure Portal with Azure Arc enabled server"></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI</a>. Azure CLI should be running version 2.14 or later. Use <code>az --version</code> to check your current installed version.</p></li></ul><h2 id=configuring-update-management>Configuring Update Management</h2><p>Update Management uses the Log Analytics agent to collect Windows and Linux server log files and the data collected is stored in a Log Analytics workspace.</p><ul><li><p>You will need to create a Log Analytics workspace. For that you can use this <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/updateManagement/law-template.json>ARM template</a> that will create a new Log Analytics Workspace and define the Update Management solution and enable it for the workspace.</p></li><li><p>First, create a new resource group for the Log Analytics workspace by running the below command, replacing the values in brackets with your own.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name &lt;Name <span style=color:#204a87;font-weight:700>for</span> your resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--location &lt;Location <span style=color:#204a87;font-weight:700>for</span> your resources&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--tags <span style=color:#4e9a06>&#34;Project=jumpstart_azure_arc_servers&#34;</span>
</code></pre></div><p><img src=./03.png alt="Screenshot showing az group create being run"></p></li><li><p>Next, edit the ARM template <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/updateManagement/law-template.parameters.json>parameters file</a>, providing a name for your Log Analytics workspace, a location, and a name for your Azure Automation account. You also need to supply the name of your Azure Arc enabled server, and the name of the resource group that contains the Arc enabled server as shown in the example below:</p><p><img src=./04.png alt="Screenshot showing Azure ARM template"></p></li><li><p>To deploy the ARM template, navigate to the <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_servers_jumpstart/updateManagement>deployment folder</a> and run the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az deployment group create --resource-group &lt;Name of the Azure resource group you created&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --template-file law-template.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    --parameters law-template.parameters.json
</code></pre></div><p><img src=./05.png alt="Screenshot showing az deployment group create being run"></p></li><li><p>When the deployment is complete, you should be able to see the resource group with your Log Analytics workspace, automation account and Update Management solution from the Azure Portal. Drilling into the Log Analytics workspace Solutions blade should show the Update Management solution.</p><p><img src=./06.png alt="Screenshot showing Azure Portal with Log Analytics workspace"></p></li></ul><h2 id=confirm-that-the-update-management-solution-is-deployed-on-your-azure-arc-enabled-server>Confirm that the Update Management solution is deployed on your Azure Arc enabled server</h2><ul><li><p>Click on the Solutions blade of the Log Analytics workspace and then click the Updates solution from the list to check the progress of the Update Management assessment.</p><p><img src=./13.png alt="Screenshot showing Solutions Blade of Log Analytics workspace"></p></li><li><p>It may take several hours for Update Management to collect enough data to show an assessment for your VM. In the screen below we can see the assessment is being performed.</p><p><img src=./14.png alt="Screenshot showing Update Management overview blade"></p></li><li><p>When the assessment is complete, you will see an option to &ldquo;View summary&rdquo; on the Update Management blade.</p><p><img src=./15.png alt="Screenshot showing Update Management with summary"></p></li><li><p>Click View Summary and then click again to drill into the Update Management assessment. In the below example we can see there are updates missing on our Azure Arc enabled server.</p><p><img src=./16.png alt="Screenshot showing"></p></li></ul><h2 id=schedule-an-update>Schedule an Update</h2><p>Now that we have configured the Update Management solution, we can deploy updates on a set schedule for our Azure Arc enabled server.</p><ul><li><p>Navigate to the Automation Account we created previously and click on the Update Management blade as shown in the screenshot below. You should see your Azure Arc enabled server listed.</p><p><img src=./18.png alt="Screenshot showing Azure Automation account"></p></li><li><p>From the above screen, click &ldquo;Schedule update deployment&rdquo;. On the next screen, select the Operating System that your Azure Arc enabled server is using, and then select &ldquo;Machines to update&rdquo; as shown below.</p><p><img src=./19.png alt="Screenshot showing scheduling an update with Update Management"></p></li><li><p>From the &ldquo;Type&rdquo; dropdown, select &ldquo;Machines&rdquo; and then select your server and click Ok.</p><p><img src=./20.png alt="Screenshot showing scheduling an update with Update Management"></p></li><li><p>Click Schedule Settings and then provide a desired schedule.</p><p><img src=./21.png alt="Screenshot showing scheduling an update with Update Management"></p><p><img src=./22.png alt="Screenshot showing scheduling an update with Update Management"></p></li><li><p>Finally, provide a name for your Update deployment and then click Create.</p><p><img src=./23.png alt="Screenshot showing scheduling an update with Update Management"></p></li><li><p>From the Automation Account Update Management blade, you should be able to see your scheduled Update deployment from the Deployment Schedules tab.
<img src=./24.png alt="Screenshot showing scheduled update"></p></li></ul><p>The Update Management solution will now update your Azure Arc enabled servers in the deployment window based on the schedule you defined. There is a lot more you can do with <a href=https://docs.microsoft.com/en-us/azure/automation/update-management/overview>Update Management</a> that is outside the scope of this scenario. Review the <a href=https://docs.microsoft.com/en-us/azure/automation/update-management/overview>documentation</a> for more information.</p><h2 id=clean-up-environment>Clean up environment</h2><p>Complete the following steps to clean up your environment.</p><ul><li><p>Remove the virtual machines from each environment by following the teardown instructions from each guide.</p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_ubuntu/>GCP Ubuntu instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/gcp/gcp_terraform_windows/>GCP Windows instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_ubuntu/>AWS Ubuntu EC2 instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/aws/aws_terraform_al2/>AWS Amazon Linux 2 EC2 instance</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_linux/>Azure Ubuntu VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/azure/azure_arm_template_win/>Azure Windows VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/>VMware vSphere Ubuntu VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>VMware vSphere Windows Server VM</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_ubuntu/>Vagrant Ubuntu box</a></strong></p></li><li><p><strong><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vagrant/local_vagrant_windows/>Vagrant Windows box</a></strong></p></li><li><p>Delete the resource group.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group delete --name &lt;Name of your resource group&gt;
</code></pre></div><p><img src=./26.png alt="Screenshot showing az group delete being run"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8683b32c638509b66c8a8d83ce8e8dd1>1.8 - Scaled Deployment</h1><div class=lead>The scenarios in this section are designed to provide scaled onboarding experience to Azure Arc of virtual machines deployed in various platforms and existing environments.</div></div><div class=td-content><h1 id=pg-3232c0522cad0a1e82efd628559a3a01>1.8.1 - VMware vSphere Windows Server VMs</h1><h2 id=scaled-onboarding-of-vmware-vsphere-windows-server-vms-to-azure-arc-using-vmware-powercli>Scaled onboarding of VMware vSphere Windows Server VMs to Azure Arc using VMware PowerCLI</h2><p>The following README will guide you on how to use the provided <a href=https://code.vmware.com/web/dp/tool/vmware-powercli/>VMware PowerCLI</a> script so you can perform an automated scaled deployment of the &ldquo;Azure Arc Connected Machine Agent&rdquo; in multiple VMware vSphere virtual machines and as a result, onboard these VMs as Azure Arc enabled servers.</p><p>This guide assumes you already have an exiting inventory of VMware Virtual Machines and will leverage the PowerCLI PowerShell module to automate the onboarding process of the VMs to Azure Arc.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Install VMware PowerCLI</p><blockquote><p><strong>Note: This guide was tested with the latest version of PowerCLI as of date (12.0.0) but earlier versions are expected to work as well</strong></p></blockquote><ul><li><p>Supported PowerShell Versions - VMware PowerCLI 12.0.0 is compatible with the following PowerShell versions:</p><ul><li>Windows PowerShell 5.1</li><li>PowerShell 7</li><li>Detailed installation instructions can be found <a href=https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.esxi.install.doc/GUID-F02D0C2D-B226-4908-9E5C-2E783D41FE2D.html>here</a> but the easiest way is to use the VMware.PowerCLI module from the PowerShell Gallery using the below command.</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#204a87>Install-Module</span> <span style=color:#000>-Name</span> <span style=color:#000>VMware</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PowerCLI</span>
</code></pre></div></li></ul></li><li><p>To be able to read the VM inventory from vCenter as well as invoke a script on the VM OS-level, the following permissions are needed:</p><ul><li><p><a href=https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.security.doc/GUID-6A952214-0E5E-4CCF-9D2A-90948FF643EC.html>VirtualMachine.GuestOperations</a> user account</p></li><li><p>VMware vCenter Server user assigned with a <a href=https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.security.doc/GUID-93B962A7-93FA-4E96-B68F-AE66D3D6C663.html>&ldquo;Read Only Role&rdquo;</a></p></li></ul></li><li><p>Create Azure service principal (SP)</p><p>To connect the VMware vSphere virtual machine to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=automation-flow>Automation Flow</h2><p>Below you can find the automation flow for this scenario:</p><ol><li><p>User edit the <em>vars.ps1</em> PowerCLI script</p></li><li><p>The <em>scale_deploy.ps1</em> script execution will initiate authentication against vCenter and will scan the targeted VM folder where Azure Arc candidate VMs are located and will copy both the <em>vars.ps1</em> and the <em>install_arc_agent.ps1</em> PowerCLI scripts to VM Windows OS located in <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_servers_jumpstart/vmware/scaled_deployment/powercli/windows>this folder</a> to each VM in that VM folder.</p></li><li><p>The <em>install_arc_agent.ps1</em> PowerCLI script will run on the VM guest OS and will install the &ldquo;Azure Arc Connected Machine Agent&rdquo; in order to onboard the VM to Azure Arc</p></li></ol><h2 id=pre-deployment>Pre-Deployment</h2><p>To demonstrate the before & after for this scenario, the below screenshots shows a dedicated, empty Azure Resources Group, a vCenter VM folder with candidate VMs and the &ldquo;Apps & features&rdquo; view in Windows showing no agent is installed.</p><p><img src=./01.png alt="An empty Azure resource group"></p><p><img src=./02.png alt="Vanilla VMware vSphere VM with no Azure Arc agent"></p><p><img src=./03.png alt="Vanilla VMware vSphere VM with no Azure Arc agent"></p><h2 id=deployment>Deployment</h2><p>Before running the PowerCLI script, you must set the <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_servers_jumpstart/vmware/scaled_deployment/powercli/windows/vars.ps1>environment variables</a> which will be used by the <em>install_arc_agent.ps1</em> script. These variables are based on the Azure service principal you&rsquo;ve just created, your Azure subscription and tenant, and your VMware vSphere credentials and data.</p><ul><li><p>Retrieve your Azure subscription ID and tenant ID using the <code>az account list</code> command</p></li><li><p>Use the Azure service principal ID and password created in the prerequisites section</p></li></ul><p><img src=./04.png alt="Export environment variables"></p><ul><li><p>From the <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_servers_jumpstart/vmware/scaled_deployment/powercli/windows><em>azure_arc_servers_jumpstart\vmware\scaled_deploy\powercli\windows</em></a> folder, open PowerShell session as an Administrator and run the <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_servers_jumpstart/vmware/scaled_deployment/powercli/windows/scale_deploy.ps1><em>scale_deploy.ps1</em></a> script.</p><p><img src=./05.png alt="scale_deploy PowerShell script"></p><p><img src=./06.png alt="scale_deploy PowerShell script"></p><p><img src=./07.png alt="scale_deploy PowerShell script"></p></li><li><p>Upon completion, the VM will have the &ldquo;Azure Arc Connected Machine Agent&rdquo; installed as well as the Azure resource group populated with the new Azure Arc enabled servers.</p><p><img src=./08.png alt="Azure Arc Connected Machine Agent installed"></p><p><img src=./09.png alt="New Azure Arc enabled servers in an Azure resource group"></p><p><img src=./10.png alt="New Azure Arc enabled servers in an Azure resource group"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6505de5782967c0e0060cc85e4dbaf9a>1.8.2 - VMware vSphere Linux VMs</h1><h2 id=scaled-onboarding-of-vmware-vsphere-linux-vms-to-azure-arc-using-vmware-powercli>Scaled onboarding of VMware vSphere Linux VMs to Azure Arc using VMware PowerCLI</h2><p>The following README will guide you on how to use the provided <a href=https://code.vmware.com/web/dp/tool/vmware-powercli/>VMware PowerCLI</a> script so you can perform an automated scaled deployment of the &ldquo;Azure Arc Connected Machine Agent&rdquo; in multiple VMware vSphere virtual machines and as a result, onboard these VMs as Azure Arc enabled servers.</p><p>This guide assumes you already have an exiting inventory of VMware Virtual Machines and will leverage the PowerCLI PowerShell module to automate the onboarding process of the VMs to Azure Arc.</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Install VMware PowerCLI</p><blockquote><p><strong>Note: This guide was tested with the latest version of PowerCLI as of date (12.0.0) but earlier versions are expected to work as well</strong></p></blockquote><ul><li><p>Supported PowerShell Versions - VMware PowerCLI 12.0.0 is compatible with the following PowerShell versions:</p><ul><li>Windows PowerShell 5.1</li><li>PowerShell 7</li><li>Detailed installation instructions can be found <a href=https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.esxi.install.doc/GUID-F02D0C2D-B226-4908-9E5C-2E783D41FE2D.html>here</a> but the easiest way is to use the VMware.PowerCLI module from the PowerShell Gallery using the below command.</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#204a87>Install-Module</span> <span style=color:#000>-Name</span> <span style=color:#000>VMware</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PowerCLI</span>
</code></pre></div></li></ul></li><li><p>To be able to read the VM inventory from vCenter as well as invoke a script on the VM OS-level, the following permissions are needed:</p><ul><li><p><a href=https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.vsphere.security.doc/GUID-6A952214-0E5E-4CCF-9D2A-90948FF643EC.html>VirtualMachine.GuestOperations</a> user account</p></li><li><p>VMware vCenter Server user assigned with a <a href=https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.security.doc/GUID-93B962A7-93FA-4E96-B68F-AE66D3D6C663.html>&ldquo;Read Only Role&rdquo;</a></p></li></ul></li><li><p>Create Azure service principal (SP)</p><p>To connect the VMware vSphere virtual machine to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=automation-flow>Automation Flow</h2><p>Below you can find the automation flow for this scenario:</p><ol><li><p>User edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/vmware/scaled_deployment/powercli/linux/vars.ps1><em>vars.ps1</em></a> PowerCLI script</p></li><li><p>Upon execution of the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/vmware/scaled_deployment/powercli/linux/scale_deploy.ps1><em>scale_deploy.ps1</em></a> PowerShell script:</p><ul><li><p>The script will auto-generate a <em>vars.sh</em> shell script with the user&rsquo;s Azure environment variables.</p></li><li><p>The script execution will initiate authentication against vCenter and will scan the targeted VM folder where Azure Arc candidate VMs are located and will copy both the auto-generated <em>vars.sh</em> and the <em>install_arc_agent.sh</em> shell scripts to VM Linux OS located in <em>/vmware/scaled_deploy/powercli/linux</em> to each VM in that VM folder.</p></li></ul></li><li><p>The <em>install_arc_agent.sh</em> shell script will run on the VM guest OS and will install the &ldquo;Azure Arc Connected Machine Agent&rdquo; in order to onboard the VM to Azure Arc</p></li></ol><h2 id=pre-deployment>Pre-Deployment</h2><p>To demonstrate the before & after for this scenario, the below screenshots shows a dedicated, empty Azure resource group, a vCenter VM folder with candidate VMs and the <em>/var/opt/</em> directory showing no agent is installed.</p><p><img src=./01.png alt="An empty Azure resource group"></p><p><img src=./02.png alt="Vanilla VMware vSphere VM with no Azure Arc agent"></p><p><img src=./03.png alt="Vanilla VMware vSphere VM with no Azure Arc agent"></p><h2 id=deployment>Deployment</h2><p>Before running the PowerCLI script, you must set the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/vmware/scaled_deployment/powercli/linux/vars.ps1>environment variables</a> which will be used by the <em>install_arc_agent.sh</em> script. These variables are based on the Azure service principal you&rsquo;ve just created, your Azure subscription and tenant, and your VMware vSphere credentials and data.</p><ul><li><p>Retrieve your Azure subscription ID and tenant ID using the <code>az account list</code> command</p></li><li><p>Use the Azure service principal ID and password created in the prerequisites section</p><p><img src=./04.png alt="Export environment variables"></p></li><li><p>From the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/vmware/scaled_deployment/powercli/linux/><em>azure_arc_servers_jumpstart\vmware\scaled_deploy\powercli\linux</em></a> folder, open PowerShell session as an Administrator and run the <em>scale_deploy.ps1</em> script.</p><p><img src=./05.png alt="scale_deploy PowerShell script"></p><p><img src=./06.png alt="scale_deploy PowerShell script"></p><p><img src=./07.png alt="scale_deploy PowerShell script"></p></li><li><p>Upon completion, the VM will have the &ldquo;Azure Arc Connected Machine Agent&rdquo; installed as well as the Azure resource group populated with the new Azure Arc enabled servers.</p><p><img src=./08.png alt="Azure Arc Connected Machine Agent installed"></p><p><img src=./09.png alt="New Azure Arc enabled servers in an Azure resource group"></p><p><img src=./10.png alt="New Azure Arc enabled servers in an Azure resource group"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c74d41f4582660136f72b61a4784fa21>1.8.3 - AWS EC2 dynamic inventory with Ansible</h1><h2 id=dynamic-scaled-onboarding-of-aws-ec2-instances-to-azure-arc-using-ansible>Dynamic scaled onboarding of AWS EC2 instances to Azure Arc using Ansible</h2><p>The following README will guide you on how to automatically perform scaled onboarding of AWS EC2 instances to Azure Arc by using <a href=https://www.ansible.com/>Ansible</a>.</p><p>This guide assumes that you have a basic understanding of Ansible. A basic Ansible playbook and configuration is provided that uses the <a href=https://docs.ansible.com/ansible/latest/collections/amazon/aws/aws_ec2_inventory.html>amazon.aws.aws_ec2</a> plugin for dynamic loading of EC2 server inventory.</p><p>This guide can be used even if you do not already have an existing Ansible test environment and includes a Terraform plan that will create a sample AWS EC2 server inventory comprised of four (4) Windows Server 2019 servers and four (4) Ubuntu servers along with a basic CentOS 7 Ansible control server with a simple configuration.</p><p><em><strong>Warning</strong></em>: <em>The provided Ansible sample workbook uses WinRM with password authentication and HTTP to configure Windows-based servers. This is not advisable for production environments. If you are planning to use Ansible with Windows hosts in a production environment then you should use <a href=https://docs.microsoft.com/en-us/troubleshoot/windows-client/system-management-components/configure-winrm-for-https>WinRM over HTTPS</a> with a certificate.</em></p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/>Generate SSH Key</a> (or use existing ssh key)</p></li><li><p><a href=https://aws.amazon.com/premiumsupport/knowledge-center/create-and-activate-aws-account/>Create free AWS account</a></p></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.13</a></p></li><li><p>Create Azure service principal (SP)</p><p>To connect the AWS virtual machine to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcAWS&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcAWS&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcAWS&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=create-an-aws-identity>Create an AWS identity</h2><p>In order for Terraform to create resources in AWS, we will need to create a new AWS IAM role with appropriate permissions and configure Terraform to use it.</p><ul><li><p>Login to the <a href=https://console.aws.amazon.com>AWS management console</a></p></li><li><p>After logging in, click the &ldquo;Services&rdquo; dropdown in the top left. Under &ldquo;Security, Identity, and Compliance&rdquo; select &ldquo;IAM&rdquo; to access the <a href=https://console.aws.amazon.com/iam/home>Identity and Access Management page</a></p><p><img src=./19.png alt="Screenshot of AWS cloud console"></p><p><img src=./20.png alt="Screenshot of IAM AWS cloud console"></p></li><li><p>Click on &ldquo;Users&rdquo; from the left menu and then click on &ldquo;Add user&rdquo; to create a new IAM user.</p><p><img src=./21.png alt="Screenshot of new user creation in AWS cloud console"></p></li><li><p>On the &ldquo;Add User&rdquo; screen, name the user &ldquo;terraform&rdquo; and select the &ldquo;Programmatic Access&rdquo; checkbox then click &ldquo;Next&rdquo;</p><p><img src=./22.png alt="Screenshot of new user creation in AWS cloud console"></p></li><li><p>On the next &ldquo;Set Permissions&rdquo; screen, select &ldquo;Attach existing policies directly&rdquo; and then check the box next to AmazonEC2FullAccess as seen in the screenshot then click &ldquo;Next&rdquo;</p><p><img src=./23.png alt="Screenshot showing new user in AWS cloud console"></p></li><li><p>On the tags screen, assign a tag with a key of &ldquo;azure-arc-demo&rdquo; and click &ldquo;Next&rdquo; to proceed to the Review screen.</p><p><img src=./24.png alt="Screenshot showing tags in AWS cloud console"></p></li><li><p>Double check that everything looks correct and click &ldquo;Create user&rdquo; when ready.</p><p><img src=./25.png alt="Screenshot showing creating a user in AWS cloud console"></p></li><li><p>After the user is created, you will see the user&rsquo;s Access key ID and Secret access key. Copy these values down before clicking the Close button. In the screen below, you can see an example of what this should look like. Once you have these keys, you will be able to use them with Terraform to create AWS resources.</p><p><img src=./26.png alt="Screenshot showing created user in AWS cloud console"></p></li></ul><h2 id=option-1--creating-a-sample-aws-server-inventory-and-ansible-control-server-using-terraform-and-onboarding-the-servers-to-azure-arc>Option 1- Creating a sample AWS server inventory and Ansible control server using Terraform and onboarding the servers to Azure Arc</h2><p><strong>Note: If you already have an existing AWS server inventory and Ansible server, skip below to Option 2.</strong></p><h3 id=configure-terraform>Configure Terraform</h3><p>Before executing the Terraform plan, you must export the environment variables which will be used by the plan. These variables are based on your Azure subscription and tenant, the Azure service principal, and the AWS IAM user and keys you just created.</p><ul><li><p>Retrieve your Azure subscription ID and tenant ID using the <code>az account list</code> command.</p></li><li><p>The Terraform plan creates resources in both Microsoft Azure and AWS. It then executes a script on an AWS EC2 virtual machine to install Ansible and all necessary artifacts. This Terraform plan requires certain information about your AWS and Azure environments which it accesses using environment variables. Edit <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/scaled_deployment/ansible/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> and update each of the variables with the appropriate values.</p><ul><li>TF_VAR_subscription_id=Your Azure subscription ID</li><li>TF_VAR_client_id=Your Azure service principal app id</li><li>TF_VAR_client_secret=Your Azure service principal password</li><li>TF_VAR_tenant_id=Your Azure tenant ID</li><li>AWS_ACCESS_KEY_ID=AWS access key</li><li>AWS_SECRET_ACCESS_KEY=AWS secret key</li></ul></li><li><p>From your shell, navigate to the <em>azure_arc_servers_jumpstart/aws/scaled_deployment/ansible/terraform</em>) directory of the cloned repo.</p></li><li><p>Export the environment variables you edited by running <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/scaled_deployment/ansible/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> with the source command as shown below. Terraform requires these to be set for the plan to execute properly.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>source</span> ./scripts/vars.sh
</code></pre></div></li><li><p>Make sure your SSH keys are available in <em>~/.ssh</em> and named <em>id_rsa.pub</em> and <em>id_rsa</em>. If you followed the ssh-keygen guide above to create your key then this should already be setup correctly. If not, you may need to modify <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/scaled_deployment/ansible/terraform/aws_infra.tf><em>aws_infra.tf</em></a> to use a key with a different path.</p></li><li><p>Run the <code>terraform init</code> command which will download the required Terraform providers.</p><p><img src=./01.png alt="Screenshot of terraform init being run"></p></li></ul><h3 id=deploy-server-infrastructure>Deploy server infrastructure</h3><ul><li><p>From the <em>azure_arc_servers_jumpstart/aws/scaled_deployment/ansible/terraform</em> directory, run <code>terraform apply --auto-approve</code> and wait for the plan to finish. Upon successful completion, you will have four (4) Windows Server 2019 servers, four (4) Ubuntu servers, and one (1) CentOS 7 Ansible control server.</p></li><li><p>Open the AWS console and verify you can see the created servers.</p><p><img src=./02.png alt="Screenshot of AWS console showing EC2 instances"></p></li></ul><h3 id=run-the-ansible-playbook-to-onboard-the-aws-ec2-instances-as-azure-arc-enabled-servers>Run the Ansible playbook to onboard the AWS EC2 instances as Azure Arc enabled servers</h3><ul><li><p>When the Terraform plan completes, it will display the public IP of the Ansible control server in an output variable named <em>ansible_ip</em>. SSH into the Ansible server by running the <code>ssh centos@XX.XX.XX.XX</code> where XX.XX.XX.XX is substituted for your Ansible server&rsquo;s IP address.</p><p><img src=./03.png alt="Screenshot of SSH into Ansible control server"></p></li><li><p>Change directory to the <em>ansible</em> directory by running <code>cd ansible</code>. This folder contains the sample Ansible configuration and the playbook we will use to onboard the servers to Azure Arc.</p><p><img src=./04.png alt="Screenshot of Ansible config folder in shell"></p></li><li><p>The aws_ec2 Ansible plugin requires AWS credentials to dynamically read your AWS server inventory. We will export these as environment variables. Run the commands below, replacing the values for AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY with AWS credentials you created earlier.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>export</span> <span style=color:#000>AWS_ACCESS_KEY_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#204a87>export</span> <span style=color:#000>AWS_SECRET_ACCESS_KEY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXX&#34;</span>
</code></pre></div></li><li><p>Replace the placeholder values for Azure tenant ID and subscription id in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/scaled_deployment/ansible/terraform/ansible_config/group_vars/all.yml>group_vars/all.yml</a> with the appropriate values for your environment.</p><p><img src=./09.png alt="Screenshot of variables YAML file"></p></li><li><p>Run the Ansible playbook by executing the following command, substituting your Azure service principal id and service principal secret.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ansible-playbook arc_agent.yml -i ansible_plugins/inventory_uswest2_aws_ec2.yml --extra-vars <span style=color:#4e9a06>&#39;{&#34;service_principal_id&#34;: &#34;XXXXXXX-XXXXX-XXXXXXX&#34;, &#34;service_principal_secret&#34;: &#34;XXXXXXXXXXXXXXXXXXXXXXXX&#34;}&#39;</span>
</code></pre></div><p>If the playbook run is successful, you should see output similar to the below screenshot.</p><p><img src=./05.png alt="Screenshot of Ansible playbook being run"></p></li><li><p>Open Azure Portal and navigate to the Arc-AWS-Demo resource group. You should see the Azure Arc enabled servers listed.</p><p><img src=./06.png alt="Screenshot of Azure Portal showing onboard Azure Arc enabled servers"></p></li></ul><h3 id=clean-up-environment-by-deleting-resources>Clean up environment by deleting resources</h3><p>To delete all the resources you created as part of this demo use the <code>terraform destroy --auto-approve</code> command as shown below.</p><p><img src=./07.png alt="Screenshot of terraform destroy being run"></p><h2 id=option-2---onboarding-an-existing-aws-server-inventory-to-azure-arc-using-your-own-ansible-control-server>Option 2 - Onboarding an existing AWS server inventory to Azure Arc using your own Ansible control server</h2><blockquote><p><strong>Note: If you do not have an existing AWS server inventory and Ansible server, navigate back to Option 1</strong></p></blockquote><h3 id=review-provided-ansible-configuration-and-playbook>Review provided Ansible configuration and playbook</h3><p>Navigate to the <em>ansible_config</em> directory and review the provided configuration. The provided configuration contains a basic <em>ansible.cfg</em> file. This file enables the <a href=https://docs.ansible.com/ansible/latest/collections/amazon/aws/aws_ec2_inventory.html>amazon.aws.aws_ec2</a> Ansible plugin which dynamically loads your server inventory by using an AWS IAM role. Ensure that the IAM role you are using has sufficient privileges to access the inventory you wish to onboard.</p><p><img src=./08.png alt="Screenshot showing Ansible config file"></p><p>The file <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_servers_jumpstart/aws/scaled_deployment/ansible/terraform/ansible_config/ansible_plugins/inventory_uswest2_aws_ec2.yml>inventory_uswest2_aws_ec2.yml</a> configures the aws_ec2 plugin to pull inventory from uswest-2 region and group assets by applied tags. Adjust this file as needed to support onboarding your server inventory (e.g., change region, or change groups or filters).</p><p>The files in <em><strong>./ansible_config/group_vars</strong></em> should be adjusted to provide the credentials you wish to use to onboard various ansible host groups.</p><p>When you have adjusted the provided config to support your environment, run the Ansible playbook by executing the following command, substituting your Azure service principal id and service principal secret.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ansible-playbook arc_agent.yml -i ansible_plugins/inventory_uswest2_aws_ec2.yml --extra-vars <span style=color:#4e9a06>&#39;{&#34;service_principal_id&#34;: &#34;XXXXXXX-XXXXX-XXXXXXX&#34;, &#34;service_principal_secret&#34;: &#34;XXXXXXXXXXXXXXXXXXXXXXXX&#34;}&#39;</span>
</code></pre></div><p>If the playbook run is successful, you should see output similar to the below screenshot.</p><p><img src=./05.png alt="Screenshot showing Ansible playbook being run"></p><p>Open Azure Portal and navigate to the Arc-Aws-Demo resource group. You should see the Azure Arc enabled servers listed.</p><p><img src=./06.png alt="Screenshot showing Azure Portal with Azure Arc enabled servers"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-bf179d00a56c61c4fb23242e6434c738>2 - Azure Arc enabled SQL Server</h1><div class=lead>The deployment scenarios in this section will guide you through onboarding Microsoft SQL Server as an Azure Arc enabled SQL server.</div></div><div class=td-content><h1 id=pg-c12c951b6c375f80f7847834cdcc8abd>2.1 - Microsoft Azure</h1><div class=lead>The following guide in this section will walk you through how to project an Azure VM installed with SQL Server as an Azure Arc enabled server and Azure Arc enabled SQL. This guide, using Azure VM as the targeted Azure Arc enabled SQL Server, is designed <strong>for demo and testing purposes ONLY and are not supported.</strong> In the guide you will find a detailed technical explanation of the mechanism and why <strong>it is not expected to project an Azure VM as an Azure Arc enabled server.</strong>
In each guide, you find a detailed, technical explanation of the mechanism and why it is not expected to project an Azure VM as an Azure Arc enabled server.</div></div><div class=td-content><h1 id=pg-7e6a22f521dd06e37a0862afc3cc5a51>2.1.1 - SQL Server Virtual Machine</h1><h2 id=deploy-an-azure-virtual-machine-with-windows-server--microsoft-sql-server-and-connect-it-to-azure-arc-using-terraform>Deploy an Azure Virtual Machine with Windows Server & Microsoft SQL Server and connect it to Azure Arc using Terraform</h2><p>The following README will guide you on how to use the provided <a href=https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview>Azure ARM Template</a> to deploy an Azure VM installed with Windows Server and Microsoft SQL Server 2019 (Developer edition) and connect it as an Azure Arc enabled SQL server resource.</p><p>Azure VMs are leveraging the <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service>Azure Instance Metadata Service (IMDS)</a> by default. By projecting an Azure VM as an Azure Arc enabled server, a &ldquo;conflict&rdquo; is created which will not allow for the Azure Arc server resources to be represented as one when the IMDS is being used and instead, the Azure Arc server will still &ldquo;act&rdquo; as a native Azure VM.</p><p>However, <strong>for demo purposes only</strong>, the below guide will allow you to use and onboard Azure VMs to Azure Arc and by doing so, you will be able to simulate a server which is deployed outside of Azure (i.e &ldquo;on-premises&rdquo; or in other cloud platforms)</p><blockquote><p><strong>Note: It is not expected for an Azure VM to be projected as an Azure Arc enabled server. The below scenario is unsupported and should ONLY be used for demo and testing purposes.</strong></p></blockquote><p>By the end of the guide, you will have an Azure VM installed with Windows Server 2019 with SQL Server 2019, projected as an Azure Arc enabled SQL Server and a running SQL assessment with data injected to Azure Log Analytics workspace.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled SQL Server is in <a href="https://docs.microsoft.com/en-us/sql/sql-server/azure-arc/overview?view=sql-server-ver15">public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>In case you don&rsquo;t already have one, you can <a href=https://azure.microsoft.com/en-us/free/>Create a free Azure account</a>.</p></li><li><p>Create Azure service principal (SP)</p><p>In order for you to deploy the Azure resources using the ARM template, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note It is optional, but highly recommended, to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a>.</strong></p></blockquote></li></ul><h2 id=automation-flow>Automation Flow</h2><p>The automation for this scenario include 3 PowerShell scripts executed in the following order:</p><ol><li><p><a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_sqlsrv_jumpstart/azure/arm_template/scripts/ClientTools.ps1><em>ClientTools.ps1</em></a> - Executed at ARM Template deployment time as a CustomScriptExtension. This script has two main functionalities:</p><ol><li>Generate the <em>LogonScript.ps1</em> script and will configure a Windows scheduled task to <em>LogonScript</em> when user log in the VM for the first time.</li><li>Download the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_sqlsrv_jumpstart/azure/arm_template/scripts/ArcOnboarding.ps1><em>ArcOnboarding.ps1</em></a> script.</li></ol></li><li><p><em>LogonScript.ps1</em> - Auto generated by the <em>ClientTools</em> script. This script has two main functionalities:</p><ol><li>Install and configure SQL Server on the VM</li><li>Execute the <em>ArcOnboarding</em> script</li></ol></li><li><p><a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_sqlsrv_jumpstart/azure/arm_template/scripts/ArcOnboarding.ps1><em>ArcOnboarding.ps1</em></a> - This is the main script and will be executed by the <em>LogonScript</em> script at VM runtime. This script has multiple functionalities:</p><ol><li>Restore AdventureWorksLT2019 Database</li><li>Allow Azure VM to be onboard to Azure Arc</li><li>Project VM as an Azure Arc enabled server resource</li><li>Project SQL Server as an Azure Arc enabled SQL server resource</li><li>Deploy Log Analytics workspace and Solutions</li><li>Install Log Analytics agent using extension on Azure Arc server</li><li>Create SQL Assessment and inject data to Azure Log Analytics workspace</li></ol></li></ol><p>For you to get familiar with the automation and deployment flow, below is an explanation.</p><ol><li><p>User is editing the ARM template parameters file (1-time edit). These parameters values are being used throughout the deployment.</p></li><li><p>The ARM template incl. an Azure VM Custom Script Extension which will deploy the the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_sqlsrv_jumpstart/azure/arm_template/scripts/ClientTools.ps1><em>ClientTools.ps1</em></a> PowerShell Script. The script will:</p><ol><li><p>Download the <em>ArcOnboarding.ps1</em> PowerShell script</p></li><li><p>Set local OS environment variables</p></li><li><p>Generate a local OS logon script named <em>LogonScript.ps1</em>. This script will:</p></li></ol></li></ol><h2 id=deployment>Deployment</h2><p>As mentioned, this deployment will use an ARM Template. You will deploy a single template, responsible for creating all the Azure resources in a single resource group as well onboarding the created VM to Azure Arc.</p><ul><li><p>Before deploying the ARM template, login to Azure using AZ CLI with the <code>az login</code> command.</p></li><li><p>The deployment is using the ARM template parameters file. Before initiating the deployment, edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_sqlsrv_jumpstart/azure/arm_template/azuredeploy.parameters.json><em>azuredeploy.parameters.json</em></a> file located in your local cloned repository folder. An example parameters file is located <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_sqlsrv_jumpstart/azure/arm_template/azuredeploy.parameters.example.json>here</a>.</p></li><li><p>To deploy the ARM template, navigate to the local cloned <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_sqlsrv_jumpstart/azure/arm_template>deployment folder</a> and run the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name &lt;Name of the Azure resource group&gt; --location &lt;Azure Region&gt; --tags <span style=color:#4e9a06>&#34;Project=jumpstart_azure_arc_sql&#34;</span>
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name &lt;The name of this deployment&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_sqlsrv_jumpstart/azure/arm_template/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters &lt;The *azuredeploy.parameters.json* parameters file location&gt;
</code></pre></div><blockquote><p><strong>Note: Make sure that you are using the same Azure resource group name as the one you&rsquo;ve just used in the <em>azuredeploy.parameters.json</em> file</strong></p></blockquote><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name Arc-SQL-Demo --location <span style=color:#4e9a06>&#34;East US&#34;</span> --tags <span style=color:#4e9a06>&#34;Project=jumpstart_azure_arc_sql&#34;</span>
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group Arc-Servers-Win-Demo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name arcsqlsrvdemo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_sqlsrv_jumpstart/azure/arm_template/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters azuredeploy.parameters.json
</code></pre></div></li><li><p>Once Azure resources has been provisioned, you will be able to see it in Azure portal.</p><p><img src=./01.jpg alt="Screenshot showing ARM deployment"></p><p><img src=./02.jpg alt="Screenshot showing Azure Portal with Azure resources"></p></li></ul><h2 id=windows-login--post-deployment>Windows Login & Post Deployment</h2><ul><li><p>Now that the Windows Server VM has been deployed, it is time to login to it. Using it&rsquo;s public IP, RDP to the VM.</p><p><img src=./03.jpg alt="Screenshot showing Overview tab of Azure VM"></p></li><li><p>At first login, as mentioned in the &ldquo;Automation Flow&rdquo; section, a logon script will get executed. This script was created as part of the automated deployment process.</p><p>Let the script to run its course and <strong>do not close</strong> the PowerShell session, this will be done for you once completed.</p><blockquote><p><strong>Note: The script run time is ~10-15min long</strong></p></blockquote><p><img src=./04.jpg alt="Screenshot showing PowerShell script executing in VM"></p><p><img src=./05.jpg alt="Screenshot showing showing PowerShell script executing in VM"></p><p><img src=./06.jpg alt="Screenshot showing showing PowerShell script executing in VM"></p><p><img src=./07.jpg alt="Screenshot showing showing PowerShell script executing in VM"></p><p><img src=./08.jpg alt="Screenshot showing showing PowerShell script executing in VM"></p><p><img src=./09.jpg alt="Screenshot showing showing PowerShell script executing in VM"></p><p><img src=./10.jpg alt="Screenshot showing showing PowerShell script executing in VM"></p><p><img src=./11.jpg alt="Screenshot showing showing PowerShell script executing in VM"></p><p><img src=./12.jpg alt="Screenshot showing showing PowerShell script executing in VM"></p><p><img src=./13.jpg alt="Screenshot showing showing PowerShell script executing in VM"></p></li><li><p>Upon successful run, in the Azure portal, notice you now have a new Azure Arc enabled server (with the Microsoft Monitoring agent installed via an extension) and Azure Arc enabled SQL resources as well as Azure Log Analytics added to the resource group.</p><p><img src=./14.jpg alt="Screenshot showing Azure Arc enabled SQL resources"></p><p><img src=./15.jpg alt="Screenshot showing Azure Arc enabled SQL resources"></p><p><img src=./16.jpg alt="Screenshot showing Azure Arc enabled SQL resources"></p></li><li><p>Open Microsoft SQL Server Management Studio (a Windows shortcut will be created for you) and validate the <em>AdventureWorksLT2019</em> sample database is deployed as well.</p><p><img src=./17.jpg alt="Screenshot showing SQL Management Studio"></p><p><img src=./18.jpg alt="Screenshot showing SQL Management Studio"></p></li></ul><h2 id=azure-sql-assessment>Azure SQL Assessment</h2><p>Now that you have both the server and SQL projected as Azure Arc resources, the last step is complete the initiation of the SQL Assessment run.</p><ul><li><p>On the SQL Azure Arc resource, click on &ldquo;Environment Health&rdquo; followed by clicking the &ldquo;Download configuration script&rdquo;.</p><p>Since the <em>LogonScript</em> run in the deployment step took care of deploying and installing the required binaries, you can safely ignore and delete the downloaded <em>AddSqlAssessment.ps1</em> file.</p><p>Clicking the &ldquo;Download configuration script&rdquo; will simply send a REST API call to the Azure portal which will make &ldquo;Step3&rdquo; available and will result with a grayed-out &ldquo;View SQL Assessment Results&rdquo; button.</p><p><img src=./19.jpg alt="Screenshot showing Environment Health blade of Azure Arc enabled SQL server"></p><p><img src=./20.jpg alt="Screenshot showing Environment Health blade of Azure Arc enabled SQL server"></p><p><img src=./21.jpg alt="Screenshot showing Environment Health blade of Azure Arc enabled SQL server"></p><p><img src=./22.jpg alt="Screenshot showing Environment Health blade of Azure Arc enabled SQL server"></p><p>It might take a bit of time, but after ~45-60min you will notice how the &ldquo;View SQL Assessment Results&rdquo; button is available for you to click on. At this point, the SQL assessment data and logs are getting injected to Azure Log Analytics.</p><p>Initially, the amount of data will be limited as it take a while for the assessment to complete a full cycle but after few hours you should be able to see much more data coming in.</p><p><img src=./23.jpg alt="Screenshot showing Environment Health blade of Azure Arc enabled SQL server"></p><p><img src=./24.jpg alt="Screenshot showing Environment Health blade of Azure Arc enabled SQL server"></p></li></ul><h2 id=cleanup>Cleanup</h2><p>To delete the entire deployment, simply delete the resource group from the Azure portal.</p><p><img src=./25.jpg alt="Screenshot showing Azure Portal delete resource group function"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-cfa90491acfc4183e3edd8811ffcda55>2.2 - Amazon Web Services</h1><div class=lead>If you are working in a multi-cloud environment, you can deploy new a AWS EC2 instance installed with SQL Server in an automated fashion using Terraform and onboard it as Azure Arc enabled SQL Server.</div></div><div class=td-content><h1 id=pg-1c7623fa022f4e3eda2af8b035cbb220>2.2.1 - SQL Server EC2 instance</h1><h2 id=deploy-an-aws-ec2-instance-with-windows-server--microsoft-sql-server-and-connect-it-to-azure-arc-using-terraform>Deploy an AWS EC2 instance with Windows Server & Microsoft SQL Server and connect it to Azure Arc using Terraform</h2><p>The following README will guide you on how to use the provided <a href=https://www.terraform.io/>Terraform</a> plan to deploy a Windows Server installed with Microsoft SQL Server 2019 (Developer edition) in a Amazon Web Services (AWS) EC2 instance and connect it as an Azure Arc enabled SQL server resource.</p><p>By the end of the guide, you will have an AWS EC2 instance installed with Windows Server 2019 with SQL Server 2019, projected as an Azure Arc enabled SQL server and a running SQL assessment with data injected to Azure Log Analytics workspace.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled SQL Server is in <a href="https://docs.microsoft.com/en-us/sql/sql-server/azure-arc/overview?view=sql-server-ver15">public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://aws.amazon.com/free/>Create a free Amazon Web Services account</a> if you don&rsquo;t already have one.</p></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>Create Azure service principal (SP)</p><p>To connect the EC2 instance to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=create-a-new-aws-iam-role--key>Create a new AWS IAM Role & Key</h2><p>Create AWS User IAM Key. An access key grants programmatic access to your resources which we will be using later on in this guide.</p><ul><li><p>Navigate to the <a href=https://console.aws.amazon.com/iam/home#/home>IAM Access page</a>.</p><p><img src=./01.png alt="Create AWS IAM Role & Key"></p></li><li><p>Select the <strong>Users</strong> from the side menu.</p><p><img src=./02.png alt="Create AWS IAM Role & Key"></p></li><li><p>Select the <strong>User</strong> you want to create the access key for.</p><p><img src=./03.png alt="Create AWS IAM Role & Key"></p></li><li><p>Select <strong>Security credentials</strong> of the <strong>User</strong> selected.</p><p><img src=./04.png alt="Create AWS IAM Role & Key"></p></li><li><p>Under <strong>Access Keys</strong> select <strong>Create Access Keys</strong>.</p><p><img src=./05.png alt="Create AWS IAM Role & Key"></p></li><li><p>In the popup window it will show you the <em><strong>Access key ID</strong></em> and <em><strong>Secret access key</strong></em>. Save both of these values to configure the <strong>Terraform plan</strong> variables later.</p><p><img src=./06.png alt="Create AWS IAM Role & Key"></p></li></ul><h2 id=automation-flow>Automation Flow</h2><p>For you to get familiar with the automation and deployment flow, below is an explanation.</p><ol><li><p>User is exporting the Terraform environment variables (1-time export) which are being used throughout the deployment.</p></li><li><p>User is executing the Terraform plan which will deploy the EC2 instance as well as:</p><ol><li><p>Create an Administrator Windows user account, enabling WinRM on the VM and change the Windows Computer Name.</p></li><li><p>Generate and execute the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_sqlsrv_jumpstart/aws/winsrv/terraform/scripts/sql.ps1.tmpl><em>sql.ps1</em></a> script. This script will:</p><ol><li><p>Install Azure CLI, Azure PowerShell module and SQL Server Management Studio (SSMS) <a href=https://chocolatey.org/>Chocolaty packages</a>.</p></li><li><p>Create a runtime logon script (<em>LogonScript.ps1</em>) which will run upon the user first logon to Windows. Runtime script will:</p><ul><li>Install SQL Server Developer Edition</li><li>Enable SQL TCP protocol on the default instance</li><li>Create SQL Server Management Studio Desktop shortcut</li><li>Restore <a href="https://docs.microsoft.com/en-us/sql/samples/adventureworks-install-configure?view=sql-server-ver15&tabs=ssms"><em>AdventureWorksLT2019</em></a> Sample Database</li><li>Onboard both the server and SQL to Azure Arc</li><li>Deploy Azure Log Analytics and a workspace</li><li>Install the <a href=https://docs.microsoft.com/en-us/services-hub/health/mma-setup>Microsoft Monitoring Agent (MMA) agent</a></li><li>Enable Log Analytics Solutions</li><li>Deploy MMA Azure Extension ARM Template from within the VM</li><li>Configure SQL Azure Assessment</li></ul></li><li><p>Disable and prevent Windows Server Manager from running on startup</p></li></ol></li></ol></li><li><p>Once Terraform plan deployment has completed and upon the user initial RDP login to Windows, <em>LogonScript.ps1</em> script will run automatically and execute all the above.</p></li></ol><h2 id=deployment>Deployment</h2><p>Before executing the Terraform plan, you must set the environment variables which will be used by the plan. These variables are based on the Azure service principal you&rsquo;ve just created, your Azure subscription and tenant, and your AWS account.</p><ul><li><p>Retrieve your Azure subscription ID and tenant ID using the <code>az account list</code> command.</p></li><li><p>The Terraform plan creates resources in both Microsoft Azure and AWS. It then executes a script on the virtual machine to install all the necessary artifacts.</p><p>Both the script and the Terraform plan itself requires certain information about your AWS and Azure environments. Edit variables according to your environment and export it using the below commands</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_subId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your Azure subscription ID&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalAppId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your Azure service principal  App ID&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalSecret</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your Azure service principal  App Password&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalTenantId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your Azure tenant ID&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_location</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Azure region&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_resourceGroup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Azure resource group name&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_AWS_ACCESS_KEY_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your AWS Access Key ID&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_AWS_SECRET_ACCESS_KEY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your AWS Secret Key&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_key_name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your AWS Key Pair name&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_aws_region</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;AWS region&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_aws_availabilityzone</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;AWS Availability Zone region&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_instance_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;EC2 instance type&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_hostname</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;EC2 instance Windows Computer Name&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_admin_user</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Guest OS Admin Username&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_admin_password</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Guest OS Admin Password&#39;</span>
</code></pre></div><p><img src=./07.png alt="Export terraform variables"></p></li><li><p>From the folder within your cloned repo where the Terraform binaries are, the below commands to download the needed TF providers and to run the plan.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>terraform init
terraform apply --auto-approve
</code></pre></div><p>Once the Terraform plan deployment has completed, a new Windows Server VM will be up & running as well as an empty Azure resource group will be created.</p><p><img src=./08.png alt="terraform apply completed"></p><p><img src=./09.png alt="New AWS EC2 instance"></p><p><img src=./10.png alt="An empty Azure resource group"></p></li><li><p>Download the RDP file and log in to the VM (<strong>using the data from the <em>TF_VAR_admin_user</em> and <em>TF_VAR_admin_password</em> environment variables</strong>) which will initiate the <em>LogonScript</em> run. Let the script to run it&rsquo;s course and which will also close the PowerShell session when completed.</p><p><img src=./11.png alt="Connect to AWS EC2 instance"></p><p><img src=./12.png alt="Connect to AWS EC2 instance"></p><blockquote><p><strong>Note: The script runtime will take ~10-15min to complete</strong></p></blockquote><p><img src=./13.png alt="PowerShell LogonScript run"></p><p><img src=./14.png alt="PowerShell LogonScript run"></p><p><img src=./15.png alt="PowerShell LogonScript run"></p><p><img src=./16.png alt="PowerShell LogonScript run"></p><p><img src=./17.png alt="PowerShell LogonScript run"></p><p><img src=./18.png alt="PowerShell LogonScript run"></p><p><img src=./19.png alt="PowerShell LogonScript run"></p><p><img src=./20.png alt="PowerShell LogonScript run"></p><p><img src=./21.png alt="PowerShell LogonScript run"></p></li><li><p>Open Microsoft SQL Server Management Studio (a Windows shortcut will be created for you) and validate the <em>AdventureWorksLT2019</em> sample database is deployed as well.</p><p><img src=./22.png alt="Microsoft SQL Server Management Studio"></p><p><img src=./23.png alt="AdventureWorksLT2019 sample database"></p></li><li><p>In the Azure Portal, notice you now have an Azure Arc enabled server resource (with the MMA agent installed via an Extension), Azure Arc enabled SQL server resource and Azure Log Analytics deployed.</p><p><img src=./24.png alt="An Azure resource group with deployed resources"></p><p><img src=./25.png alt="Azure Arc enabled server resource"></p><p><img src=./26.png alt="MMA agent installed via an Extension"></p><p><img src=./27.png alt="Azure Arc enabled SQL server resources"></p></li></ul><h2 id=azure-sql-assessment>Azure SQL Assessment</h2><p>Now that you have both the server and SQL projected as Azure Arc resources, the last step is complete the initiation of the SQL Assessment run.</p><ul><li><p>On the SQL Azure Arc resource, click on &ldquo;Environment Health&rdquo; followed by clicking the &ldquo;Download configuration script&rdquo;.</p><p>Since the <em>LogonScript</em> run in the deployment step took care of deploying and installing the required binaries, you can safely and delete the downloaded <em>AddSqlAssessment.ps1</em> file.</p><p>Clicking the &ldquo;Download configuration script&rdquo; will simply send a REST API call to the Azure portal which will make &ldquo;Step3&rdquo; available and will result with a grayed-out &ldquo;View SQL Assessment Results&rdquo; button.</p><p><img src=./28.png alt="SQL Assessment Environment Health"></p><p><img src=./29.png alt="SQL Assessment Environment Health"></p><p><img src=./30.png alt="View SQL Assessment Results"></p></li><li><p>After few minutes you will notice how the &ldquo;View SQL Assessment Results&rdquo; button is available for you to click on. At this point, the SQL assessment data and logs are getting injected to Azure Log Analytics.</p><p>Initially, the amount of data will be limited as it take a while for the assessment to complete a full cycle but after few hours you should be able to see much more data coming in.</p><p><img src=./31.png alt="SQL Assessment results"></p><p><img src=./32.png alt="SQL Assessment results"></p></li></ul><h2 id=cleanup>Cleanup</h2><p>To delete the environment, use the <em><code>terraform destroy --auto-approve</code></em> command which will delete the AWS and the Azure resources.</p><p><img src=./33.png alt="terraform destroy completed"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-48665cd3821fc3cb6a56e5bf4a7b1700>2.3 - Google Cloud Platform</h1><div class=lead>If you are working in a multi-cloud environment, you can deploy new a GCP instance installed with SQL Server in an automated fashion using Terraform and onboard it as Azure Arc enabled SQL Server.</div></div><div class=td-content><h1 id=pg-902ce380d3ffe6b2389dbb5f0587b0ec>2.3.1 - SQL Server GCP instance</h1><h2 id=deploy-a-gcp-instance-with-windows-server--microsoft-sql-server-and-connect-it-to-azure-arc-using-terraform>Deploy a GCP instance with Windows Server & Microsoft SQL Server and connect it to Azure Arc using Terraform</h2><p>The following README will guide you on how to use the provided <a href=https://www.terraform.io/>Terraform</a> plan to deploy a Windows Server installed with Microsoft SQL Server 2019 (Developer edition) in a Google Cloud Platform (GCP) virtual machine and connect it as an Azure Arc enabled SQL server resource.</p><p>By the end of the guide, you will have a GCP VM instance installed with Windows Server 2019 with SQL Server 2019, projected as an Azure Arc enabled SQL Server and a running SQL assessment with data injected to Azure Log Analytics workspace.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled SQL Server is in <a href="https://docs.microsoft.com/en-us/sql/sql-server/azure-arc/overview?view=sql-server-ver15">public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://cloud.google.com/free>Create a free Google Cloud account</a> if you don&rsquo;t have one already.</p></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>Create Azure service principal (SP)</p><p>To connect the GCP virtual machine to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=create-a-new-gcp-project-iam-role--service-account>Create a new GCP Project, IAM Role & Service Account</h2><p>In order to deploy resources in GCP, we will create a new GCP Project as well as a service account to allow Terraform to authenticate against GCP APIs and run the plan to deploy resources.</p><ul><li><p>Browse to <a href=https://console.cloud.google.com/>https://console.cloud.google.com/</a> and login with your Google Cloud account. Once logged in, <a href=https://cloud.google.com/resource-manager/docs/creating-managing-projects>create a new project</a> named &ldquo;Azure Arc Demo&rdquo;. After creating it, be sure to copy down the project id as it is usually different then the project name.</p><p><img src=./01.png alt="Screenshot showing GCP cloud console dashboard"></p><p><img src=./02.png alt="Screenshot showing GCP console new project creation"></p><p><img src=./03.png alt="Screenshot showing GCP console new project creation"></p></li><li><p>Enable the Compute Engine API for the project, create a project Owner service account credentials and download the private key JSON file and copy the file to the directory where Terraform files are located. Change the JSON file name (for example <em>account.json</em>). The Terraform plan will be using the credentials stored in this file to authenticate against your GCP project.</p><p><img src=./04.png alt="Screenshot showing enabling Compute Engine API in GCP"></p><p><img src=./05.png alt="Screenshot showing enabling Compute Engine API in GCP"></p><p><img src=./06.png alt="Screenshot showing creating a GCP service account"></p><p><img src=./07.png alt="Screenshot showing creating a GCP service account"></p><p><img src=./08.png alt="Screenshot showing creating a GCP service account"></p><p><img src=./09.png alt="Screenshot showing creating a GCP service account"></p><p><img src=./10.png alt="Screenshot showing creating a GCP service account"></p><p><img src=./11.png alt="Screenshot showing creating a GCP service account"></p><p><img src=./12.png alt="Screenshot showing creating a GCP service account key"></p><p><img src=./13.png alt="Screenshot showing creating a GCP service account key"></p><p><img src=./14.png alt="Screenshot showing creating a GCP service account key"></p><p><img src=./15.png alt="Screenshot showing creating a GCP service account key"></p><p><img src=./16.png alt="Screenshot GCP service account key saved to project folder in Visual Studio Code"></p></li><li><p>Enable the Kubernetes Engine API for the project</p><p><img src=./17.png alt="Screenshot showing enabling the Kubernetes Engine API"></p><p><img src=./18.png alt="Screenshot showing enabling the Kubernetes Engine API"></p></li></ul><h2 id=automation-flow>Automation Flow</h2><p>For you to get familiar with the automation and deployment flow, below is an explanation.</p><ol><li><p>User is exporting the Terraform environment variables (1-time export) which are being used throughout the deployment.</p></li><li><p>User is executing the Terraform plan which will deploy the VM as well as:</p><ol><li><p>Create an Administrator Windows user account and enabling WinRM on the VM</p></li><li><p>Generate and execute the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_sqlsrv_jumpstart/gcp/winsrv/terraform/scripts/sql.ps1.tmpl><em>sql.ps1</em></a> script. This script will:</p><ol><li><p>Install Azure CLI, Azure PowerShell module and SQL Server Management Studio (SSMS) <a href=https://chocolatey.org/>Chocolaty packages</a>.</p></li><li><p>Create a runtime logon script (<em>LogonScript.ps1</em>) which will run upon the user first logon to Windows. Runtime script will:</p><ul><li>Install SQL Server Developer Edition</li><li>Enable SQL TCP protocol on the default instance</li><li>Create SQL Server Management Studio Desktop shortcut</li><li>Restore <a href="https://docs.microsoft.com/en-us/sql/samples/adventureworks-install-configure?view=sql-server-ver15&tabs=ssms"><em>AdventureWorksLT2019</em></a> Sample Database</li><li>Onboard both the server and SQL to Azure Arc</li><li>Deploy Azure Log Analytics and a workspace</li><li>Install the <a href=https://docs.microsoft.com/en-us/services-hub/health/mma-setup>Microsoft Monitoring Agent (MMA) agent</a></li><li>Enable Log Analytics Solutions</li><li>Deploy MMA Azure Extension ARM Template from within the VM</li><li>Configure SQL Azure Assessment</li></ul></li><li><p>Disable and prevent Windows Server Manager from running on startup</p></li></ol></li></ol></li><li><p>Once Terraform plan deployment has completed and upon the user initial RDP login to Windows, <em>LogonScript.ps1</em> script will run automatically and execute all the above.</p></li></ol><h2 id=deployment>Deployment</h2><p>Before executing the Terraform plan, you must set the environment variables which will be used by the plan. These variables are based on the Azure service principal you&rsquo;ve just created, your Azure subscription and tenant, and your GCP project.</p><ul><li><p>Retrieve your Azure subscription ID and tenant ID using the <code>az account list</code> command.</p></li><li><p>The Terraform plan creates resources in both Microsoft Azure and GCP. It then executes a script on the virtual machine to install all the necessary artifacts.</p><p>Both the script and the Terraform plan itself requires certain information about your GCP and Azure environments. Edit variables according to your environment and export it using the below commands</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_subId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your Azure subscription ID&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalAppId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your Azure service principal App ID&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalSecret</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your Azure service principal App Password&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalTenantId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your Azure tenant ID&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_location</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Azure Region&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_resourceGroup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Azure resource group name&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gcp_project_id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;GCP Project ID&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gcp_credentials_filename</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;GCP Project credentials filename&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gcp_region</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;GCP region where resource will be created&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gcp_zone</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;GCP zone where resource will be created&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gcp_instance_name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;GCP VM instance name&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gcp_instance_machine_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;GCP VM instance type&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_admin_user</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Guest OS Admin Username&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_admin_password</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Guest OS Admin Password&#39;</span>
</code></pre></div><p><img src=./19.png alt="Screenshot showing exporting environment variables in shell"></p></li><li><p>From the folder within your cloned repo where the Terraform binaries are, the below commands to download the needed TF providers and to run the plan.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>terraform init
terraform apply --auto-approve
</code></pre></div><p>Once the Terraform plan deployment has completed, a new Windows Server VM will be up & running as well as an empty Azure resource group will be created.</p><p><img src=./20.png alt="Screenshot showing terraform apply being run"></p><p><img src=./21.png alt="Screenshot showing GCP cloud console with server"></p><p><img src=./22.png alt="Screenshot showing Azure Portal with empty resource group"></p></li><li><p>Download the RDP file and log in to the VM (<strong>using data from the <em>TF_VAR_admin_user</em> and <em>TF_VAR_admin_password</em> environment variables</strong>) which will initiate the <em>LogonScript</em> run. Let the script to run it&rsquo;s course and which will also close the PowerShell session when completed.</p><p><img src=./23.png alt="Screenshot showing link to download RDP file in GCP cloud console"></p><blockquote><p><strong>Note: The script runtime will take ~10-15min to complete</strong></p></blockquote><p><img src=./24.png alt="Screenshot showing PowerShell script being run in server"></p><p><img src=./25.png alt="Screenshot showing PowerShell script being run in server"></p><p><img src=./26.png alt="Screenshot showing PowerShell script being run in server"></p><p><img src=./27.png alt="Screenshot showing PowerShell script being run in server"></p><p><img src=./28.png alt="Screenshot showing PowerShell script being run in server"></p><p><img src=./29.png alt="Screenshot showing PowerShell script being run in server"></p><p><img src=./30.png alt="Screenshot showing PowerShell script being run in server"></p><p><img src=./31.png alt="Screenshot showing PowerShell script being run in server"></p><p><img src=./32.png alt="Screenshot showing PowerShell script being run in server"></p></li><li><p>Open Microsoft SQL Server Management Studio (a Windows shortcut will be created for you) and validate the <em>AdventureWorksLT2019</em> sample database is deployed as well.</p><p><img src=./33.png alt="Screenshot showing SQL Management Studio"></p><p><img src=./34.png alt="Screenshot showing SQL Management Studio"></p></li><li><p>In the Azure Portal, notice you now have an Azure Arc enabled server resource (with the MMA agent installed via an Extension), Azure Arc enabled SQL resource and Azure Log Analytics deployed.</p><p><img src=./35.png alt="Screenshot showing Azure Portal with Azure Arc enabled SQL resources"></p><p><img src=./36.png alt="Screenshot showing Azure Portal with Azure Arc enabled SQL resources"></p><p><img src=./37.png alt="Screenshot showing Azure Portal with Azure Arc enabled SQL resources"></p><p><img src=./38.png alt="Screenshot showing Azure Portal with Azure Arc enabled SQL resources"></p></li></ul><h2 id=azure-sql-assessment>Azure SQL Assessment</h2><p>Now that you have both the server and SQL projected as Azure Arc resources, the last step is complete the initiation of the SQL Assessment run.</p><ul><li><p>On the SQL Azure Arc resource, click on &ldquo;Environment Health&rdquo; followed by clicking the &ldquo;Download configuration script&rdquo;.</p><p>Since the <em>LogonScript</em> run in the deployment step took care of deploying and installing the required binaries, you can safely and delete the downloaded <em>AddSqlAssessment.ps1</em> file.</p><p>Clicking the &ldquo;Download configuration script&rdquo; will simply send a REST API call to the Azure portal which will make &ldquo;Step3&rdquo; available and will result with a grayed-out &ldquo;View SQL Assessment Results&rdquo; button.</p><p><img src=./39.png alt="Screenshot showing Azure Arc enabled SQL Server Environment Health blade"></p><p><img src=./40.png alt="Screenshot showing Azure Arc enabled SQL Server Environment Health blade"></p><p><img src=./41.png alt="Screenshot showing Azure Arc enabled SQL Server Environment Health blade"></p></li><li><p>After few minutes you will notice how the &ldquo;View SQL Assessment Results&rdquo; button is available for you to click on. At this point, the SQL assessment data and logs are getting injected to Azure Log Analytics.</p><p>Initially, the amount of data will be limited as it take a while for the assessment to complete a full cycle but after few hours you should be able to see much more data coming in.</p><p><img src=./42.png alt="Screenshot showing SQL Assessment Results in Azure Portal"></p><p><img src=./43.png alt="Screenshot showing SQL Assessment Results in Azure Portal"></p></li></ul><h2 id=cleanup>Cleanup</h2><p>To delete the environment, use the <em><code>terraform destroy --auto-approve</code></em> command which will delete the GCP and the Azure resources.</p><p><img src=./44.png alt="Screenshot showing terraform destroy being run"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c2f7cf1f325670d4b3c331a6b7955873>2.4 - VMware vSphere</h1><div class=lead>If you are working with an on-premises VMware vSphere infrastructure, you can deploy new Windows Server virtual machine installed with SQL Server in an automated fashion using Terraform and onboard it as Azure Arc enabled SQL Server.</div></div><div class=td-content><h1 id=pg-d522c677fb3694c8b330c3549f9e9cb2>2.4.1 - SQL Server VM</h1><h2 id=deploy-a-vmware-vsphere-based-windows-server-with-sql-and-connect-it-to-azure-arc-using-terraform>Deploy a VMware vSphere-based Windows Server with SQL and connect it to Azure Arc using Terraform</h2><p>The following README will guide you on how to use the provided <a href=https://www.terraform.io/>Terraform</a> plan to deploy a Windows Server installed with Microsoft SQL Server 2019 (Developer edition) in a VMware vSphere virtual machine and connect it as an Azure Arc enabled SQL server resource.</p><p>By the end of the guide, you will have a VMware vSphere VM installed with Windows Server 2019 with SQL Server 2019, projected as an Azure Arc enabled SQL Server and a running SQL assessment with data injected to Azure Log Analytics workspace.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled SQL Server is in <a href="https://docs.microsoft.com/en-us/sql/sql-server/azure-arc/overview?view=sql-server-ver15">public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>A VMware vCenter Server user with <a href=https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.vm_admin.doc/GUID-8254CD05-CC06-491D-BA56-A773A32A8130.html>permissions to deploy</a> a Virtual Machine from a Template in the vSphere Web Client.</p></li><li><p>Create Azure service principal (SP)</p><p>To connect the VMware vSphere virtual machine to Azure Arc, an Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcServers&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h3 id=preparing-a-window-server-vmware-vsphere-vm-template>Preparing a Window Server VMware vSphere VM Template</h3><p>Before using the below guide to deploy a Windows Server VM and connect it to Azure Arc, a VMware vSphere Template is required. <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_winsrv/>The following README</a> will instruct you how to easily create such a template using VMware vSphere 6.5 and above.</p><p><strong>The Terraform plan uses the <em>remote-exec</em> provisioner which uses the WinRM protocol to copy and execute the required Azure Arc script. To allow WinRM connectivity to the VM, run the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_sqlsrv_jumpstart/vmware/winsrv/terraform/scripts/allow_winrm.ps1><em>allow_winrm</em></a> PowerShell script on your VM before converting it to template.</strong></p><blockquote><p><strong>Note: If you already have a Windows Server VM template it is still recommended to use the guide as a reference.</strong></p></blockquote><h2 id=automation-flow>Automation Flow</h2><p>For you to get familiar with the automation and deployment flow, below is an explanation.</p><ol><li><p>User is exporting the Terraform environment variables (1-time export) which are being used throughout the deployment.</p></li><li><p>User is executing the Terraform plan which will deploy the VM as well as generate and execute the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_sqlsrv_jumpstart/vmware/winsrv/terraform/scripts/sql.ps1.tmpl><em>sql.ps1</em></a> script. This script will:</p><ol><li><p>Install Azure CLI, Azure PowerShell module and SQL Server Management Studio (SSMS) <a href=https://chocolatey.org/>Chocolaty packages</a>.</p></li><li><p>Create a runtime logon script (<em>LogonScript.ps1</em>) which will run upon the user first logon to Windows. Runtime script will:</p><ul><li>Install SQL Server Developer Edition</li><li>Enable SQL TCP protocol on the default instance</li><li>Create SQL Server Management Studio Desktop shortcut</li><li>Restore <a href="https://docs.microsoft.com/en-us/sql/samples/adventureworks-install-configure?view=sql-server-ver15&tabs=ssms"><em>AdventureWorksLT2019</em></a> Sample Database</li><li>Onboard both the server and SQL to Azure Arc</li><li>Deploy Azure Log Analytics and a workspace</li><li>Install the <a href=https://docs.microsoft.com/en-us/services-hub/health/mma-setup>Microsoft Monitoring Agent (MMA) agent</a></li><li>Enable Log Analytics Solutions</li><li>Deploy MMA Azure Extension ARM Template from within the VM</li><li>Configure SQL Azure Assessment</li></ul></li><li><p>Disable Windows Firewall</p></li><li><p>Disable and prevent Windows Server Manager from running on startup</p></li></ol></li><li><p>Once Terraform plan deployment has completed and upon the user initial RDP login to Windows, <em>LogonScript.ps1</em> script will run automatically and execute all the above.</p></li></ol><h2 id=deployment>Deployment</h2><p>Before executing the Terraform plan, you must set the environment variables which will be used by the plan. These variables are based on the Azure service principal you&rsquo;ve just created, your Azure subscription and tenant, and your VMware vSphere environment.</p><ul><li><p>Retrieve your Azure subscription ID and tenant ID using the <code>az account list</code> command.</p></li><li><p>The Terraform plan creates resources in both Microsoft Azure and VMware vSphere. It then executes a script on the virtual machine to install all the necessary artifacts.</p></li><li><p>Both the script and the Terraform plan itself requires certain information about your VMware vSphere and Azure environments. Edit variables according to your environment and export it using the below commands</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_subId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your Azure subscription ID&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalAppId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your Azure service principal App ID&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalSecret</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your Azure service principal App Password&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalTenantId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Your Azure tenant ID&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_location</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Azure Region&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_resourceGroup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Azure resource group name&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_vsphere_datacenter</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;VMware vSphere Datacenter Name&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_vsphere_datastore</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;VMware vSphere Datastore Name&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_vsphere_resource_pool</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;VMware vSphere Cluster or Resource Pool Name&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_network_cards</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;VMware vSphere Network Name&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_vsphere_folder</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;VMware vSphere Folder Name&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_vsphere_vm_template_name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;VMware vSphere VM Template Name&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_vsphere_virtual_machine_name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;VMware vSphere VM Name&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_vsphere_virtual_machine_cpu_count</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;VMware vSphere VM CPU Count&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_vsphere_virtual_machine_memory_size</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;VMware vSphere VM Memory Size in Megabytes&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_domain</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Domain&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_vsphere_user</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;VMware vSphere vCenter Admin Username&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_vsphere_password</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;VMware vSphere vCenter Admin Password&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_vsphere_server</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;VMware vSphere vCenter server FQDN/IP&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_admin_user</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Guest OS Admin Username&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_admin_password</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Guest OS Admin Password&#39;</span>
</code></pre></div><blockquote><p><strong>Note: Use the Terraform plan <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_sqlsrv_jumpstart/vmware/winsrv/terraform/variables.tf><em>variables.tf</em></a> file for more details around VMware vSphere vars structure if needed</strong></p></blockquote><p><img src=./01.jpg alt="Screenshot of environment variables exporting in shell"></p></li><li><p>From the folder within your cloned repo where the Terraform binaries are, the below commands to download the needed TF providers and to run the plan.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>terraform init
terraform apply --auto-approve
</code></pre></div><p>Once the Terraform plan deployment has completed, a new Windows Server VM will be up & running as well as an empty Azure resource group will be created.</p><p><img src=./02.jpg alt="Screenshot of terraform plan completing"></p><p><img src=./03.jpg alt="Screenshot of SQL Server in vCenter"></p><p><img src=./04.jpg alt="Screenshot of Azure Portal showing empty resource group"></p></li><li><p>Log in to the VM (<strong>using data from the <em>TF_VAR_admin_user</em> and <em>TF_VAR_admin_password</em> environment variables</strong>) which will initiate the <em>LogonScript</em> run. Let the script to run it&rsquo;s course and which will also close the PowerShell session when completed.</p><blockquote><p><strong>Note: The script runtime will take ~10-15min to complete</strong></p></blockquote><p><img src=./05.jpg alt="Screenshot of PowerShell script being run"></p><p><img src=./06.jpg alt="Screenshot of PowerShell script being run"></p><p><img src=./07.jpg alt="Screenshot of PowerShell script being run"></p><p><img src=./08.jpg alt="Screenshot of PowerShell script being run"></p><p><img src=./09.jpg alt="Screenshot of PowerShell script being run"></p><p><img src=./10.jpg alt="Screenshot of PowerShell script being run"></p><p><img src=./11.jpg alt="Screenshot of PowerShell script being run"></p><p><img src=./12.jpg alt="Screenshot of PowerShell script being run"></p><p><img src=./13.jpg alt="Screenshot of PowerShell script being run"></p></li><li><p>Open Microsoft SQL Server Management Studio (a Windows shortcut will be created for you) and validate the <em>AdventureWorksLT2019</em> sample database is deployed as well.</p><p><img src=./14.jpg alt="Screenshot of SQL Server Management Studio"></p><p><img src=./15.jpg alt="Screenshot of SQL Server Management Studio"></p></li><li><p>In the Azure Portal, notice you now have an Azure Arc enabled Server resource (with the MMA agent installed via an Extension), Azure Arc enabled SQL resource and Azure Log Analytics deployed.</p><p><img src=./16.jpg alt="Screenshot of Azure Portal showing Azure Arc enabled SQL server resources"></p><p><img src=./17.jpg alt="Screenshot of Azure Portal showing Azure Arc enabled SQL server resources"></p><p><img src=./18.jpg alt="Screenshot of Azure Portal showing Azure Arc enabled SQL server resources"></p><p><img src=./19.jpg alt="Screenshot of Azure Portal showing Azure Arc enabled SQL server resources"></p></li></ul><h2 id=azure-sql-assessment>Azure SQL Assessment</h2><p>Now that you have both the server and SQL projected as Azure Arc resources, the last step is complete the initiation of the SQL Assessment run.</p><ul><li><p>On the SQL Azure Arc resource, click on &ldquo;Environment Health&rdquo; followed by clicking the &ldquo;Download configuration script&rdquo;.</p><p>Since the <em>LogonScript</em> run in the deployment step took care of deploying and installing the required binaries, you can safely and delete the downloaded <em>AddSqlAssessment.ps1</em> file.</p><p>Clicking the &ldquo;Download configuration script&rdquo; will simply send a REST API call to the Azure portal which will make &ldquo;Step3&rdquo; available and will result with a grayed-out &ldquo;View SQL Assessment Results&rdquo; button.</p><p><img src=./20.jpg alt="Screenshot showing Azure Arc enabled SQL Server Environment Health"></p><p><img src=./21.jpg alt="Screenshot showing Azure Arc enabled SQL Server Environment Health"></p><p><img src=./22.jpg alt="Screenshot showing Azure Arc enabled SQL Server Environment Health"></p></li><li><p>After few minutes you will notice how the &ldquo;View SQL Assessment Results&rdquo; button is available for you to click on. At this point, the SQL assessment data and logs are getting injected to Azure Log Analytics.</p><p>Initially, the amount of data will be limited as it take a while for the assessment to complete a full cycle but after few hours you should be able to see much more data coming in.</p><p><img src=./23.jpg alt="Screenshot showing Azure Arc enabled SQL Server Environment Health"></p><p><img src=./24.jpg alt="Screenshot showing Azure Arc enabled SQL Server Environment Health"></p><p><img src=./25.jpg alt="Screenshot showing Azure Arc enabled SQL Server Environment Health"></p></li></ul><h2 id=cleanup>Cleanup</h2><p>To delete the environment, use the <em><code>terraform destroy --auto-approve</code></em> command which will delete the VMware vSphere VM and the Azure resource group along with it&rsquo;s resources.</p><p><img src=./26.jpg alt="Screenshot showing terraform destroy being run"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-2002d72914137e61c4c0f458cae83603>3 - Azure Arc enabled Kubernetes</h1><div class=lead>The deployment scenarios in this section will guide you through onboarding various Kubernetes distributions as an Azure Arc enabled Kubernetes clusters.</div></div><div class=td-content><h1 id=pg-b5702fde6357d066dbe4fb888521f927>3.1 - Onboarding</h1><div class=lead>This example demonstrates how to connect an existing Kubernetes cluster to Arc. It assumes you already have a cluster ready to work with.</div></div><div class=td-content><h1 id=pg-8e99abf7a2c151b8574581f07908c165>3.1.1 - Existing cluster</h1><h2 id=connect-an-existing-kubernetes-cluster-to-azure-arc>Connect an existing Kubernetes cluster to Azure Arc</h2><p>The following README will guide you on how to connect an existing Kubernetes cluster to Azure Arc using a simple shell script.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/>public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Make sure your <em>kubeconfig</em> file is configured properly and you are working against your <a href=https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/>k8s cluster context</a>.</p></li><li><p>(Optional) To simplify work against multiple k8s contexts, consider using <a href=https://github.com/ahmetb/kubectx>kubectx</a>.</p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/>Install and Set Up kubectl</a></p></li><li><p><a href=https://helm.sh/docs/intro/install/>Install Helm 3</a>. If you are on a Windows environment, a recommended and easy way is to use the <a href=https://chocolatey.org/packages/kubernetes-helm>Helm 3 Chocolatey package</a>.</p></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li><li><p>Create a new Azure resource group where you want your cluster(s) to show up.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create -l &lt;Azure Region&gt; -n &lt;resource group name&gt;
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create -l eastus -n Arc-k8s-Clusters
</code></pre></div><blockquote><p><strong>Note: Currently, Azure Arc enabled Kubernetes resource creation is supported only in the following locations: eastus, westeurope. Use the &ndash;location (or -l) flag to specify one of these locations.</strong></p></blockquote><p><img src=./01.png alt="Screenshot showing Azure Portal with empty resource group"></p></li><li><p>Change the following environment variables according to your Azure service principal name and Azure environment.</p><p>If using shell:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>export</span> <span style=color:#000>appId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;Your Azure service principal name&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>password</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;Your Azure service principal password&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>tenantId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;Your Azure tenant ID&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>resourceGroup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;Azure resource group name&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>arcClusterName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;The name of your k8s cluster as it will be shown in Azure Arc&gt;&#39;</span>
</code></pre></div><p>If using PowerShell:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000>$env:appId</span><span style=color:#000;font-weight:700>=&lt;</span><span style=color:#000>Your</span> <span style=color:#000>Azure</span> <span style=color:#000>service</span> <span style=color:#000>principal</span> <span style=color:#000>name</span><span style=color:#000;font-weight:700>&gt;</span>
<span style=color:#000>$env:password</span><span style=color:#000;font-weight:700>=&lt;</span><span style=color:#000>Your</span> <span style=color:#000>Azure</span> <span style=color:#000>service</span> <span style=color:#000>principal</span> <span style=color:#000>password</span><span style=color:#000;font-weight:700>&gt;</span>
<span style=color:#000>$env:tenantId</span><span style=color:#000;font-weight:700>=&lt;</span><span style=color:#000>Your</span> <span style=color:#000>Azure</span> <span style=color:#000>tenant</span> <span style=color:#000>ID</span><span style=color:#000;font-weight:700>&gt;</span>
<span style=color:#000>$env:resourceGroup</span><span style=color:#000;font-weight:700>=&lt;</span><span style=color:#000>Azure</span> <span style=color:#000>resource</span> <span style=color:#204a87>group </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>&gt;</span>
<span style=color:#000>$env:arcClusterName</span><span style=color:#000;font-weight:700>=&lt;</span><span style=color:#000>The</span> <span style=color:#000>name</span> <span style=color:#000>of</span> <span style=color:#000>your</span> <span style=color:#000>k8s</span> <span style=color:#000>cluster</span> <span style=color:#000>as</span> <span style=color:#000>it</span> <span style=color:#000>will</span> <span style=color:#000>be</span> <span style=color:#000>shown</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>Azure</span> <span style=color:#000>Arc</span><span style=color:#000;font-weight:700>&gt;</span>
</code></pre></div></li></ul><h2 id=deployment>Deployment</h2><ul><li><p>Install the Azure Arc for Kubernetes CLI extensions <em><strong>connectedk8s</strong></em> and <em><strong>k8sconfiguration</strong></em>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az extension add --name connectedk8s
az extension add --name k8sconfiguration
</code></pre></div><blockquote><p><strong>Note: If you already used this guide before and/or have the extensions installed, use the bellow commands:</strong></p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az extension update --name connectedk8s
az extension update --name k8sconfiguration
</code></pre></div></li><li><p>Login to your Azure subscription using the SP you created.</p><p>If using shell:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login --service-principal --username <span style=color:#000>$appId</span> --password <span style=color:#000>$password</span> --tenant <span style=color:#000>$tenantId</span>
</code></pre></div><p>If using PowerShell:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000>az</span> <span style=color:#000>login</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-service-principal</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-username</span> <span style=color:#000>$env:appId</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-password</span> <span style=color:#000>$env:password</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-tenant</span> <span style=color:#000>$env:tenantId</span>
</code></pre></div></li><li><p>If you are working in a Linux OS or MacOS environment, make sure you are the owner of the following:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo chown -R <span style=color:#000>$USER</span> /home/<span style=color:#4e9a06>${</span><span style=color:#000>USER</span><span style=color:#4e9a06>}</span>/.kube
sudo chown -R <span style=color:#000>$USER</span> /home/<span style=color:#4e9a06>${</span><span style=color:#000>USER</span><span style=color:#4e9a06>}</span>/.kube/config
sudo chown -R <span style=color:#000>$USER</span> /home/<span style=color:#4e9a06>${</span><span style=color:#000>USER</span><span style=color:#4e9a06>}</span>/.azure/config
sudo chown -R <span style=color:#000>$USER</span> /home/<span style=color:#4e9a06>${</span><span style=color:#000>USER</span><span style=color:#4e9a06>}</span>/.azure
sudo chmod -R <span style=color:#0000cf;font-weight:700>777</span> /home/<span style=color:#4e9a06>${</span><span style=color:#000>USER</span><span style=color:#4e9a06>}</span>/.azure/config
sudo chmod -R <span style=color:#0000cf;font-weight:700>777</span> /home/<span style=color:#4e9a06>${</span><span style=color:#000>USER</span><span style=color:#4e9a06>}</span>/.azure
</code></pre></div></li><li><p>To connect the Kubernetes cluster to Azure Arc use the below command.</p><p>If using shell:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az connectedk8s connect --name <span style=color:#000>$arcClusterName</span> --resource-group <span style=color:#000>$resourceGroup</span>
</code></pre></div><p>If using PowerShell:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000>az</span> <span style=color:#000>connectedk8s</span> <span style=color:#000>connect</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-name</span> <span style=color:#000>$env:arcClusterName</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-resource-group</span> <span style=color:#000>$env:resourceGroup</span>
</code></pre></div></li></ul><p>Upon completion, you will have your Kubernetes cluster, connected as a new Azure Arc enabled Kubernetes resource inside your resource group.</p><p><img src=./02.png alt="Screenshot showing Azure ARM template deployment"></p><p><img src=./03.png alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource"></p><p><img src=./04.png alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource"></p><h2 id=delete-the-deployment>Delete the deployment</h2><p>The most straightforward way is to delete the Azure Arc enabled Kubernetes resource is via the Azure Portal, just select cluster and delete it.</p><p><img src=./05.png alt="Screenshot showing how to delete resources in Azure Portal"></p><p>If you want to delete the entire environment, just delete the Azure resource group.</p><p><img src=./06.png alt="Screenshot showing how to delete resource groups in Azure Portal"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-4058c92f46090baba44b0e09d635676b>3.2 - Azure Kubernetes Service</h1><div class=lead>If you do not yet have a Kubernetes cluster, the scenarios in this section will guide on creating an AKS cluster in order to simulate an &ldquo;on-premises&rdquo; cluster in an automated fashion using either ARM template or Terraform.</div></div><div class=td-content><h1 id=pg-c2630ddab80d3d6d1693e2416207a76a>3.2.1 - AKS cluster ARM template</h1><h2 id=deploy-aks-cluster-and-connect-it-to-azure-arc-using-an-azure-arm-template>Deploy AKS cluster and connect it to Azure Arc using an Azure ARM template</h2><p>The following README will guide you on how to use the provided <a href=https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview>Azure ARM Template</a> to deploy an <a href=https://docs.microsoft.com/en-us/azure/aks/intro-kubernetes>Azure Kubernetes Service (AKS)</a> cluster and connected it as an Azure Arc cluster resource.</p><blockquote><p><strong>Note: Since AKS is a 1st-party Azure solution and natively supports capabilities such as <a href=https://docs.microsoft.com/en-us/azure/azure-monitor/insights/container-insights-overview>Azure Monitor</a> integration as well as GitOps configurations (currently in private preview), it is not expected for an AKS cluster to be projected as an Azure Arc enabled Kubernetes cluster. The following scenario should ONLY be used for demo and testing purposes.</strong></p></blockquote><blockquote><p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/>public preview</a>.</strong></p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-ssh-keys-detailed>Generate SSH Key</a> (or use existing ssh key).</p></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li></ul><h2 id=deployment>Deployment</h2><ul><li><p>Before deploying the ARM template, determine which AKS Kubernetes versions are available in your region using the below Azure CLI command.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az aks get-versions -l <span style=color:#4e9a06>&#34;&lt;Your Azure Region&gt;&#34;</span>
</code></pre></div></li><li><p>The deployment is using the template parameters file. Before initiating the deployment, edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/arm_template/azuredeploy.parameters.json><em>azuredeploy.parameters.json</em></a> file to match your environment and using one of the available Kubernetes Versions from the previous step.</p><p><img src=./01.png alt="Screenshot of Azure ARM template"></p><p>To deploy the ARM template, navigate to the <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_k8s_jumpstart/aks/arm_template>deployment folder</a> and run the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name &lt;Name of the Azure resource group&gt; --location &lt;Azure Region&gt;
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name &lt;The name of this deployment&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_k8s_jumpstart/aks/arm_template/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters &lt;The *azuredeploy.parameters.json* parameters file location&gt;
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name Arc-AKS-Demo --location <span style=color:#4e9a06>&#34;East US&#34;</span>
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group Arc-AKS-Demo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name arcaksdemo01 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_k8s_jumpstart/aks/arm_template/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters azuredeploy.parameters.json
</code></pre></div></li><li><p>Once the ARM template deployment is completed, a new AKS cluster in a new Azure resource group is created.</p><p><img src=./02.png alt="Screenshot of Azure Portal showing AKS resource"></p><p><img src=./03.png alt="Screenshot of Azure Portal showing AKS resource"></p></li></ul><h2 id=connecting-to-azure-arc>Connecting to Azure Arc</h2><ul><li><p>Now that you have a running AKS cluster, edit the environment variables section in the included <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/arm_template/scripts/az_connect_aks.sh>az_connect_aks</a> shell script.</p><p><img src=./04.png alt="Screenshot of az_connect_aks shell script"></p></li><li><p>In order to keep your local environment clean and untouched, we will use <a href=https://docs.microsoft.com/en-us/azure/cloud-shell/overview>Azure Cloud Shell</a> (located in the top-right corner in the Azure portal) to run the <em>az_connect_aks</em> shell script against the AKS cluster. <strong>Make sure Cloud Shell is configured to use Bash.</strong></p><p><img src=./05.png alt="Screenshot of Azure Cloud Shell button in Visual Studio Code"></p></li><li><p>After editing the environment variables in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/arm_template/scripts/az_connect_aks.sh><em>az_connect_aks</em></a> shell script to match your parameters, save the file and then upload it to the Cloud Shell environment and run it using the <code>. ./az_connect_aks.sh</code> command.</p><blockquote><p><strong>Note: The extra dot is due to the script having an <em>export</em> function and needs to have the vars exported in the same shell session as the other commands.</strong></p></blockquote><p><img src=./06.png alt="Screenshot showing upload of file to Cloud Shell"></p><p><img src=./07.png alt="Screenshot showing upload of file to Cloud Shell"></p><p><img src=./08.png alt="Screenshot showing Cloud Shell with uploaded file"></p></li><li><p>Once the script run has finished, the AKS cluster will be projected as a new Azure Arc cluster resource.</p><p><img src=./09.png alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource"></p><p><img src=./10.png alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource"></p><p><img src=./11.png alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><p>The most straightforward way is to delete the Azure Arc cluster resource via the Azure Portal, just select the cluster and delete it.</p><p><img src=./12.png alt="Screenshot showing how to delete Azure Arc enabled Kubernetes resource"></p><p>If you want to nuke the entire environment, run the below commands.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az deployment group delete --name &lt;Deployment name&gt; --resource-group &lt;Azure resource group name&gt;
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group delete --name &lt;Azure resource group name&gt; --yes
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az deployment group delete --name arcaksdemo01 --resource-group Arc-AKS-Demo
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group delete --name Arc-AKS-Demo --yes
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-468b4e879c0975ed6583c45f5657a0cc>3.2.2 - AKS cluster Terraform plan</h1><h2 id=deploy-aks-cluster-and-connect-it-to-azure-arc-using-terraform>Deploy AKS cluster and connect it to Azure Arc using Terraform</h2><p>The following README will guide you on how to use the provided <a href=https://www.terraform.io/>Terraform</a> plan to deploy an <a href=https://docs.microsoft.com/en-us/azure/aks/intro-kubernetes>Azure Kubernetes Service (AKS)</a> cluster and connected it as an Azure Arc enabled Kubernetes resource.</p><blockquote><p><strong>Note: Since AKS is a 1st-party Azure solution and natively supports capabilities such as <a href=https://docs.microsoft.com/en-us/azure/azure-monitor/insights/container-insights-overview>Azure Monitor</a> integration as well as GitOps configurations (currently in private preview), it is not expected for an AKS cluster to be projected as an Azure Arc enabled Kubernetes cluster. The following scenario should ONLY be used for demo and testing purposes.</strong></p></blockquote><blockquote><p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/>public preview</a>.</strong></p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li></ul><h2 id=deployment>Deployment</h2><p>The only thing you need to do before executing the Terraform plan is to export the environment variables which will be used by the plan. This is based on the Azure service principal you&rsquo;ve just created and your subscription.</p><p>In addition, validate that the AKS Kubernetes version is available in your region using the below Azure CLI command.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az aks get-versions -l <span style=color:#4e9a06>&#34;&lt;Your Azure Region&gt;&#34;</span>
</code></pre></div><p>In case the AKS service is not available in your region, you can change the AKS Kubernetes version in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/terraform/variables.tf><em>variables.tf</em></a> file by searching for <em>kubernetes_version</em>.</p><ul><li><p>Export the environment variables needed for the Terraform plan.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_client_id</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your Azure service principal App ID&gt;
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_client_secret</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your Azure service principal App Password&gt;
</code></pre></div></li><li><p>Run the <code>terraform init</code> command which will download the Terraform AzureRM provider.</p><p><img src=./01.png alt="Screenshot showing terraform init being run"></p></li><li><p>Run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish.</p><p>Once the Terraform deployment is completed, a new AKS cluster in a new Azure resource group is created.</p><p><img src=./02.png alt="Screenshot showing terraform plan completing"></p><p><img src=./03.png alt="Screenshot showing Azure Portal with AKS resource"></p><p><img src=./04.png alt="Screenshot showing Azure Portal with AKS resource"></p></li><li><p>Now that you have a running AKS cluster, edit the environment variables section in the included <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/terraform/scripts/az_connect_aks.sh>az_connect_aks</a> shell script.</p><p><img src=./05.png alt="Screenshot showing az_connect_aks shell script"></p></li><li><p>In order to keep your local environment clean and untouched, we will use <a href=https://docs.microsoft.com/en-us/azure/cloud-shell/overview>Azure Cloud Shell</a> (located in the top-right corner in the Azure portal) to run the <em>az_connect_aks</em> shell script against the AKS cluster. <strong>Make sure Cloud Shell is configured to use Bash.</strong></p><p><img src=./06.png alt="Screenshot showing how to access Cloud Shell in Visual Studio Code"></p></li><li><p>Edit the environment variables in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/terraform/scripts/az_connect_aks.sh><em>az_connect_aks</em></a> shell script to match your parameters, upload it to the Cloud Shell environment and run it using the <code>. ./az_connect_aks.sh</code> command.</p><blockquote><p><strong>Note: The extra dot is due to the script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p></blockquote><p><img src=./07.png alt="Screenshot showing Cloud Shell upload functionality"></p><p><img src=./08.png alt="Screenshot showing Cloud Shell upload functionality"></p><p><img src=./09.png alt="Screenshot showing Cloud Shell upload functionality"></p><p><img src=./10.png alt="Screenshot showing Cloud Shell upload functionality"></p></li><li><p>Once the script run has finished, the AKS cluster will be projected as a new Azure Arc enabled Kubernetes resource.</p><p><img src=./11.png alt="Screenshot showing Azure Portal with Azure Arc enabled resource"></p><p><img src=./12.png alt="Screenshot showing Azure Portal with Azure Arc enabled resource"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><p>The most straightforward way is to delete the Azure Arc enabled Kubernetes resource via the Azure Portal, just select the cluster and delete it.</p><p><img src=./13.png alt="Screenshot showing delete function in Azure Portal"></p><p>If you want to nuke the entire environment, delete both the AKS and the AKS resources resource groups or run the <code>terraform destroy -auto-approve</code> command.</p><p><img src=./14.png alt="Screenshot showing terraform destroy being run"></p><p><img src=./15.png alt="Screenshot showing terraform destroy being run"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-3e05fff6e5f9edc84a1c1f7e7cbd6a89>3.3 - Amazon Elastic Kubernetes Service</h1><div class=lead>If you are working in a multi-cloud environment, the scenario in this section will guide on creating an Amazon Elastic Kubernetes Service (EKS) and onboard it as an Azure Arc enabled Kubernetes cluster in an automated fashion using Terraform.</div></div><div class=td-content><h1 id=pg-5e17a5ecfaf4883b327e3a3a5a173c93>3.3.1 - EKS cluster Terraform plan</h1><h2 id=deploy-eks-cluster-and-connect-it-to-azure-arc-using-terraform>Deploy EKS cluster and connect it to Azure Arc using Terraform</h2><p>The following README will guide you on how to use the provided <a href=https://www.terraform.io/>Terraform</a> plan to deploy an Amazon Web Services (AWS) <a href=https://aws.amazon.com/eks/>Kubernetes Engine cluster</a> and connected it as an Azure Arc cluster resource.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/>public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html>Install</a> and <a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html#cli-quick-configuration>Configure</a> AWS CLI</p></li><li><p>Install <strong>wget</strong> package (required for the eks module)</p><ul><li><a href=https://builtvisible.com/download-your-website-with-wget/>Windows</a></li><li><a href=https://www.cyberciti.biz/faq/howto-install-wget-om-mac-os-x-mountain-lion-mavericks-snow-leopard/>Mac</a></li><li><a href=https://www.tecmint.com/install-wget-in-linux/>Linux</a></li></ul></li><li><p><a href=https://docs.aws.amazon.com/eks/latest/userguide/install-aws-iam-authenticator.html>Install AWS IAM Authenticator</a></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://aws.amazon.com/free/>Create a free Amazon Web Service&rsquo;s account</a></p></li><li><p><a href=https://helm.sh/docs/intro/install/>Install Helm 3</a></p></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li><li><p>Install the Azure Arc for Kubernetes CLI extensions <em><strong>connectedk8s</strong></em> and <em><strong>k8sconfiguration</strong></em>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az extension add --name connectedk8s
az extension add --name k8sconfiguration
</code></pre></div><blockquote><p><strong>Note: If you already used this guide before and/or have the extensions installed, use the bellow commands:</strong></p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az extension update --name connectedk8s
az extension update --name k8sconfiguration
</code></pre></div></li><li><p>Create AWS User IAM Key</p><p>An access key grants programmatic access to your resources. To create an AWS Access Key for a user:</p><ul><li><p>Navigate to the <a href=https://console.aws.amazon.com/iam/home#/home>IAM Access page</a>.</p><p><img src=./image0.png alt="Screenshot showing how to create AWS IAM key"></p></li><li><p>Select the <strong>Users</strong> from the side menu.</p><p><img src=./image1.png alt="Screenshot showing how to create AWS IAM key"></p></li><li><p>Select the <strong>User</strong> you want to create the access key for.</p><p><img src=./image2.png alt="Screenshot showing how to create AWS IAM key"></p></li><li><p>Select *<strong>Security credentials</strong> of the <strong>User</strong> selected.</p><p><img src=./image3.png alt="Screenshot showing how to create AWS IAM key"></p></li><li><p>Under <strong>Access Keys</strong> select <strong>Create Access Keys</strong>.</p><p><img src=./image4.png alt="Screenshot showing how to create AWS IAM key"></p></li><li><p>In the popup window it will show you the <em><strong>Access key ID</strong></em> and <em><strong>Secret access key</strong></em>. Save both of these values to configure <strong>AWS CLI</strong> later</p><p><img src=./image5.png alt="Screenshot showing how to create AWS IAM key"></p></li><li><p>Set your credentials via the AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY, environment variables, representing your AWS Access Key and AWS Secret Key.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>export</span> <span style=color:#000>AWS_ACCESS_KEY_ID</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;an access key&#34;</span>
<span style=color:#204a87>export</span> <span style=color:#000>AWS_SECRET_ACCESS_KEY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;a secret key&#34;</span>
<span style=color:#204a87>export</span> <span style=color:#000>AWS_DEFAULT_REGION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;us-west-2&#34;</span>
</code></pre></div></li></ul></li></ul><h2 id=deployment>Deployment</h2><ul><li><p>Navigate to the folder that has <strong>EKS</strong> terraform binaries.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>cd</span> azure_arc_k8s_jumpstart/eks/terraform
</code></pre></div></li><li><p>Run the <code>terraform init</code> command which will initialize Terraform, creating the state file to track our work:</p><p><img src=./image6.png alt="Screenshot showing terraform init being run"></p></li><li><p>Deploy EKS by running the <code>terraform apply --auto-approve</code> command.
Wait for the plan to finish:</p><p><img src=./image7.png alt="Screenshot showing terraform apply being run"></p></li><li><p>You will need the configuration output from Terraform in order to use kubectl to interact with your new cluster. Create your kube configuration directory, and output the configuration from Terraform into the config file using the Terraform output command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>mkdir ~/.kube/
terraform output kubeconfig&gt;~/.kube/config
</code></pre></div><p>Check to see if cluster is discoverable by <code>kubectl</code> by running:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl version
</code></pre></div><p>Output should look similar to this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>Client Version: version.Info<span style=color:#ce5c00;font-weight:700>{</span>Major:<span style=color:#4e9a06>&#34;1&#34;</span>, Minor:<span style=color:#4e9a06>&#34;15&#34;</span>, GitVersion:<span style=color:#4e9a06>&#34;v1.15.5&#34;</span>, GitCommit:<span style=color:#4e9a06>&#34;20c265fef0741dd71a66480e35bd69f18351daea&#34;</span>, GitTreeState:<span style=color:#4e9a06>&#34;clean&#34;</span>, BuildDate:<span style=color:#4e9a06>&#34;2019-10-15T19:16:51Z&#34;</span>, GoVersion:<span style=color:#4e9a06>&#34;go1.12.10&#34;</span>, Compiler:<span style=color:#4e9a06>&#34;gc&#34;</span>, Platform:<span style=color:#4e9a06>&#34;darwin/amd64&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
Server Version: version.Info<span style=color:#ce5c00;font-weight:700>{</span>Major:<span style=color:#4e9a06>&#34;1&#34;</span>, Minor:<span style=color:#4e9a06>&#34;16+&#34;</span>, GitVersion:<span style=color:#4e9a06>&#34;v1.16.8-eks-e16311&#34;</span>, GitCommit:<span style=color:#4e9a06>&#34;e163110a04dcb2f39c3325af96d019b4925419eb&#34;</span>, GitTreeState:<span style=color:#4e9a06>&#34;clean&#34;</span>, BuildDate:<span style=color:#4e9a06>&#34;2020-03-27T22:37:12Z&#34;</span>, GoVersion:<span style=color:#4e9a06>&#34;go1.13.8&#34;</span>, Compiler:<span style=color:#4e9a06>&#34;gc&#34;</span>, Platform:<span style=color:#4e9a06>&#34;linux/amd64&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div></li><li><p>Configure EKS Nodes to communicate to EKS Control Plane</p><p>Now let’s add the ConfigMap to the cluster from Terraform as well. The ConfigMap is a Kubernetes configuration, in this case for granting access to our EKS cluster. This ConfigMap allows our ec2 instances in the cluster to communicate with the EKS master, as well as allowing our user account access to run commands against the cluster. You’ll run the Terraform output command to a file, and the kubectl apply command to apply that file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>terraform output config_map_aws_auth &gt; configmap.yml
kubectl apply -f configmap.yml
</code></pre></div><p><img src=./image8.png alt="Screenshot showing kubectl apply being run"></p><p>Once this is complete, you should see your nodes from your autoscaling group either starting to join or joined to the cluster. Once the second column reads Ready the node can have deployments pushed to it. Again, your output may vary here:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get nodes -o wide
</code></pre></div><p><img src=./image9.png alt="Screenshot showing kubectl get nodes being run"></p></li><li><p>Verify EKS deployment</p><p>Once done, you will have a ready EKS cluster under the <em><strong>Elastic Kubernetes Service</strong></em> section in your AWS console.</p><p><img src=./image10.png alt="Screenshot showing AWS cloud console"></p><p><img src=./image11.png alt="Screenshot showing AWS cloud console with EKS cluster"></p></li></ul><h2 id=connecting-to-azure-arc>Connecting to Azure Arc</h2><p>Now that you have a running EKS cluster, lets connect the EKS cluster to Azure Arc by:</p><ul><li><p>Login to previously created <a href=#prerequisites><em><strong>Service Principal</strong></em></a></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login --service-principal -u mySpnClientId -p mySpnClientSecret --tenant myTenantID
</code></pre></div></li><li><p>Create a resource group</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name arceksdemo -l EastUS -o table
</code></pre></div><blockquote><p><strong>Note: Azure Arc enabled Kubernetes is currently supported in <em>East US</em> and <em>West Europe</em></strong></p></blockquote></li><li><p>Deploy Arc binaries using Azure CLI:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az connectedk8s connect --name arceksdemo --resource-group arceksdemo --location <span style=color:#4e9a06>&#39;eastus&#39;</span> --tags <span style=color:#4e9a06>&#39;Project=jumpstart_azure_arc_k8s&#39;</span>
</code></pre></div></li><li><p>Upon completion, you will have your EKS cluster connect as a new Azure Arc enabled Kubernetes resource in a new resource group.</p><p><img src=./image13.png alt="Screenshot showing ARM deployment"></p><p><img src=./image14.png alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource"></p><p><img src=./image15.png alt="Screenshot showing Azure POrtal with Azure Arc enabled Kubernetes resource detail"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><p>In Azure, the most straightforward way is to delete the cluster or the resource group via the Azure Portal or through the CLI.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group delete --name arceksdemo
</code></pre></div><p><img src=./image16.png alt="Screenshot showing delete resource function in Azure Portal"></p><p><img src=./image17.png alt="Screenshot showing delete resource group function in Azure Portal"></p><p>On your AWS portal, select the cluster and delete it or alternatively, you can use the <code>terraform destroy --auto-approve</code> command.</p><p><img src=./image18.png alt="Screenshot showing terraform destroy being run"></p><p><img src=./image20.png alt="Screenshot showing terraform destroy being run"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-28b2918a0d905681a5ba4bb5b347ea47>3.4 - Google Kubernetes Engine</h1><div class=lead>If you are working in a multi-cloud environment, the scenario in this section will guide on creating a Google Kubernetes Engine (GKE) and onboard it as an Azure Arc enabled Kubernetes cluster in an automated fashion using Terraform.</div></div><div class=td-content><h1 id=pg-7b3417c1127106046a16ebb3ce567134>3.4.1 - GKE cluster Terraform plan</h1><h2 id=deploy-gke-cluster-and-connect-it-to-azure-arc-using-terraform>Deploy GKE cluster and connect it to Azure Arc using Terraform</h2><p>The following README will guide you on how to use the provided <a href=https://www.terraform.io/>Terraform</a> plan to deploy a Google Cloud Platform <a href=https://cloud.google.com/kubernetes-engine>Kubernetes Engine cluster</a> and connected it as an Azure Arc cluster resource.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/>public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://cloud.google.com/free>Create a free Google Cloud account</a></p></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li><li><p>Install the Azure Arc for Kubernetes CLI extensions <em><strong>connectedk8s</strong></em> and <em><strong>k8sconfiguration</strong></em>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az extension add --name connectedk8s
az extension add --name k8sconfiguration
</code></pre></div><blockquote><p><strong>Note: If you already used this guide before and/or have the extensions installed, use the bellow commands:</strong></p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az extension update --name connectedk8s
az extension update --name k8sconfiguration
</code></pre></div></li></ul><h3 id=create-a-new-gcp-project>Create a new GCP Project</h3><ul><li><p>Browse to <a href=https://console.cloud.google.com/>https://console.cloud.google.com/</a> and login with your Google Cloud account. Once logged in, <a href=https://cloud.google.com/resource-manager/docs/creating-managing-projects>create a new project</a> named &ldquo;Azure Arc Demo&rdquo;. After creating it, be sure to copy down the project id as it is usually different then the project name.</p><p><img src=./01.png alt="GCP new project"></p><p><img src=./02.png alt="GCP new project"></p><p><img src=./03.png alt="GCP new project"></p></li><li><p>Enable the Compute Engine API for the project, create a project Owner service account credentials and download the private key JSON file and copy the file to the directory where Terraform files are located. Change the JSON file name (for example <em>account.json</em>). The Terraform plan will be using the credentials stored in this file to authenticate against your GCP project.</p><p><img src=./04.png alt="Enable Compute Engine API"></p><p><img src=./05.png alt="Enable Compute Engine API"></p><p><img src=./06.png alt="Add credentials"></p><p><img src=./07.png alt="Add credentials"></p><p><img src=./08.png alt="Add credentials"></p><p><img src=./09.png alt="Add credentials"></p><p><img src=./10.png alt="Add credentials"></p><p><img src=./11.png alt="Create private key"></p><p><img src=./12.png alt="Create private key"></p><p><img src=./13.png alt="Create private key"></p><p><img src=./14.png alt="Create private key"></p><p><img src=./15.png alt=account.json></p></li><li><p>Enable the Compute Engine API for the project</p><p><img src=./16.png alt="Enable the Kubernetes Engine API"></p><p><img src=./17.png alt="Enable the Kubernetes Engine API"></p></li></ul><h2 id=deployment>Deployment</h2><p>The only thing you need to do before executing the Terraform plan is to export the environment variables which will be used by the plan. This is based on the Azure service principal you&rsquo;ve just created and your subscription.</p><ul><li><p>Export the environment variables needed for the Terraform plan.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_subscriptionId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;Your Azure subscription ID&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalAppId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;Your Azure service principal App ID&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalSecret</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;Your Azure service principal App Password&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalTenantId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;Your Azure tenant ID&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gcp_project_id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;Your GCP Project ID&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_location</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;Azure Region&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_resourceGroup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;Azure resource group name&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gcp_credentials_filename</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;Location on the Keys JSON file&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gcp_region</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;GCP Region to deploy resources&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gke_cluster_name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;GKE cluster name&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_admin_username</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;GKE control plane administrator username&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_admin_password</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;GKE control plane administrator password&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gke_cluster_node_count</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;GKE cluster node count&gt;&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gke_cluster_node_machine_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;&lt;GKE cluster node machine type&gt;&#39;</span>
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_subscriptionId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalAppId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalSecret</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_servicePrincipalTenantId</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_location</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;eastus&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_resourceGroup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;Arc-GKE-Demo&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gcp_project_id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;azure-arc-demo-111111&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gcp_credentials_filename</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;account.json&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gcp_region</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;us-west1&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gke_cluster_name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;arc-gke-demo&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_admin_username</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;arcdemo&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_admin_password</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;ArcDemo1234567!!&#39;</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gke_cluster_node_count</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_gke_cluster_node_machine_type</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;n1-standard-2&#39;</span>
</code></pre></div></li><li><p>Run the <code>terraform init</code> command which will download the required terraform providers.</p><p><img src=./18.png alt="terraform init"></p></li><li><p>Run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish. Once done, you will have a new empty Azure resource group and and a GKE cluster under the <em>Kubernetes Engine</em> page in your GCP console.</p><p><img src=./19.png alt="terraform apply"></p><p><img src=./20.png alt="An empty Azure resource group"></p><p><img src=./21.png alt="New GKE cluster in the Google Console"></p><p><img src=./22.png alt="New GKE cluster in the Google Console"></p></li></ul><h2 id=connecting-to-azure-arc>Connecting to Azure Arc</h2><ul><li><p>Now that you have a running GKE cluster, retrieve your Azure subscription ID using the <code>az account list</code> command and edit the environment variables section in the included <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/terraform/scripts/az_connect_gke.sh>az_connect_gke</a> shell script.</p><p><img src=./23.png alt="Export environment variables"></p></li><li><p>Open a new Cloud Shell session which will pre-authenticated against your GKE cluster.</p><p><img src=./24.png alt="Open Google Cloud Shell session and authenticate against the GKE cluster"></p><p><img src=./25.png alt="Open Google Cloud Shell session and authenticate against the GKE cluster"></p><p><img src=./26.png alt="Open Google Cloud Shell session and authenticate against the GKE cluster"></p></li><li><p>Upload the <em>az_connect_gke</em> shell script and run it using the <code>. ./az_connect_gke.sh</code> command.</p><blockquote><p><strong>Note: The extra dot is due to the script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p></blockquote><p><img src=./27.png alt="Upload a file to Cloud Shell"></p><p><img src=./28.png alt="Upload a file to Cloud Shell"></p><p><img src=./29.png alt="Upload a file to Cloud Shell"></p></li><li><p>Upon completion, you will have your GKE cluster connect as a new Azure Arc Kubernetes cluster resource in the new Azure resource group.</p><p><img src=./30.png alt="New Azure Arc enabled Kubernetes cluster"></p><p><img src=./31.png alt="New Azure Arc enabled Kubernetes cluster"></p><p><img src=./32.png alt="New Azure Arc enabled Kubernetes cluster"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><p>To delete the environment, use the <em><code>terraform destroy --auto-approve</code></em> command.</p><p><img src=./33.png alt="terraform destroy"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-a57a5382ffb7c67c0e8f32e5cd7bda2f>3.5 - Kubernetes Cluster API</h1><div class=lead>If you are working in a multi-cloud environment, the scenarios in this section will guide on creating clusters using Kubernetes Cluster API (CAPI) and onboard it as an Azure Arc enabled Kubernetes cluster in an automated fashion.</div></div><div class=td-content><h1 id=pg-19ad9d47852711a9ec0dfb3405805685>3.5.1 - Azure Provider</h1><h2 id=deploy-kubernetes-cluster-and-connect-it-to-azure-arc-using-cluster-api-azure-provider>Deploy Kubernetes cluster and connect it to Azure Arc using Cluster API Azure provider</h2><p>The following README will guide you on to deploy an Kubernetes cluster in Azure virtual machines and connected it as an Azure Arc cluster resource by leveraging the <a href=https://cluster-api.sigs.k8s.io/introduction.html>Kubernetes Cluster API (CAPI) project</a> and it&rsquo;s <a href=https://cloudblogs.microsoft.com/opensource/2020/12/15/introducing-cluster-api-provider-azure-capz-kubernetes-cluster-management/>Cluster API Azure provider (CAPZ)</a>.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/>public preview</a>.</strong></p></blockquote><h2 id=architecture-in-a-nutshell>Architecture (In a nutshell)</h2><p>From the Cluster API Book docs:</p><p>&ldquo;Cluster API requires an existing Kubernetes cluster accessible via kubectl; during the installation process the Kubernetes cluster will be transformed into a management cluster by installing the Cluster API provider components, so it is recommended to keep it separated from any application workload.&rdquo;</p><p>In this guide (as explained in the CAPI Book docs), you will deploy a local <a href=https://kind.sigs.k8s.io/>kind</a> cluster which will be used as the management cluster. This cluster will then be used to deploy the workload cluster using the Cluster API Azure provider (CAPZ).</p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li><li><p>As mentioned, you will need to deploy a local, small footprint Kubernetes cluster using kind which will act the management/provisioner cluster. To install kind on your machine, use the below command.</p><blockquote><p><strong>Note: In order for you to complete this scenario, either a Linux (<a href=https://docs.microsoft.com/en-us/windows/wsl/install-win10>WSL incl.</a>) or MacOS is required. Currently, this scenario does not support Windows OS</strong></p></blockquote><p>On Linux:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.9.0/kind-linux-amd64
chmod +x ./kind
sudo mv ./kind /usr/local/bin/kind
</code></pre></div><p>On MacOS:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>brew install kind
</code></pre></div><p><img src=./01.png alt="Screenshot of kind CLI"></p></li></ul><h2 id=deployment---management-cluster>Deployment - Management Cluster</h2><blockquote><p><strong>Disclaimer: The deployment process of a the management cluster and the <em>clusterctl</em> CLI tool described in below are taken straight from the <a href=https://cluster-api.sigs.k8s.io/user/quick-start.html>&ldquo;Cluster API Book&rdquo;</a> and deserves it&rsquo;s writers all the credit for it!</strong>
<strong>The reason being for this process to be included is to provide you with the end-to-end user experience which also include the proprietary automation developed for this Jumpstart scenario and will be used later on in this guide.</strong></p></blockquote><ul><li><p>Now that you have kind installed, deploy the local management cluster and test to ensure it&rsquo;s ready using the below commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kind create cluster
kubectl cluster-info
</code></pre></div><p><img src=./02.png alt="Screenshot of kind management cluster deployment"></p></li><li><p>Install the <em>clusterctl</em> CLI tool which handles the lifecycle of a Cluster API management cluster using the below commands:</p><p>On Linux:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -L https://github.com/kubernetes-sigs/cluster-api/releases/download/v0.3.12/clusterctl-linux-amd64 -o clusterctl
chmod +x ./clusterctl
sudo mv ./clusterctl /usr/local/bin/clusterctl
clusterctl version
</code></pre></div><p>On MacOS:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -L https://github.com/kubernetes-sigs/cluster-api/releases/download/v0.3.12/clusterctl-darwin-amd64 -o clusterctl
chmod +x ./clusterctl
sudo mv ./clusterctl /usr/local/bin/clusterctl
clusterctl version
</code></pre></div><p><img src=./03.png alt="Screenshot clusterctl installation"></p></li></ul><h2 id=deployment---workload-cluster>Deployment - Workload Cluster</h2><ul><li><p>In the your directory of the cloned Jumpstart repository, navigate to where the <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_k8s_jumpstart/cluster_api/capi_azure><em>arc_capi_azure</em></a> bash script is located.</p><p>The script will transform the kind Kubernetes cluster to management cluster with the Azure Cluster API provisioner components that are needed. It will then deploy the workload cluster and it&rsquo;s Azure resources based on the environment variables you will edit in the next bullet. Once the deployment is completed, the cluster will be onboard as an Azure Arc enabled Kubernetes cluster.</p></li><li><p>Edit the environment variables to match your Azure subscription and SPN details created in the prerequisites section in this guide as well as the required workload cluster details.</p><ul><li><em>KUBERNETES_VERSION</em>=&ldquo;Kubernetes version. For example: 1.18.10&rdquo;</li><li><em>CONTROL_PLANE_MACHINE_COUNT</em>=&ldquo;Control Plane node count. For example: 1&rdquo;</li><li><em>WORKER_MACHINE_COUNT</em>=&ldquo;Workers node count. For example: 2&rdquo;</li><li><em>AZURE_LOCATION</em>=&ldquo;Azure region. For example: eastus&rdquo;</li><li><em>CAPI_WORKLOAD_CLUSTER_NAME</em>=&ldquo;Workload cluster name. For example: arc-capi-azure&rdquo;. Must consist of lower case alphanumeric characters, &lsquo;-&rsquo; or &lsquo;.&rsquo;, and must start and end with an alphanumeric character (e.g. &lsquo;example.com&rsquo;, regex used for validation is &lsquo;<a href=%5B-a-z0-9%5D*%5Ba-z0-9%5D>a-z0-9</a>?(.<a href=%5B-a-z0-9%5D*%5Ba-z0-9%5D>a-z0-9</a>?)*')</li><li><em>AZURE_SUBSCRIPTION_ID</em>=&ldquo;Azure subscription id&rdquo;</li><li><em>AZURE_TENANT_ID</em>=&ldquo;Azure tenant id&rdquo;</li><li><em>AZURE_CLIENT_ID=</em>&ldquo;Azure SPN application client id&rdquo;</li><li><em>AZURE_CLIENT_SECRET</em>=&ldquo;Azure SPN application client secret&rdquo;</li><li><em>AZURE_CONTROL_PLANE_MACHINE_TYPE</em>=&ldquo;Control Plane node Azure VM type .For example: Standard_D2_v3&rdquo;</li><li><em>AZURE_NODE_MACHINE_TYPE</em>=&ldquo;Worker node Azure VM type .For example: Standard_D4s_v3&rdquo;</li></ul><p><img src=./04.png alt="Screenshot of user environment variables"></p></li><li><p>Execute the script using the below command. The script runtime can take ~10-20min, depends on the number of control plane and worker nodes you chose to deploy. In case you don&rsquo;t have the required Azure CLI extensions already installed or if they are requires an update, the script will either install it or perform an update.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>. ./arc_capi_azure.sh
</code></pre></div><blockquote><p><strong>Note: The extra dot is due to the script having an <em>export</em> function and needs to have the vars exported in the same shell session as the other commands.</strong></p></blockquote><p><img src=./05.png alt="Screenshot of workload cluster deployment script runtime"></p><p><img src=./06.png alt="Screenshot of workload cluster deployment script runtime"></p><p><img src=./07.png alt="Screenshot of workload cluster deployment script runtime"></p><p><img src=./08.png alt="Screenshot of workload cluster deployment script runtime"></p><p><img src=./09.png alt="Screenshot of workload cluster deployment script runtime"></p></li><li><p>Upon completion, you will have a new Kubernetes cluster deployed on top of Azure virtual machines that is already onboard as an Azure Arc enabled Kubernetes cluster.</p><p>The script will generate the cluster definition <em>yaml</em> file which was used to deploy the workload cluster as will as the <em>kubeconfig</em> file. To test the cluster is up and running use the below command.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl --kubeconfig<span style=color:#ce5c00;font-weight:700>=</span>./&lt;Name of your workload cluster&gt;.kubeconfig get nodes
</code></pre></div><p><img src=./10.png alt="Screenshot of the workload cluster nodes"></p></li><li><p>In the Azure portal, you can see how all the resources were deployed in a new resource group as well as the Azure Arc enabled Kubernetes cluster resource.</p><p><img src=./11.png alt="Screenshot of the deployment Azure virtual machines"></p><p><img src=./12.png alt="Screenshot of the Azure Arc enabled Kubernetes cluster in a resource group"></p><p><img src=./13.png alt="Screenshot of the Azure Arc enabled Kubernetes cluster resource"></p></li></ul><h2 id=cleanup>Cleanup</h2><ul><li><p>To delete only the workload cluster (and as a result, the Azure resources as well), run the below command. Deletion can take ~10min, depends on the number of control plane and worker nodes you have chosen to deploy.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl delete cluster <span style=color:#4e9a06>&#34;&lt;Name of your cluster&gt;&#34;</span>
</code></pre></div><p><img src=./14.png alt="Screenshot of the workload cluster deletion"></p></li><li><p>In addition, you can also delete the management cluster using the below command.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kind delete cluster
</code></pre></div><p><img src=./15.png alt="Screenshot of the management cluster deletion"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ce8c5dc601de838593a9b6be96998df3>3.6 - Rancher K3s</h1><div class=lead>If you do not have a Kubernetes cluster, the scenarios in this section will guide on creating a Rancher K3s Kubernetes cluster on either your VMware vSphere infrastructure or on an Azure VM and onboard it as an Azure Arc enabled Kubernetes cluster in an automated fashion using either ARM template or Terraform.</div></div><div class=td-content><h1 id=pg-6b79ac779a90e2d51c854647ee30fd19>3.6.1 - k3s Azure ARM template</h1><h2 id=deploy-rancher-k3s-on-an-azure-vm-and-connect-it-to-azure-arc-using-azure-arm-template>Deploy Rancher k3s on an Azure VM and connect it to Azure Arc using Azure ARM template</h2><p>The following README will guide you on how to use the provided <a href=https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview>Azure ARM Template</a> to deploy a &ldquo;Ready to Go&rdquo; Azure virtual machine installed with single-master Rancher K3s Kubernetes cluster and connected it as an Azure Arc cluster resource.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/>public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Enable subscription for two providers for Azure Arc enabled Kubernetes.</p></li><li><p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li></ul><h2 id=deployment>Deployment</h2><p>The deployment is using the template parameters file. Before initiating the deployment, edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/rancher_k3s/azure/arm_template/azuredeploy.parameters.json><em>azuredeploy.parameters.json</em></a> file to include the OS username and password as well as the appId, password and tenant generated from the service principal creation.</p><ul><li><p>To deploy the ARM template, navigate to the <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_k8s_jumpstart/rancher_k3s/azure/arm_template>deployment folder</a> and run the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name &lt;Name of the Azure resource group&gt; --location &lt;Azure Region&gt;
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name &lt;The name of this deployment&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_k8s_jumpstart/rancher_k3s/azure/arm_template/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters &lt;The *azuredeploy.parameters.json* parameters file location&gt;
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name Arc-K3s-Demo --location <span style=color:#4e9a06>&#34;East US&#34;</span>
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group Arc-K3s-Demo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name arck3sdemo01 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_k8s_jumpstart/rancher_k3s/azure/arm_template/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters azuredeploy.parameters.json
</code></pre></div><p>Upon completion, you will have new VM installed as a single-host k3s cluster which is already projected as an Azure Arc enabled Kubernetes cluster in a new resource group.</p><p><img src=./01.png alt="Azure resource group"></p></li></ul><h2 id=k3s-external-access>K3s External Access</h2><p>Traefik is the (default) ingress controller for k3s and uses port 80. To test external access to k3s cluster, an &ldquo;<em>hello-world</em>&rdquo; deployment was for you and it is included in the <em>home</em> directory <a href=https://github.com/paulbouwer/hello-kubernetes>(credit)</a>.</p><ul><li><p>Since port 80 is taken by Traefik <a href=https://github.com/rancher/k3s/issues/436>(read more about here)</a>, the deployment LoadBalancer was changed to use port 32323 along side with the matching Azure Network Security Group (NSG).</p><p><img src=./02.png alt="Azure Network Security Group (NSG) rule"></p><p><img src=./03.png alt="hello-kubernetes.yaml file"></p></li><li><p>To deploy it, use the <code>kubectl apply -f hello-kubernetes.yaml</code> command. Run <code>kubectl get pods</code> and <code>kubectl get svc</code> to check that the pods and the service has been created.</p><p><img src=./04.png alt="kubectl apply -f hello-kubernetes.yaml command"></p><p><img src=./05.png alt="kubectl get pods command"></p><p><img src=./06.png alt="kubectl get svc command"></p></li><li><p>In your browser, enter the <em>cluster_public_ip:3232</em> which will bring up the <em>hello-world</em> application.</p><p><img src=./07.png alt="hello-kubernetes application in a web browser"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><p>To delete environment, simply just delete the Azure resource group.</p><p><img src=./08.png alt="Delete Azure resource group"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-d56ecc40c26e1cc0f12f4d0304905c81>3.6.2 - k3s Azure Terraform plan</h1><h2 id=deploy-rancher-k3s-on-an-azure-vm-and-connect-it-to-azure-arc-using-terraform>Deploy Rancher k3s on an Azure VM and connect it to Azure Arc using Terraform</h2><p>The following README will guide you on how to use the provided <a href=https://www.terraform.io/>Terraform</a> plan to deploy a &ldquo;Ready to Go&rdquo; Azure virtual machine installed with single-master Rancher K3s Kubernetes cluster and connected it as an Azure Arc cluster resource.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/>public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li><li><p>The Terraform plan execute a script on the VM OS to install all the needed artifacts as well to inject environment variables. Edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/rancher_k3s/azure/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> to match the Azure service principal you&rsquo;ve just created.</p></li></ul><h2 id=deployment>Deployment</h2><p>The only thing you need to do before executing the Terraform plan is to export the environment variables which will be used by the plan. This is based on the Azure service principal you&rsquo;ve just created and your subscription.</p><ul><li><p>Retrieve your Azure subscription ID using the <code>az account list</code> command.</p></li><li><p>Export the environment variables needed for the Terraform plan.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_subscription_id</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your Azure subscription ID&gt;  
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_client_id</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your Azure service principal App ID&gt;
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_client_secret</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your Azure service principal App password&gt;  
<span style=color:#204a87>export</span> <span style=color:#000>TF_VAR_tenant_id</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;Your Azure service principal Tenant ID&gt;
</code></pre></div></li><li><p>Run the <code>terraform init</code> command which will download the Terraform AzureRM provider.</p><p><img src=./01.png alt="terraform init"></p></li><li><p>Run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish.</p><p><img src=./02.png alt="terraform apply completed"></p></li></ul><h2 id=connecting-to-azure-arc>Connecting to Azure Arc</h2><blockquote><p><strong>Note: The VM bootstrap includes the log in process to Azure as well deploying the needed Azure Arc CLI extensions - no action items on you there!</strong></p></blockquote><ul><li><p>SSH to the VM using the created Azure Public IP and your username/password.</p><p><img src=./03.png alt="Azure VM public IP"></p></li><li><p>Check the cluster is up and running using the <code>kubectl get nodes -o wide</code></p><p><img src=./04.png alt="k3s cluster nodes"></p></li><li><p>Using the Azure service principal you&rsquo;ve created, run the below command to connect the cluster to Azure Arc.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az connectedk8s connect --name &lt;Name of your cluster as it will be shown in Azure&gt; --resource-group &lt;Azure resource group name&gt;
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az connectedk8s connect --name arck3sdemo --resource-group Arc-K3s-Demo
</code></pre></div><p><img src=./05.png alt="Successful azconnctedk8s command"></p><p><img src=./06.png alt="Azure Arc enabled Kubernetes cluster in an Azure resource group"></p><p><img src=./07.png alt="Azure Arc enabled Kubernetes cluster in an Azure resource group"></p></li></ul><h2 id=k3s-external-access>K3s External Access</h2><p>Traefik is the (default) ingress controller for k3s and uses port 80. To test external access to k3s cluster, an &ldquo;<em>hello-world</em>&rdquo; deployment was <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/rancher_k3s/azure/terraform/deployment/hello-kubernetes.yaml>made available</a> for you and it is included in the <em>home</em> directory <a href=https://github.com/paulbouwer/hello-kubernetes>(credit)</a>.</p><ul><li><p>Since port 80 is taken by Traefik <a href=https://github.com/rancher/k3s/issues/436>(read more about here)</a>, the deployment LoadBalancer was changed to use port 32323 along side with the matching Azure Network Security Group (NSG).</p><p><img src=./08.png alt="Azure Network Security Group (NSG) rule"></p><p><img src=./09.png alt="hello-kubernetes.yaml file"></p></li><li><p>To deploy it, use the <code>kubectl apply -f hello-kubernetes.yaml</code> command. Run <code>kubectl get pods</code> and <code>kubectl get svc</code> to check that the pods and the service has been created.</p><p><img src=./10.png alt="kubectl apply -f hello-kubernetes.yaml command"></p><p><img src=./11.png alt="kubectl get pods command"></p><p><img src=./12.png alt="kubectl get svc command"></p></li><li><p>In your browser, enter the <em>cluster_public_ip:3232</em> which will bring up the <em>hello-world</em> application.</p><p><img src=./13.png alt="hello-kubernetes application in a web browser"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><ul><li><p>The most straightforward way is to delete the cluster is via the Azure Portal, just select cluster and delete it.</p><p><img src=./14.png alt="Delete Azure Arc enabled Kubernetes cluster"></p></li><li><p>If you want to nuke the entire environment, just delete the Azure resource group or alternatively, you can use the <code>terraform destroy --auto-approve</code> command.</p><p><img src=./15.png alt="Delete Azure resource group"></p><p><img src=./16.png alt="terraform destroy"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-cff71fdb229d543e558525c8c80283d9>3.6.3 - k3s on VMware Terraform plan</h1><h2 id=deploy-rancher-k3s-on-a-vmware-vsphere-vm-and-connect-it-to-azure-arc-using-terraform>Deploy Rancher k3s on a VMware vSphere VM and connect it to Azure Arc using Terraform</h2><p>The following README will guide you on how to use the provided <a href=https://www.terraform.io/>Terraform</a> plan to deploy a &ldquo;Ready to Go&rdquo; VMware vSphere Ubuntu Server virtual machine installed with a single-master Rancher K3s Kubernetes cluster and connected it as an Azure Arc cluster resource.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/>public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>A VMware vCenter Server user with <a href=https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.vm_admin.doc/GUID-8254CD05-CC06-491D-BA56-A773A32A8130.html>permissions to deploy</a> a Virtual Machine from a Template in the vSphere Web Client.</p></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li></ul><h3 id=preparing-an-ubuntu-server-vmware-vsphere-vm-template>Preparing an Ubuntu Server VMware vSphere VM Template</h3><p>Before using the below guide to deploy an Ubuntu Server VM and connect it to Azure Arc, a VMware vSphere Template is required. <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_servers/vmware/vmware_terraform_ubuntu/vmware_ubuntu_template/>The following README</a> will instruct you how to easily create such a template using VMware vSphere 6.5 and above.</p><blockquote><p><strong>Note: If you already have an Ubuntu Server VM template it is still recommended to use the guide as a reference.</strong></p></blockquote><h2 id=deployment>Deployment</h2><p>Before executing the Terraform plan, you must set the environment variables which will be used by the plan. These variables are based on the Azure service principal you&rsquo;ve just created, your Azure subscription and tenant, and your VMware vSphere credentials.</p><ul><li><p>Retrieve your Azure subscription ID and tenant ID using the <code>az account list</code> command.</p></li><li><p>The Terraform plan creates resources in both Microsoft Azure and VMware vSphere. It then executes a script on the virtual machine to install the Azure Arc agent and all necessary artifacts. This script requires certain information about your VMware vSphere and Azure environments.</p></li><li><p>Edit <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/rancher_k3s/vmware/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> and update each of the variables with the appropriate values.</p><ul><li>TF_VAR_subscription_id=Your Azure subscription ID</li><li>TF_VAR_client_id=Your Azure service principal name</li><li>TF_VAR_client_secret=Your Azure service principal password</li><li>TF_VAR_tenant_id=Your Azure tenant ID</li><li>TF_VAR_resourceGroup=Azure resource group name</li><li>TF_VAR_location=Azure Region</li><li>TF_VAR_arcClusterName=The name of your k8s cluster as it will be shown in Azure Arc</li><li>TF_VAR_vsphere_user=vCenter Admin Username</li><li>TF_VAR_vsphere_password=vCenter Admin Password</li><li>TF_VAR_vsphere_server=vCenter server FQDN/IP</li><li>TF_VAR_admin_user=OS Admin Username</li><li>TF_VAR_admin_password=OS Admin Password</li></ul></li><li><p>From CLI, navigate to the <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_k8s_jumpstart/rancher_k3s/vmware/terraform><em>azure_arc_k8s_jumpstart/rancher_k3s/vmware/terraform</em></a> directory of the cloned repo.</p></li><li><p>Export the environment variables you edited by running <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/rancher_k3s/vmware/terraform/scripts/vars.sh><em>scripts/vars.sh</em></a> with the source command as shown below. Terraform requires these to be set for the plan to execute properly. Note that this script will also be automatically executed remotely on the virtual machine as part of the Terraform deployment.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>source</span> ./scripts/vars.sh
</code></pre></div></li><li><p>In addition to the <em>TF_VAR</em> environment variables you&rsquo;ve just exported, edit the Terraform variables in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/rancher_k3s/vmware/terraform/terraform.tfvars><em>terraform.tfvars</em></a> to match your VMware vSphere environment.</p><p><img src=./01.png alt="TF_VAR environment variables"></p></li><li><p>Run the <code>terraform init</code> command which will download the Terraform AzureRM, Local and vSphere providers.</p><p><img src=./02.png alt="terraform init"></p></li><li><p>Run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish.</p><p><img src=./03.png alt="terraform apply"></p></li><li><p>Once the Terraform deployment is completed, a new Ubuntu Server VM will be up & running, installed with a single-master Rancher K3s Kubernetes cluster and will be projected as an Azure Arc Kubernetes cluster in a newly created Azure resource group.</p><p><img src=./04.png alt="VMware vSphere Ubuntu Server VM"></p><p><img src=./05.png alt="Azure Arc enabled Kubernetes cluster"></p><p><img src=./06.png alt="Azure Arc enabled Kubernetes cluster"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><ul><li><p>The most straightforward way is to delete the cluster is via the Azure Portal, just select cluster and delete it.</p><p><img src=./07.png alt="Delete Azure Arc enabled Kubernetes cluster"></p></li><li><p>If you want to nuke the entire environment, just delete the Azure resource group and the newly generated <em>az_connect_k3s</em> shell script in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/rancher_k3s/vmware/terraform/scripts><em>scripts</em></a> folder.</p><p><img src=./08.png alt="Delete Azure resource group"></p></li><li><p>Alternatively, you can use the <code>terraform destroy --auto-approve</code> command.</p><p><img src=./09.png alt="terraform destroy"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-aaac4d3169279a7ae1691c0c9b59ec53>3.7 - Azure Red Hat OpenShift</h1><div class=lead>The scenario in this section will guide on creating an Azure Red Hat OpenShift (ARO) v4 Kubernetes cluster and onboard it as an Azure Arc enabled Kubernetes cluster in an automated fashion.</div></div><div class=td-content><h1 id=pg-b00ec34618f4a7c6c0cefb270ee9bd59>3.7.1 - ARO Cluster</h1><h2 id=deploy-azure-red-hat-openshift-cluster-and-connect-it-to-azure-arc-using-automation>Deploy Azure Red Hat OpenShift Cluster and connect it to Azure Arc using automation</h2><p>The following is a guide on how to use the Azure Cloud Shell to deploy an <a href=https://azure.microsoft.com/en-us/services/openshift/>Azure Red Hat OpenShift</a> 4 cluster and have it as a connected Azure Arc Kubernetes resource.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/>public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Ensure the user logging into Azure portal as admin or co-admin rights to be able to create service principals and/or assign policies to those service principals.</p></li><li><p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li></ul><h2 id=deployment>Deployment</h2><p>There are two sets of resources that will be deployed, first is the Azure Red Hat OpenShift Container cluster. Second is the Azure Arc Kubernetes resource that will connect the <code>aro</code> cluster to Azure Arc.</p><p>The deployment of all resources is going to be done via Azure Cloud Shell.</p><ul><li><p>Log into Azure Cloud Shell.</p><p><img src=./image1.png alt="Screenshot showing Azure Cloud Shell"></p></li><li><p>Run the following script:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>wget -O - https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_k8s_jumpstart/aro/run.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>This script will perform the following tasks:</p><ul><li><p>Deploy the following Resources:</p><ul><li>Azure Container Instance</li><li>Azure VNet</li><li>Azure Red Hat OpenShift (<code>aro</code>) cluster</li><li>Azure Arc K8s connected resource</li><li>Ensure required providers are registered</li></ul></li></ul></li><li><p>When the script is finished copy the <strong>device login code</strong></p><p><img src=./image2.png alt="Screenshot showing device login code"></p></li><li><p>To start creating resources first log into <a href=https://microsoft.com/devicelogin>Azure device login page</a> and authenticate your credentials and that code copied earlier.</p><p><img src=./image3.png alt="Screenshot showing how to use device code with Azure login"></p></li><li><p>Close the Cloud Shell and navigate to the resource group</p><p><img src=./image4.png alt="Screenshot showing Azure Portal closing Cloud Shell"></p><p><img src=./image5.png alt="Screenshot showing Azure Portal"></p></li><li><p>To track progress navigate to the logs of the container by selecting <strong>Containers</strong> under <strong>Settings</strong> and then selecting <strong>Logs</strong>. This deployment can take up to <em><strong>50 mins</strong></em>.</p><p><img src=./image6.png alt="Screenshot showing Azure Portal container deployment"></p></li><li><p>Upon completion, the following resources will be deployed in the resource group:</p><ul><li>Azure Arc enabled Kubernetes</li><li>OpenShift cluster</li><li>Azure VNet</li></ul><p><img src=./image7.png alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resources"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><p>The way to delete all the resources deployed is by deleting the resource group. This will delete the managed resource group as well the resources created for the Azure Arc enabled Kubernetes cluster.</p><p><img src=./image8.png alt="Screenshot showing how to delete resource group from Azure Portal"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-715d96aca7ade3fe976071e1cd0ba8e0>3.8 - Kind</h1><div class=lead>If you do not have a Kubernetes cluster, the scenario in this section will guide on creating a kind (kubernetes in docker) cluster on your local machine and onboard it as an Azure Arc enabled Kubernetes cluster in an automated fashion.</div></div><div class=td-content><h1 id=pg-26e6fd581cdac268f933c80f67cb66ed>3.8.1 - Kind cluster</h1><h2 id=deploy-a-local-kubernetes-cluster-using-kind-and-connect-it-to-azure-arc>Deploy a local Kubernetes Cluster using kind and connect it to Azure Arc</h2><p>The following README will guide you on how to use <a href=https://kind.sigs.k8s.io/>kind</a> to run a Kubernetes cluster locally and connect it as an Azure Arc enabled Kubernetes cluster resource.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/>public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/>Install and Set Up kubectl</a></p></li><li><p><a href=https://helm.sh/docs/intro/install/>Install Helm 3</a></p></li><li><p>Kind leverages Docker to run the Kubernetes nodes. You will need to install Docker locally:</p><ul><li>If you are a Windows user, install <a href=https://www.docker.com/products/docker-desktop>Docker Desktop</a>. You can also use the <a href=https://chocolatey.org/packages/docker-desktop>Chocolatey package</a> to automate the installation.</li><li>If you are a MacOS User, install <a href=https://docs.docker.com/docker-for-mac/>Docker Desktop for Mac</a>.</li><li>If you are a Linux user, use your package manager to install the <a href=https://docs.docker.com/engine/install/>Docker engine</a>.</li></ul></li><li><p>Install the <a href=https://golang.org/dl/>Go programming language</a>.</p></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li><li><p>Install the Azure Arc for Kubernetes CLI extensions <em><strong>connectedk8s</strong></em> and <em><strong>k8sconfiguration</strong></em>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az extension add --name connectedk8s
az extension add --name k8sconfiguration
</code></pre></div><blockquote><p><strong>Note: If you already used this guide before and/or have the extensions installed, use the bellow commands:</strong></p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az extension update --name connectedk8s
az extension update --name k8sconfiguration
</code></pre></div></li></ul><h2 id=deployment>Deployment</h2><ul><li><p>Install kind</p><p>On Linux:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.9.0/kind-linux-amd64
chmod +x ./kind
sudo mv ./kind /usr/local/bin/kind
</code></pre></div><p>On MacOS:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>brew install kind
</code></pre></div><p>On Windows:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000>choco</span> <span style=color:#000>install</span> <span style=color:#000>kind</span>
</code></pre></div><ul><li>Navigate to the folder that has the kind cluster definition.</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>cd</span> azure_arc/azure_arc_k8s_jumpstart/kind
</code></pre></div><ul><li>Create the kind cluster. We are using a configuration file called <code>kind_cluster.yaml</code> to specify our cluster configuration. This will create a 3 node cluster, with 1 master node and 2 worker nodes.</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kind create cluster --config kind_cluster.yaml --name arc-cluster
</code></pre></div><p><img src=./01.png alt="kind create cluster"></p><blockquote><p><strong>Note: By default, kind will store the kubeconfig file used to connect to your cluster in the ~/.kube directory. If you want to use a custom directory to store the kubeconfig file, use the <code>--kube-config</code> flag.</strong></p></blockquote><p>If you did chose a specific location for the cluster&rsquo;s <em>kubeconfig</em> file make sure you are exporting its location as an environment variable using the <code>export KUBECONFIG=kubeconfig location</code> or in Windows, add this location to your PATH.</p></li><li><p>Verify your cluster was created successfully and you can access the cluster using <code>kubectl</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get nodes
</code></pre></div><p><img src=./02.png alt="kubectl get nodes"></p></li></ul><h2 id=connecting-to-azure-arc>Connecting to Azure Arc</h2><ul><li><p>Now that you have a running kind cluster, lets connect the kind cluster to Azure Arc.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login --service-principal -u mySpnClientId -p mySpnClientSecret --tenant myTenantID
</code></pre></div></li><li><p>Create a resource group</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name Arc-kind-Demo -l EastUS -o table
</code></pre></div><blockquote><p><strong>Note: Azure Arc enabled Kubernetes is currently supported in <em>East US</em> and <em>West Europe</em></strong></p></blockquote><p><img src=./03.png alt="Create Azure resource group"></p></li><li><p>Deploy the Arc binaries using Azure CLI:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az connectedk8s connect -n Arc-kind-Demo -g Arc-kind-Demo --tags <span style=color:#4e9a06>&#39;Project=jumpstart_azure_arc_k8s&#39;</span>
</code></pre></div></li><li><p>Upon completion, you will have your kind cluster connected as a new Azure Arc Kubernetes cluster resource in a new resource group.</p><p><img src=./04.png alt="New Azure Arc enabled Kubernetes cluster"></p><p><img src=./05.png alt="New Azure Arc enabled Kubernetes cluster"></p><p><img src=./06.png alt="New Azure Arc enabled Kubernetes cluster"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><ul><li><p>In Azure, the most straightforward way is to delete the cluster or the resource group via the Azure Portal or through the CLI.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group delete --name Arc-kind-Demo
</code></pre></div><p><img src=./07.png alt="Delete the Azure Arc enabled Kubernetes cluster"></p><p><img src=./08.png alt="Delete Azure resource group"></p></li><li><p>To delete the kind cluster locally, use the following command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kind delete cluster --name arc-cluster
</code></pre></div><p><img src=./09.png alt="kind delete cluster"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d7bef51078e0d72deaa1a59c8907857a>3.9 - MicroK8s</h1><div class=lead>If you do not have a Kubernetes cluster, the scenario in this section will guide on creating a MicroK8s Kubernetes cluster on your local machine and onboard it as an Azure Arc enabled Kubernetes cluster in an automated fashion.</div></div><div class=td-content><h1 id=pg-4e867e92b2a5802eefb8ffa06426f985>3.9.1 - MicroK8s cluster</h1><h2 id=deploy-a-local-kubernetes-cluster-using-microk8s-and-connect-it-to-azure-arc>Deploy a local Kubernetes Cluster using MicroK8s and connect it to Azure Arc</h2><p>The following README will guide you on how to use <a href=https://microk8s.io/>MicroK8s</a> to run a Kubernetes cluster locally and connect it as an Azure Arc enabled Kubernetes cluster resource.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled Kubernetes is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/>public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/>Install and Set Up kubectl</a></p></li><li><p><a href=https://helm.sh/docs/intro/install/>Install Helm 3</a></p></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Enable subscription with the two resource providers for Azure Arc enabled Kubernetes. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.Kubernetes
az provider register --namespace Microsoft.KubernetesConfiguration
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.Kubernetes -o table
az provider show -n Microsoft.KubernetesConfiguration -o table
</code></pre></div></li><li><p>Install the Azure Arc for Kubernetes CLI extensions <em><strong>connectedk8s</strong></em> and <em><strong>k8sconfiguration</strong></em>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az extension add --name connectedk8s
az extension add --name k8sconfiguration
</code></pre></div><blockquote><p><strong>Note: If you already used this guide before and/or have the extensions installed, use the bellow commands:</strong></p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az extension update --name connectedk8s
az extension update --name k8sconfiguration
</code></pre></div></li></ul><h2 id=deployment>Deployment</h2><ul><li><p>Install MicroK8s following the <a href=https://microk8s.io/>specific install guide</a> for your operating system. For convenience, we&rsquo;ve added some commands below:</p><p>Windows:</p><p>Download the <a href=https://microk8s.io/docs/install-alternatives#heading--windows>MicroK8s installer for Windows</a> and follow the instructions.</p><p><img src=https://aws1.discourse-cdn.com/business6/uploads/kubernetes/original/2X/c/cc39a370d6a9f62bbcfa0b84ba8356da84a4c8c1.png alt="MicroK8s installer for Windows"></p><p>Once installed, enable MicroK8s with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>microk8s status --wait-ready
microk8s <span style=color:#204a87>enable</span> dns
</code></pre></div><p>Linux:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo snap install microk8s --classic
microk8s status --wait-ready
microk8s <span style=color:#204a87>enable</span> dns
</code></pre></div><p>MacOS:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>brew install ubuntu/microk8s/microk8s
microk8s install
microk8s status --wait-ready
microk8s <span style=color:#204a87>enable</span> dns
</code></pre></div><p><img src=https://assets.ubuntu.com/v1/670398bd-mac1.png alt="brew install microk8s"></p><p>WSL2:</p><p><a href=https://ubuntu.com/blog/kubernetes-on-windows-with-microk8s-and-wsl-2>This blog post</a> walks through an installation of MicroK8s in WSL 2.</p></li><li><p>Export MicroK8s cluster kubeconfig file path</p><p>MicroK8s will not update your .kube/config file, and accessing the cluster is done using the microk8s cli, eg: <code>microk8s kubectl get nodes</code>. To be able to use this config with the Azure Arc CLI, we need to export it into a file.</p><p>Windows:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>microk8s config view &gt; %HOMEPATH%<span style=color:#4e9a06>\.</span>kube<span style=color:#4e9a06>\m</span>icrok8s
</code></pre></div><p>Linux and MacOS:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>microk8s config view &gt; ~/.kube/microk8s
</code></pre></div></li></ul><h2 id=connect-the-cluster-to-azure-arc>Connect the cluster to Azure Arc</h2><ul><li><p>Authenticate Azure CLI</p><p>We&rsquo;ll start by authenticating our CLI with Azure, <strong>replacing the values below</strong> with the output from the command we issued to create service principal earlier (<code>az ad sp create-for-rbac</code>) in the prerequisite section of this guide.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login --service-principal -u appId -p password --tenant tenant
</code></pre></div><p><img src=./01.png alt="Authenticate Azure CLI"></p></li><li><p>Create a resource group</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create -n Arc-MicroK8s-Demo -l EastUS
</code></pre></div><p><img src=./02.png alt="Create new Azure resource group"></p><p><img src=./03.png alt="Create new Azure resource group"></p></li><li><p>Connect the cluster to Azure Arc</p><p>Windows:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az connectedk8s connect --name Arc-MicroK8s-Demo --resource-group Arc-MicroK8s-Demo --kube-config %HOMEPATH%<span style=color:#4e9a06>\.</span>kube<span style=color:#4e9a06>\m</span>icrok8s --kube-context microk8s --tags <span style=color:#4e9a06>&#39;Project=jumpstart_azure_arc_k8s&#39;</span>
</code></pre></div><p>Linux and MacOS:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az connectedk8s connect --name Arc-MicroK8s-Demo --resource-group Arc-MicroK8s-Demo  --kube-config ~/.kube/microk8s --kube-context microk8s --tags <span style=color:#4e9a06>&#39;Project=jumpstart_azure_arc_k8s&#39;</span>
</code></pre></div><p><img src=./04.png alt="New Azure Arc enabled Kubernetes cluster"></p></li><li><p>Upon completion, you will have your MicroK8s cluster connected as a new Azure Arc Kubernetes cluster resource in a new resource group.</p><p><img src=./05.png alt="New Azure Arc enabled Kubernetes cluster"></p><p><img src=./06.png alt="New Azure Arc enabled Kubernetes cluster"></p></li></ul><h2 id=optional---day-2-operations>Optional - Day 2 Operations</h2><p>Now that your Kubernetes cluster is connected to Azure Arc, you might want to explore the following Day 2 scenarios:</p><ul><li><a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/day2/microk8s/local_microk8s_gitops_helm/>Deploy GitOps configurations and perform Helm-based GitOps flow on MicroK8s as an Azure Arc Connected Cluster</a></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><ul><li><p>In Azure, the most straightforward way is to delete the cluster or the resource group via the Azure Portal or through the CLI.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group delete --name Arc-MicroK8s-Demo
</code></pre></div><p><img src=./07.png alt="Delete Azure resource group"></p></li><li><p>To stop the MicroK8s cluster locally, use the following command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>microk8s stop
</code></pre></div></li><li><p>The uninstall process of MicroK8s depends on your operating system.</p><p>Windows</p><p>Stop the MicroK8s VM in Multipass:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>multipass stop microk8s-vm
</code></pre></div><p>Launch <code>Add or Remove Programs</code> and uninstall MicroK8s.</p><p><img src=./08.png alt="Uninstall MicroK8s from Windows"></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>multipass delete microk8s-vm
multipass purge
</code></pre></div><p>If you want to completely uninstall Multipass, launch <code>Add or Remove Programs</code> and uninstall Multipass.</p><p><img src=./09.png alt="Uninstall Multipass from Windows"></p><p>Linux:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo snap remove microk8s
</code></pre></div><p>MacOS:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>brew uninstall ubuntu/microk8s/microk8s
</code></pre></div></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1d0f8542d6157eb9642fa1e8bba23a9d>3.10 - Unified Operations Use Cases</h1><div class=lead>Once you have Kubernetes clusters projected into Azure with Azure Arc, you can start to use native Azure tooling to manage the clusters as native Azure resources. The following scenarios show examples of using Azure management tools such as Azure Monitor, GitOps configurations, and Azure Policy.</div></div><div class=td-content><h1 id=pg-4d3df2981d26d03a22ca357944650885>3.10.1 - AKS</h1></div><div class=td-content><h1 id=pg-44610c6b5316b3f8cd2b84332697b1c4>3.10.1.1 - Deploy GitOps configurations and perform basic GitOps flow on AKS as an Azure Arc Connected Cluster</h1><h2 id=deploy-gitops-configurations-and-perform-basic-gitops-flow-on-aks-as-an-azure-arc-connected-cluster>Deploy GitOps configurations and perform basic GitOps flow on AKS as an Azure Arc Connected Cluster</h2><p>The following README will guide you on how to create GitOps configuration on an Azure Kubernetes Service (AKS) cluster which is projected as an Azure Arc connected cluster resource.</p><p>In this guide, you will deploy & attach GitOps configuration to your cluster which will also include deploying an &ldquo;Hello World&rdquo; Azure Arc web application on your Kubernetes cluster. By doing so, you will be able to make real-time changes to the application and show how the GitOps flow takes effect.</p><blockquote><p><strong>Note: This guide assumes you already deployed an AKS cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using either <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_arm_template/>ARM Template</a> or <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_terraform/>Terraform</a>.</strong></p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p>Fork the <a href=https://github.com/likamrat/hello_arc>&ldquo;Hello Arc&rdquo;</a> demo application repository.</p></li><li><p>(Optional) Install the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. This will help you to show the real-time changes on the application in an automated way.</p><ul><li><p><a href=https://microsoftedge.microsoft.com/addons/detail/odiofbnciojkpogljollobmhplkhmofe>Microsoft Edge</a></p></li><li><p><a href="https://chrome.google.com/webstore/detail/tab-auto-refresh/jaioibhbkffompljnnipmpkeafhpicpd?hl=en">Google Chrome</a></p></li><li><p><a href=https://addons.mozilla.org/en-US/firefox/addon/tab-auto-refresh/>Mozilla Firefox</a></p></li></ul></li><li><p>As mentioned, this guide starts at the point where you already have a connected AKS cluster to Azure Arc.</p><p><img src=./01.png alt="Existing Azure Arc enabled Kubernetes cluster"></p><p><img src=./02.png alt="Existing Azure Arc enabled Kubernetes cluster"></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=azure-arc-kubernetes-gitops-configuration>Azure Arc Kubernetes GitOps Configuration</h2><ul><li><p>In order to keep your local environment clean and untouched, we will use <a href=https://docs.microsoft.com/en-us/azure/cloud-shell/overview>Azure Cloud Shell</a> (located in the top-right corner in the Azure portal) to run the <em>az_k8sconfig_aks</em> shell script against the AKS connected cluster. <strong>Make sure Cloud Shell is configured to use Bash.</strong></p></li><li><p>Edit the environment variables in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/gitops/basic/az_k8sconfig_aks.sh><em>az_k8sconfig_aks</em></a> shell script to match your parameters, upload it to the Cloud Shell environment and run it using the <code>. ./az_k8sconfig_aks.sh</code> command.</p><blockquote><p><strong>Note: The extra dot is due to the script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p></blockquote><p><img src=./03.png alt="Open Azure Cloud Shell"></p><p><img src=./04.png alt="Upload a file to Azure Cloud Shell"></p><p><img src=./05.png alt="Upload a file to Azure Cloud Shell"></p><p><img src=./06.png alt="Upload a file to Azure Cloud Shell"></p><p>The script will:</p><ul><li><p>Login to your Azure subscription using the SPN credentials</p></li><li><p>Retrieve the cluster credentials (KUBECONFIG)</p></li><li><p>Will use Helm to deploy NGINX ingress controller</p></li><li><p>Create the GitOps configurations and deploy the Flux operator and Memcached on the Azure Arc connected cluster</p></li><li><p>Deploy the <a href=https://github.com/likamrat/hello_arc>&ldquo;Hello Arc&rdquo;</a> application along side an Ingress rule to make it available from outside the cluster</p><blockquote><p><strong>Disclaimer: For the purpose of this guide, notice how the &ldquo;<em>git-poll-interval 3s</em>&rdquo; is set. The 3 seconds interval is useful for demo purposes since it will make the git-poll interval to rapidly track changes on the repository but it is recommended to have longer interval in your production environment (default value is 5min)</strong></p></blockquote></li></ul></li><li><p>Once the script will complete it&rsquo;s run, you will have the GitOps configuration created and all the resources deployed in your Kubernetes cluster.</p><blockquote><p><strong>Note: that it takes few min for the configuration change it&rsquo;s Operator state status from &ldquo;Pending&rdquo; to Install.</strong></p></blockquote><p><img src=./07.png alt="New GitOps configurations"></p><p><img src=./08.png alt="New GitOps configurations"></p><p><img src=./09.png alt="New GitOps configurations"></p></li></ul><h2 id=the-hello-arc-application--components>The &ldquo;Hello Arc&rdquo; Application & Components</h2><ul><li><p>Before kicking the GitOps flow, let&rsquo;s verify and zoom-in to the Kubernetes resources deployed by running few <em>kubectl</em> commands.</p><ul><li><p><code>kubectl get pods -n cluster-config</code> - Will show the Flux operator and the Memcached pods.</p><ul><li><code>kubectl get pods -n hello-arc</code> - Will show 3 replicas of the &ldquo;Hello Arc&rdquo; application and the NGINX controller.</li><li><code>kubectl get svc -n hello-arc</code> - Will show NGINX controller Kubernetes Service (Type LoadBalancer).</li><li><code>kubectl get ing -n hello-arc</code> - Will show NGINX rule which will route the traffic to the &ldquo;Hello Arc&rdquo; application from outside the cluster.</li></ul><p><img src=./10.png alt="kubectl get pods -n cluster-config"></p><p><img src=./11.png alt="kubectl get pods -n hello-arc"></p><p><img src=./12.png alt="kubectl get svc -n hello-arc"></p><p><img src=./13.png alt="kubectl get ing -n hello-arc"></p></li></ul></li><li><p>The GitOps flow works as follow:</p><ol><li><p>The Flux operator holds the &ldquo;desired state&rdquo; of the &ldquo;Hello Arc&rdquo; application, this are the configuration we deployed against the Azure Arc connected cluster. The operator &ldquo;polls&rdquo; the state of the of the <a href=https://github.com/likamrat/hello_arc>&ldquo;Hello Arc&rdquo;</a> application repository.</p></li><li><p>Changing the application which is consider to be a new version of it, will trigger the Flux operator to kick-in the GitOps flow.</p></li><li><p>A new Kubernetes pod with the new version of the application will be deployed on the cluster. Once the new pods is successfully deployed, the old one will be terminated (rolling upgrade).</p></li></ol></li><li><p>To show the above flow, open 2 (ideally 3) side-by-side browser windows:</p><ul><li><p>Azure Cloud Shell open running the <code>kubectl get pods -n hello-arc -w</code> command</p><p><img src=./14.png alt="kubectl get pods -n hello-arc -w"></p></li><li><p>Your fork of the &ldquo;Hello Arc&rdquo; application repository. Open the <a href=https://github.com/likamrat/hello_arc/blob/master/yaml/hello_arc.yaml><em>hello_arc.yaml</em></a> file.</p></li><li><p>The external IP address of the Kubernetes Service seen using the <code>kubectl get svc -n hello-arc</code> command.</p><p><img src=./15.png alt="kubectl get svc -n hello-arc"></p></li><li><p>End result should look like that:</p><p><img src=./16.png alt="Side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p></li></ul></li><li><p>As mentioned in the prerequisites section, it is optional but very recommended to configure the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. If you did, in the &ldquo;Hello Arc&rdquo; application window, configure it to refresh every 2 seconds.</p><p><img src=./17.png alt="Tab Auto Refresh"></p></li><li><p>In the repository window showing the <em>hello_arc.yaml</em> file, change the text under &ldquo;MESSAGE&rdquo; section commit the change. Alternatively, you can open the fork repository in your IDE, make the change, commit and push it.</p><p><img src=./18.png alt="Making a change to the &ldquo;MESSAGE&rdquo; section"></p><p><img src=./19.png alt="Making a change to the &ldquo;MESSAGE&rdquo; section and committing"></p></li><li><p>Upon committing the changes, notice how the Kubernetes Pod rolling upgrade starts. Once the Pod is up & running, the new &ldquo;Hello Arc&rdquo; application version window will show the new message, showing the rolling upgrade is completed and the GitOps flow is successful.</p><p><img src=./20.png alt="New Side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c88c142dc87e09357d590b49fc212f80>3.10.1.2 - Deploy GitOps configurations and perform Helm-based GitOps flow on AKS as an Azure Arc Connected Cluster</h1><h2 id=deploy-gitops-configurations-and-perform-helm-based-gitops-flow-on-aks-as-an-azure-arc-connected-cluster>Deploy GitOps configurations and perform Helm-based GitOps flow on AKS as an Azure Arc Connected Cluster</h2><p>The following README will guide you on how to create <a href=https://helm.sh/>Helm</a>-based GitOps configuration on an Azure Kubernetes Service (AKS) cluster which is projected as an Azure Arc connected cluster resource.</p><p>In this guide, you will deploy & attach 2 GitOps configuration to your cluster, a cluster-level config to deploy nginx-ingress controller and a namespace-level config to deploy the &ldquo;Hello Arc&rdquo; web application on your Kubernetes cluster.</p><p>By doing so, you will be able to make real-time changes to the application and show how the GitOps flow takes effect.</p><blockquote><p><strong>Note: This guide assumes you already deployed an AKS cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using either <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_arm_template/>ARM Template</a> or <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_terraform/>Terraform</a>.</strong></p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p>Fork/Clone the <a href=https://github.com/likamrat/hello_arc>&ldquo;Hello Arc&rdquo;</a> demo application repository.</p></li><li><p>(Optional) Install the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. This will help you to show the real-time changes on the application in an automated way.</p><ul><li><p><a href=https://microsoftedge.microsoft.com/addons/detail/odiofbnciojkpogljollobmhplkhmofe>Microsoft Edge</a></p></li><li><p><a href="https://chrome.google.com/webstore/detail/tab-auto-refresh/jaioibhbkffompljnnipmpkeafhpicpd?hl=en">Google Chrome</a></p></li><li><p><a href=https://addons.mozilla.org/en-US/firefox/addon/tab-auto-refresh/>Mozilla Firefox</a></p></li></ul></li><li><p>As mentioned, this guide starts at the point where you already have a connected AKS cluster to Azure Arc.</p><p><img src=./01.png alt="Existing Azure Arc enabled Kubernetes cluster"></p><p><img src=./02.png alt="Existing Azure Arc enabled Kubernetes cluster"></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=cluster-level-config-vs-namespace-level-config>Cluster-level Config vs. Namespace-level Config</h2><h3 id=cluster-level-config>Cluster-level Config</h3><p>With Cluster-level GitOps config, the goal is to have an &ldquo;horizontal components&rdquo; or &ldquo;management components&rdquo; deployed on your Kubernetes cluster which will then be used by your applications. Good examples are Service Meshes, Security products, Monitoring solutions, etc. A very popular example will also be Ingress Controller which is exactly the nginx-ingress controller we will deploy in the next section.</p><h3 id=namespace-level-config>Namespace-level Config</h3><p>With Namespace-level GitOps config, the goal is to have Kubernetes resources deployed only in the namespace selected. The most obvious use-case here is simply your application and it&rsquo;s respective pods, services, ingress routes, etc. In the next section will have the &ldquo;Hello Arc&rdquo; application deployed on a dedicated namespace.</p><h2 id=azure-arc-kubernetes-gitops-configuration-with-helm>Azure Arc Kubernetes GitOps Configuration with Helm</h2><h3 id=the-mechanism-in-a-nutshell>The Mechanism (In a nutshell)</h3><p>In the process of creating Azure Arc GitOps configuration, <a href=https://github.com/fluxcd/flux>Weaveworks Flux Kubernetes Operator</a> is deployed on the cluster.</p><p>The Operator is aware of the &ldquo;HelmRelease&rdquo; Custom Resource Definition (CRD). This HelmRelease points to a helm chart in a git repo and can optionally contain specific values to input into the helm chart. Due to this configuration, a user can choose to leave the chart values intact or to have different values for different releases.</p><p>For example, an application (captured in an Helm chart) dev release can have no pod replication (single pod) while a production release, using the same chart can have 3 pod replicas.</p><p>In the next section will use the &ldquo;Hello Arc&rdquo; Helm chart to deploy a production release which we will then change and see the results in real-time.</p><h3 id=deployment-flow>Deployment Flow</h3><p>For our scenario, notice we have in two Helm charts in the &ldquo;Hello Arc&rdquo; repository; one for nginx and one for the actual application as well as an Helm Release for each.</p><p><img src=./03.png alt="&ldquo;Hello Arc&rdquo; GitHub repository"></p><p><img src=./04.png alt="&ldquo;Hello Arc&rdquo; GitHub repository"></p><ul><li><p>The nginx-ingress controller (a Cluster-level component) will be deployed with 3 replicas to the <em>cluster-mgmt</em> namespace.</p></li><li><p>The &ldquo;Hello Arc&rdquo; application (a Namespace-level component) will be deployed with 1 replica to the <em>prod</em> namespace.</p></li></ul><h2 id=deployment>Deployment</h2><ul><li><p>In order to keep your local environment clean and untouched, we will use <a href=https://docs.microsoft.com/en-us/azure/cloud-shell/overview>Azure Cloud Shell</a> (located in the top-right corner in the Azure portal) to run the <em>az_k8sconfig_helm_aks</em> shell script against the AKS connected cluster. <strong>Make sure Cloud Shell is configured to use Bash.</strong></p></li><li><p>Edit the environment variables in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/gitops/helm/az_k8sconfig_helm_aks.sh><em>az_k8sconfig_helm_aks</em></a> shell script to match your parameters, upload it to the Cloud Shell environment and run it using the <code>. ./az_k8sconfig_helm_aks</code> command.</p><blockquote><p><strong>Note: The extra dot is due to the script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p></blockquote><p><img src=./03.png alt="Open Azure Cloud Shell"></p><p><img src=./04.png alt="Upload a file to Azure Cloud Shell"></p><p><img src=./05.png alt="Upload a file to Azure Cloud Shell"></p><p><img src=./06.png alt="Upload a file to Azure Cloud Shell"></p><p>The script will:</p><ul><li><p>Login to your Azure subscription using the SPN credentials</p></li><li><p>Retrieve the cluster credentials (KUBECONFIG)</p></li><li><p>Create two GitOps configurations for the Azure Arc Connected Cluster. Both configurations will be using the Helm charts located in the &ldquo;Hello Arc&rdquo; repository.</p></li><li><p>Cluster-level config to deploy nginx-ingress controller Helm chart</p></li><li><p>Namespace-level config to deploy the &ldquo;Hello Arc&rdquo; application Helm chart</p><blockquote><p><strong>Disclaimer: For the purpose of this guide, notice how the &ldquo;<em>git-poll-interval 3s</em>&rdquo; is set. The 3 seconds interval is useful for demo purposes since it will make the git-poll interval to rapidly track changes on the repository but it is recommended to have longer interval in your production environment (default value is 5min)</strong></p></blockquote></li></ul></li><li><p>Once the script will complete it&rsquo;s run, you will have 2 GitOps configuration created and all the resources deployed in your Kubernetes cluster. <strong>Note:</strong> that it takes few min for the configuration change it&rsquo;s Operator state status from &ldquo;Pending&rdquo; to Install.</p><p><img src=./09.png alt="New GitOps configurations"></p><p><img src=./10.png alt="New GitOps configurations"></p><p><img src=./11.png alt="New GitOps configurations"></p><p><img src=./12.png alt="New GitOps configurations"></p></li><li><p>The Cluster-level config initiated the nginx-ingress Pods and Service resource deployment (along with the Flux operator and Memcached). To see it&rsquo;s resource, use the below <em>kubectl</em> commands.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get pods -n cluster-mgmt
kubectl get svc -n cluster-mgmt
</code></pre></div><p><img src=./13.png alt="nginx-ingress Pods and Service resource"></p></li><li><p>The Namespace-level config initiated the &ldquo;Hello Arc&rdquo; Pod (1 replica), Service and Ingress Route resource deployment.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get pods -n prod
kubectl get svc -n prod
kubectl get ing -n prod
</code></pre></div><p><img src=./14.png alt="Hello Arc" pod, service and ingress route resource"></p></li></ul><h2 id=initiating-hello-arc-application-gitops>Initiating &ldquo;Hello Arc&rdquo; Application GitOps</h2><ul><li><p>The GitOps flow works as follow:</p><ol><li><p>The Flux operator holds the &ldquo;desired state&rdquo; for both the nginx-ingress and the &ldquo;Hello Arc&rdquo; Helm releases, this are the configuration we deployed against the Azure Arc connected cluster. The operator will pull every 3 seconds the state of the releases in the repository.</p></li><li><p>Changing the application release will trigger the Flux operator to kick-in the GitOps flow.</p></li><li><p>A new version of the application will be deployed on the cluster with more replicas as configured. Once the new pods is successfully deployed, the old ones will be terminated (rolling upgrade).</p></li></ol></li><li><p>To show the above flow, open 2 (ideally 3) side-by-side browser windows:</p><ul><li><p>Azure Cloud Shell open running the <code>kubectl get pods -n prod -w</code></p><p><img src=./15.png alt="kubectl get pods -n prod -w"></p></li><li><p>In your own repository fork, open the &ldquo;Hello Arc&rdquo; <a href=https://github.com/likamrat/hello_arc/blob/master/releases/prod/hello-arc.yaml><em>hello-arc.yaml</em></a> Helm release file.</p></li><li><p>The external IP address of the Kubernetes Service seen using the <code>kubectl get svc -n hello-arc</code> command.</p><p><img src=./16.png alt="kubectl get svc -n hello-arc"></p></li><li><p>End result should look like that:</p><p><img src=./17.png alt="Side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p></li></ul></li><li><p>As mentioned in the prerequisites section, it is optional but very recommended to configure the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. If you did, in the &ldquo;Hello Arc&rdquo; application window, configure it to refresh every 2 seconds.</p><p><img src=./18.png alt="Tab Auto Refresh"></p></li><li><p>In the repository window showing the <em>hello-arc.yaml</em> file, change the number of <em>replicaCount</em> to 3 as well as the the message text and commit your changes. Alternatively, you can open the forked repository in your IDE, make the change, commit and push it.</p><p><img src=./19.png alt="Making a change to the replica count and the &ldquo;MESSAGE&rdquo; section"></p></li><li><p>Upon committing the changes, notice how the rolling upgrade starts. Once the Pods are up & running, the new &ldquo;Hello Arc&rdquo; application version window will show the new messages as well as the additional pods replicas, showing the rolling upgrade is completed and the GitOps flow is successful.</p><p><img src=./20.png alt="&ldquo;Hello Arc&rdquo; rolling upgrade"></p><p><img src=./21.png alt="&ldquo;Hello Arc&rdquo; rolling upgrade"></p><p><img src=./22.png alt="New side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p></li></ul><h2 id=cleanup>Cleanup</h2><p>To delete the GitOps configuration and it&rsquo;s respective Kubernetes resources, edit the environment variables to match the Azure Arc Kubernetes cluster and Resources in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/gitops/helm/az_k8sconfig_helm_cleanup.sh>az_k8sconfig_helm_cleanup</a> script, upload it to Cloud Shell and run it using the <code>. ./az_k8sconfig_helm_cleanup.sh</code> command.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cdb23c16630e70509b44b66208dbc024>3.10.1.3 - Integrate Azure Monitor for Containers with AKS as an Azure Arc Connected Cluster</h1><h2 id=integrate-azure-monitor-for-containers-with-aks-as-an-azure-arc-connected-cluster>Integrate Azure Monitor for Containers with AKS as an Azure Arc Connected Cluster</h2><p>The following README will guide you on how to onboard an Azure Kubernetes Service (AKS) cluster which is projected an Azure Arc connected cluster resource on to <a href=https://docs.microsoft.com/en-us/azure/azure-monitor/insights/container-insights-overview>Azure Monitor for Containers</a>.</p><p>In this guide, you will hook the AKS cluster to Azure Monitor by deploying the <a href=https://docs.microsoft.com/en-us/azure/azure-monitor/platform/log-analytics-agent>OMS agent</a> on your Kubernetes cluster to start collecting telemetry.</p><blockquote><p><strong>Note: This guide assumes you already deployed an AKS cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using either <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_arm_template/>ARM Template</a> or <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_terraform/>Terraform</a>.</strong></p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=azure-monitor-for-containers-integration>Azure Monitor for Containers Integration</h2><ul><li><p>In order to keep your local environment clean and untouched, we will use <a href=https://docs.microsoft.com/en-us/azure/cloud-shell/overview>Azure Cloud Shell</a> (located in the top-right corner in the Azure portal) to run the <em>aks_monitor_onboarding</em> script against the AKS connected cluster. For your convenient, both shell and PowerShell scripts are <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_k8s_jumpstart/aks/azure_monitor>provided</a>.</p></li><li><p>Before integrating the cluster with Azure Monitor for Containers, click on the &ldquo;Insights (preview)&rdquo; blade for the connected Arc cluster to show how the cluster is not currently being monitored.</p><p><img src=./01.png alt="An existing Azure Arc enabled Kubernetes cluster"></p><p><img src=./02.png alt="An existing Azure Arc enabled Kubernetes cluster with no Azure Monitor integration"></p></li><li><p>Edit the environment variables in either of the scripts to match your environment parameters, upload it to the Cloud Shell environment and run it using the <code>. ./aks_monitor_onboarding.sh</code> (Bash) or <code>./aks_monitor_onboarding.ps1</code> (PowerShell) command.</p><blockquote><p><strong>Note: The extra dot is due to the shell script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p></blockquote><p><img src=./03.png alt="Open Azure Cloud Shell"></p><p><img src=./04.png alt="Upload a file to Azure Cloud Shell"></p><p><img src=./05.png alt="Upload a file to Azure Cloud Shell"></p><p><img src=./06.png alt="Upload a file to Azure Cloud Shell"></p><p><img src=./07.png alt="Upload a file to Azure Cloud Shell"></p><p>The script will:</p><ul><li>Login to your Azure subscription using the SPN credentials</li><li>Download the OMS script</li><li>Retrieve the Azure Arc Connected Cluster Azure Resource ID as well as the cluster credentials (KUBECONFIG)</li><li>Execute the script which will create Azure Log Analytics workspace, deploy the OMS agent on the Kubernetes cluster and tag the cluster</li><li>Delete the downloaded script</li></ul></li><li><p>Once the script will complete it&rsquo;s run, you will have an Azure Arc connected cluster integrated with Azure Monitor for Containers. At the end of it&rsquo;s run, the script generates URL for you to click on. This URL will open a new browser tab leading to the Azure Monitor for Containers Insights page.</p><blockquote><p><strong>Note: As the OMS start collecting telemetry from the cluster nodes and pods, it will take 5-10min for data to start show up in the Azure Portal.</strong></p></blockquote><p><img src=./08.png alt="Installing the OMS agent on the cluster"></p><p><img src=./09.png alt="Installing the OMS agent on the cluster"></p></li><li><p>Click the &ldquo;Connected Clusters&rdquo; tab and see the Azure Arc connected cluster was added. Now that your cluster is being monitored, navigate trough the different tabs and sections and watch the monitoring telemetry for the cluster nodes and pods.</p><p><img src=./10.png alt="Agent install on the cluster"></p><p><img src=./11.png alt="New Azure Monitor telemetry"></p><p><img src=./12.png alt="New Azure Monitor telemetry"></p><p><img src=./13.png alt="New Azure Monitor telemetry"></p><p><img src=./14.png alt="New Azure Monitor telemetry"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-0ab2c80854e6dbba2714dfe7f5623dd0>3.10.1.4 - Apply GitOps configurations on AKS as an Azure Arc Connected Cluster using Azure Policy for Kubernetes</h1><h2 id=apply-gitops-configurations-on-aks-as-an-azure-arc-connected-cluster-using-azure-policy-for-kubernetes>Apply GitOps configurations on AKS as an Azure Arc Connected Cluster using Azure Policy for Kubernetes</h2><p>The following README will guide you on how to enable <a href="https://docs.microsoft.com/en-us/azure/governance/policy/concepts/policy-for-kubernetes#:~:text=Azure%20Policy%20extends%20Gatekeeper%20v3,Kubernetes%20clusters%20from%20one%20place.">Azure Policy for Kubernetes</a> on an Azure Kubernetes Service (AKS) cluster that is projected as an Azure Arc connected cluster as well as how to create GitOps policy to apply on the cluster.</p><blockquote><p><strong>Note: This guide assumes you already deployed an AKS cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using either <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_arm_template/>ARM Template</a> or <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_terraform/>Terraform</a>.</strong></p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p>Fork the <a href=https://github.com/likamrat/hello_arc>&ldquo;Hello Arc&rdquo;</a> demo application repository.</p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>As mentioned, this guide starts at the point where you already have a connected AKS cluster to Azure Arc.</p><p><img src=./01.png alt="Existing AKS Azure Arc connected cluster"></p><p><img src=./02.png alt="Existing AKS Azure Arc connected cluster"></p></li><li><p>Before installing the Azure Policy Add-on or enabling any of the service features, your subscription must enable the Microsoft.PolicyInsights resource provider and create a role assignment for the cluster service principal. To do that, open <a href=https://shell.azure.com/>Azure Cloud Shell</a> and run either the Azure CLI or Azure PowerShell command.</p><p><img src=./03.png alt="Open Azure Cloud Shell"></p><p>Azure CLI:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace <span style=color:#4e9a06>&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div><p>Azure PowerShell:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#204a87>Register-AzResourceProvider</span> <span style=color:#000>-ProviderNamespace</span> <span style=color:#4e9a06>&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div><p>To verify successful registration, run either the below Azure CLI or Azure PowerShell command.</p><p>Azure CLI:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show --namespace <span style=color:#4e9a06>&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div><p>Azure PowerShell:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#204a87>Get-AzResourceProvider</span> <span style=color:#000>-ProviderNamespace</span> <span style=color:#4e9a06>&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div><p><img src=./04.png alt="AzResourceProvider Bash"></p><p><img src=./05.png alt="AzResourceProvider PowerShell"></p></li><li><p>Create Azure service principal (SP)</p><blockquote><p><strong>Note: This guide assumes you will be working with a service principal assigned with the &lsquo;Contributor&rsquo; role as described below. If you want to further limit the RBAC scope of your service Principal, you can assign it with the &lsquo;Policy Insights Data Writer (Preview)&rsquo; role the Azure Arc enabled Kubernetes cluster as described <a href=https://github.com/MicrosoftDocs/azure-docs/edit/master/articles/governance/policy/concepts/policy-for-kubernetes#L247-L275>here</a>.</strong></p></blockquote><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in Azure Cloud Shell).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=azure-policy-for-azure-arc-connected-cluster-integration>Azure Policy for Azure Arc Connected Cluster Integration</h2><ul><li><p>In order to keep your local environment clean and untouched, we will use <a href=https://docs.microsoft.com/en-us/azure/cloud-shell/overview>Azure Cloud Shell</a> (located in the top-right corner in the Azure portal) to run the <em>aks_policy_onboarding</em> script against the AKS connected cluster. For your convenient, shell script is <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/aks/azure_policy/aks_policy_onboarding.sh>provided to you</a>.</p></li><li><p>Edit the environment variables in the script to match your environment parameters, upload it to the Cloud Shell environment and run it using the <code>. ./aks_policy_onboarding.sh</code> command. <strong>If you decided to use the &lsquo;Policy Insights Data Writer (Preview)&rsquo; role assignment as described in the perquisites section, make sure to use it&rsquo;s respective <em>appId</em>, <em>password</em> and <em>tenantId</em></strong></p><blockquote><p><strong>Note: The extra dot is due to the shell script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p></blockquote><p><img src=./06.png alt="Upload onboarding script"></p><p><img src=./07.png alt="Upload onboarding script"></p><p><img src=./08.png alt="Upload onboarding script"></p></li></ul><p>The script will:</p><ul><li>Login to your Azure subscription using the SPN credentials</li><li>Install NGINX Ingress Controller</li><li>Retrieve the Azure Arc Connected Cluster Azure Resource ID</li><li>Install the &lsquo;azure-policy-addon&rsquo; helm chart & Gatekeeper</li></ul><p>After few seconds, by running the the <code>kubectl get pods -A</code> command, you will notice all pods have been deployed.</p><p><img src=./09.png alt="Showing pods deployment"></p><h2 id=deploy-gitops-to-azure-arc-kubernetes-cluster-using-azure-policy>Deploy GitOps to Azure Arc Kubernetes cluster using Azure Policy</h2><p>Although you can <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/day2/aks/aks_gitops_helm/>deploy GitOps configuration individually</a> on each of your Azure Arc connected clusters, Azure Policy for Kubernetes allows to do the same on a broader scope (i.e subscription or resource group). That way, you can guarantee existing and newly added Azure Arc connected clusters to all have the same GitOps configuration and as a result, the same cluster baseline and/or application version deployed.</p><ul><li><p>Before assigning the policy, in the Azure portal, click the <em>Configuration</em> setting in your AKS connected cluster. Notice how no GitOps configurations are deployed.</p><p><img src=./10.png alt="Empty GitOps configurations"></p></li><li><p>In the Search bar, look for <em>Policy</em> and click on <em>Definitions</em> which will show you all of the available Azure policies.</p><p><img src=./11.png alt="Searching for Azure Policy definitions"></p><p><img src=./12.png alt="Searching for Azure Policy definitions"></p></li><li><p>The &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; policy is part of the Kubernetes policies. Once you filter to find these, click on the policy and the &lsquo;Assign&rsquo; button.</p><p><img src=./13.png alt="GitOps to Kubernetes cluster Azure policy"></p><p><img src=./14.png alt="GitOps to Kubernetes cluster Azure policy"></p></li><li><p>In the below example, the scope of the policy represent the resource group where the AKS connected cluster Azure Arc resource is located. Alternatively, the scope could have been the entire Azure subscription or a resource group with many Azure Arc connected clusters. Also, make sure <em>Policy enforcement</em> is set to <em>Enabled</em>.</p><p>For this GitOps configuration policy, we will be using the <a href=https://github.com/likamrat/hello_arc>&ldquo;Hello Arc&rdquo;</a> application repository which includes the Kubernetes Service for external access, Deployment as well as the ingress rule to be used by the NGINX ingress controller.</p><p><img src=./15.png alt="Assigning Azure policy"></p><p><img src=./16.png alt="Assigning Azure policy"></p><p><img src=./17.png alt="Assigning Azure policy"></p><p><img src=./18.png alt="Assigning Azure policy"></p><p><img src=./19.png alt="Assigning Azure policy"></p></li><li><p>Once the policy configuration deployed, after ~15-25min, the policy remediation task will start the evaluation against the Kubernetes cluster, recognize it as &ldquo;Non-compliant&rdquo; (since it&rsquo;s still does note have the GitOps configuration deployed) and lastly, after the configuration has been deployed the policy will move to a &ldquo;Compliant&rdquo; state. To check this, go back to the main Policy page in the Azure portal.</p><blockquote><p><strong>Note: The process of evaluation all the way to the point that the GitOps configuration is deployed against the cluster can take ~15-30min.</strong></p></blockquote><p><img src=./20.png alt="Azure policy evaluation"></p><p><img src=./21.png alt="Azure policy evaluation"></p><p><img src=./22.png alt="Azure policy evaluation"></p><p><img src=./23.png alt="Azure policy evaluation"></p><p><img src=./24.png alt="Azure policy evaluation"></p></li></ul><h2 id=verify-gitops-configuration--app-deployment>Verify GitOps Configuration & App Deployment</h2><ul><li><p>Now that the policy is in compliant state, let&rsquo;s first verify the GitOps configurations. In the Azure portal click the AKS connected Azure Arc cluster and open the Configurations settings.</p><p><img src=./25.png alt="Successful GitOps config deployment"></p><p><img src=./26.png alt="Successful GitOps config deployment"></p><p><img src=./27.png alt="Successful GitOps config deployment"></p></li><li><p>In order to verify the &ldquo;Hello Arc&rdquo; application and it&rsquo;s component has been deployed, In the Azure Cloud Shell, run the below commands.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get pods -n hello-arc
kubectl get ing -n hello-arc
kubectl get svc -n hello-arc
</code></pre></div><p>You can see how the Flux GitOps operator, Memcached, the &ldquo;Hello Arc&rdquo; application and the ingress rule now deployed on the cluster as well the Service with an external IP.</p><p><img src=./28.png alt="&ldquo;Hello Arc&rdquo; Kubernetes pods"></p></li><li><p>Copy the Service external IP and paste in your browser.</p><p><img src=./29.png alt="&ldquo;Hello Arc&rdquo; application deployed"></p></li></ul><h2 id=clean-up-environment>Clean up environment</h2><p>Complete the following steps to clean up your environment.</p><ul><li><p>Delete the AKS cluster as described in the <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_arm_template/>ARM Template teardown instructions</a> or the <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/aks/aks_terraform/>Terraform teardown instructions</a>.</p></li><li><p>From the Policy page in the Azure portal, remove the &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; policy assignment from the cluster.</p><p><img src=./30.png alt="Delete Azure Policy assignment"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ecb095d0322798ee5c46b4a8223b12cf>3.10.2 - GKE</h1></div><div class=td-content><h1 id=pg-d457b58c7bf722d2347deaef42e48f9f>3.10.2.1 - Deploy GitOps configurations and perform basic GitOps flow on GKE as an Azure Arc Connected Cluster</h1><h2 id=deploy-gitops-configurations-and-perform-basic-gitops-flow-on-gke-as-an-azure-arc-connected-cluster>Deploy GitOps configurations and perform basic GitOps flow on GKE as an Azure Arc Connected Cluster</h2><p>The following README will guide you on how to create GitOps configuration on a Google Kubernetes Engine (GKE) cluster which is projected as an Azure Arc connected cluster resource.</p><p>In this guide, you will deploy & attach GitOps configuration to your cluster which will also include deploying an &ldquo;Hello World&rdquo; Azure Arc web application on your Kubernetes cluster. By doing so, you will be able to make real-time changes to the application and show how the GitOps flow takes effect.</p><p><strong>Note: This guide assumes you already deployed a GKE cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/gke/gke_terraform/>Terraform</a>.</strong></p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p>Clone the <a href=https://github.com/likamrat/hello_arc>&ldquo;Hello Arc&rdquo;</a> demo application repository.</p></li><li><p>(Optional) Install the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. This will help you to show the real-time changes on the application in an automated way.</p><ul><li><p><a href=https://microsoftedge.microsoft.com/addons/detail/odiofbnciojkpogljollobmhplkhmofe>Microsoft Edge</a></p></li><li><p><a href="https://chrome.google.com/webstore/detail/tab-auto-refresh/jaioibhbkffompljnnipmpkeafhpicpd?hl=en">Google Chrome</a></p></li><li><p><a href=https://addons.mozilla.org/en-US/firefox/addon/tab-auto-refresh/>Mozilla Firefox</a></p></li></ul></li><li><p>As mentioned, this guide starts at the point where you already have a connected GKE cluster to Azure Arc.</p><p><img src=./01.png alt="Existing Azure Arc enabled Kubernetes cluster"></p><p><img src=./02.png alt="Existing Azure Arc enabled Kubernetes cluster"></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=azure-arc-kubernetes-gitops-configuration>Azure Arc Kubernetes GitOps Configuration</h2><ul><li><p>In order to keep your local environment clean and untouched, we will use <a href=https://cloud.google.com/shell>Google Cloud Shell</a> to run the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/gitops/basic/az_k8sconfig_gke.sh><em>az_k8sconfig_gke</em></a> shell script against the GKE connected cluster.</p></li><li><p>Edit the environment variables in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/gitops/basic/az_k8sconfig_gke.sh><em>az_k8sconfig_gke</em></a> shell script to match your parameters, upload it to the Cloud Shell environment and run it using the <code>. ./az_k8sconfig_gke.sh</code> command.</p><blockquote><p><strong>Note: The extra dot is due to the script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p></blockquote><p><img src=./03.png alt="Open Google Cloud Shell session and authenticate against the GKE cluster"></p><p><img src=./04.png alt="Open Google Cloud Shell session and authenticate against the GKE cluster"></p><p><img src=./05.png alt="Upload a file to Cloud Shell"></p><p><img src=./06.png alt="Upload a file to Cloud Shell"></p><p><img src=./07.png alt="Upload a file to Cloud Shell"></p><p>The script will:</p><ul><li><p>Login to your Azure subscription using the SPN credentials</p></li><li><p>Retrieve the cluster credentials (KUBECONFIG)</p></li><li><p>Will use Helm to deploy NGINX ingress controller</p></li><li><p>Create the GitOps configurations and deploy the Flux operator and Memcached on the Azure Arc connected cluster</p></li><li><p>Deploy the <a href=https://github.com/likamrat/hello_arc>&ldquo;Hello Arc&rdquo;</a> application along side an Ingress rule to make it available from outside the cluster</p><blockquote><p><strong>Disclaimer: For the purpose of this guide, notice how the &ldquo;<em>git-poll-interval 3s</em>&rdquo; is set. The 3 seconds interval is useful for demo purposes since it will make the git-poll interval to rapidly track changes on the repository but it is recommended to have longer interval in your production environment (default value is 5min)</strong></p></blockquote></li></ul></li><li><p>Once the script will complete it&rsquo;s run, you will have the GitOps configuration created all the resources deployed in your Kubernetes cluster. Note that it takes few min for the configuration change it&rsquo;s Operator state status from &ldquo;Pending&rdquo; to Install.</p><p><img src=./08.png alt="New GitOps configuration"></p><p><img src=./09.png alt="New GitOps configuration"></p></li></ul><h2 id=the-hello-arc-application--components>The &ldquo;Hello Arc&rdquo; Application & Components</h2><ul><li><p>Before kicking the GitOps flow, let&rsquo;s verify and zoom-in to the Kubernetes resources deployed by running few <em>kubectl</em> commands.</p><p><code>kubectl get pods -n cluster-config</code> - Will show the Flux operator and the Memcached pods.</p><p><code>kubectl get pods -n hello-arc</code> - Will show 3 replicas of the &ldquo;Hello Arc&rdquo; application and the NGINX controller.</p><p><code>kubectl get svc -n hello-arc</code> - Will show NGINX controller Kubernetes Service (Type LoadBalancer).</p><p><code>kubectl get ing -n hello-arc</code> - Will show NGINX rule which will route the traffic to the &ldquo;Hello Arc&rdquo; application from outside the cluster.</p><p><img src=./10.png alt="kubectl get pods -n cluster-config"></p><p><img src=./11.png alt="kubectl get pods -n hello-arc"></p><p><img src=./12.png alt="kubectl get svc -n hello-arc"></p><p><img src=./13.png alt="kubectl get ing -n hello-arc"></p></li><li><p>The GitOps flow works as follow:</p><ol><li><p>The Flux operator holds the &ldquo;desired state&rdquo; of the &ldquo;Hello Arc&rdquo; application, this are the configuration we deployed against the Azure Arc connected cluster. The operator &ldquo;polls&rdquo; the state of the of the <a href=https://github.com/likamrat/hello_arc>&ldquo;Hello Arc&rdquo;</a> application repository.</p></li><li><p>Changing the application which is consider to be a new version of it, will trigger the Flux operator to kick-in the GitOps flow.</p></li><li><p>A new Kubernetes pod with the new version of the application will be deployed on the cluster. Once the new pods is successfully deployed, the old one will be terminated (rolling upgrade).</p></li></ol></li><li><p>To show the above flow, open 2 (ideally 3) side-by-side browser windows:</p><ul><li><p>Google Cloud Shell open running the <code>kubectl get pods -n hello-arc -w</code></p><p><img src=./14.png alt="kubectl get pods -n hello-arc -w"></p></li><li><p>Your clone of the &ldquo;Hello Arc&rdquo; application repository. Open the <a href=https://github.com/likamrat/hello_arc/blob/master/yaml/hello_arc.yaml><em>hello_arc.yaml</em></a> file.</p></li><li><p>The external IP address of the Kubernetes Service seen using the <code>kubectl get svc -n hello-arc</code> command.</p><p><img src=./15.png alt="kubectl get svc -n hello-arc"></p></li><li><p>End result should look like that:</p><p><img src=./16.png alt="Side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p></li></ul></li><li><p>As mentioned in the prerequisites section, it is optional but very recommended to configure the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. If you did, in the &ldquo;Hello Arc&rdquo; application window, configure it to refresh every 2 seconds.</p><p><img src=./17.png alt="Tab Auto Refresh"></p></li><li><p>In the repository window showing the <em>hello_arc.yaml</em> file, change the text under &ldquo;MESSAGE&rdquo; section commit the change. Alternatively, you can open the clone repository in your IDE, make the change, commit and push it.</p><p><img src=./18.png alt="Making a change to the replica count and the &ldquo;MESSAGE&rdquo; section"></p><p><img src=./19.png alt="Making a change to the replica count and the &ldquo;MESSAGE&rdquo; section"></p></li><li><p>Upon committing the changes, notice how the Kubernetes Pod rolling upgrade starts. Once the Pod is up & running, the new &ldquo;Hello Arc&rdquo; application version window will show the new message, showing the rolling upgrade is completed and the GitOps flow is successful.</p><p><img src=./20.png alt="New side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-185c98c7d0c0e36f4297a126b0d881f3>3.10.2.2 - Deploy GitOps configurations and perform Helm-based GitOps flow on GKE as an Azure Arc Connected Cluster</h1><h2 id=deploy-gitops-configurations-and-perform-helm-based-gitops-flow-on-gke-as-an-azure-arc-connected-cluster>Deploy GitOps configurations and perform Helm-based GitOps flow on GKE as an Azure Arc Connected Cluster</h2><p>The following README will guide you on how to create <a href=https://helm.sh/>Helm</a>-based GitOps configuration on a Google Kubernetes Engine (GKE) cluster which is projected as an Azure Arc connected cluster resource.</p><p>In this guide, you will deploy & attach 2 GitOps configuration to your cluster, a cluster-level config to deploy nginx-ingress controller and a namespace-level config to deploy the &ldquo;Hello Arc&rdquo; web application on your Kubernetes cluster.</p><p>By doing so, you will be able to make real-time changes to the application and show how the GitOps flow takes effect.</p><p><strong>Note: This guide assumes you already deployed a GKE cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/gke/gke_terraform/>Terraform</a>.</strong></p><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p>Fork/Clone the <a href=https://github.com/likamrat/hello_arc>&ldquo;Hello Arc&rdquo;</a> demo application repository.</p></li><li><p>(Optional) Install the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. This will help you to show the real-time changes on the application in an automated way.</p><ul><li><p><a href=https://microsoftedge.microsoft.com/addons/detail/odiofbnciojkpogljollobmhplkhmofe>Microsoft Edge</a></p></li><li><p><a href="https://chrome.google.com/webstore/detail/tab-auto-refresh/jaioibhbkffompljnnipmpkeafhpicpd?hl=en">Google Chrome</a></p></li><li><p><a href=https://addons.mozilla.org/en-US/firefox/addon/tab-auto-refresh/>Mozilla Firefox</a></p></li></ul></li><li><p>As mentioned, this guide starts at the point where you already have a connected GKE cluster to Azure Arc.</p><p><img src=./01.png alt="Existing Azure Arc enabled Kubernetes cluster"></p><p><img src=./02.png alt="Existing Azure Arc enabled Kubernetes cluster"></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=cluster-level-config-vs-namespace-level-config>Cluster-level Config vs. Namespace-level Config</h2><h3 id=cluster-level-config>Cluster-level Config</h3><p>With Cluster-level GitOps config, the goal is to have an &ldquo;horizontal components&rdquo; or &ldquo;management components&rdquo; deployed on your Kubernetes cluster which will then be used by your applications. Good examples are Service Meshes, Security products, Monitoring solutions, etc. A very popular example will also be Ingress Controller which is exactly the nginx-ingress controller we will deploy in the next section.</p><h3 id=namespace-level-config>Namespace-level Config</h3><p>With Namespace-level GitOps config, the goal is to have Kubernetes resources deployed only in the namespace selected. The most obvious use-case here is simply your application and it&rsquo;s respective pods, services, ingress routes, etc. In the next section will have the &ldquo;Hello Arc&rdquo; application deployed on a dedicated namespace.</p><h2 id=azure-arc-kubernetes-gitops-configuration-with-helm>Azure Arc Kubernetes GitOps Configuration with Helm</h2><h2 id=the-mechanism-in-a-nutshell>The Mechanism (In a nutshell)</h2><p>In the process of creating Azure Arc GitOps configuration, <a href=https://github.com/fluxcd/flux>Weaveworks Flux Kubernetes Operator</a> is deployed on the cluster.</p><p>The Operator is aware of the &ldquo;HelmRelease&rdquo; Custom Resource Definition (CRD). This HelmRelease points to a helm chart in a git repo and can optionally contain specific values to input into the helm chart. Due to this configuration, a user can choose to leave the chart values intact or to have different values for different releases.</p><p>For example, an application (captured in an Helm chart) dev release can have no pod replication (single pod) while a production release, using the same chart can have 3 pod replicas.</p><p>In the next section will use the &ldquo;Hello Arc&rdquo; Helm chart to deploy a production release which we will then change and see the results in real-time.</p><h3 id=deployment-flow>Deployment Flow</h3><p>For our scenario, notice we have in two Helm charts in the &ldquo;Hello Arc&rdquo; repository; one for nginx and one for the actual application as well as an Helm Release for each.</p><p><img src=./03.png alt="&ldquo;Hello Arc&rdquo; GitHub repository"></p><p><img src=./04.png alt="&ldquo;Hello Arc&rdquo; GitHub repository"></p><ul><li><p>The nginx-ingress controller (a Cluster-level component) will be deployed with 3 replicas to the <em>cluster-mgmt</em> namespace.</p></li><li><p>The &ldquo;Hello Arc&rdquo; application (a Namespace-level component) will be deployed with 1 replica to the <em>prod</em> namespace.</p></li></ul><h3 id=deployment>Deployment</h3><ul><li><p>In order to keep your local environment clean and untouched, we will use <a href=https://cloud.google.com/shell>Google Cloud Shell</a> to run the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/gitops/helm/az_k8sconfig_helm_gke.sh><em>az_k8sconfig_helm_gke</em></a> shell script against the GKE connected cluster.</p></li><li><p>Edit the environment variables in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/gitops/helm/az_k8sconfig_helm_gke.sh><em>az_k8sconfig_helm_gke</em></a> shell script to match your parameters, upload it to the Cloud Shell environment and run it using the <code>. ./az_k8sconfig_helm_gke</code> command.</p><blockquote><p><strong>Note: The extra dot is due to the script has an <em>export</em> function and needs to have the variables exported in the same shell session as the rest of the commands.</strong></p></blockquote><p><img src=./05.png alt="Export environment variables"></p><p><img src=./06.png alt="Open Google Cloud Shell session and authenticate against the GKE cluster"></p><p><img src=./07.png alt="Open Google Cloud Shell session and authenticate against the GKE cluster"></p><p><img src=./08.png alt="Upload a file to Cloud Shell"></p><p><img src=./09.png alt="Upload a file to Cloud Shell"></p><p><img src=./10.png alt="Upload a file to Cloud Shell"></p><p>The script will:</p><ul><li><p>Install Helm 3 in Google Cloud Shell</p></li><li><p>Install Azure CLI & Azure Arc extensions</p></li><li><p>Login to your Azure subscription using the SPN credentials</p></li><li><p>Create two GitOps configurations for the Azure Arc Connected Cluster. Both configurations will be using the Helm charts located in the &ldquo;Hello Arc&rdquo; repository.</p></li><li><p>Cluster-level config to deploy nginx-ingress controller Helm chart</p></li><li><p>Namespace-level config to deploy the &ldquo;Hello Arc&rdquo; application Helm chart</p><blockquote><p><strong>Disclaimer: For the purpose of this guide, notice how the &ldquo;<em>git-poll-interval 3s</em>&rdquo; is set. The 3 seconds interval is useful for demo purposes since it will make the git-poll interval to rapidly track changes on the repository but it is recommended to have longer interval in your production environment (default value is 5min)</strong></p></blockquote></li></ul></li><li><p>Once the script will complete it&rsquo;s run, you will have 2 GitOps configuration created and all the resources deployed in your Kubernetes cluster.</p><blockquote><p><strong>Note: that it takes few min for the configuration change it&rsquo;s Operator state status from &ldquo;Pending&rdquo; to Install.</strong></p></blockquote><p><img src=./11.png alt="Cluster-level GitOps configurations"></p><p><img src=./12.png alt="Namespace-level GitOps configurations"></p><p><img src=./13.png alt="Azure Arc enabled Kubernetes GitOps configurations"></p><p><img src=./14.png alt="New GitOps configurations in Azure portal"></p><p>The Cluster-level config initiated the nginx-ingress Pods and Service resource deployment (along with the Flux operator and Memcached). To see it&rsquo;s resource, use the below <em>kubectl</em> commands.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get pods -n cluster-mgmt
kubectl get svc -n cluster-mgmt
</code></pre></div><p><img src=./15.png alt="cluster-mgmt namespace resources"></p><p>The Namespace-level config initiated the &ldquo;Hello Arc&rdquo; Pod (1 replica), Service and Ingress Route resource deployment.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get pods -n prod
kubectl get svc -n prod
kubectl get ing -n prod
</code></pre></div><p><img src=./16.png alt="prod namespace resources"></p></li></ul><h2 id=initiating-hello-arc-application-gitops>Initiating &ldquo;Hello Arc&rdquo; Application GitOps</h2><ul><li><p>The GitOps flow works as follow:</p><ol><li><p>The Flux operator holds the &ldquo;desired state&rdquo; for both the nginx-ingress and the &ldquo;Hello Arc&rdquo; Helm releases, this are the configuration we deployed against the Azure Arc connected cluster. The operator will pull every 3 seconds the state of the releases in the repository.</p></li><li><p>Changing the application release will trigger the Flux operator to kick-in the GitOps flow.</p></li><li><p>A new version of the application will be deployed on the cluster with more replicas as configured. Once the new pods is successfully deployed, the old ones will be terminated (rolling upgrade).</p></li></ol></li><li><p>To show the above flow, open 2 (ideally 3) side-by-side browser windows:</p><ul><li><p>Google Cloud Shell open running the <code>kubectl get pods -n prod -w</code></p><p><img src=./17.png alt="kubectl get pods -n prod -w"></p></li><li><p>In your own repository fork, open the &ldquo;Hello Arc&rdquo; <a href=https://github.com/likamrat/hello_arc/blob/master/releases/prod/hello-arc.yaml><em>hello-arc.yaml</em></a> Helm release file.</p></li><li><p>The external IP address of the Kubernetes Service seen using the <code>kubectl get svc -n prod</code> command.</p><p><img src=./18.png alt="kubectl get svc -n prod"></p></li><li><p>End result should look like that:</p><p><img src=./19.png alt="Side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p></li></ul></li><li><p>As mentioned in the prerequisites section, it is optional but very recommended to configure the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. If you did, in the &ldquo;Hello Arc&rdquo; application window, configure it to refresh every 2 seconds.</p><p><img src=./20.png alt="Tab Auto Refresh"></p></li><li><p>In the repository window showing the <em>hello-arc.yaml</em> file, change the number of <em>replicaCount</em> to 3 as well as the the message text and commit your changes. Alternatively, you can open the forked repository in your IDE, make the change, commit and push it.</p><p><img src=./21.png alt="Making a change to the replica count and the &ldquo;MESSAGE&rdquo; section"></p></li><li><p>Upon committing the changes, notice how the rolling upgrade starts. Once the Pods are up & running, the new &ldquo;Hello Arc&rdquo; application version window will show the new messages as well as the additional pods replicas, showing the rolling upgrade is completed and the GitOps flow is successful.</p><p><img src=./22.png alt="&ldquo;Hello Arc&rdquo; rolling upgrade"></p><p><img src=./23.png alt="New side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p><p><img src=./24.png alt="New pods deployed"></p></li></ul><h2 id=cleanup>Cleanup</h2><p>To delete the GitOps configuration and it&rsquo;s respective Kubernetes resources, edit the environment variables to match the Azure Arc Kubernetes cluster and Resources in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/gitops/helm/az_k8sconfig_helm_cleanup.sh>az_k8sconfig_helm_cleanup</a> shell script, upload it to Cloud Shell and run it using the <code>. ./az_k8sconfig_helm_cleanup.sh</code> command.</p><p><img src=./25.png alt="Edit environment variables"></p><p><img src=./26.png alt="GitOps configuration deleted"></p><p><img src=./27.png alt="Empty GitOps configuration"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-de11c18b0e8549b41c0a88fa1af98a22>3.10.2.3 - Integrate Azure Monitor for Containers with GKE as an Azure Arc Connected Cluster</h1><h2 id=integrate-azure-monitor-for-containers-with-gke-as-an-azure-arc-connected-cluster>Integrate Azure Monitor for Containers with GKE as an Azure Arc Connected Cluster</h2><p>The following README will guide you on how to enable <a href=https://docs.microsoft.com/en-us/azure/azure-monitor/insights/container-insights-overview>Azure Monitor for Containers</a> for a Google Kubernetes Engine (GKE) cluster that is projected as an Azure Arc connected cluster.</p><p>In this guide, you will hook the GKE cluster to Azure Monitor by deploying the <a href=https://docs.microsoft.com/en-us/azure/azure-monitor/platform/log-analytics-agent>OMS agent</a> on your Kubernetes cluster in order to start collecting telemetry.</p><blockquote><p><strong>Note: This guide assumes you already deployed a GKE cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/docs/gke_terraform.md>Terraform</a>.</strong></p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=azure-monitor-for-containers-integration>Azure Monitor for Containers Integration</h2><ul><li><p>In order to keep your local environment clean and untouched, we will use <a href=https://cloud.google.com/shell>Google Cloud Shell</a> to run the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/gke_monitor/gke_monitor_onboarding.sh><em>gke_monitor_onboarding</em></a> shell script against the GKE connected cluster.</p></li><li><p>Before integrating the cluster with Azure Monitor for Containers, click on the &ldquo;Insights (preview)&rdquo; blade for the connected Arc cluster to show how the cluster is not currently being monitored.</p><p><img src=./01.png alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource"></p><p><img src=./02.png alt="Screenshot showing Azure Portal with Azure Arc enabled Kubernetes resource Insights"></p></li><li><p>Edit the environment variables in the script to match your environment parameters, upload it to the Cloud Shell environment and run it using the <code>. ./gke_monitor_onboarding.sh</code> command.</p><blockquote><p><strong>Note: The extra dot is due to the shell script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</strong></p></blockquote><p><img src=./03.png alt="Screenshot showing GKE cluster in GCP console"></p><p><img src=./04.png alt="Screenshot showing connection to GKE cluster in GCP console"></p><p><img src=./05.png alt="Screenshot showing GKE cluster in GCP console"></p><p><img src=./06.png alt="Screenshot showing GKE cluster in GCP console"></p><p><img src=./07.png alt="Screenshot showing GKE cluster in GCP console"></p><p>The script will:</p><ul><li>Login to your Azure subscription using the SPN credentials</li><li>Download the OMS script</li><li>Retrieve cluster Azure resource ID as well as the cluster credentials (KUBECONFIG)</li><li>Execute the script which will create Azure Log Analytics workspace, deploy the OMS agent on the Kubernetes cluster and tag the cluster</li><li>Delete the downloaded script</li></ul></li><li><p>Once the script will complete it&rsquo;s run, you will have an Azure Arc connected cluster integrated with Azure Monitor for Containers. At the end of it&rsquo;s run, the script generates URL for you to click on. This URL will open a new browser tab leading to the Azure Monitor for Containers Insights page.a</p><blockquote><p><strong>Note: As the OMS start collecting telemetry from the cluster nodes and pods, it will take 5-10min for data to start show up in the Azure Portal.</strong></p></blockquote><p><img src=./08.png alt="Screenshot showing script being run"></p><p><img src=./09.png alt="Screenshot showing deployment"></p></li><li><p>Click the &ldquo;Connected Clusters&rdquo; tab and see the Azure Arc connected cluster was added. Now that your cluster is being monitored, navigate trough the different tabs and sections and watch the monitoring telemetry for the cluster nodes and pods.</p><p><img src=./10.png alt="Screenshot showing Azure Portal with connected cluster detail"></p><p><img src=./11.png alt="Screenshot showing Azure Portal with connected cluster detail"></p><p><img src=./12.png alt="Screenshot showing Azure Portal with connected cluster detail"></p><p><img src=./13.png alt="Screenshot showing Azure Portal with connected cluster detail"></p><p><img src=./14.png alt="Screenshot showing Azure Portal with connected cluster detail"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-aff3a2239473fef2a378434ef6640e2c>3.10.2.4 - Apply GitOps configurations on GKE as an Azure Arc Connected Cluster using Azure Policy for Kubernetes</h1><h2 id=apply-gitops-configurations-on-gke-as-an-azure-arc-connected-cluster-using-azure-policy-for-kubernetes>Apply GitOps configurations on GKE as an Azure Arc Connected Cluster using Azure Policy for Kubernetes</h2><p>The following README will guide you on how to enable <a href="https://docs.microsoft.com/en-us/azure/governance/policy/concepts/policy-for-kubernetes#:~:text=Azure%20Policy%20extends%20Gatekeeper%20v3,Kubernetes%20clusters%20from%20one%20place.">Azure Policy for Kubernetes</a> on a Google Kubernetes Engine (GKE) cluster that is projected as an Azure Arc connected cluster as well as how to create GitOps policy to apply on the cluster.</p><blockquote><p><strong>Note: This guide assumes you already deployed a GKE cluster and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in an automated fashion using <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/gke/gke_terraform/>Terraform</a>.</strong></p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>As mentioned, this guide starts at the point where you already have a connected GKE cluster to Azure Arc.</p><p><img src=./01.png alt="Existing GKE Azure Arc enabled Kubernetes cluster"></p><p><img src=./02.png alt="Existing GKE Azure Arc enabled Kubernetes cluster"></p></li><li><p>Before installing the Azure Policy addon or enabling any of the service features, your subscription must enable the Microsoft.PolicyInsights resource provider and create a role assignment for the cluster service principal. To do that, open <a href=https://shell.azure.com/>Azure Cloud Shell</a> and run either the Azure CLI or Azure PowerShell command.</p><p><img src=./03.png alt="Azure Cloud Shell"></p><p>Azure CLI:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace <span style=color:#4e9a06>&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div><p>PowerShell:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#204a87>Register-AzResourceProvider</span> <span style=color:#000>-ProviderNamespace</span> <span style=color:#4e9a06>&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div></li><li><p>To verify successful registration, run either the below Azure CLI or Azure PowerShell command.</p><p>Azure CLI:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show --namespace <span style=color:#4e9a06>&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div><p>PowerShell:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#204a87>Get-AzResourceProvider</span> <span style=color:#000>-ProviderNamespace</span> <span style=color:#4e9a06>&#39;Microsoft.PolicyInsights&#39;</span>
</code></pre></div><p><img src=./04.png alt="Installing the Azure Policy addon resource provider"></p><p><img src=./05.png alt="Installing the Azure Policy addon resource provider"></p></li><li><p>Create Azure service principal (SP)</p><blockquote><p><strong>Note: This guide assumes you will be working with a service principal assigned with the &lsquo;Contributor&rsquo; role as described below. If you want to further limit the RBAC scope of your service Principal, you can assign it with the &lsquo;Policy Insights Data Writer (Preview)&rsquo; role the Azure Arc enabled Kubernetes cluster as described <a href=https://github.com/MicrosoftDocs/azure-docs/blob/master/articles/governance/policy/concepts/policy-for-kubernetes.md#install-azure-policy-add-on-for-azure-arc-enabled-kubernetes-preview>here</a>.</strong></p></blockquote></li><li><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in Azure Cloud Shell).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p><strong>Note</strong>: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></p></li></ul><h2 id=azure-policy-for-azure-arc-connected-cluster-integration>Azure Policy for Azure Arc Connected Cluster Integration</h2><ul><li><p>In order to keep your local environment clean and untouched, we will use <a href=https://cloud.google.com/shell>Google Cloud Shell</a> to run the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/gke/azure_policy/gke_policy_onboarding.sh><em>gke_policy_onboarding</em></a> shell script against the GKE connected cluster.</p></li><li><p>Edit the environment variables in the script to match your environment parameters, upload it to the Cloud Shell environment and run it using the <code>. ./gke_policy_onboarding.sh</code> command. <strong>If you decided to use the &lsquo;Policy Insights Data Writer (Preview)&rsquo; role assignment as described in the perquisites section, make sure to use it&rsquo;s respective <em>appId</em>, <em>password</em> and <em>tenantId</em></strong>.</p><p><strong>Note</strong>: The extra dot is due to the shell script has an <em>export</em> function and needs to have the vars exported in the same shell session as the rest of the commands.</p><p><img src=./06.png alt="Run GCP Cloud Shell"></p><p><img src=./07.png alt="Run GCP Cloud Shell"></p><p><img src=./08.png alt="Upload a file to GCP Cloud Shell"></p><p><img src=./09.png alt="Upload a file to GCP Cloud Shell"></p><p><img src=./10.png alt="Upload a file to GCP Cloud Shell"></p><p>The script will:</p><ul><li><p>Install Helm 3 & Azure CLI</p></li><li><p>Install NGINX Ingress Controller</p></li><li><p>Login to your Azure subscription using the SPN credentials</p></li><li><p>Retrieve cluster Azure Resource ID</p></li><li><p>Install the &lsquo;azure-policy-addon&rsquo; helm chart & Gatekeeper</p><p>After few seconds, by running the the <code>kubectl get pods -A</code> command, you will notice all pods have been deployed.</p><p><img src=./11.png alt="kubectl get pods"></p></li></ul></li></ul><h2 id=deploy-gitops-to-azure-arc-kubernetes-cluster-using-azure-policy>Deploy GitOps to Azure Arc Kubernetes cluster using Azure Policy</h2><p>Although you can <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/day2/gke/gke_gitops_basic/>deploy GitOps configuration individually</a> on each of your Azure Arc connected clusters, Azure Policy for Kubernetes allows to do the same on a broader scope (i.e Subscription or resource group). That way, you can guarantee existing and newly added Azure Arc connected clusters to all have the same GitOps configuration and as a result, the same cluster baseline and/or application version deployed.</p><ul><li><p>Before assigning the policy, in the Azure portal, click the <em>Configuration</em> setting in your GKE connected cluster. Notice how no GitOps configurations are deployed.</p><p><img src=./12.png alt="No GitOps configurations"></p></li><li><p>In the Search bar, look for <em>Policy</em> and click on <em>Definitions</em> which will show you all of the available Azure policies.</p><p><img src=./13.png alt="Search for Azure Policy Definitions in the Azure portal"></p><p><img src=./14.png alt="Search for Azure Policy Definitions in the Azure portal"></p></li><li><p>The &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; policy is part of the Kubernetes policies. Once you filter to find these, click on the policy and the &lsquo;Assign&rsquo; button.</p><p><img src=./15.png alt="Azure Policy in the Azure portal"></p><p><img src=./16.png alt="Azure Policy definitions in the Azure portal"></p></li><li><p>In the below example, the scope of the policy represent the resource group where the GKE connected cluster Azure Arc resource is located. Alternatively, the scope could have been the entire Azure subscription or a resource group with many Azure Arc connected clusters. Also, make sure <em>Policy enforcement</em> is set to <em>Enabled</em>.</p><p>For this GitOps configuration policy, we will be using the <a href=https://github.com/likamrat/hello_arc>&ldquo;Hello Arc&rdquo;</a> application repository which includes the Kubernetes Service for external access, Deployment as well as the ingress rule to be used by the NGINX ingress controller.</p><p><img src=./17.png alt="Assign the &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; Azure Policy"></p><p><img src=./18.png alt="Assign the &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; Azure Policy"></p><p><img src=./19.png alt="Assign the &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; Azure Policy"></p><p><img src=./20.png alt="Assign the &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; Azure Policy"></p></li><li><p>Once the policy configuration deployed, after ~10-20min, the policy remediation task will start the evaluation against the Kubernetes cluster, recognize it as &ldquo;Non-compliant&rdquo; (since it&rsquo;s still does note have the GitOps configuration deployed) and lastly, after the configuration has been deployed the policy will move to a &ldquo;Compliant&rdquo; state. To check this, go back to the main Policy page in the Azure portal.</p><blockquote><p><strong>Note: The process of evaluation all the way to the point that the GitOps configuration is deployed against the cluster can take ~15-30min.</strong></p></blockquote><p><img src=./21.png alt="Verifying Azure Policy status and compliance state"></p><p><img src=./22.png alt="Verifying Azure Policy status and compliance state"></p><p><img src=./23.png alt="Verifying Azure Policy status and compliance state"></p><p><img src=./24.png alt="Verifying Azure Policy status and compliance state"></p><p><img src=./25.png alt="Verifying Azure Policy status and compliance state"></p></li></ul><h2 id=verify-gitops-configuration--app-deployment>Verify GitOps Configuration & App Deployment</h2><ul><li><p>Now that the policy is in compliant state, let&rsquo;s first verify the GitOps configurations. In the Azure portal click the GKE connected Azure Arc cluster and open the Configurations settings.</p><p><img src=./26.png alt="Newly created GitOps configurations"></p><p><img src=./27.png alt="Newly created GitOps configurations"></p><p><img src=./28.png alt="Newly created GitOps configurations"></p></li><li><p>In order to verify the &ldquo;Hello Arc&rdquo; application and it&rsquo;s component has been deployed, In the Google Cloud Shell, run the below commands.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get pods -n hello-arc
kubectl get ing -n hello-arc
kubectl get svc -n hello-arc
</code></pre></div><p>You can see how the Flux GitOps operator, Memcached, the &ldquo;Hello Arc&rdquo; application and the ingress rule now deployed on the cluster as well the Kubernetes service with an external IP.</p><p><img src=./29.png alt="Running kubectl commands to verifying successful deployment"></p></li><li><p>Copy the Service external IP and paste in your browser to see the deployed &ldquo;Hello Arc&rdquo; application.</p><p><img src=./30.png alt="Deployed &ldquo;Hello Arc&rdquo; application"></p></li></ul><h2 id=clean-up-environment>Clean up environment</h2><p>Complete the following steps to clean up your environment.</p><ul><li><p>Delete the GKE cluster as described in the <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/gke/gke_terraform/>teardown instructions</a>.</p></li><li><p>From the Policy page in the Azure portal, remove the &ldquo;[Preview]: Deploy GitOps to Kubernetes cluster&rdquo; policy assignment from the cluster.</p><p><img src=./31.png alt="Delete Azure Policy assignment"></p><p><img src=./32.png alt="Delete Azure Policy assignment"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-35f95ff005abe064acf384005986b669>3.10.3 - Kind</h1></div><div class=td-content><h1 id=pg-37841f0de5e94de64c5a1f739f9f2f89>3.10.3.1 - Deploy GitOps configurations and perform Helm-based GitOps flow on kind as an Azure Arc Connected Cluster</h1><h2 id=deploy-gitops-configurations-and-perform-helm-based-gitops-flow-on-kind-as-an-azure-arc-connected-cluster>Deploy GitOps configurations and perform Helm-based GitOps flow on kind as an Azure Arc Connected Cluster</h2><p>The following README will guide you on how to create <a href=https://helm.sh/>Helm</a>-based GitOps configuration on a <a href=https://kind.sigs.k8s.io/>kind (Kubernetes in Docker)</a> cluster which is projected as an Azure Arc connected cluster resource.</p><p>In this guide, you will first deploy a nginx ingress controller to your cluster. Then you will deploy & attach a GitOps configuration to your cluster. This will be a namespace-level config to deploy the &ldquo;Hello Arc&rdquo; web application on your Kubernetes cluster.</p><p>By doing so, you will be able to make real-time changes to the application and show how the GitOps flow takes effect.</p><blockquote><p><strong>Note: This guide assumes you already deployed a kind and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in the <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/kind/local_kind/>kind onboarding guide</a>.</strong></p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p>Fork/Clone the <a href=https://github.com/likamrat/hello_arc>&ldquo;Hello Arc&rdquo;</a> demo application repository.</p></li><li><p>(Optional) Install the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. This will help you to show the real-time changes on the application in an automated way.</p><ul><li><p><a href=https://microsoftedge.microsoft.com/addons/detail/odiofbnciojkpogljollobmhplkhmofe>Microsoft Edge</a></p></li><li><p><a href="https://chrome.google.com/webstore/detail/tab-auto-refresh/jaioibhbkffompljnnipmpkeafhpicpd?hl=en">Google Chrome</a></p></li><li><p><a href=https://addons.mozilla.org/en-US/firefox/addon/tab-auto-refresh/>Mozilla Firefox</a></p></li></ul></li><li><p>As mentioned, this guide starts at the point where you already have a connected kind cluster to Azure Arc.</p><p><img src=./01.png alt="Existing Azure Arc enabled Kubernetes cluster"></p><p><img src=./02.png alt="Existing Azure Arc enabled Kubernetes cluster"></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li></ul><h2 id=manually-setting-up-an-ingress-controller-on-kind>Manually setting up an ingress controller on kind</h2><p>The demo application that will be deployed later in this guide relies on an ingress controller. For ingress controllers to work on kind, a specific configuration of the ingress needs to be deployed. For more information related to this, please refer to the <a href=https://kind.sigs.k8s.io/docs/user/ingress/>kind documentation</a>.</p><h2 id=nginx-controller-deployment>NGINX Controller Deployment</h2><ul><li><p>Run the following command to install the nginx ingress controller on kind:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/kind/deploy.yaml
</code></pre></div></li><li><p>This command will create a new namespace and deploy the required components in this namespace. To verify the deployment of the ingress controller was successful, make sure the pod with name <code>ingress-nginx-controller-&lt;random id>-&lt;random id></code> is in a running state with 1/1 containers ready:</p><p><img src=./03.png alt="Running ingress nginx controller"></p></li><li><p>Finally, test that the ingress is responding to traffic. To test this, either browse to <a href=http://localhost>http://localhost</a> or use the command line to connect to <code>localhost</code>. You should get a HTTP 404 response with a nginx footer. This shows that the ingress is working. The 404 response is to be expected since you haven&rsquo;t setup an ingress route yet. You will do that in the next section.</p><p><img src=./04.png alt="HTTP 404 response in a web browser"></p><p><img src=./05.png alt="HTTP 404 response in a terminal"></p></li></ul><h2 id=cluster-level-config-vs-namespace-level-config>Cluster-level Config vs. Namespace-level Config</h2><h3 id=cluster-level-config>Cluster-level Config</h3><p>With Cluster-level GitOps config, the goal is to have &ldquo;horizontal components&rdquo; or &ldquo;management components&rdquo; deployed on your Kubernetes cluster which will then be used by your applications. Good examples are Service Meshes, Security products, Monitoring solutions, etc.</p><blockquote><p><strong>Note: You will not be creating a cluster-level config in this guide. For an example of a cluster-level configuration please refer to either the <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/day2/aks/aks_gitops_helm/>Helm-based GitOps on AKS scenario</a> or the <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/day2/gke/gke_gitops_helm/>GKE one</a>.</strong></p></blockquote><h3 id=namespace-level-config>Namespace-level Config</h3><p>With Namespace-level GitOps config, the goal is to have Kubernetes resources deployed only in the namespace selected. The most obvious use-case here is simply your application and its respective pods, services, ingress routes, etc. In the next section will have the &ldquo;Hello Arc&rdquo; application deployed on a dedicated namespace.</p><h2 id=azure-arc-kubernetes-gitops-configuration-with-helm>Azure Arc Kubernetes GitOps Configuration with Helm</h2><h3 id=the-mechanism-in-a-nutshell>The Mechanism (In a nutshell)</h3><p>In the process of creating Azure Arc enabled Kubernetes GitOps configuration, <a href=https://github.com/fluxcd/flux>Weaveworks Flux Kubernetes Operator</a> is deployed on the cluster.</p><p>The Operator is aware of the &ldquo;HelmRelease&rdquo; Custom Resource Definition (CRD). This HelmRelease points to a helm chart in a git repo and can optionally contain specific values to input into the helm chart. Due to this configuration, a user can choose to leave the chart values intact or to have different values for different releases.</p><p>For example, an application (captured in an Helm chart) dev release can have no pod replication (single pod) while a production release, using the same chart can have 3 pod replicas.</p><p>In the next section will use the &ldquo;Hello Arc&rdquo; Helm chart to deploy a production release which we will then change and see the results in real-time.</p><h3 id=deployment-flow>Deployment Flow</h3><p>For our scenario, we will deploy the &ldquo;Hello Arc&rdquo; application from the <a href=https://github.com/likamrat/hello_arc>&ldquo;demo repository&rdquo;</a> through GitOps. We will deploy the &ldquo;Hello Arc&rdquo; application (a Namespace-level component) with 1 replica to the <em>prod</em> namespace.</p><p><img src=./06.png alt="&ldquo;Hello Arc&rdquo; application GitHub repository"></p><p><img src=./07.png alt="&ldquo;Hello Arc&rdquo; application GitHub repository"></p><h3 id=deployment>Deployment</h3><ul><li><p>Edit the environment variables in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/kind/gitops/helm/az_k8sconfig_helm_kind.sh><em>az_k8sconfig_helm_kind</em></a> shell script to match your parameters, and run it using the <code>. az_k8sconfig_helm_kind.sh</code> command.</p><blockquote><p><strong>Note: The extra dot is due to the script having an <em>export</em> function and that needs to have the vars exported in the same shell session as the rest of the commands.</strong></p></blockquote><p>The <code>az_k8sconfig_helm_kind.sh</code> script will:</p><ul><li><p>Login to your Azure subscription using the SPN credentials.</p></li><li><p>Create the GitOps configurations for the Azure Arc Connected Cluster. The configuration will be using the Helm chart located in the &ldquo;Hello Arc&rdquo; repository. This will create a namespace-level config to deploy the &ldquo;Hello Arc&rdquo; application Helm chart.</p><blockquote><p><strong>Disclaimer: For the purpose of this guide, notice how the &ldquo;<em>git-poll-interval 3s</em>&rdquo; is set. The 3 seconds interval is useful for demo purposes since it will make the git-poll interval to rapidly track changes on the repository but it is recommended to have longer interval in your production environment (default value is 5min)</strong></p></blockquote></li></ul></li><li><p>Once the script will complete its run, you will have the GitOps configuration created and all the resources deployed in your local kind Kubernetes cluster.</p><blockquote><p><strong>Note: it can take a few minutes for the configuration to change its Operator state status from &ldquo;Pending&rdquo; to &ldquo;Installed&rdquo;.</strong></p></blockquote><p><img src=./08.png alt="New GitOps configuration created"></p><p><img src=./09.png alt="New GitOps configuration created"></p></li><li><p>The Namespace-level config initiated the &ldquo;Hello Arc&rdquo; Pod (1 replica), Service and Ingress Route resource deployment.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get pods -n prod
kubectl get svc -n prod
kubectl get ing -n prod
</code></pre></div><p><img src=./10.png alt="&ldquo;Hello Arc&rdquo; application deployed"></p></li></ul><h2 id=initiating-hello-arc-application-gitops>Initiating &ldquo;Hello Arc&rdquo; Application GitOps</h2><ul><li><p>The GitOps flow works as follow:</p><ol><li><p>The Flux operator holds the &ldquo;desired state&rdquo; of the &ldquo;Hello Arc&rdquo; Helm release. This is the configuration we deployed against the Azure Arc connected cluster. The operator will pull the state of the releases in the repository every 3 seconds.</p></li><li><p>Changing the application release will trigger the Flux operator to kick-in the GitOps flow. In our case, we will be changing the welcome message and the amount of replicas.</p></li><li><p>A new version of the application will be deployed on the cluster with more replicas as configured. Once the new pods are successfully deployed, the old ones will be terminated (rolling upgrade).</p></li></ol></li><li><p>To show the above flow, open 2 (ideally 3) side-by-side windows:</p><ul><li><p>Local shell running <code>kubectl get pods -n prod -w</code></p><p><img src=./11.png alt="&lsquo;kubectl get pods&rsquo; command"></p></li><li><p>In your own repository fork, open the &ldquo;Hello Arc&rdquo; <a href=https://github.com/likamrat/hello_arc/blob/master/releases/prod/hello-arc.yaml><em>hello-arc.yaml</em></a> Helm release file.</p></li><li><p>Another browser window that has the webpage <a href=http://localhost>http://localhost</a> open</p></li><li><p>End result should look like this:</p><p><img src=./12.png alt="Side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p></li></ul></li><li><p>As mentioned in the prerequisites section, it is optional but very recommended to configure the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. If you did, in the &ldquo;Hello Arc&rdquo; application window, configure it to refresh every 2 seconds.</p><p><img src=./13.png alt="&ldquo;Tab Auto Refresh&rdquo; extension"></p></li><li><p>In the repository window showing the <em>hello-arc.yaml</em> file, change the number of <em>replicaCount</em> to 3 as well as the the message text and commit your changes. Alternatively, you can open the forked repository in your IDE, make the change, commit and push it.</p><p><img src=./14.png alt="hello-arc.yaml file"></p></li><li><p>Upon committing the changes, notice how the rolling upgrade starts. Once the Pods are up & running, the new &ldquo;Hello Arc&rdquo; application version window will show the new messages as well as the additional pods replicas, showing the rolling upgrade is completed and the GitOps flow is successful.</p><p><img src=./15.png alt="&ldquo;Hello Arc&rdquo; application rolling upgrade in terminal"></p><p><img src=./16.png alt="&ldquo;Hello Arc&rdquo; application rolling upgrade in terminal"></p><p><img src=./17.png alt="New side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the new application version open in a web browser"></p></li></ul><h2 id=cleanup>Cleanup</h2><ul><li><p>To delete the GitOps configuration and it&rsquo;s respective Kubernetes resources, edit the environment variables to match the Azure Arc Kubernetes cluster and Resources in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/kind/gitops/helm/az_k8sconfig_helm_cleanup_kind.sh>az_k8sconfig_helm_cleanup_kind</a> shell script.It is recommended to run this script locally, since it also removes elements from the local cluster.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>. ./az_k8sconfig_helm_cleanup_kind.sh
</code></pre></div><p><img src=./18.png alt="Cleanup script in terminal"></p></li><li><p>If you also wish to remove the local kind cluster and the Arc connected cluster from Azure, you can run the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kind delete cluster --name &lt;cluster-name&gt;
az group delete -n &lt;resource group name&gt;
</code></pre></div></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-38c8e0744fcb743de272a63e7e6783d7>3.10.4 - Microk8s</h1></div><div class=td-content><h1 id=pg-149a30bbf147076ee35e812c981993fb>3.10.4.1 - Deploy GitOps configurations and perform Helm-based GitOps flow on MicroK8s as an Azure Arc Connected Cluster</h1><h2 id=deploy-gitops-configurations-and-perform-helm-based-gitops-flow-on-microk8s-as-an-azure-arc-connected-cluster>Deploy GitOps configurations and perform Helm-based GitOps flow on MicroK8s as an Azure Arc Connected Cluster</h2><p>The following README will guide you on how to create <a href=https://helm.sh/>Helm</a>-based GitOps configuration on a <a href=https://microk8s.io/>MicroK8s</a> cluster which is projected as an Azure Arc connected cluster resource.</p><p>In this guide, you will first deploy a nginx ingress controller to your cluster. Then you will deploy & attach a GitOps configuration to your cluster. This will be a namespace-level config to deploy the &ldquo;Hello Arc&rdquo; web application on your Kubernetes cluster.</p><p>By doing so, you will be able to make real-time changes to the application and show how the GitOps flow takes effect.</p><blockquote><p><strong>Note: This guide assumes you already deployed MicroK8s and connected it to Azure Arc. If you haven&rsquo;t, this repository offers you a way to do so in the <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/microk8s/local_microk8s/>MicroK8s onboarding guide</a>.</strong></p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p>Fork/Clone the <a href=https://github.com/likamrat/hello_arc>&ldquo;Hello Arc&rdquo;</a> demo application repository.</p></li><li><p>(Optional) Install the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. This will help you to show the real-time changes on the application in an automated way.</p><ul><li><p><a href=https://microsoftedge.microsoft.com/addons/detail/odiofbnciojkpogljollobmhplkhmofe>Microsoft Edge</a></p></li><li><p><a href="https://chrome.google.com/webstore/detail/tab-auto-refresh/jaioibhbkffompljnnipmpkeafhpicpd?hl=en">Google Chrome</a></p></li><li><p><a href=https://addons.mozilla.org/en-US/firefox/addon/tab-auto-refresh/>Mozilla Firefox</a></p></li></ul></li><li><p>As mentioned, this guide starts at the point where you already have a connected MicroK8s cluster to Azure Arc.</p><p><img src=./01.png alt="Existing Azure Arc enabled Kubernetes cluster"></p><p><img src=./02.png alt="Existing Azure Arc enabled Kubernetes cluster"></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Export MicroK8s config</p><p>You can export MicroK8s cluster config to a file and use <code>kubectl</code> directly instead of <code>microk8s kubectl</code> command.</p><ul><li><p>Windows</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>microk8s config view &gt; %HOMEPATH%<span style=color:#4e9a06>\.</span>kube<span style=color:#4e9a06>\m</span>icrok8s
</code></pre></div></li><li><p>Linux</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>microk8s config view &gt; ~<span style=color:#4e9a06>\.</span>kube<span style=color:#4e9a06>\m</span>icrok8s
</code></pre></div></li></ul></li><li><p>From this point forward, this guide assumes you have exported MicroK8s config file and have set it in kubectl using <code>--kubeconfig</code> flag or <code>$KUBECONFIG</code> environment variable. More information can be found in <a href=https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/>Organizing Cluster Access Using kubeconfig Files</a>.</p></li></ul><h2 id=manually-setting-up-an-ingress-controller-on-microk8s>Manually setting up an ingress controller on MicroK8s</h2><p>The demo application that will be deployed later in this guide relies on an ingress controller. Given that MicroK8s needs <a href=https://multipass.run/>Multipass</a> on Windows and MacOS, we&rsquo;ll be covering that scenario and assuming Multipass is running.</p><h2 id=nginx-controller-deployment>NGINX Controller Deployment</h2><ul><li><p>Run the following command to install the nginx ingress controller on MicroK8s:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.35.0/deploy/static/provider/baremetal/deploy.yaml
</code></pre></div></li><li><p>This command will create a new namespace and deploy the required components in this namespace. To verify the deployment of the ingress controller was successful, make sure the pod with name <code>ingress-nginx-controller-&lt;random id>-&lt;random id></code> is in a running state with 1/1 containers ready and that a service has been exposed as NodePort.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get pods -n ingress-nginx
</code></pre></div><p><img src=./03.png alt="Running ingress nginx controller"></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get svc -n ingress-nginx
</code></pre></div><p><img src=./04.png alt="Running ingress nginx controller service"></p></li><li><p>Take note of the port where the ingress has been exposed (in the image above it was assigned port <strong>32106</strong>). We now need to get the IP address assigned to our microk8s-vm instance in multipass:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>multipass list
</code></pre></div><p><img src=./05.png alt="multipass list"></p></li><li><p>Combining the IP address from multipass and the NodePort assigned to the ingress controller, we can now test that the NGINX ingress controller has been deployed successfully. In our case, the full address becomes <em><code>http://172.22.206.155:32106</code></em>.</p></li><li><p>Using the below in your browser or command line, should get you with a HTTP 404 response with a nginx footer. This shows that the ingress is working. The 404 response is to be expected since you haven&rsquo;t setup an ingress route yet. You will do that in the next section.</p><p><img src=./06.png alt="HTTP 404 response in a web browser"></p><p><img src=./07.png alt="HTTP 404 response in a terminal"></p></li></ul><h2 id=cluster-level-config-vs-namespace-level-config>Cluster-level Config vs. Namespace-level Config</h2><h3 id=cluster-level-config>Cluster-level Config</h3><p>With Cluster-level GitOps config, the goal is to have &ldquo;horizontal components&rdquo; or &ldquo;management components&rdquo; deployed on your Kubernetes cluster which will then be used by your applications. Good examples are Service Meshes, Security products, Monitoring solutions, etc.</p><blockquote><p><strong>Note: You will not be creating a cluster-level config in this guide. For an example of a cluster-level configuration please refer to either the <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/day2/aks/aks_gitops_helm/>Helm-based GitOps on AKS scenario</a> or the <a href=https://azurearcjumpstart.io/azure_arc_jumpstart/azure_arc_k8s/day2/gke/gke_gitops_helm/>GKE one</a>.</strong></p></blockquote><h3 id=namespace-level-config>Namespace-level Config</h3><p>With Namespace-level GitOps config, the goal is to have Kubernetes resources deployed only in the namespace selected. The most obvious use-case here is simply your application and its respective pods, services, ingress routes, etc. In the next section will have the &ldquo;Hello Arc&rdquo; application deployed on a dedicated namespace.</p><h2 id=azure-arc-kubernetes-gitops-configuration-with-helm>Azure Arc Kubernetes GitOps Configuration with Helm</h2><h3 id=the-mechanism-in-a-nutshell>The Mechanism (In a nutshell)</h3><p>In the process of creating Azure Arc enabled Kubernetes GitOps configuration, <a href=https://github.com/fluxcd/flux>Weaveworks Flux Kubernetes Operator</a> is deployed on the cluster.</p><p>The Operator is aware of the &ldquo;HelmRelease&rdquo; Custom Resource Definition (CRD). This HelmRelease points to a helm chart in a git repo and can optionally contain specific values to input into the helm chart. Due to this configuration, a user can choose to leave the chart values intact or to have different values for different releases.</p><p>For example, an application (captured in an Helm chart) dev release can have no pod replication (single pod) while a production release, using the same chart can have 3 pod replicas.</p><p>In the next section will use the &ldquo;Hello Arc&rdquo; Helm chart to deploy a production release which we will then change and see the results in real-time.</p><h3 id=deployment-flow>Deployment Flow</h3><p>For our scenario, we will deploy the &ldquo;Hello Arc&rdquo; application from the <a href=https://github.com/likamrat/hello_arc>&ldquo;demo repository&rdquo;</a> through GitOps. We will deploy the &ldquo;Hello Arc&rdquo; application (a Namespace-level component) with 1 replica to the <em>prod</em> namespace.</p><p><img src=./08.png alt="&ldquo;Hello Arc&rdquo; application GitHub repository"></p><p><img src=./09.png alt="&ldquo;Hello Arc&rdquo; application GitHub repository"></p><h3 id=deployment>Deployment</h3><p>To create the GitOps configuration and it&rsquo;s respective Kubernetes resources, we&rsquo;ve provided a script in a shell file (Linux, MacOS) and batch file (Windows).</p><ul><li><p>Linux and MacOS</p><p>Edit the environment variables in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/microk8s/gitops/helm/az_k8sconfig_helm_microk8s.sh><em>az_k8sconfig_helm_microk8s</em></a> shell script to match your parameters, and run the below command.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>. ./az_k8sconfig_helm_microk8s.sh
</code></pre></div><blockquote><p><strong>Note: The extra dot is due to the script having an <em>export</em> function and that needs to have the vars exported in the same shell session as the rest of the commands.</strong></p></blockquote></li><li><p>Windows</p><p>Edit the environment variables in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/microk8s/gitops/helm/az_k8sconfig_helm_microk8s_windows.ps1><em>az_k8sconfig_helm_microk8s_windows</em></a> PowerShell file to match your parameters, and run it using the <code>.\az_k8sconfig_helm_microk8s.ps1</code> command.</p></li></ul><p>The <code>az_k8sconfig_helm_microk8s</code> and <code>az_k8sconfig_helm_microk8s_windows</code> scripts will:</p><ul><li><p>Login to your Azure subscription using the SPN credentials.</p></li><li><p>Create the GitOps configurations for the Azure Arc Connected Cluster. The configuration will be using the Helm chart located in the &ldquo;Hello Arc&rdquo; repository. This will create a namespace-level config to deploy the &ldquo;Hello Arc&rdquo; application Helm chart.</p><blockquote><p><strong>Disclaimer: For the purpose of this guide, notice how the &ldquo;<em>git-poll-interval 3s</em>&rdquo; is set. The 3 seconds interval is useful for demo purposes since it will make the git-poll interval to rapidly track changes on the repository but it is recommended to have longer interval in your production environment (default value is 5min)</strong></p></blockquote></li><li><p>Once the script will complete its run, you will have the GitOps configuration created and all the resources deployed in your local MicroK8s Kubernetes cluster.</p><blockquote><p><strong>Note: it can take a few minutes for the configuration to change its Operator state status from &ldquo;Pending&rdquo; to &ldquo;Installed&rdquo;.</strong></p></blockquote><p><img src=./10.png alt="New GitOps configuration created"></p><p><img src=./11.png alt="New GitOps configuration created"></p></li><li><p>The Namespace-level config initiated the &ldquo;Hello Arc&rdquo; Pod (1 replica), Service and Ingress Route resource deployment.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get pods -n prod
kubectl get svc -n prod
kubectl get ing -n prod
</code></pre></div><p><img src=./12.png alt="&ldquo;Hello Arc&rdquo; application deployed"></p></li></ul><h2 id=initiating-hello-arc-application-gitops>Initiating &ldquo;Hello Arc&rdquo; Application GitOps</h2><ul><li><p>The GitOps flow works as follow:</p><ol><li><p>The Flux operator holds the &ldquo;desired state&rdquo; of the &ldquo;Hello Arc&rdquo; Helm release. This is the configuration we deployed against the Azure Arc connected cluster. The operator will pull the state of the releases in the repository every 3 seconds.</p></li><li><p>Changing the application release will trigger the Flux operator to kick-in the GitOps flow. In our case, we will be changing the welcome message and the amount of replicas.</p></li><li><p>A new version of the application will be deployed on the cluster with more replicas as configured. Once the new pods are successfully deployed, the old ones will be terminated (rolling upgrade).</p></li></ol></li><li><p>To show the above flow, open 2 (ideally 3) side-by-side windows:</p><ul><li><p>Local shell running <code>kubectl get pods -n prod -w</code></p></li><li><p>In your own repository fork, open the &ldquo;Hello Arc&rdquo; <a href=https://github.com/likamrat/hello_arc/blob/master/releases/prod/hello-arc.yaml><em>hello-arc.yaml</em></a> Helm release file.</p></li><li><p>Another browser window that has the webpage <a href=http://172.22.206.155:32106>http://172.22.206.155:32106</a> open <strong>(replace with your own values)</strong></p></li><li><p>End result should look like this:</p><p><img src=./13.png alt="Side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the application open in a web browser"></p></li></ul></li><li><p>As mentioned in the prerequisites section, it is optional but very recommended to configure the &ldquo;Tab Auto Refresh&rdquo; extension for your browser. If you did, in the &ldquo;Hello Arc&rdquo; application window, configure it to refresh every 2 seconds.</p><p><img src=./14.png alt="&ldquo;Tab Auto Refresh&rdquo; extension"></p></li><li><p>In the repository window showing the <em>hello-arc.yaml</em> file, change the number of <em>replicaCount</em> to 3 as well as the the message text and commit your changes. Alternatively, you can open the forked repository in your IDE, make the change, commit and push it.</p><p><img src=./15.png alt="hello-arc.yaml file"></p></li><li><p>Upon committing the changes, notice how the rolling upgrade starts. Once the Pods are up & running, the new &ldquo;Hello Arc&rdquo; application version window will show the new messages as well as the additional pods replicas, showing the rolling upgrade is completed and the GitOps flow is successful.</p><p><img src=./16.png alt="&ldquo;Hello Arc&rdquo; application rolling upgrade in terminal"></p><p><img src=./17.png alt="&ldquo;Hello Arc&rdquo; application rolling upgrade in terminal"></p><p><img src=./18.png alt="New side-by-side view of terminal, &ldquo;Hello Arc&rdquo; GitHub repo and the new application version open in a web browser"></p></li></ul><h2 id=cleanup>Cleanup</h2><p>To delete the GitOps configuration and it&rsquo;s respective Kubernetes resources, we&rsquo;ve provided a script in a shell file (Linux, MacOS) and a PowerShell file (Windows). It is recommended to run this script locally, since it also removes elements from the local cluster.</p><ul><li><p>Linux and MacOS</p><p>Edit the environment variables to match the Azure Arc Kubernetes cluster and Resources in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/microk8s/gitops/helm/az_k8sconfig_helm_cleanup_microk8s.sh>az_k8sconfig_helm_cleanup_microk8s</a> shell script, then run the file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>./az_k8sconfig_helm_cleanup_microk8s.sh
</code></pre></div></li><li><p>Windows</p><p>Edit the environment variables to match the Azure Arc Kubernetes cluster and Resources in the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/microk8s/gitops/helm/az_k8sconfig_helm_cleanup_microk8s_windows.ps1>az_k8sconfig_helm_cleanup_microk8s_windows</a> script, then run the file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>.<span style=color:#4e9a06>\a</span>z_k8sconfig_helm_cleanup_microk8s_windows.ps1
</code></pre></div></li><li><p>You should see the resources being deleted:</p><p><img src=./19.png alt="Cleanup script in terminal"></p></li><li><p>If you also wish to remove the local MicroK8s cluster and the Arc connected cluster from Azure, please refer to the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_k8s_jumpstart/microk8s/gitops/helm/az_k8sconfig_helm_cleanup_microk8s_windows.ps1>Delete the Deployment section</a> in the onboarding guide.</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-5ab6b24072ecc818fea52358b4b7ec35>4 - Azure Arc enabled data services</h1><div class=lead>The deployment scenarios in this section will guide you through deploying and working with Azure Arc enabled data services on multiple infrastructure platforms.</div></div><div class=td-content><h1 id=pg-a8de654c4e1024d6d7b2cfcfce45536b>4.1 - Azure Kubernetes Service</h1><div class=lead>If you do not yet have a Kubernetes cluster, the scenarios in this section will guide on creating an AKS cluster with Azure Arc enabled data services integration in an automated fashion using ARM template.</div></div><div class=td-content><h1 id=pg-cf0bb7467ca6126c55bbde86783f5e54>4.1.1 - Data Controller ARM Template</h1><h2 id=deploy-an-azure-arc-data-controller-vanilla-deployment-on-aks-using-an-arm-template>Deploy an Azure Arc Data Controller Vanilla Deployment on AKS using an ARM Template</h2><p>The following README will guide you on how to deploy a &ldquo;Ready to Go&rdquo; environment so you can start using Azure Arc Data Services and deploy Azure data services on <a href=https://docs.microsoft.com/en-us/azure/aks/intro-kubernetes>Azure Kubernetes Service (AKS)</a> cluster, using <a href=https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview>Azure ARM Template</a>.</p><p>By the end of this guide, you will have an AKS cluster deployed with an Azure Arc Data Controller (<a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/connectivity>in &ldquo;Directly Connected&rdquo; mode</a>) and a Microsoft Windows Server 2019 (Datacenter) Azure VM, installed & pre-configured with all the required tools needed to work with Azure Arc Data Services.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled data services is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/release-notes>public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-ssh-keys-detailed>Generate SSH Key</a> (or use existing ssh key).</p></li><li><p>Create Azure service principal (SP)</p><p>In order for you to deploy the AKS cluster using the ARM template, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcData&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcData&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcData&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional, but highly recommended, to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a>.</strong></p></blockquote></li><li><p>Enable subscription for the Microsoft.AzureArcData resource provider for Azure Arc enabled data services. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.AzureArcData
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.AzureArcData -o table
</code></pre></div></li></ul><h2 id=automation-flow>Automation Flow</h2><p>For you to get familiar with the automation and deployment flow, below is an explanation.</p><ul><li><p>User is editing the ARM template parameters file (1-time edit). These parameters values are being used throughout the deployment.</p></li><li><p>Main ARM template will deploy AKS.</p></li><li><p>Once AKS deployment has finished, the main ARM template will call a secondary ARM template which is depended on a successful AKS deployment.</p></li><li><p>Secondary ARM template will deploy a client Windows Server 2019 VM.</p></li><li><p>As part of the Windows Server 2019 VM deployment, there are 2 scripts executions; First script (ClientTools.ps1) at deployment runtime using the ARM <em>&ldquo;CustomScriptExtension&rdquo;</em> module and a second script (LogonScript.ps1) on user first logon to Windows.</p><ul><li><p>Runtime script will:</p><ul><li>Inject user parameters values (from bullet point #1) to be used in both runtime and logon script</li><li>Install the required tools – az cli, az cli PowerShell module, kubernetes-cli, Visual C++ Redistributable (Chocolaty packages)</li><li>Download & install the Azure Data Studio & azdata cli</li><li>Download the Azure Data Studio Azure Data CLI, Azure Arc & PostgreSQL extensions</li><li>Download the <em>DC_Cleanup</em> and <em>DC_Deploy</em> PowerShell scripts</li><li>Create the logon script</li><li>Create the Windows schedule task to run the logon script at first login</li><li>Disable Windows Server Manager from running at login</li></ul></li><li><p>Logon script will:</p><ul><li>Create the <em>LogonScript.log</em> file</li><li>Retrieve the AKS credentials & create the <em>kubeconfig</em> file in user Windows profile</li><li>Create the <em>azdata</em> config file in user Windows profile</li><li>Install the Azure Data Studio Azure Data CLI, Azure Arc & PostgreSQL extensions</li><li>Create the Azure Data Studio desktop shortcut</li><li>Open another PowerShell session which will execute the <code>kubectl get pods -n &lt;Arc Data Controller namespace> -w</code> command</li><li>Deploy the Arc Data Controller in <strong>&ldquo;Directly Connected&rdquo; mode</strong> using the user parameters values</li><li>Unregister the logon script Windows schedule task so it will not run after first login</li></ul></li></ul></li></ul><h2 id=deployment>Deployment</h2><p>As mentioned, this deployment will leverage ARM templates. You will deploy a single template, responsible on deploying AKS. Once AKS deployment has finished, the template will then automatically execute another template which will deploy the Windows Server Azure VM followed by the Azure Arc Data Controller deployment on the AKS cluster.</p><ul><li><p>Before deploying the ARM template, login to Azure using AZ CLI with the <code>az login</code> command. To determine which AKS Kubernetes versions are available in your region use the below Azure CLI command.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az aks get-versions -l <span style=color:#4e9a06>&#34;&lt;Your Azure Region&gt;&#34;</span>
</code></pre></div></li><li><p>The deployment is using the ARM template parameters file. Before initiating the deployment, edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_data_jumpstart/aks/arm_template/dc_vanilla/azuredeploy.parameters.json><em>azuredeploy.parameters.json</em></a> file located in your local cloned repository folder. An example parameters file is located <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_data_jumpstart/aks/arm_template/dc_vanilla/azuredeploy.parameters.example.json>here</a>.</p><blockquote><p><strong>Note: Currently, On Azure Kubernetes Service (AKS), <a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/release-notes#known-issues>Kubernetes version 1.19.x is not supported</a>.</strong></p></blockquote><ul><li><em>clusterName</em> - AKS cluster name</li><li><em>dnsPrefix</em> - AKS unique DNS prefix</li><li><em>nodeAdminUsername</em> - AKS Node Username</li><li><em>sshRSAPublicKey</em> - Your ssh public key</li><li><em>SPN_CLIENT_ID</em> - Your Azure service principal name</li><li><em>SPN_CLIENT_SECRET</em> - Your Azure service principal password</li><li><em>SPN_TENANT_ID</em> - Your Azure tenant ID</li><li><em>SPN_AUTHORITY</em> - <em><a href=https://login.microsoftonline.com>https://login.microsoftonline.com</a></em> <strong>Do not change</strong></li><li><em>kubernetesVersion</em> - AKS Kubernetes Version (See previous prerequisite)</li><li><em>adminUsername</em> - Client Windows VM admin username</li><li><em>adminPassword</em> - Client Windows VM admin password</li><li><em>vmSize</em> - Client Windows VM size</li><li><em>resourceGroup</em> - Azure resource group where all the resources get deploy</li><li><em>AZDATA_USERNAME</em> - Azure Arc Data Controller admin username</li><li><em>AZDATA_PASSWORD</em> - Azure Arc Data Controller admin password (The password must be at least 8 characters long and contain characters from three of the following four sets: uppercase letters, lowercase letters, numbers, and symbols.)</li><li><em>ACCEPT_EULA</em> - &ldquo;yes&rdquo; <strong>Do not change</strong></li><li><em>ARC_DC_NAME</em> - Azure Arc Data Controller name. The name must consist of lowercase alphanumeric characters or &lsquo;-&rsquo;, and must start and end with an alphanumeric character. This name will be used for k8s namespace as well.</li><li><em>ARC_DC_SUBSCRIPTION</em> - Azure Arc Data Controller Azure subscription ID</li><li><em>ARC_DC_REGION</em> - Azure location where the Azure Arc Data Controller resource will be created in Azure (Currently, supported regions supported are eastus, eastus2, centralus, westus2, westeurope, southeastasia)</li></ul></li><li><p>To deploy the ARM template, navigate to the local cloned <a href=.>deployment folder</a> and run the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name &lt;Name of the Azure resource group&gt; --location &lt;Azure Region&gt;
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name &lt;The name of this deployment&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_data_jumpstart/aks/arm_template/dc_vanilla/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters &lt;The *azuredeploy.parameters.json* parameters file location&gt;
</code></pre></div><blockquote><p><strong>Note: Make sure that you are using the same Azure resource group name as the one you&rsquo;ve just used in the <em>azuredeploy.parameters.json</em> file</strong></p></blockquote><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name Arc-Data-Vanilla-Demo --location <span style=color:#4e9a06>&#34;East US&#34;</span>
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group Arc-Data-Vanilla-Demo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name arcdatademo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_data_jumpstart/aks/arm_template/dc_vanilla/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters azuredeploy.parameters.json
</code></pre></div><blockquote><p><strong>Note: Deployment time of the Azure Resource (AKS + Windows VM) can take ~20-30min</strong></p></blockquote></li><li><p>Once Azure resources has been provisioned, you will be able to see it in Azure portal.</p><p><img src=./01.jpg alt="ARM template deployment completed"></p><p><img src=./02.jpg alt="New Azure resource group with all resources"></p></li></ul><h2 id=windows-login--post-deployment>Windows Login & Post Deployment</h2><p>Now that both the AKS cluster and the Windows Server VM are created, it is time to login to the Client VM.</p><ul><li><p>Using it&rsquo;s public IP, RDP to the <strong>Client VM</strong></p><p><img src=./03.jpg alt="Data Client VM public IP"></p></li><li><p>At first login, as mentioned in the &ldquo;Automation Flow&rdquo; section, a logon script will get executed. This script was created as part of the automated deployment process.</p><p>Let the script to run its course and <strong>do not close</strong> the PowerShell session, this will be done for you once completed. You will notice that the Azure Arc Data Controller gets deployed on the AKS cluster. <strong>The logon script run time is approximately 10min long</strong>.</p><p>Once the script will finish it&rsquo;s run, the logon script PowerShell session will be closed and the Azure Arc Data Controller will be deployed on the AKS cluster and be ready to use.</p><p><img src=./04.jpg alt="PowerShell logon script run"></p><p><img src=./05.jpg alt="PowerShell logon script run"></p><p><img src=./06.jpg alt="PowerShell logon script run"></p><p><img src=./07.jpg alt="PowerShell logon script run"></p><p><img src=./08.jpg alt="PowerShell logon script run"></p></li><li><p>Initially, since the data controller was deployed in &ldquo;Directly Connected&rdquo; mode, only after the logon script run is will be completed, a new Azure resource for the controller will be created as well.</p><p><img src=./09.jpg alt="Data Controller in a resource group"></p><p><img src=./10.jpg alt="Data Controller resource"></p></li><li><p>Using PowerShell, login to the Data Controller and check it&rsquo;s health using the below commands.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000>azdata</span> <span style=color:#000>login</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-namespace</span> <span style=color:#000>$env:ARC_DC_NAME</span>
<span style=color:#000>azdata</span> <span style=color:#000>arc</span> <span style=color:#000>dc</span> <span style=color:#000>status</span> <span style=color:#000>show</span>
</code></pre></div><p><img src=./11.jpg alt="azdata login"></p></li><li><p>Another tool automatically deployed is Azure Data Studio along with the <em>Azure Data CLI</em>, the <em>Azure Arc</em> and the <em>PostgreSQL</em> extensions. Using the Desktop shortcut created for you, open Azure Data Studio and click the Extensions settings to see both extensions.</p><p><img src=./12.jpg alt="Azure Data Studio shortcut"></p><p><img src=./13.jpg alt="Azure Data Studio extension"></p></li></ul><h2 id=cleanup>Cleanup</h2><ul><li><p>To delete the Azure Arc Data Controller and all of it&rsquo;s Kubernetes resources, run the <em>DC_Cleanup.ps1</em> PowerShell script located in <em>C:\tmp</em> on the Windows Client VM. At the end of it&rsquo;s run, the script will close all PowerShell sessions. <strong>The Cleanup script run time is approximately 5min long</strong>.</p><p><img src=./14.jpg alt="DC_Cleanup PowerShell script run"></p></li><li><p>If you want to delete the entire environment, simply delete the deployment resource group from the Azure portal.</p><p><img src=./15.jpg alt="Delete Azure resource group"></p></li></ul><h2 id=re-deploy-azure-arc-data-controller>Re-Deploy Azure Arc Data Controller</h2><p>In case you deleted the Azure Arc Data Controller from the AKS cluster, you can re-deploy it by running the <em>DC_Deploy.ps1</em> PowerShell script located in <em>C:\tmp</em> on the Windows Client VM. <strong>The Deploy script run time is approximately 5-10min long</strong></p><p><img src=./16.jpg alt="Re-Deploy Azure Arc Data Controller PowerShell script"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-38c79c16af3e1716130983a099acb141>4.1.2 - SQL Managed Instance ARM Template</h1><h2 id=deploy-an-azure-sql-managed-instance-deployment-on-aks-using-an-arm-template>Deploy an Azure SQL Managed Instance Deployment on AKS using an ARM Template</h2><p>The following README will guide you on how to deploy a &ldquo;Ready to Go&rdquo; environment so you can start using Azure Arc Data Services and deploy Azure data services on <a href=https://docs.microsoft.com/en-us/azure/aks/intro-kubernetes>Azure Kubernetes Service (AKS)</a> cluster, using <a href=https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview>Azure ARM Template</a>.</p><p>By the end of this guide, you will have an AKS cluster deployed with an Azure Arc Data Controller (<a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/connectivity>in &ldquo;Directly Connected&rdquo; mode</a>), Azure SQL MI with a sample database and a Microsoft Windows Server 2019 (Datacenter) Azure VM, installed & pre-configured with all the required tools needed to work with Azure Arc Data Services.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled data services is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/release-notes>public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-ssh-keys-detailed>Generate SSH Key</a> (or use existing ssh key).</p></li><li><p>Create Azure service principal (SP)</p><p>In order for you to deploy the AKS cluster using the ARM template, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcData&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcData&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcData&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional, but highly recommended, to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a>.</strong></p></blockquote></li><li><p>Enable subscription for the Microsoft.AzureArcData resource provider for Azure Arc enabled data services. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.AzureArcData
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.AzureArcData -o table
</code></pre></div></li></ul><h2 id=automation-flow>Automation Flow</h2><p>For you to get familiar with the automation and deployment flow, below is an explanation.</p><ul><li><p>User is editing the ARM template parameters file (1-time edit). These parameters values are being used throughout the deployment.</p></li><li><p>Main ARM template will deploy AKS.</p></li><li><p>Once AKS deployment has finished, the main ARM template will call a secondary ARM template which is depended on a successful AKS deployment.</p></li><li><p>Secondary ARM template will deploy a client Windows Server 2019 VM.</p></li><li><p>As part of the Windows Server 2019 VM deployment, there are 2 scripts executions; First script (ClientTools.ps1) at deployment runtime using the ARM <em>&ldquo;CustomScriptExtension&rdquo;</em> module and a second script (LogonScript.ps1) on user first logon to Windows.</p><ul><li><p>Runtime script will:</p><ul><li>Inject user parameters values (from bullet point #1) to be used in both runtime and logon script</li><li>Install the required tools – az cli, az cli PowerShell module, kubernetes-cli, Visual C++ Redistributable (Chocolaty packages)</li><li>Download & install the Azure Data Studio & azdata cli</li><li>Download the Azure Data Studio Azure Data CLI, Azure Arc & PostgreSQL extensions</li><li>Download the <em>MSSQL_MI_Cleanup</em> and <em>MSSQL_MI_Deploy</em> PowerShell scripts</li><li>Create the SQL Connectivity script</li><li>Create the logon script</li><li>Create the Windows schedule task to run the logon script at first login</li><li>Disable Windows Server Manager from running at login</li></ul></li><li><p>Logon script will:</p><ul><li>Create the <em>LogonScript.log</em> file</li><li>Retrieve the AKS credentials & create the <em>kubeconfig</em> file in user Windows profile</li><li>Create the <em>azdata</em> config file in user Windows profile</li><li>Install the Azure Data Studio Azure Data CLI, Azure Arc & PostgreSQL extensions</li><li>Create the Azure Data Studio desktop shortcut</li><li>Open another PowerShell session which will execute the <code>kubectl get pods -n &lt;Arc Data Controller namespace> -w</code> command</li><li>Deploy the Arc Data Controller in <strong>&ldquo;Directly Connected&rdquo; mode</strong> using the user parameters values</li><li>Deploy Azure SQL Managed Instance on the AKS cluster</li><li>Creating MSSQL Instance connectivity details using the SQL Connectivity script</li><li>Unregister the logon script Windows schedule task so it will not run after first login</li></ul></li></ul></li></ul><h2 id=deployment>Deployment</h2><p>As mentioned, this deployment will leverage ARM templates. You will deploy a single template, responsible on deploying AKS. Once AKS deployment has finished, the template will then automatically execute another template which will deploy the Windows Server Azure VM followed by the Azure Arc Data Controller deployment and Azure SQL MI on the AKS cluster.</p><ul><li><p>Before deploying the ARM template, login to Azure using AZ CLI with the <code>az login</code> command. To determine which AKS Kubernetes versions are available in your region use the below Azure CLI command.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az aks get-versions -l <span style=color:#4e9a06>&#34;&lt;Your Azure Region&gt;&#34;</span>
</code></pre></div></li><li><p>The deployment is using the ARM template parameters file. Before initiating the deployment, edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_data_jumpstart/aks/arm_template/dc_vanilla/azuredeploy.parameters.json><em>azuredeploy.parameters.json</em></a> file located in your local cloned repository folder. An example parameters file is located <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_data_jumpstart/aks/arm_template/dc_vanilla/azuredeploy.parameters.example.json>here</a>.</p><blockquote><p><strong>Note: Currently, On Azure Kubernetes Service (AKS), <a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/release-notes#known-issues>Kubernetes version 1.19.x is not supported</a>.</strong></p></blockquote><ul><li><em>clusterName</em> - AKS cluster name</li><li><em>dnsPrefix</em> - AKS unique DNS prefix</li><li><em>nodeAdminUsername</em> - AKS Node Username</li><li><em>sshRSAPublicKey</em> - Your ssh public key</li><li><em>SPN_CLIENT_ID</em> - Your Azure service principal name</li><li><em>SPN_CLIENT_SECRET</em> - Your Azure service principal password</li><li><em>SPN_TENANT_ID</em> - Your Azure tenant ID</li><li><em>SPN_AUTHORITY</em> - <em><a href=https://login.microsoftonline.com>https://login.microsoftonline.com</a></em> <strong>Do not change</strong></li><li><em>kubernetesVersion</em> - AKS Kubernetes Version (See previous prerequisite)</li><li><em>adminUsername</em> - Client Windows VM admin username</li><li><em>adminPassword</em> - Client Windows VM admin password</li><li><em>vmSize</em> - Client Windows VM size</li><li><em>resourceGroup</em> - Azure resource group where all the resources get deploy</li><li><em>AZDATA_USERNAME</em> - Azure Arc Data Controller admin username. DO NOT USE &lsquo;sa&rsquo; or &lsquo;admin&rsquo;!!</li><li><em>AZDATA_PASSWORD</em> - Azure Arc Data Controller admin password (The password must be at least 8 characters long and contain characters from three of the following four sets: uppercase letters, lowercase letters, numbers, and symbols.)</li><li><em>ACCEPT_EULA</em> - &ldquo;yes&rdquo; <strong>Do not change</strong></li><li><em>ARC_DC_NAME</em> - Azure Arc Data Controller name. The name must consist of lowercase alphanumeric characters or &lsquo;-&rsquo;, and must start d end with a alphanumeric character (This name will be used for k8s namespace as well).</li><li><em>ARC_DC_SUBSCRIPTION</em> - Azure Arc Data Controller Azure subscription ID</li><li><em>ARC_DC_REGION</em> - Azure location where the Azure Arc Data Controller resource will be created in Azure (Currently, supported regions supported are eastus, eastus2, centralus, westus2, westeurope, southeastasia)</li><li><em>MSSQL_MI_NAME</em> - SQL Managed Instance name to be deployed on the Kubernetes cluster</li></ul></li><li><p>To deploy the ARM template, navigate to the local cloned <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_data_jumpstart/aks/arm_template/mssql_mi>deployment folder</a> and run the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name &lt;Name of the Azure resource group&gt; --location &lt;Azure Region&gt;
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name &lt;The name of this deployment&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_data_jumpstart/aks/arm_template/mssql_mi/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters &lt;The *azuredeploy.parameters.json* parameters file location&gt;
</code></pre></div><blockquote><p><strong>Note: Make sure that you are using the same Azure resource group name as the one you&rsquo;ve just used in the <em>azuredeploy.parameters.json</em> file</strong></p></blockquote><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name Arc-Data-SQLMI-Demo --location <span style=color:#4e9a06>&#34;East US&#34;</span>
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group Arc-Data-SQLMI-Demo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name arcdatasqlmidemo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_data_jumpstart/aks/arm_template/mssql_mi/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters azuredeploy.parameters.json
</code></pre></div><blockquote><p><strong>Note: Deployment time of the Azure Resource (AKS + Windows VM) can take ~25-30 minutes.</strong></p></blockquote></li><li><p>Once Azure resources has been provisioned, you will be able to see it in Azure portal.</p><p><img src=./01.jpg alt="ARM template deployment completed"></p><p><img src=./02.jpg alt="New Azure resource group with all resources"></p></li></ul><h2 id=windows-login--post-deployment>Windows Login & Post Deployment</h2><p>Now that both the AKS cluster and the Windows Server client VM are created, it is time to login the Client VM.</p><ul><li><p>Using it&rsquo;s public IP, RDP to the <strong>Client VM</strong>.</p><p><img src=./03.jpg alt="Data Client VM public IP"></p></li><li><p>At first login, as mentioned in the &ldquo;Automation Flow&rdquo; section, a logon script will get executed. This script was created as part of the automated deployment process.</p><p>Let the script to run it&rsquo;s course and <strong>do not close</strong> the PowerShell session, this will be done for you once completed. You will notice that the Azure Arc Data Controller gets deployed on the AKS cluster. <strong>The logon script run time is approximately 15min long</strong>.</p><p>Once the script will finish it&rsquo;s run, the logon script PowerShell session will be closed and the Azure Arc Data Controller and an Azure SQL MI (and a sample DB) will be deployed on the AKS cluster and be ready to use.</p><p><img src=./04.jpg alt="PowerShell logon script run"></p><p><img src=./05.jpg alt="PowerShell logon script run"></p><p><img src=./06.jpg alt="PowerShell logon script run"></p><p><img src=./07.jpg alt="PowerShell logon script run"></p><p><img src=./08.jpg alt="PowerShell logon script run"></p><p><img src=./09.jpg alt="PowerShell logon script run"></p></li><li><p>Initially, since the data controller was deployed in &ldquo;Directly Connected&rdquo; mode, only after the logon script run is will be completed, a new Azure resource for the controller will be created as well.</p><p><img src=./10.jpg alt="Data Controller in a resource group"></p><p><img src=./11.jpg alt="Data Controller resource"></p></li><li><p>Another tool automatically deployed is Azure Data Studio along with the <em>Azure Data CLI</em>, the <em>Azure Arc</em> and the <em>PostgreSQL</em> extensions. At the end of the logon script run, Azure Data Studio will automatically be open and connected to the Azure SQL MI with the sample DB.</p><blockquote><p><strong>Note: To connect to the SQL managed instance use the AZDATA_USERNAME and AZDATA_PASSWORD values specified in the azuredeploy.parameters.json file. The &ldquo;sa&rdquo; login is disabled.</strong></p></blockquote><p><img src=./12.jpg alt="Azure Data Studio shortcut"></p><p><img src=./13.jpg alt="Azure Data Studio extension"></p><p><img src=./14.jpg alt="Azure SQL MI with the sample DB"></p></li><li><p>(Optional) In PowerShell, login to the Data Controller and check it&rsquo;s health using the below commands.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000>azdata</span> <span style=color:#000>login</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-name</span> <span style=color:#000>$env:ARC_DC_NAME</span>
<span style=color:#000>azdata</span> <span style=color:#000>arc</span> <span style=color:#000>dc</span> <span style=color:#000>status</span> <span style=color:#000>show</span>
</code></pre></div><p><img src=./15.jpg alt="azdata login"></p></li></ul><h2 id=cleanup>Cleanup</h2><ul><li><p>To delete the Azure Arc Data Controller and all of it&rsquo;s Kubernetes resources as well as the SQL MI, run the <em>MSSQL_MI_Cleanup.ps1</em> PowerShell script located in <em>C:\tmp</em> on the Windows Client VM. At the end of it&rsquo;s run, the script will close all PowerShell sessions. <strong>The Cleanup script run time is approximately 10min long</strong>.</p><p><img src=./16.jpg alt="MSSQL_MI_Cleanup PowerShell script run"></p><p><img src=./17.jpg alt="MSSQL_MI_Cleanup PowerShell script run"></p></li><li><p>If you want to delete the entire environment, simply delete the deployment resource group from the Azure portal.</p><p><img src=./18.jpg alt="Delete Azure resource group"></p></li></ul><h2 id=re-deploy-azure-arc-data-controller--sql-mi>Re-Deploy Azure Arc Data Controller & SQL MI</h2><p>In case you deleted the Azure Arc Data Controller and the SQL MI from the Kubernetes cluster, you can re-deploy it by running the <em>MSSQL_MI_Deploy.ps1</em> PowerShell script located in <em>C:\tmp</em> on the Windows Client VM. <strong>The Deploy script run time is approximately 15min long</strong>.</p><p><img src=./19.jpg alt="Re-Deploy Azure Arc Data Controller + MSSQL PowerShell script"></p><p><img src=./20.jpg alt="Re-Deploy Azure Arc Data Controller + MSSQL PowerShell script"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c090c91194a8bca318c0a3d2f5811a40>4.1.3 - PostgreSQL Hyperscale ARM Template</h1><h2 id=deploy-an-azure-postgresql-hyperscale-deployment-on-aks-using-an-arm-template>Deploy an Azure PostgreSQL Hyperscale Deployment on AKS using an ARM Template</h2><p>The following README will guide you on how to deploy a &ldquo;Ready to Go&rdquo; environment so you can start using Azure Arc Data Services with Azure PostgreSQL Hyperscale (Citus) deployed on <a href=https://docs.microsoft.com/en-us/azure/aks/intro-kubernetes>Azure Kubernetes Service (AKS)</a> cluster, using <a href=https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview>Azure ARM Template</a>.</p><p>By the end of this guide, you will have an AKS cluster deployed with an Azure Arc Data Controller (<a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/connectivity>in &ldquo;Directly Connected&rdquo; mode</a>), Azure PostgreSQL Hyperscale with a sample database and a Microsoft Windows Server 2019 (Datacenter) Azure VM, installed & pre-configured with all the required tools needed to work with Azure Arc Data Services.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled data services is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/release-notes>public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-ssh-keys-detailed>Generate SSH Key</a> (or use existing ssh key).</p></li><li><p>Create Azure service principal (SP)</p><p>In order for you to deploy the AKS cluster using the ARM template, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcData&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcData&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcData&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional, but highly recommended, to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a>.</strong></p></blockquote></li><li><p>Enable subscription for the Microsoft.AzureArcData resource provider for Azure Arc enabled data services. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.AzureArcData
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.AzureArcData -o table
</code></pre></div></li></ul><h2 id=automation-flow>Automation Flow</h2><p>For you to get familiar with the automation and deployment flow, below is an explanation.</p><ul><li><p>User is editing the ARM template parameters file (1-time edit). These parameters values are being used throughout the deployment.</p></li><li><p>Main ARM template will deploy AKS.</p></li><li><p>Once AKS deployment has finished, the main ARM template will call a secondary ARM template which is depended on a successful AKS deployment.</p></li><li><p>Secondary ARM template will deploy a client Windows Server 2019 VM.</p></li><li><p>As part of the Windows Server 2019 VM deployment, there are 2 scripts executions; First script (ClientTools.ps1) at deployment runtime using the ARM <em>&ldquo;CustomScriptExtension&rdquo;</em> module and a second script (LogonScript.ps1) on user first logon to Windows.</p><ul><li><p>Runtime script will:</p><ul><li>Inject user parameters values (from bullet point #1) to be used in both runtime and logon script</li><li>Install the required tools – az cli, az cli PowerShell module, kubernetes-cli, Visual C++ Redistributable (Chocolaty packages)</li><li>Download & install the Azure Data Studio & azdata cli</li><li>Download the Azure Data Studio Azure Data CLI, Azure Arc & PostgreSQL extensions</li><li>Download the <em>Postgres_Cleanup</em> and <em>Postgres_Deploy</em> PowerShell scripts</li><li>Create the Postgres Connectivity script</li><li>Create the logon script</li><li>Create the Windows schedule task to run the logon script at first login</li><li>Disable Windows Server Manager from running at login</li></ul></li><li><p>Logon script will:</p><ul><li>Create the <em>LogonScript.log</em> file</li><li>Retrieve the AKS credentials & create the <em>kubeconfig</em> file in user Windows profile</li><li>Create the <em>azdata</em> config file in user Windows profile</li><li>Install the Azure Data Studio Azure Data CLI, Azure Arc & PostgreSQL extensions</li><li>Create the Azure Data Studio desktop shortcut</li><li>Open another PowerShell session which will execute the <code>kubectl get pods -n &lt;Arc Data Controller namespace> -w</code> command</li><li>Deploy the Arc Data Controller in <strong>&ldquo;Directly Connected&rdquo; mode</strong> using the user parameters values</li><li>Deploy Azure Postgres server group <strong>(with 5 workers)</strong> on the AKS cluster</li><li>Creating Postgres connectivity details using the Postgres Connectivity script</li><li>Unregister the logon script Windows schedule task so it will not run after first login</li></ul></li></ul></li></ul><h2 id=deployment>Deployment</h2><p>As mentioned, this deployment will leverage ARM templates. You will deploy a single template, responsible on deploying AKS. Once AKS deployment has finished, the template will then automatically execute another template which will deploy the Windows Server Azure VM followed by the Azure Arc Data Controller deployment and Azure Postgres on the AKS cluster.</p><ul><li><p>Before deploying the ARM template, login to Azure using AZ CLI with the <code>az login</code> command. To determine which AKS Kubernetes versions are available in your region use the below Azure CLI command.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az aks get-versions -l <span style=color:#4e9a06>&#34;&lt;Your Azure Region&gt;&#34;</span>
</code></pre></div></li><li><p>The deployment is using the ARM template parameters file. Before initiating the deployment, edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_data_jumpstart/aks/arm_template/postgres_hs/azuredeploy.parameters.json><em>azuredeploy.parameters.json</em></a> file located in your local cloned repository folder. An example parameters file is located <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_data_jumpstart/aks/arm_template/postgres_hs/azuredeploy.parameters.example.json>here</a>.</p><blockquote><p><strong>Note: Currently, On Azure Kubernetes Service (AKS), <a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/release-notes#known-issues>Kubernetes version 1.19.x is not supported</a>.</strong></p></blockquote><ul><li><em>clusterName</em> - AKS cluster name</li><li><em>dnsPrefix</em> - AKS unique DNS prefix</li><li><em>nodeAdminUsername</em> - AKS Node Username</li><li><em>sshRSAPublicKey</em> - Your ssh public key</li><li><em>servicePrincipalClientId</em> - Your Azure service principal name</li><li><em>servicePrincipalClientSecret</em> - Your Azure service principal password</li><li><em>kubernetesVersion</em> - AKS Kubernetes Version (See previous prerequisite)</li><li><em>adminUsername</em> - Client Windows VM admin username</li><li><em>adminPassword</em> - Client Windows VM admin password</li><li><em>vmSize</em> - Client Windows VM size</li><li><em>tenantId</em> - Azure tenant ID</li><li><em>resourceGroup</em> - Azure resource group where all the resources get deploy</li><li><em>AZDATA_USERNAME</em> - Azure Arc Data Controller admin username</li><li><em>AZDATA_PASSWORD</em> - Azure Arc Data Controller admin password (The password must be at least 8 characters long and contain characters from three of the following four sets: uppercase letters, lowercase letters, numbers, and symbols.)</li><li><em>ACCEPT_EULA</em> - &ldquo;yes&rdquo; <strong>Do not change</strong></li><li><em>ARC_DC_NAME</em> - Azure Arc Data Controller name. The name must consist of lowercase alphanumeric characters or &lsquo;-&rsquo;, and must start d end with a alphanumeric character (This name will be used for k8s namespace as well).</li><li><em>ARC_DC_SUBSCRIPTION</em> - Azure Arc Data Controller Azure subscription ID</li><li><em>ARC_DC_REGION</em> - Azure location where the Azure Arc Data Controller resource will be created in Azure (Currently, supported regions supported are eastus, eastus2, centralus, westus2, westeurope, southeastasia)</li><li><em>POSTGRES_NAME</em> - PostgreSQL Hyperscale server group name to be deployed on the Kubernetes cluster. Names must be 10 characters or fewer in length and conform to DNS naming conventions.</li><li><em>POSTGRES_WORKER_NODE_COUNT</em> - PostgreSQL Hyperscale server group number of workers</li><li><em>POSTGRES_DATASIZE</em> - PostgreSQL Hyperscale size of data volumes in MB (Recommended to use at least 1GB (1024 MB)).*</li><li><em>POSTGRES_SERVICE_TYPE</em> - Kubernetes service type i.e ClusterIP/LoadBalancer/NodePort. As AKS supports Load Balancers, leave configured with <em>LoadBalancer</em>.</li></ul></li><li><p>To deploy the ARM template, navigate to the local cloned <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_data_jumpstart/aks/arm_template/postgres_hs>deployment folder</a> and run the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name &lt;Name of the Azure resource group&gt; --location &lt;Azure Region&gt;
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name &lt;The name of this deployment&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_data_jumpstart/aks/arm_template/postgres_hs/azuredeploy.jsonpostgres_hs/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters &lt;The *azuredeploy.parameters.json* parameters file location&gt;
</code></pre></div><blockquote><p><strong>Note: Make sure that you are using the same Azure resource group name as the one you&rsquo;ve just used in the <em>azuredeploy.parameters.json</em> file.</strong></p></blockquote><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name Arc-Data-Postgres-Demo --location <span style=color:#4e9a06>&#34;East US&#34;</span>
az deployment group create --resource-group Arc-Data-Postgres-Demo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name arcdatapostgresdemo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_data_jumpstart/aks/arm_template/postgres_hs/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters azuredeploy.parameters.json
</code></pre></div><blockquote><p><strong>Note: Deployment time of the Azure Resource (AKS + Windows VM) can take ~25-30min long</strong></p></blockquote></li><li><p>Once Azure resources has been provisioned, you will be able to see it in Azure portal.</p><p><img src=./01.jpg alt="ARM template deployment completed"></p><p><img src=./02.jpg alt="New Azure resource group with all resources"></p></li></ul><h2 id=windows-login--post-deployment>Windows Login & Post Deployment</h2><p>Now that both the AKS cluster and the Windows Server client VM are created, it is time to login the Client VM.</p><ul><li><p>Using it&rsquo;s public IP, RDP to the <strong>Client VM</strong></p><p><img src=./03.jpg alt="Data Client VM public IP"></p></li><li><p>At first login, as mentioned in the &ldquo;Automation Flow&rdquo; section, a logon script will get executed. This script was created as part of the automated deployment process.</p><p>Let the script to run it&rsquo;s course and <strong>do not close</strong> the PowerShell session, this will be done for you once completed. You will notice that the Azure Arc Data Controller gets deployed on the AKS cluster. <strong>The logon script run time is 10-15min long</strong>.</p><p>Once the script will finish it&rsquo;s run, the logon script PowerShell session will be closed and the Azure Arc Data Controller and an Azure Postgres Hyperscale (and a sample DB) will be deployed on the AKS cluster and be ready to use.</p><p><img src=./04.jpg alt="PowerShell logon script run"></p><p><img src=./05.jpg alt="PowerShell logon script run"></p><p><img src=./06.jpg alt="PowerShell logon script run"></p><p><img src=./07.jpg alt="PowerShell logon script run"></p><p><img src=./08.jpg alt="PowerShell logon script run"></p></li><li><p>Initially, since the data controller was deployed in &ldquo;Directly Connected&rdquo; mode, only after the logon script run is will be completed, a new Azure resource for the controller will be created as well.</p><p><img src=./09.jpg alt="Data Controller in a resource group"></p><p><img src=./10.jpg alt="Data Controller resource"></p></li><li><p>Another tool automatically deployed is Azure Data Studio along with the <em>Azure Data CLI</em>, the <em>Azure Arc</em> and the <em>PostgreSQL</em> extensions. At the end of the logon script run, Azure Data Studio will automatically be open and connected to the Azure PostgreSQL Hyperscale server with the sample DB.</p><p><img src=./11.jpg alt="Azure Data Studio shortcut"></p><p><img src=./12.jpg alt="Azure Data Studio extension"></p><p><img src=./13.jpg alt="Azure PostgreSQL Hyperscale server with the sample DB"></p></li><li><p>(Optional) In PowerShell, login to the Data Controller and check it&rsquo;s health using the below commands.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000>azdata</span> <span style=color:#000>login</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-namespace</span> <span style=color:#000>$env:ARC_DC_NAME</span>
<span style=color:#000>azdata</span> <span style=color:#000>arc</span> <span style=color:#000>dc</span> <span style=color:#000>status</span> <span style=color:#000>show</span>
</code></pre></div><p><img src=./14.jpg alt="azdata login"></p></li></ul><h2 id=cleanup>Cleanup</h2><ul><li><p>To delete the Azure Arc Data Controller and all of it&rsquo;s Kubernetes resources as well as Postgres Hyperscale, run the <em>Postgres_Cleanup.ps1</em> PowerShell script located in <em>C:\tmp</em> on the Windows Client VM. At the end of it&rsquo;s run, the script will close all PowerShell sessions. <strong>The Cleanup script run time is 5-10min long</strong>.</p><p><img src=./15.jpg alt="Postgres_Cleanup PowerShell script run"></p></li><li><p>If you want to delete the entire environment, simply delete the deployment resource group from the Azure portal.</p><p><img src=./16.jpg alt="Delete Azure resource group"></p></li></ul><h2 id=re-deploy-azure-arc-data-controller--postgres>Re-Deploy Azure Arc Data Controller & Postgres</h2><p>In case you deleted the Azure Arc Data Controller and Postgres Hyperscale from the Kubernetes cluster, you can re-deploy it by running the <em>Postgres_Deploy.ps1</em> PowerShell script located in <em>C:\tmp</em> on the Windows Client VM. <strong>The Deploy script run time is approximately 15min long</strong>.</p><p><img src=./17.jpg alt="Re-Deploy Azure Arc Data Controller + PostgreSQL PowerShell script"></p><p><img src=./18.jpg alt="Re-Deploy Azure Arc Data Controller + PostgreSQL PowerShell script"></p><p><img src=./19.jpg alt="Re-Deploy Azure Arc Data Controller + PostgreSQL PowerShell script"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-d70863f525996f26010a52ca274a8bce>4.2 - Amazon Elastic Kubernetes Service</h1><div class=lead>If you are working in a multi-cloud environment, the scenario in this section will guide on creating an Amazon Elastic Kubernetes Service (EKS) with Azure Arc enabled data services integration in an automated fashion using Terraform.</div></div><div class=td-content><h1 id=pg-8837fdad1692ac50843da72c4bec59a5>4.2.1 - Data Controller Terraform plan</h1><h2 id=deploy-an-azure-arc-data-controller-vanilla-deployment-on-eks-using-terraform>Deploy an Azure Arc Data Controller Vanilla Deployment on EKS using Terraform</h2><p>The following README will guide you on how to deploy a &ldquo;Ready to Go&rdquo; environment so you can start using Azure Arc Data Services and deploy Azure data services on <a href=https://aws.amazon.com/eks/>Elastic Kubernetes Service (EKS)</a> cluster, using <a href=https://www.terraform.io/>Terraform</a>.</p><p>By the end of this guide, you will have an EKS cluster deployed with an Azure Arc Data Controller (<a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/connectivity>in &ldquo;Directly Connected&rdquo; mode</a>) and a Microsoft Windows Server 2019 (Datacenter) AWS EC2 instance VM, installed & pre-configured with all the required tools needed to work with Azure Arc Data Services.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled data services is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/release-notes>public preview</a></strong>.</p></blockquote><h2 id=deployment-process-overview>Deployment Process Overview</h2><ul><li>Create AWS IAM Role</li><li>Create & download AWS Key Pair</li><li>Clone the Azure Arc Jumpstart repository</li><li>Edit <em>TF_VAR</em> variables values</li><li><em>terraform init</em></li><li><em>terraform apply</em></li><li>EKS cleanup</li><li><em>terraform destroy</em></li></ul><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href=https://docs.aws.amazon.com/eks/latest/userguide/install-aws-iam-authenticator.html>Install AWS IAM Authenticator</a></p></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://aws.amazon.com/free/>Create a free Amazon Web Services account</a> if you don&rsquo;t already have one.</p></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a></strong></p></blockquote></li><li><p>Enable subscription for the Microsoft.AzureArcData resource provider for Azure Arc enabled data services. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.AzureArcData
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.AzureArcData -o table
</code></pre></div></li></ul><h2 id=create-a-new-aws-iam-role--key>Create a new AWS IAM Role & Key</h2><p>Create AWS User IAM Key. An access key grants programmatic access to your resources which we will be using later on in this guide.</p><ul><li><p>Navigate to the <a href=https://console.aws.amazon.com/iam/home#/home>IAM Access page</a>.</p><p><img src=./01.png alt="Create AWS IAM Role & Key"></p></li><li><p>Select the <strong>Users</strong> from the side menu.</p><p><img src=./02.png alt="Create AWS IAM Role & Key"></p></li><li><p>Select the <strong>User</strong> you want to create the access key for.</p><p><img src=./03.png alt="Create AWS IAM Role & Key"></p></li><li><p>Select <strong>Security credentials</strong> of the <strong>User</strong> selected.</p><p><img src=./04.png alt="Create AWS IAM Role & Key"></p></li><li><p>Under <strong>Access Keys</strong> select <strong>Create Access Keys</strong>.</p><p><img src=./05.png alt="Create AWS IAM Role & Key"></p></li><li><p>In the popup window it will show you the <em><strong>Access key ID</strong></em> and <em><strong>Secret access key</strong></em>. Save both of these values to configure the <strong>Terraform plan</strong> variables later.</p><p><img src=./06.png alt="Create AWS IAM Role & Key"></p></li><li><p>In order to open a RDP session to the Windows Client EC2 instance, an EC2 Key Pair is required. From the <em>Services</em> menu, click on <em>&ldquo;EC2&rdquo;</em>, enter the <em>Key Pairs</em> settings from the left sidebar (under the <em>Network & Security</em> section) and click on <em>&ldquo;Create key pair&rdquo;</em> (top-right corner) to create a new key pair.</p><p><img src=./07.png alt="Create EC2 Key Pair"></p><p><img src=./08.png alt="Create EC2 Key Pair"></p><p><img src=./09.png alt="Create EC2 Key Pair"></p></li><li><p>Provide a meaningful name, for example <em>terraform</em>, and click on <em>&ldquo;Create key pair&rdquo;</em> which will then automatically download the created <em>pem</em> file.</p><p><img src=./10.png alt="Create EC2 Key Pair"></p><p><img src=./11.png alt="Create EC2 Key Pair"></p><p><img src=./12.png alt="Create EC2 Key Pair"></p></li><li><p>Copy the downloaded <em>pem</em> file to where the terraform binaries are located (in your cloned repository directory).</p><p><img src=./13.png alt="Create EC2 Key Pair"></p><blockquote><p><strong>Note: EC2 Key Pairs are regional.</strong></p></blockquote></li></ul><h2 id=automation-flow>Automation Flow</h2><p>For you to get familiar with the automation and deployment flow, below is an explanation.</p><ul><li><p>User is editing and exporting Terraform runtime environment variables, AKA <em>TF_VAR</em> (1-time edit). The variables values are being used throughout the deployment.</p></li><li><p>User deploys the Terraform plan which will deploy the EKS cluster and the EC2 Windows Client instance as well as an Azure resource group. The Azure resource group is required to host the Azure Arc services you will be able to deploy such as Azure SQL Managed Instance and PostgreSQL Hyperscale.</p></li><li><p>In addition, the plan will copy the EKS <em>kubeconfig</em> file as well as the <em>configmap.yml</em> file (which is responsible for having the EKS nodes communicate with the cluster control plane) on to the Windows instance.</p></li><li><p>As part of the Windows Server 2019 VM deployment, there are 3 scripts executions:</p><ol><li><p><em>azure_arc.ps1</em> script will be created automatically as part of the Terraform plan runtime and is responsible on injecting the <em>TF_VAR</em> variables values on to the Windows instance which will then be used in both the <em>ClientTools</em> and the <em>LogonScript</em> scripts.</p></li><li><p><em>ClientTools.ps1</em> script will run at the Terraform plan runtime Runtime and will:</p><ul><li>Create the <em>ClientTools.log</em> file</li><li>Install the required tools – az cli, az cli Powershell module, kubernetes-cli, aws-iam-authenticator, Visual C++ Redistributable (Chocolaty packages)</li><li>Download Azure Data Studio & Azure Data CLI</li><li>Download the <em>DC_Cleanup</em> and <em>DC_Deploy</em> Powershell scripts</li><li>Create the logon script</li><li>Create the Windows schedule task to run the logon script at first login</li></ul></li><li><p><em>LogonScript.ps1</em> script will run on user first logon to Windows and will:</p><ul><li>Create the <em>LogonScript.log</em> file</li><li>Install Azure Data Studio & Azure Data CLI</li><li>Install the Azure Data Studio Azure Data CLI, Azure Arc & PostgreSQL extensions</li><li>Apply the <em>configmap.yml</em> file on the EKS cluster</li><li>Create the <em>azdata</em> config file in user Windows profile</li><li>Create the Azure Data Studio desktop shortcut</li><li>Open another Powershell session which will execute a command to watch the deployed Azure Arc Data Controller Kubernetes pods</li><li>Deploy the Arc Data Controller in <strong>&ldquo;Directly Connected&rdquo; mode</strong> using the <em>TF_VAR</em> variables values</li><li>Unregister the logon script Windows schedule task so it will not run after first login</li></ul></li></ol></li></ul><h2 id=deployment>Deployment</h2><p>As mentioned, the Terraform plan will deploy an EKS cluster, the Azure Arc Data Controller on that cluster and an EC2 Windows Server 2019 Client instance.</p><ul><li><p>Before running the Terraform plan, edit the below <em>TF_VAR</em> values and export it (simply copy/paste it after you finished edit these). An example <em>TF_VAR</em> shell script file is located <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_data_jumpstart/eks/dc_vanilla/terraform/example/TF_VAR_example.sh>here</a></p><p><img src=./14.png alt="Export environment variables"></p><ul><li><em>export TF_VAR_AWS_ACCESS_KEY_ID</em>=&lsquo;Your AWS Access Key ID (Created in the prerequisites section)&rsquo;</li><li><em>export TF_VAR_AWS_SECRET_ACCESS_KEY</em>=&lsquo;Your AWS Secret Key (Created in the prerequisites section)&rsquo;</li><li><em>export TF_VAR_key_name</em>=&lsquo;Your AWS Key Pair name (Created in the prerequisites section)&rsquo;</li><li><em>export TF_VAR_key_pair_filename</em>=&lsquo;Your AWS Key Pair *.pem filename (Created in the prerequisites section)&rsquo;</li><li><em>export TF_VAR_aws_region</em>=&lsquo;Your AWS region where resources will get deployed&rsquo; (Since key pairs are regional, make sure both AWS region and availability zone matches the ones where the key pair was created)</li><li><em>export TF_VAR_aws_availabilityzone</em>=&lsquo;Your AWS availability zone&rsquo; (Since key pairs are regional, make sure both AWS region and availability zone matches the ones where the key pair was created)</li><li><em>export TF_VAR_SPN_CLIENT_ID</em>=&lsquo;Your Azure service principal name&rsquo;</li><li><em>export TF_VAR_SPN_CLIENT_SECRET</em>=&lsquo;Your Azure service principal password&rsquo;</li><li><em>export TF_VAR_SPN_TENANT_ID</em>=&lsquo;Your Azure tenant ID&rsquo;</li><li><em>export TF_VAR_SPN_AUTHORITY</em>=<em><a href=https://login.microsoftonline.com>https://login.microsoftonline.com</a></em> <strong>Do not change</strong></li><li><em>export TF_VAR_AZDATA_USERNAME</em>=&lsquo;Azure Arc Data Controller admin username&rsquo;</li><li><em>export TF_VAR_AZDATA_PASSWORD</em>=&lsquo;Azure Arc Data Controller admin password&rsquo; (The password must be at least 8 characters long and contain characters from three of the following four sets: uppercase letters, lowercase letters, numbers, and symbols)</li><li><em>export TF_VAR_ARC_DC_NAME</em>=&lsquo;Azure Arc Data Controller name&rsquo; (The name must consist of lowercase alphanumeric characters or &lsquo;-&rsquo;, and must start and end with a alphanumeric character. This name will be used for k8s namespace as well)</li><li><em>export TF_VAR_ARC_DC_SUBSCRIPTION</em>=&lsquo;Azure Arc Data Controller Azure subscription ID&rsquo;</li><li><em>export TF_VAR_ARC_DC_RG</em>=&lsquo;Azure resource group where all future Azure Arc resources will be deployed&rsquo;</li><li><em>export TF_VAR_ARC_DC_REGION</em>=&lsquo;Azure location where the Azure Arc Data Controller resource will be created in Azure&rsquo; (Currently, supported regions supported are eastus, eastus2, centralus, westus2, westeurope, southeastasia)</li></ul></li><li><p>Navigate to the folder that has Terraform binaries.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>cd</span> azure_arc_data_jumpstart/eks/dc_vanilla/terraform
</code></pre></div></li><li><p>Run the <code>terraform init</code> command which is used to initialize a working directory containing Terraform configuration files and load the required Terraform providers.</p><p><img src=./15.png alt="terraform init"></p></li><li><p>(Optional but recommended) Run the <code>terraform plan</code> command to make sure everything is configured properly.</p><p><img src=./16.png alt="terraform plan"></p></li><li><p>Run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish. <strong>Runtime for deploying all the AWS resources for this plan is ~30min.</strong></p></li><li><p>Once completed, the plan will output a decrypted password for your Windows Client instance. Before connecting to the Client instance, you can review the EKS cluster and the EC2 instances created. Notice how 3 instances were created; 2 EKS nodes and the Client instance.</p><p><img src=./17.png alt="terraform apply"></p><p><img src=./18.png alt="New EKS cluster"></p><p><img src=./19.png alt="New EKS cluster"></p><p><img src=./20.png alt="New EC2 instances"></p><p><img src=./21.png alt="New EC2 instances"></p><p><img src=./22.png alt="New EC2 instances"></p></li><li><p>In the Azure Portal, a new empty Azure resource group was created which will be used for Azure Arc Data Controller and the other data services you will be deploying in the future.</p><p><img src=./23.png alt="New empty Azure resource group"></p></li></ul><h2 id=windows-login--post-deployment>Windows Login & Post Deployment</h2><p>Now that we have both the EKS cluster and the Windows Server Client instance created, it is time to login to the Client VM.</p><ul><li><p>Select the Windows instance, click <em>&ldquo;Connect&rdquo;</em> and download the Remote Desktop file.</p><p><img src=./24.png alt="RDP to the Client instance"></p><p><img src=./25.png alt="RDP to the Client instance"></p><p><img src=./26.png alt="RDP to the Client instance"></p></li><li><p>Using the decrypted password, RDP the Windows instance. In case you need to get the password later, use the <code>terraform output</code> command to re-present the plan output.</p></li><li><p>At first login, as mentioned in the &ldquo;Automation Flow&rdquo; section, a logon script will get executed. This script was created as part of the automated deployment process.</p></li><li><p>Let the script to run it&rsquo;s course and <strong>do not close</strong> the PowerShell session, this will be done for you once completed. You will notice that the Azure Arc Data Controller gets deployed on the EKS cluster. <strong>The logon script run time is approximately 10min long</strong>.</p><p>Once the script will finish it&rsquo;s run, the logon script PowerShell session will be close and the Azure Arc Data Controller will be deployed on the EKS cluster and be ready to use.</p><p><img src=./27.png alt="PowerShell login script run"></p><p><img src=./28.png alt="PowerShell login script run"></p><p><img src=./29.png alt="PowerShell logon script run"></p><p><img src=./30.png alt="PowerShell login script run"></p><p><img src=./31.png alt="PowerShell login script run"></p><p><img src=./32.png alt="PowerShell logon script run"></p></li><li><p>Initially, since the data controller was deployed in &ldquo;Directly Connected&rdquo; mode, only after the logon script run is will be completed, a new Azure resource for the controller will be created as well.</p><p><img src=./33.png alt="Data Controller in a resource group"></p><p><img src=./34.png alt="Data Controller resource"></p></li><li><p>Using PowerShell, login to the Data Controller and check it&rsquo;s health using the below commands.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>azdata login --namespace <span style=color:#000>$env</span>:ARC_DC_NAME
azdata arc dc status show
</code></pre></div><p><img src=./35.png alt="azdata login"></p></li><li><p>Another tool automatically deployed is Azure Data Studio along with the <em>Azure Data CLI</em>, the <em>Azure Arc</em> and the <em>PostgreSQL</em> extensions. Using the Desktop shortcut created for you, open Azure Data Studio and click the Extensions settings to see both extensions.</p><p><img src=./36.png alt="Azure Data Studio shortcut"></p><p><img src=./37.png alt="Azure Data Studio extension"></p></li></ul><h2 id=cleanup>Cleanup</h2><ul><li><p>To delete the Azure Arc Data Controller and all of it&rsquo;s Kubernetes resources, run the <em>DC_Cleanup.ps1</em> PowerShell script located in <em>C:\tmp</em> on the Windows Client instance. At the end of it&rsquo;s run, the script will close all PowerShell sessions. <strong>The Cleanup script run time is ~2-3min long</strong>.</p><p><img src=./38.png alt="DC_Cleanup PowerShell script run"></p></li></ul><h2 id=re-deploy-azure-arc-data-controller>Re-Deploy Azure Arc Data Controller</h2><ul><li><p>In case you deleted the Azure Arc Data Controller from the EKS cluster, you can re-deploy it by running the <em>DC_Deploy.ps1</em> PowerShell script located in <em>C:\tmp</em> on the Windows Client instance. <strong>The Deploy script run time is approximately ~3-4min long</strong>.</p><p><img src=./39.png alt="Re-Deploy Azure Arc Data Controller PowerShell script"></p></li></ul><h2 id=delete-the-deployment>Delete the deployment</h2><p>To completely delete the environment, follow the below steps:</p><ul><li><p>on the Windows Client instance, run the <em>DC_Cleanup.ps1</em> PowerShell script.</p></li><li><p>Run the <code>terraform destroy --auto-approve</code> which will delete all of the AWS resources as well as the Azure resource group. <strong>The <em>terraform destroy</em> run time is approximately ~5-10min long</strong>.</p><p><img src=./40.png alt="terraform destroy"></p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b0a3ec2e3953376bf0aa17e63f36c93c>4.3 - Google Kubernetes Engine</h1><div class=lead>If you are working in a multi-cloud environment, the scenario in this section will guide on creating a Google Kubernetes Engine (GKE) with Azure Arc enabled data services integration in an automated fashion using Terraform.</div></div><div class=td-content><h1 id=pg-b8cb9eadc7cc3146b19781c3ed7d36cc>4.3.1 - Data Controller Terraform plan</h1><h2 id=deploy-an-azure-arc-data-controller-vanilla-deployment-on-gke-using-terraform>Deploy an Azure Arc Data Controller Vanilla Deployment on GKE using Terraform</h2><p>The following README will guide you on how to deploy a &ldquo;Ready to Go&rdquo; environment so you can start using Azure Arc Data Services and deploy Azure data services on a <a href=https://cloud.google.com/kubernetes-engine>Google Kubernetes Engine (GKE)</a> cluster, using <a href=https://www.terraform.io/>Terraform</a>.</p><p>By the end of this guide, you will have a GKE cluster deployed with an Azure Arc Data Controller (<a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/connectivity>in &ldquo;Directly Connected&rdquo; mode</a>) and a Microsoft Windows Server 2019 (Datacenter) GKE compute instance VM, installed & pre-configured with all the required tools needed to work with Azure Arc Data Services.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled data services is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/release-notes>public preview</a></strong>.</p></blockquote><h2 id=deployment-process-overview>Deployment Process Overview</h2><ul><li>Create a Google Cloud Platform (GCP) project, IAM Role & Service Account</li><li>Download credentials file</li><li>Clone the Azure Arc Jumpstart repository</li><li>Edit <em>TF_VAR</em> variables values</li><li><em>terraform init</em></li><li><em>terraform apply</em></li><li><em>terraform destroy</em></li></ul><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p><a href=https://cloud.google.com/free>Create a free Google Cloud account</a> if you don&rsquo;t have one already.</p></li><li><p><a href=https://learn.hashicorp.com/terraform/getting-started/install.html>Install Terraform >=0.12</a></p></li><li><p>Create Azure service principal (SP)</p><p>To connect a Kubernetes cluster to Azure Arc, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure CloudShell</a>)</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcK8s&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional, but highly recommended, to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a>.</strong></p></blockquote></li><li><p>Enable subscription for the Microsoft.AzureArcData resource provider for Azure Arc enabled data services. Registration is an asynchronous process, and registration may take approximately 10 minutes.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider register --namespace Microsoft.AzureArcData
</code></pre></div><p>You can monitor the registration process with the following commands:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az provider show -n Microsoft.AzureArcData -o table
</code></pre></div></li><li><p>Create a new GCP Project, IAM Role & Service Account. In order to deploy resources in GCP, we will create a new GCP Project as well as a service account to allow Terraform to authenticate against GCP APIs and run the plan to deploy resources.</p></li><li><p>Browse to <a href=https://console.cloud.google.com/>https://console.cloud.google.com/</a> and login with your Google Cloud account. Once logged in, <a href=https://cloud.google.com/resource-manager/docs/creating-managing-projects>create a new project</a> named &ldquo;Azure Arc Demo&rdquo;. After creating it, be sure to copy down the project id as it is usually different then the project name.</p><p><img src=./01.png alt="GCP new project"></p><p><img src=./02.png alt="GCP new project"></p><p><img src=./03.png alt="GCP new project"></p></li><li><p>Enable the Compute Engine API for the project, create a project Owner service account credentials and download the private key JSON file and copy the file to the directory where Terraform files are located. Change the JSON file name (for example <em>account.json</em>). The Terraform plan will be using the credentials stored in this file to authenticate against your GCP project.</p><p><img src=./04.png alt="Enable Compute Engine API"></p><p><img src=./05.png alt="Enable Compute Engine API"></p><p><img src=./06.png alt="Add credentials"></p><p><img src=./07.png alt="Add credentials"></p><p><img src=./08.png alt="Add credentials"></p><p><img src=./09.png alt="Add credentials"></p><p><img src=./10.png alt="Add credentials"></p><p><img src=./11.png alt="Create private key"></p><p><img src=./12.png alt="Create private key"></p><p><img src=./13.png alt="Create private key"></p><p><img src=./14.png alt="Create private key"></p><p><img src=./15.png alt=account.json></p><p><img src=./16.png alt=account.json></p></li><li><p>Enable the Kubernetes Engine API for the project</p><p><img src=./17.png alt="Enable the Kubernetes Engine API"></p><p><img src=./18.png alt="Enable the Kubernetes Engine API"></p></li></ul><h2 id=automation-flow>Automation Flow</h2><p>For you to get familiar with the automation and deployment flow, below is an explanation.</p><ul><li><p>User is editing and exporting Terraform runtime environment variables, AKA <em>TF_VAR</em> (1-time edit). The variables values are being used throughout the deployment.</p></li><li><p>User deploys the Terraform plan which will deploy the GKE cluster and the GCP compute instance VM as well as an Azure resource group. The Azure resource group is required to host the Azure Arc services you will be able to deploy such as Azure SQL Managed Instance and PostgreSQL Hyperscale.</p></li><li><p>In addition, the plan will copy the <em>local_ssd_sc.yaml</em> file which will be used to create a Kubernetes Storage Class backed by SSD disks that will be used by Arc Data Controller to create <a href=https://kubernetes.io/docs/concepts/storage/persistent-volumes/>persistent volume claims (PVC)</a>.</p><blockquote><p><strong>Note: Depending on the GCP region, make sure you do not have any <a href=https://cloud.google.com/compute/quotas>SSD quota limit in the region</a>, otherwise, the Azure Arc Data Controller kubernetes resources will fail to deploy.</strong></p></blockquote></li><li><p>As part of the Windows Server 2019 VM deployment, there are 4 scripts executions:</p><ol><li><p><em>azure_arc.ps1</em> script will be created automatically as part of the Terraform plan runtime and is responsible on injecting the <em>TF_VAR</em> variables values on to the Windows instance which will then be used in both the <em>ClientTools</em> and the <em>LogonScript</em> scripts.</p></li><li><p><em>password_reset.ps1</em> script will be created automatically as part of the Terraform plan runtime and is responsible on creating the Windows username & password.</p></li><li><p><em>ClientTools.ps1</em> script will run at the Terraform plan runtime Runtime and will:</p><ul><li>Create the <em>ClientTools.log</em> file</li><li>Install the required tools – az cli, az cli Powershell module, kubernetes-cli, Visual C++ Redistributable (Chocolaty packages)</li><li>Download Azure Data Studio & Azure Data CLI</li><li>Download the <em>DC_Cleanup</em> and <em>DC_Deploy</em> Powershell scripts</li><li>Disable Windows Server Manager</li><li>Create the logon script</li><li>Create the Windows schedule task to run the logon script at first login</li></ul></li><li><p><em>LogonScript.ps1</em> script will run on user first logon to Windows and will:</p><ul><li>Create the <em>LogonScript.log</em> file</li><li>Install the Azure Data Studio Azure Data CLI, Azure Arc & PostgreSQL extensions</li><li>Create the Azure Data Studio desktop shortcut</li><li>Apply the <em>local_ssd_sc.yaml</em> file on the GKE cluster</li><li>Create the <em>azdata</em> config file in user Windows profile</li><li>Open another Powershell session which will execute a command to watch the deployed Azure Arc Data Controller Kubernetes pods</li><li>Create Arc Data Controller config file (<em>control.json</em>) to setup the use of the Storage Class and Kubernetes LoadBalancer service</li><li>Deploy the Arc Data Controller <strong>&ldquo;Directly Connected&rdquo; mode</strong> using the <em>TF_VAR</em> variables values</li><li>Unregister the logon script Windows schedule task so it will not run after first login</li></ul></li></ol></li></ul><h2 id=deployment>Deployment</h2><p>As mentioned, the Terraform plan will deploy a GKE cluster, the Azure Arc Data Controller on that cluster and a Windows Server 2019 Client GCP compute instance.</p><ul><li><p>Before running the Terraform plan, edit the below <em>TF_VAR</em> values and export it (simply copy/paste it after you finished edit these). An example <em>TF_VAR</em> shell script file is located <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_data_jumpstart/gke/terraform/example/TF_VAR_example.sh>here</a></p><p><img src=./19.png alt="Terraform vars export"></p><ul><li><em>export TF_VAR_gcp_project_id</em>=&lsquo;Your GCP Project ID (Created in the prerequisites section)&rsquo;</li><li><em>export TF_VAR_gcp_credentials_filename</em>=&lsquo;Your GCP Credentials JSON filename (Created in the prerequisites section)&rsquo;</li><li><em>export TF_VAR_gcp_region</em>=&lsquo;GCP region where resource will be created&rsquo;</li><li><em>export TF_VAR_gcp_zone</em>=&lsquo;GCP zone where resource will be created&rsquo;</li><li><em>export TF_VAR_gke_cluster_name</em>=&lsquo;GKE cluster name&rsquo;</li><li><em>export TF_VAR_admin_username</em>=&lsquo;GKE cluster administrator username&rsquo;</li><li><em>export TF_VAR_admin_password</em>=&lsquo;GKE cluster administrator password&rsquo;</li><li><em>export TF_VAR_gke_cluster_node_count</em>=&lsquo;GKE cluster number of worker nodes&rsquo;</li><li><em>export TF_VAR_windows_username</em>=&lsquo;Windows Server Client compute instance VM administrator username&rsquo;</li><li><em>export TF_VAR_windows_password</em>=&lsquo;Windows Server Client compute instance VM administrator password&rsquo; (The password must be at least 8 characters long and contain characters from three of the following four sets: uppercase letters, lowercase letters, numbers, and symbols as well as <strong>not containing</strong> the user&rsquo;s account name or parts of the user&rsquo;s full name that exceed two consecutive characters)</li><li><em>export TF_VAR_SPN_CLIENT_ID</em>=&lsquo;Your Azure service principal name&rsquo;</li><li><em>export TF_VAR_SPN_CLIENT_SECRET</em>=&lsquo;Your Azure service principal password&rsquo;</li><li><em>export TF_VAR_SPN_TENANT_ID</em>=&lsquo;Your Azure tenant ID&rsquo;</li><li><em>export TF_VAR_SPN_AUTHORITY</em>=<em><a href=https://login.microsoftonline.com>https://login.microsoftonline.com</a></em> <strong>Do not change</strong></li><li><em>export TF_VAR_AZDATA_USERNAME</em>=&lsquo;Azure Arc Data Controller admin username&rsquo;</li><li><em>export TF_VAR_AZDATA_PASSWORD</em>=&lsquo;Azure Arc Data Controller admin password&rsquo; (The password must be at least 8 characters long and contain characters from three of the following four sets: uppercase letters, lowercase letters, numbers, and symbols)</li><li><em>export TF_VAR_ARC_DC_NAME</em>=&lsquo;Azure Arc Data Controller name&rsquo; (The name must consist of lowercase alphanumeric characters or &lsquo;-&rsquo;, and must start and end with a alphanumeric character. This name will be used for k8s namespace as well)</li><li><em>export TF_VAR_ARC_DC_SUBSCRIPTION</em>=&lsquo;Azure Arc Data Controller Azure subscription ID&rsquo;</li><li><em>export TF_VAR_ARC_DC_RG</em>=&lsquo;Azure resource group where all future Azure Arc resources will be deployed&rsquo;</li><li><em>export TF_VAR_ARC_DC_REGION</em>=&lsquo;Azure location where the Azure Arc Data Controller resource will be created in Azure&rsquo; (Currently, supported regions supported are eastus, eastus2, centralus, westus2, westeurope, southeastasia)</li></ul></li><li><p>Navigate to the folder that has Terraform binaries.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#204a87>cd</span> azure_arc_data_jumpstart/gke/terraform
</code></pre></div></li><li><p>Run the <code>terraform init</code> command which is used to initialize a working directory containing Terraform configuration files and load the required Terraform providers.</p><p><img src=./20.png alt="terraform init"></p></li><li><p>(Optional but recommended) Run the <code>terraform plan</code> command to make sure everything is configured properly.</p><p><img src=./21.png alt="terraform plan"></p></li><li><p>Run the <code>terraform apply --auto-approve</code> command and wait for the plan to finish. <strong>Runtime for deploying all the GCP resources for this plan is ~20-30min.</strong></p></li><li><p>Once completed, you can review the GKE cluster and the worker nodes resources as well as the GCP compute instance VM created.</p><p><img src=./22.png alt="terraform apply completed"></p><p><img src=./23.png alt="GKE cluster"></p><p><img src=./24.png alt="GKE cluster"></p><p><img src=./25.png alt="GCP VM instances"></p><p><img src=./26.png alt="GCP VM instances"></p></li><li><p>In the Azure Portal, a new empty Azure resource group was created which will be used for Azure Arc Data Controller and the other data services you will be deploying in the future.</p><p><img src=./27.png alt="New empty Azure resource group"></p></li></ul><h2 id=windows-login--post-deployment>Windows Login & Post Deployment</h2><p>Now that we have both the GKE cluster and the Windows Server Client instance created, it is time to login to the Client VM.</p><ul><li><p>Select the Windows instance, click on the RDP dropdown and download the RDP file. Using your <em>windows_username</em> and <em>windows_password</em> credentials, log in to the VM.</p><p><img src=./28.png alt="GCP Client VM RDP"></p><p><img src=./29.png alt="GCP Client VM RDP"></p></li><li><p>At first login, as mentioned in the &ldquo;Automation Flow&rdquo; section, a logon script will get executed. This script was created as part of the automated deployment process.</p><p>Let the script to run it&rsquo;s course and <strong>do not close</strong> the PowerShell session, this will be done for you once completed. You will notice that the Azure Arc Data Controller gets deployed on the GKE cluster. <strong>The logon script run time is approximately 10min long</strong>.</p><p>Once the script will finish it&rsquo;s run, the logon script PowerShell session will be close and the Azure Arc Data Controller will be deployed on the GKE cluster and be ready to use.</p><p><img src=./30.png alt="PowerShell login script run"></p><p><img src=./31.png alt="PowerShell login script run"></p><p><img src=./32.png alt="PowerShell login script run"></p><p><img src=./33.png alt="PowerShell login script run"></p><p><img src=./34.png alt="PowerShell login script run"></p><p><img src=./35.png alt="PowerShell login script run"></p></li><li><p>Initially, since the data controller was deployed in &ldquo;Directly Connected&rdquo; mode, only after the logon script run is will be completed, a new Azure resource for the controller will be created as well.</p><p><img src=./36.png alt="Data Controller in a resource group"></p><p><img src=./37.png alt="Data Controller resource"></p></li><li><p>Using PowerShell, login to the Data Controller and check it&rsquo;s health using the below commands.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000>azdata</span> <span style=color:#000>login</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-namespace</span> <span style=color:#000>$env:ARC_DC_NAME</span>
<span style=color:#000>azdata</span> <span style=color:#000>arc</span> <span style=color:#000>dc</span> <span style=color:#000>status</span> <span style=color:#000>show</span>
</code></pre></div><p><img src=./38.png alt="azdata login"></p></li><li><p>Another tool automatically deployed is Azure Data Studio along with the <em>Azure Data CLI</em>, the <em>Azure Arc</em> and the <em>PostgreSQL</em> extensions. Using the Desktop shortcut created for you, open Azure Data Studio and click the Extensions settings to see both extensions.</p><p><img src=./39.png alt="Azure Data Studio shortcut"></p><p><img src=./40.png alt="Azure Data Studio extension"></p></li></ul><h2 id=cleanup>Cleanup</h2><ul><li><p>To delete the Azure Arc Data Controller and all of it&rsquo;s Kubernetes resources, run the <em>DC_Cleanup.ps1</em> PowerShell script located in <em>C:\tmp</em> on the Windows Client instance. At the end of it&rsquo;s run, the script will close all PowerShell sessions. <strong>The Cleanup script run time is ~2-3min long</strong>.</p><p><img src=./41.png alt="DC_Cleanup PowerShell script run"></p></li></ul><h2 id=re-deploy-azure-arc-data-controller>Re-Deploy Azure Arc Data Controller</h2><p>In case you deleted the Azure Arc Data Controller from the GKE cluster, you can re-deploy it by running the <em>DC_Deploy.ps1</em> PowerShell script located in <em>C:\tmp</em> on the Windows Client instance. <strong>The Deploy script run time is approximately ~3-4min long</strong>.</p><p><img src=./42.png alt="Re-Deploy Azure Arc Data Controller PowerShell script"></p><h2 id=delete-the-deployment>Delete the deployment</h2><p>To completely delete the environment, follow the below steps run the <code>terraform destroy --auto-approve</code> command which will delete all of the GCP resources as well as the Azure resource group. <strong>The <em>terraform destroy</em> run time is approximately ~5-6min long</strong>.</p><p><img src=./43.png alt="terraform destroy"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-afa54bcc6f5679cb5d63462c1eff04a6>4.4 - Upstream Kubernetes (Kubeadm)</h1><div class=lead>If you do not have a Kubernetes cluster, the scenario in this section will guide on creating a Kubernetes cluster using kubeadm in an Azure VM with Azure Arc enabled data services integration in an automated fashion using ARM template.</div></div><div class=td-content><h1 id=pg-2112d779f6fa22c76cef146c2063f97c>4.4.1 - Data Controller Azure VM ARM Template</h1><h2 id=deploy-an-azure-arc-data-controller-vanilla-deployment-on-kubeadm-azure-vm-using-arm-template>Deploy an Azure Arc Data Controller Vanilla Deployment on Kubeadm Azure VM using ARM Template</h2><p>The following README will guide you on how to deploy a &ldquo;Ready to Go&rdquo; environment so you can start using Azure Arc Data Services and deploy Azure data services on single-node Kubernetes cluster deployed with <a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/>Kubeadm</a> in az Azure Ubuntu VM, using <a href=https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview>Azure ARM Template</a>.</p><p>By the end of this guide, you will an Ubuntu VM deployed with an Azure Arc Data Controller (<a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/connectivity>in &ldquo;Directly Connected&rdquo; mode</a>) and a Microsoft Windows Server 2019 (Datacenter) Azure VM, installed & pre-configured with all the required tools needed to work with Azure Arc Data Services.</p><blockquote><p><strong>Note: Currently, Azure Arc enabled data services is in <a href=https://docs.microsoft.com/en-us/azure/azure-arc/data/release-notes>public preview</a></strong>.</p></blockquote><h2 id=prerequisites>Prerequisites</h2><ul><li><p>Clone the Azure Arc Jumpstart repository</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/microsoft/azure_arc.git
</code></pre></div></li><li><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Install or update Azure CLI to version 2.7.0 and above</a>. Use the below command to check your current installed version.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az --version
</code></pre></div></li><li><p>Create Azure service principal (SP)</p><p>In order for you to deploy the Azure resources using the ARM template, Azure service principal assigned with the &ldquo;Contributor&rdquo; role is required. To create it, login to your Azure account run the below command (this can also be done in <a href=https://shell.azure.com/>Azure Cloud Shell</a>).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az login
az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;&lt;Unique SP Name&gt;&#34;</span> --role contributor
</code></pre></div><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az ad sp create-for-rbac -n <span style=color:#4e9a06>&#34;http://AzureArcData&#34;</span> --role contributor
</code></pre></div><p>Output should look like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
<span style=color:#204a87;font-weight:700>&#34;appId&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;displayName&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;AzureArcData&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;http://AzureArcData&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;password&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span><span style=color:#000;font-weight:700>,</span>
<span style=color:#204a87;font-weight:700>&#34;tenant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><blockquote><p><strong>Note: It is optional but highly recommended to scope the SP to a specific <a href="https://docs.microsoft.com/en-us/cli/azure/ad/sp?view=azure-cli-latest">Azure subscription and resource group</a>.</strong></p></blockquote></li></ul><h2 id=automation-flow>Automation Flow</h2><p>For you to get familiar with the automation and deployment flow, below is an explanation.</p><ul><li><p>User is editing the ARM template parameters file (1-time edit). These parameters values are being used throughout the deployment.</p></li><li><p>Main ARM template will deploy an Ubuntu VM. The ARM template will call the the Azure <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/custom-script-linux>Linux Custom Script Extension</a> to:</p></li><li><p>Deploy a single-node Kubernetes cluster using Kubeadm.</p></li><li><p>Deploy the Azure Arc Data Controller in <strong>&ldquo;Directly Connected&rdquo; mode</strong> on that cluster.</p></li><li><p>Once Ubuntu VM deployment has finished, the main ARM template will call a secondary ARM template which is depended on a successful Ubuntu VM deployment.</p></li><li><p>Secondary ARM template will deploy a client Windows Server 2019 VM.</p></li><li><p>As part of the Windows Server 2019 VM deployment, there are 2 script executions; First PowerShell script <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_data_jumpstart/kubeadm/azure/arm_template/scripts/ClientTools.ps1>ClientTools.ps1</a> at deployment runtime using the ARM <em>CustomScriptExtension</em> module and the second PowerShell script <em>LogonScript.ps1</em> on user first logon to Windows.</p></li><li><p>Runtime script will:</p><ul><li>Inject user parameters values (from bullet point #1) to be used in both runtime and logon script</li><li>Install the required tools – az cli, az cli PowerShell module, kubernetes-cli and putty (Chocolaty packages)</li><li>Download & install the Azure Data Studio & azdata cli</li><li>Download the Azure Data Studio Azure Data CLI, Azure Arc & PostgreSQL extensions</li><li>Create the logon script</li><li>Create the Windows schedule task to run the logon script at first login</li><li>Disable Windows Server Manager from running at login</li></ul></li><li><p>Logon script will:</p><ul><li>Create the <em>LogonScript.log</em> file</li><li>Connect to Azure using SPN credentials (from bullet point #1)</li><li>Copy the kubeconfig file from the Ubuntu (Kubeadm) VM to the local Windows user profile</li><li>Install the Azure Data Studio Azure Data CLI, Azure Arc & PostgreSQL extensions</li><li>Create the Azure Data Studio desktop shortcut</li><li>Unregister the logon script Windows schedule task so it will not run after first login</li></ul></li></ul><h2 id=deployment>Deployment</h2><p>As mentioned, this deployment will leverage ARM templates. You will deploy a single template, responsible on deploying Ubuntu VM install with Kubernetes and the Data Controller. Once Ubuntu VM deployment has finished, the template will then automatically execute another template which will deploy the Windows Server Azure VM which will be automatically connected to the Kubernetes cluster.</p><ul><li><p>The deployment is using the ARM template parameters file. Before initiating the deployment, edit the <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_data_jumpstart/kubeadm/azure/arm_template/azuredeploy.parameters.json><em>azuredeploy.parameters.json</em></a> file located in your local cloned repository folder. An example parameters file is located <a href=https://github.com/microsoft/azure_arc/blob/main/azure_arc_data_jumpstart/kubeadm/azure/arm_template/azuredeploy.parameters.example.json>here</a>.</p><ul><li><em>K8svmName</em> - Kubeadm Ubuntu</li><li><em>vmName</em> - Client Windows</li><li><em>adminUsername</em> - Client Windows VM</li><li><em>adminPassword</em> - Client Windows VM</li><li><em>K8sVMSize</em> - Kubeadm Ubuntu</li><li><em>vmSize</em> - Client Windows</li><li><em>SPN_CLIENT_ID</em> - Your Azure service principal name</li><li><em>SPN_CLIENT_SECRET</em> - Your Azure service principal password</li><li><em>SPN_TENANT_ID</em> - Your Azure tenant ID</li><li><em>SPN_AUTHORITY</em> - <em><a href=https://login.microsoftonline.com>https://login.microsoftonline.com</a></em> <strong>Do not change</strong></li><li><em>AZDATA_USERNAME</em> - Azure Arc Data Controller</li><li><em>AZDATA_PASSWORD</em> - Azure Arc Data Controller admin password (The password must be at least 8 characters long and contain characters from three of the following four sets: uppercase letters, lowercase letters, numbers, and symbols.)</li><li><em>ACCEPT_EULA</em> - &ldquo;yes&rdquo; <strong>Do not change</strong></li><li><em>ARC_DC_NAME</em> - Azure Arc Data Controller name. The name must consist of lowercase alphanumeric characters or &lsquo;-&rsquo;, and must start and end with a alphanumeric character (This name will be used for *s namespace as well).</li><li><em>ARC_DC_SUBSCRIPTION</em> - Azure Arc Data Controller Azure subscription ID</li><li><em>ARC_DC_RG</em> - Azure resource group where all the resources get deploy</li><li><em>ARC_DC_REGION</em> - Azure location where the Azure Arc Data Controller resource will be created in Azure (Currently, supported regions supported are eastus, eastus2, centralus, westus2, westeurope, southeastasia)</li></ul></li><li><p>To deploy the ARM template, navigate to the local cloned <a href=https://github.com/microsoft/azure_arc/tree/main/azure_arc_data_jumpstart/kubeadm/azure/arm_template>deployment folder</a> and run the below command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name &lt;Name of the Azure resource group&gt; --location &lt;Azure region&gt;
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group &lt;Name of the Azure resource group&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name &lt;The name of this deployment&gt; <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_data_jumpstart/kubeadm/azure/arm_template/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters &lt;The *azuredeploy.parameters.json* parameters file location&gt;
</code></pre></div><blockquote><p><strong>Note: Make sure that you are using the same Azure resource group name as the one you&rsquo;ve just used in the <em>azuredeploy.parameters.json</em> file</strong></p></blockquote><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>az group create --name rc-Data-Kubeadm-Demo --location <span style=color:#4e9a06>&#34;East US&#34;</span>
az deployment group create <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--resource-group Arc-Data-Kubeadm-Demo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--name arcdatakubeadmdemo <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--template-uri https://raw.githubusercontent.com/microsoft/azure_arc/main/azure_arc_data_jumpstart/kubeadm/azure/arm_template/azuredeploy.json <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>--parameters azuredeploy.parameters.json
</code></pre></div><blockquote><p><strong>Note: Deployment time of the Azure Resource (Ubuntu VM + Windows VM) can take ~15-20 minutes.</strong></p></blockquote></li><li><p>Once Azure resources have been provisioned, you will be able to see it in Azure portal with the Azure Arc Data Controller included.</p><p><img src=./01.png alt="A successful ARM deployment"></p><p><img src=./02.png alt="Post-Deployment resource group"></p></li></ul><h2 id=windows-login--post-deployment>Windows Login & Post Deployment</h2><p>Now that both the Ubuntu Kubernetes VM and the Windows Server client VM are created, it is time to login the Client VM.</p><ul><li><p>Using it&rsquo;s public IP, RDP to the <strong>Client VM</strong></p><p><img src=./03.png alt="Client VM"></p></li><li><p>At first login, as mentioned in the &ldquo;Automation Flow&rdquo; section, a logon script will get executed. This script was created as part of the automated deployment process.</p><p>Let the script to run it&rsquo;s course and <strong>do not close</strong> the PowerShell session, this will be done for you once completed. <strong>The logon script run time is approximately 30s long</strong>.</p><p>Once the script will finish it&rsquo;s run, the logon script PowerShell session will be closed and the <em>kubeconfig</em> is copied to the <em>.kube</em> folder of the Windows user profile, the client VM will be ready to use.</p><p><img src=./04.png alt="PowerShell logon script run"></p><p><img src=./05.png alt="PowerShell logon script run"></p><p><img src=./06.png alt="PowerShell logon script run"></p></li><li><p>To start interacting with the Azure Arc Data Controller, Open PowerShell and use the log in command bellow.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000>azdata</span> <span style=color:#000>login</span> <span style=color:#000;font-weight:700>-</span><span style=color:#000>-namespace</span> <span style=color:#000>$env:ARC_DC_NAME</span>
<span style=color:#000>azdata</span> <span style=color:#000>arc</span> <span style=color:#000>dc</span> <span style=color:#000>status</span> <span style=color:#000>show</span>
</code></pre></div></li><li><p>Another tool automatically deployed is Azure Data Studio along with the <em>Azure Data CLI</em>, the <em>Azure Arc</em> and the <em>PostgreSQL</em> extensions. Using the Desktop shortcut created for you, open Azure Data Studio and click the Extensions settings to see both extensions.</p><p><img src=./07.png alt="Azure Data Studio shortcut"></p><p><img src=./08.png alt="Azure Data Studio extensions"></p></li></ul><h2 id=using-the-ubuntu-kubernetes-vm>Using the Ubuntu Kubernetes VM</h2><p>Even though everything you need is installed in the Windows client VM, it is possible, if you prefer, to use <em>azdata</em> CLI from within the Ubuntu VM.</p><ul><li><p>SSH to the Ubuntu VM using it public IP.</p><p><img src=./09.png alt="Ubuntu Data client VM"></p></li><li><p>To start interacting with the Azure Arc Data Controller, use the log in command bellow.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>azdata login --namespace <span style=color:#000>$ARC_DC_NAME</span>
azdata arc dc status show
</code></pre></div><p><img src=./10.png alt="azdata login"></p></li></ul><h2 id=cleanup>Cleanup</h2><ul><li><p>To delete the entire environment, simply delete the deployment resource group from the Azure portal.</p><p><img src=./11.png alt="Delete Azure resource group"></p></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/stack><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel="noopener noreferrer" href=https://github.com/lujiansong/azure_arc><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel="noopener noreferrer" href=https://example.org/mail><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2021 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>Privacy Policy</a></small></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.b5fc1b29d2465835844254bd4d804738eaf24c0cec53009b4c6899989be55a47.js integrity="sha256-tfwbKdJGWDWEQlS9TYBHOOryTAzsUwCbTGiZmJvlWkc=" crossorigin=anonymous></script></body></html>